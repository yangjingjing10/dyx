<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>多云熊小手机</title>

<!-- PWA支持 -->
<!-- <link rel="manifest" href="manifest.json"> -->
<meta name="theme-color" content="#ff6b9d">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="多云熊小手机">
<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaD0iMTkyIiB2aWV3Qm94PSIwIDAgMTkyIDE5MiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iOTYiIGN5PSI5NiIgcj0iOTYiIGZpbGw9IiNmZjZiOWQiLz4KPHN2ZyB3aWR0aD0iMTkyIiBoZWlnaD0iMTkyIiB2aWV3Qm94PSIwIDAgMTkyIDE5MiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iOTYiIGN5PSI5NiIgcj0iOTYiIGZpbGw9IiNmZjZiOWQiLz4KPC9zdmc+">
<!-- 样式已内联到HTML中 -->
<style>
/* 原有样式保持不变 */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

/* 移动端优化 */
@media screen and (max-width: 768px) {
    .widget {
        width: calc(50% - 6px);
        padding: 8px;
    }
    
    .widget-clock .time {
        font-size: 20px;
    }
    
    .widget-weather .temp {
        font-size: 20px;
    }
    
    .app-block span {
        font-size: 10px;
    }
    
    .bottom-bar .app span {
        font-size: 9px;
    }
}

/* 防止用户缩放 */
html {
    -webkit-text-size-adjust: 100%;
    -ms-text-size-adjust: 100%;
    touch-action: manipulation;
}

/* 隐藏滚动条 */
::-webkit-scrollbar {
    display: none;
}

body {
    margin: 0;
    padding: 0;
    width: 100vw;
    height: calc(var(--vh, 1vh) * 100);
    background-color: transparent;
    overflow: hidden;
}

.phone-container {
    width: 100vw;
    height: calc(var(--vh, 1vh) * 100);
    border: none;
    border-radius: 0;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    position: relative;
    overflow: hidden;
}

.phone-charm {
    position: absolute;
    top: -12px;
    right: -49px;
    width: 160px;
    height: 160px;
    background-image: url('https://files.catbox.moe/7ozygy.gif');
    background-size: contain;
    background-repeat: no-repeat;
    z-index: 9999; /* 设置更高的z-index确保显示在最上层 */
    pointer-events: none; /* 让鼠标事件穿透到下面的元素 */
}

.phone-notch {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 160px;
    height: 13px;
    background: #363636;
    border-bottom-left-radius: 12px;
    border-bottom-right-radius: 12px;
    z-index: 2;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
}

.notch-forum {
    width: 8px;
    height: 8px;
    background: #222;
    border-radius: 50%;
    border: 2px solid #444;
}

.notch-speaker {
    width: 40px;
    height: 4px;
    background: #222;
    border-radius: 2px;
}

.notch-sensor {
    width: 6px;
    height: 6px;
    background: #222;
    border-radius: 50%;
    border: 1px solid #444;
}

.status-bar {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 24px;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 16px;
    color: #fff;
    font-size: 12px;
    z-index: 1;
}

.status-bar-left {
    display: flex;
    align-items: center;
    gap: 4px;
}

.status-bar-right {
    display: flex;
    align-items: center;
    gap: 8px;
}

.status-icon-svg {
    width: 16px;
    height: 16px;
    fill: #fff;
}

.widget-container {
    position: absolute;
    top: 40px;
    left: 4vw;
    right: 4vw;
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    z-index: 1;
    transition: transform 0.3s ease-in-out;
}

.widget {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 12px;
    width: calc(50% - 6px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    transition: transform 0.2s;
}

.widget:hover {
    transform: scale(1.05);
}

.widget-clock {
    display: flex;
    flex-direction: column;
    align-items: center;
    color: #fff;
}

.widget-clock .time {
    font-size: 24px;
    font-weight: bold;
}

.widget-clock .date {
    font-size: 12px;
    opacity: 0.8;
}

.widget-weather {
    display: flex;
    flex-direction: column;
    align-items: center;
    color: #fff;
}

.widget-weather .temp {
    font-size: 24px;
    font-weight: bold;
}

.widget-weather .condition {
    font-size: 12px;
    opacity: 0.8;
}

/* 桌面容器样式 */
.desktop-container {
    position: absolute;
    top: 30vh;
    left: 4vw;
    right: 4vw;
    bottom: 20vh;
    overflow: hidden;
    display: flex;
    transition: transform 0.3s ease-in-out;
}

.desktop-page {
    min-width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease-in-out;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
}

.desktop-page.active {
    opacity: 1;
    transform: translateX(0);
}

.desktop-page:first-child {
    transform: translateX(0);
    opacity: 1;
}

.app-grid {
    position: relative;
    width: 100%;
    height: 100%;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 4vw;
    justify-content: center;
    align-content: center;
}

/* 页面指示器样式 */
.page-indicators {
    position: absolute;
    bottom: 15vh;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 8px;
    z-index: 10;
}

.page-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    cursor: pointer;
    transition: all 0.3s ease;
}

.page-indicator.active {
    background: rgba(255, 255, 255, 0.8);
    transform: scale(1.2);
}

.app-block {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(5px);
    border-radius: 16px;
    padding: 12px;
    transition: transform 0.2s;
    cursor: pointer;
}

.app-block:hover {
    transform: scale(1.05);
}

.app-block img {
    width: 12vw;
    height: 12vw;
    max-width: 60px;
    max-height: 60px;
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 12px;
    margin-bottom: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.app-block span {
    font-size: 12px;
    color: #fff;
    text-align: center;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

.bottom-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 80px;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    align-items: center;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(20px);
    border-top: 1px solid rgba(255, 255, 255, 0.2);
}

.bottom-bar .app {
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: transform 0.2s;
    cursor: pointer;
}

.bottom-bar .app:hover {
    transform: translateY(-4px);
}

.bottom-bar .app img {
    width: 8vw;
    height: 8vw;
    max-width: 40px;
    max-height: 40px;
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.bottom-bar .app span {
    font-size: 10px;
    color: #000;
    text-align: center;
    margin-top: 4px;
}
/* 弹窗容器 */
.dialog {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(5px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.dialog.show {
    opacity: 1;
    visibility: visible;
}

/* 弹窗内容 */
.dialog-content {
    background: linear-gradient(135deg, #fff8f8 0%, #ffe6ea 100%);
    padding: 25px;
    border-radius: 24px;
    width: 85%;
    max-width: 320px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    transform: scale(0.9);
    transition: all 0.3s ease;
    border: 2px solid rgba(255, 182, 193, 0.3);
}

.dialog.show .dialog-content {
    transform: scale(1);
}

/* 标题 */
.dialog-content h3 {
    margin: 0 0 20px;
    color: #ff6b81;
    font-size: 1.4em;
    text-align: center;
    font-weight: 600;
    text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
}

/* 输入框 */
.dialog-content input {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #ffb6c1;
    border-radius: 12px;
    margin-bottom: 20px;
    font-size: 1em;
    color: #444;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.9);
}

.dialog-content input:focus {
    outline: none;
    border-color: #ff6b81;
    box-shadow: 0 0 15px rgba(255, 107, 129, 0.2);
    transform: translateY(-2px);
}

/* 按钮容器 */
.dialog-buttons {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

/* 按钮样式 */
.dialog-buttons button {
    padding: 10px 20px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9em;
    transition: all 0.3s ease;
}

.dialog-buttons button:first-child {
    background: linear-gradient(45deg, #ff6b81, #ff8e9e);
    color: white;
    box-shadow: 0 4px 15px rgba(255, 107, 129, 0.3);
}

.dialog-buttons button:first-child:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 107, 129, 0.4);
}

.dialog-buttons button:last-child {
    background: rgba(255, 255, 255, 0.8);
    color: #ff6b81;
    border: 2px solid rgba(255, 107, 129, 0.3);
}

.dialog-buttons button:last-child:hover {
    background: rgba(255, 255, 255, 0.95);
    transform: translateY(-2px);
}

/* 消息列表样式 */
.messages-app {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgb(255, 255, 255);
    backdrop-filter: blur(10px);
    z-index: 2000;
    display: none;
    flex-direction: column;
}

.messages-app.show {
    display: flex;
}

.messages-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    flex-shrink: 0;
}

.messages-back-btn {
    font-size: 24px;
    font-weight: bold;
    color: #333;
    cursor: pointer;
    padding: 4px;
}

.messages-title {
    font-size: 17px;
    font-weight: 600;
    color: #333;
    text-align: center;
    flex: 1;
}

.messages-list {
    flex: 1;
    overflow-y: auto;
    padding: 0;
}

.message-item {
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    cursor: pointer;
    transition: background 0.2s;
}

.message-item:hover {
    background: rgba(108, 140, 213, 0.1);
}

.message-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #fff;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    flex-shrink: 0;
}

.message-info {
    flex: 1;
    min-width: 0;
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.message-name {
    font-size: 16px;
    font-weight: 600;
    color: #333;
}

.message-time {
    font-size: 12px;
    color: #999;
}

.message-preview {
    font-size: 14px;
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.unread-badge {
    min-width: 20px;
    height: 20px;
    padding: 0 6px;
    background: #6C8CD5;
    color: white;
    font-size: 12px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 8px;
}

.messages-fab-btn {
    position: absolute;
    bottom: 60px;
    right: 24px;
    width: 56px;
    height: 56px;
    background: #6C8CD5;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 4px 12px rgba(108, 140, 213, 0.3);
    z-index: 100;
}

.messages-fab-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(108, 140, 213, 0.4);
}

/* 论坛应用样式 */
.forum-app {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: #f5f5f5;
    z-index: 2000;
    display: none;
    flex-direction: column;
}

.forum-app.show {
    display: flex;
}

.forum-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: white;
    border-bottom: 1px solid #e0e0e0;
    flex-shrink: 0;
}

.forum-back-btn {
    font-size: 32px;
    font-weight: 300;
    color: #333;
    cursor: pointer;
    padding: 4px;
    line-height: 1;
}

.forum-settings-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 6px;
    transition: background-color 0.2s;
}

.forum-settings-btn:hover {
    background-color: #f5f5f5;
}

.forum-settings-btn svg {
    color: #666;
}

/* 论坛导航按钮容器 */
.forum-nav-buttons {
    display: flex;
    gap: 8px;
    align-items: center;
}

/* 调试按钮样式 */
.forum-debug-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
}

.forum-debug-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
}

.forum-debug-btn svg {
    color: white;
    animation: sparkle 2s ease-in-out infinite;
}

@keyframes sparkle {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

/* 论坛设置弹窗样式 */
.forum-settings-content {
    max-width: 400px;
    max-height: 80vh;
    overflow-y: auto;
}

.settings-section {
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px solid #f0f0f0;
}

.settings-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.settings-section-title {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin: 0 0 15px 0;
}

.settings-label {
    display: block;
    font-size: 14px;
    color: #666;
    margin-bottom: 8px;
}

/* 取色器样式 */
.color-picker-container {
    margin-bottom: 15px;
}

.color-picker-wrapper {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
}

.color-picker {
    width: 40px;
    height: 40px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    padding: 0;
}

.color-preview {
    width: 30px;
    height: 30px;
    border-radius: 6px;
    border: 2px solid #ddd;
    background: #ff6b35;
}

.color-value {
    font-family: monospace;
    font-size: 14px;
    color: #666;
    background: #f5f5f5;
    padding: 4px 8px;
    border-radius: 4px;
}

.preset-colors {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
}

.preset-color {
    width: 30px;
    height: 30px;
    border-radius: 6px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s;
}

.preset-color:hover {
    transform: scale(1.1);
    border-color: #333;
}

.preset-color.selected {
    border-color: #333;
    box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
}

/* 世界观设置样式 */
.worldview-container {
    margin-bottom: 15px;
}

.settings-select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    background: white;
    margin-bottom: 10px;
}

.worldview-textarea {
    width: 100%;
    min-height: 80px;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
    margin-bottom: 10px;
}

.worldview-textarea:focus {
    outline: none;
    border-color: var(--forum-theme-color, #ff6b35);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.worldview-tips {
    font-size: 12px;
    color: #666;
    background: #f8f9fa;
    padding: 8px 12px;
    border-radius: 4px;
    border-left: 3px solid var(--forum-theme-color, #ff6b35);
}

/* 联系人参与设置样式 */
.contact-integration {
    margin-bottom: 15px;
}

.toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
    margin-bottom: 15px;
}

.toggle-input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-label {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 24px;
}

.toggle-label:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

.toggle-input:checked + .toggle-label {
    background-color: var(--forum-theme-color, #ff6b35);
}

.toggle-input:checked + .toggle-label:before {
    transform: translateX(26px);
}

.contact-list {
    margin-top: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.contact-list-header {
    font-size: 14px;
    color: #666;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.refresh-contacts-btn {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    background: #f5f5f5;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 12px;
    color: #666;
    cursor: pointer;
    transition: all 0.2s;
}

.refresh-contacts-btn:hover {
    background: #e9ecef;
    border-color: #adb5bd;
}

.refresh-contacts-btn svg {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.contact-items {
    max-height: 150px;
    overflow-y: auto;
}

.contact-item {
    display: flex;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.contact-item:last-child {
    border-bottom: none;
}

.contact-item input[type="checkbox"] {
    margin-right: 10px;
}

.contact-avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    margin-right: 8px;
}

.contact-name {
    font-size: 14px;
    color: #333;
}

/* 设置按钮样式 */
.settings-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #f0f0f0;
}

.settings-btn {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.settings-btn-secondary {
    background: #f5f5f5;
    color: #666;
}

.settings-btn-secondary:hover {
    background: #e9ecef;
}

.settings-btn-primary {
    background: var(--forum-theme-color, #ff6b35);
    color: white;
}

.settings-btn-primary:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

/* AI帖子样式 */
.ai-post {
    border-left: 3px solid #e3f2fd;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
}

.ai-post .forum-post-title {
    color: #000000;
}

.ai-badge {
    background: #e3f2fd !important;
    color: #1976d2 !important;
    padding: 2px 6px !important;
    border-radius: 10px !important;
    font-size: 10px !important;
    margin-left: 5px !important;
    font-weight: 500;
}

/* 论坛标签样式 */
.forum-tag {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 500;
    margin-right: 5px;
    color: white;
}

.forum-tag.生活 {
    background: #4caf50;
}

.forum-tag.职场 {
    background: #ff9800;
}

.forum-tag.情感 {
    background: #e91e63;
}

.forum-tag.学习 {
    background: #9c27b0;
}

.forum-tag.娱乐 {
    background: #f44336;
}

.forum-title {
    font-size: 17px;
    font-weight: 600;
    color: #333;
    text-align: center;
    flex: 1;
}

.forum-page-content {
    flex: 1;
    overflow-y: auto;
    background: #f5f5f5;
}


.forum-posts-container {
    padding: 0;
}

/* 论坛贴文卡片样式 */
.forum-post-card {
    background: white;
    border-radius: 16px;
    margin-bottom: 15px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    overflow: hidden;
}

.forum-post-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

.forum-post-card.pinned-post-card {
    background: white;
    color: #333;
    border-left: 0px solid #ff6b35;
}

.forum-post-card.pinned-post-card .forum-post-title {
    color: #ff6b35;
}

.forum-post-card.pinned-post-card .forum-post-content {
    color: #333;
}

.forum-post-card.pinned-post-card .forum-post-author {
    color: #ff6b35;
}

.forum-post-card.pinned-post-card .forum-stat-item {
    color: #666;
}

.forum-post {
    padding: 20px;
    border-left: 4px solid transparent;
    transition: all 0.3s ease;
}

.forum-post.pinned {
    border-left-color: #ff9a9e;
}

.forum-post:active {
    background: #fafafa;
}

.forum-post-title {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
    line-height: 1.4;
}

.forum-post-content {
    color: #666;
    line-height: 1.6;
    margin-bottom: 15px;
    font-size: 14px;
}

.forum-post-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
}

.forum-post-author-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.forum-post-time {
    font-size: 12px;
    color: #999;
}

.forum-post-author {
    color: #ff6b35;
    font-size: 14px;
    font-weight: 500;
}

.forum-post-stats {
    display: flex;
    align-items: center;
    gap: 15px;
}

.forum-stat-item {
    display: flex;
    align-items: center;
    gap: 4px;
    color: #999;
    font-size: 13px;
}

.forum-tag {
    background: #ff4757;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    margin-right: 6px;
    font-weight: 500;
    display: inline-block;
}

.forum-tag.gossip {
    background: #ff4757;
}

.forum-tag.help {
    background: #ff6b35;
}

.forum-tag.discussion {
    background: #3742fa;
}

.forum-tag.职场 {
    background: #ff6b35;
}

.forum-tag.求助 {
    background: #ff4757;
}

.forum-tag.生活 {
    background: #2ed573;
}

.forum-tag.吐槽 {
    background: #ff3838;
}

.forum-tag.分享 {
    background: #3742fa;
}

.forum-tag.效率 {
    background: #ffa502;
}

.forum-tag.心情 {
    background: #ff9ff3;
}

.forum-tag.推荐 {
    background: #54a0ff;
}

.forum-tag.读书 {
    background: #5f27cd;
}

.forum-tag.美食 {
    background: #ff6348;
}

/* 论坛发帖按钮 */
.forum-fab-btn {
    position: absolute;
    bottom: 100px;
    right: 24px;
    width: 56px;
    height: 56px;
    background: #ff6b35;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
    z-index: 100;
}

.forum-fab-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(255, 107, 53, 0.4);
}

/* 论坛贴文详情页面样式 */
.forum-detail-page {
    display: none;
    flex-direction: column;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: white;
    z-index: 1000;
}

.forum-detail-page.show {
    display: flex;
}

.forum-detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: white;
    border-bottom: 1px solid #e0e0e0;
    flex-shrink: 0;
}

.forum-detail-back-btn {
    font-size: 32px;
    font-weight: 300;
    color: #333;
    cursor: pointer;
    line-height: 1;
    transition: color 0.3s ease;
}

.forum-detail-back-btn:hover {
    color: #ff6b35;
}

.forum-detail-title {
    font-size: 17px;
    font-weight: 600;
    color: #333;
    text-align: center;
    flex: 1;
}

.forum-detail-content {
    flex: 1;
    overflow-y: auto;
    background: #f5f5f5;
}

/* 论坛详情页面卡片样式 */
.forum-detail-post-card {
    background: white;
    border-radius: 16px;
    margin: 15px 10px 15px 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.forum-detail-post {
    padding: 20px;
    display: flex;
    flex-direction: column;
}

.forum-detail-post-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 15px;
}

.forum-detail-post-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-size: cover;
    border: 2px solid #ff6b35;
}

.forum-detail-post-info {
    flex: 1;
}

.forum-detail-post-author {
    font-weight: bold;
    font-size: 16px;
    color: #333;
    margin-bottom: 2px;
}

.forum-detail-post-time {
    font-size: 12px;
    color: #888;
}

.forum-detail-post-title {
    font-size: 28px;
    font-weight: 700;
    color: #333;
    margin-bottom: 25px;
    line-height: 1.3;
    text-align: center;
    padding: 0 10px;
}

.forum-detail-post-content {
    font-size: 16px;
    line-height: 1.7;
    color: #333;
    margin-bottom: 25px;
    padding: 0 10px;
}

.forum-detail-post-stats {
    display: flex;
    justify-content: space-around;
    font-size: 15px;
    color: #ff6b35;
    padding-top: 20px;
    border-top: 1px solid #f0f0f0;
    margin-top: auto;
}

.forum-detail-stat-item {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    transition: transform 0.2s ease;
    padding: 8px 12px;
    border-radius: 8px;
}

.forum-detail-stat-item:hover {
    transform: scale(1.1);
    background: rgba(255, 105, 180, 0.1);
}

/* 论坛我的页面样式 */
.forum-profile-page {
    display: none;
    flex-direction: column;
    height: 100%;
}

.forum-profile-page.show {
    display: flex;
}

.forum-profile-header {
    background: linear-gradient(135deg, #ff6b35, #ff9a9e);
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    padding: 20px;
    color: white;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.forum-profile-header:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
}

.forum-profile-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    margin: 0 auto 10px;
    background-size: cover;
    background-position: center;
    border: 4px solid rgba(255, 255, 255, 0.3);
}

.forum-profile-name {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 5px;
    cursor: pointer;
    transition: opacity 0.3s ease;
}

.forum-profile-name:hover {
    opacity: 0.8;
}


.forum-profile-stats {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-top: 15px;
}

.forum-profile-stat {
    text-align: center;
}

.forum-profile-stat-number {
    font-size: 18px;
    font-weight: 600;
    display: block;
}

.forum-profile-stat-label {
    font-size: 12px;
    opacity: 0.8;
}

.forum-profile-posts {
    flex: 1;
    overflow-y: auto;
    background: #f5f5f5;
}

.forum-profile-post {
    background: white;
    margin-bottom: 8px;
    padding: 15px 20px;
    border-left: 4px solid transparent;
    transition: all 0.3s ease;
}

.forum-profile-post:hover {
    background: #fafafa;
}

.forum-profile-post-title {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
    line-height: 1.4;
}

.forum-profile-post-content {
    color: #666;
    line-height: 1.6;
    margin-bottom: 10px;
    font-size: 14px;
}

.forum-profile-post-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: #999;
}

.forum-profile-post-stats {
    display: flex;
    gap: 15px;
}

.forum-profile-post-stat {
    display: flex;
    align-items: center;
    gap: 4px;
}

/* 个人主页帖子卡片样式 */
.forum-profile-post-card {
    background: white;
    border-radius: 16px;
    margin: 15px 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border: 1px solid #f0f0f0;
    overflow: hidden;
    transition: all 0.2s ease;
}

.forum-profile-post-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

.forum-profile-post {
    padding: 20px;
}

.forum-profile-post-title {
    font-size: 18px;
    font-weight: 600;
    color: #333;
    margin-bottom: 10px;
    line-height: 1.4;
}

.forum-profile-post-content {
    font-size: 15px;
    color: #555;
    line-height: 1.6;
    margin-bottom: 15px;
    word-wrap: break-word;
    word-break: break-word;
    overflow-wrap: break-word;
}

.forum-profile-post-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-top: 15px;
    border-top: 1px solid #f0f0f0;
}

.forum-profile-post-time {
    font-size: 13px;
    color: #999;
}

.forum-profile-post-stats {
    display: flex;
    align-items: center;
    gap: 15px;
}

.forum-profile-post-stat {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    color: #666;
}

.forum-profile-post-stat svg {
    color: #999;
    flex-shrink: 0;
}

/* 论坛个人资料编辑样式 */
.forum-profile-edit-section {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-bottom: 20px;
}

.forum-profile-edit-avatar-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

.forum-profile-edit-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    border: 3px solid #ff6b35;
    cursor: pointer;
    transition: all 0.3s ease;
}

.forum-profile-edit-avatar:hover {
    transform: scale(1.05);
    border-color: #ff9a9e;
}

.forum-profile-edit-avatar-btn {
    background: #ff6b35;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.forum-profile-edit-avatar-btn:hover {
    background: #ff9a9e;
    transform: translateY(-2px);
}

.forum-profile-edit-card-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

.forum-profile-edit-card {
    width: 120px;
    height: 80px;
    border: 2px dashed #ff6b35;
    border-radius: 8px;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
    background-color: transparent;
}

.forum-profile-edit-card:hover {
    border-color: #e55a2b;
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(255, 107, 53, 0.2);
}

.forum-profile-edit-card-placeholder {
    color: #ff6b35;
    font-size: 12px;
    text-align: center;
    padding: 10px;
}

.forum-profile-edit-card-btn {
    background: #ff6b35;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.forum-profile-edit-card-btn:hover {
    background: #ff9a9e;
    transform: translateY(-2px);
}

.forum-profile-edit-form {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.forum-profile-edit-label {
    font-size: 14px;
    font-weight: 600;
    color: #333;
}

/* 论坛底部导航栏 */
.forum-bottom-nav {
    display: flex;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-top: 1px solid rgba(0, 0, 0, 0.05);
    padding: 8px 0 6px 0;
    position: sticky;
    bottom: 0;
    z-index: 100;
    box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.08);
}

.forum-bottom-nav-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 6px 4px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    border-radius: 12px;
    margin: 0 4px;
}

.forum-bottom-nav-item:hover {
    background: rgba(255, 107, 53, 0.08);
    transform: translateY(-2px);
}

.forum-bottom-nav-item.active {
    color: #ff6b35;
    background: rgba(255, 107, 53, 0.1);
    transform: translateY(-2px);
}

.forum-bottom-nav-item.active::before {
    content: '';
    position: absolute;
    top: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 4px;
    height: 4px;
    background: #ff6b35;
    border-radius: 50%;
}

.forum-bottom-nav-icon {
    font-size: 20px;
    margin-bottom: 3px;
    transition: all 0.3s ease;
}

.forum-bottom-nav-item.active .forum-bottom-nav-icon {
    transform: scale(1.1);
}

.forum-bottom-nav-text {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
}

.forum-bottom-nav-item.active .forum-bottom-nav-text {
    font-weight: 700;
}

/* 论坛评论样式 */
.forum-comment-item {
    background: white;
    border-radius: 16px;
    padding: 20px;
    margin: 15px 10px 15px 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border: 1px solid #f0f0f0;
    cursor: pointer;
    transition: all 0.2s ease;
}

.forum-comment-item:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
    transform: translateY(-1px);
}

.forum-comment-item:active {
    transform: translateY(0);
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
}

.forum-comment-item:last-child {
    margin-bottom: 0;
}

.forum-comment-header {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    gap: 10px;
}

.forum-comment-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: #ff6b35;
    background-size: cover;
    background-position: center;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 14px;
}

.forum-comment-info {
    flex: 1;
}

.forum-comment-author {
    font-weight: 600;
    color: #333;
    font-size: 14px;
    margin-bottom: 2px;
}

.forum-comment-time {
    color: #999;
    font-size: 12px;
}

.forum-comment-content {
    margin-bottom: 10px;
    margin-left: 42px; /* 与用户名对齐：头像宽度32px + 间距10px */
}

.forum-comment-text {
    color: #666;
    line-height: 1.5;
    margin-bottom: 10px;
    font-size: 14px;
    word-wrap: break-word;
    word-break: break-word;
    overflow-wrap: break-word;
    max-width: 100%;
}

.forum-comment-actions {
    display: none;
}

.forum-comment-replies {
    margin-top: 10px;
    margin-left: 0; /* 让灰色UI和主评论文字对齐，不需要额外边距 */
}

.forum-reply-toggle {
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
    color: #666;
    font-size: 13px;
    padding: 5px 0;
    transition: color 0.2s;
}

.forum-reply-toggle:hover {
    color: #ff6b35;
}

.forum-reply-toggle-text {
    font-weight: 500;
}

.forum-reply-toggle-icon {
    font-size: 10px;
    transition: transform 0.2s;
}

.forum-reply-toggle.expanded .forum-reply-toggle-icon {
    transform: rotate(180deg);
}

.forum-reply-list {
    margin-top: 8px;
}

/* 底部收起按钮已删除 */

.forum-comment-reply {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 8px;
    margin-bottom: 6px;
    border: 1px solid #e9ecef;
    cursor: pointer;
    transition: all 0.2s ease;
}

.forum-comment-reply:hover {
    background: #f0f1f2;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
}

.forum-comment-reply:active {
    transform: scale(0.98);
}

.forum-comment-reply:last-child {
    margin-bottom: 0;
}

.forum-comment-reply .forum-comment-header {
    margin-bottom: 8px;
    gap: 8px;
}

.forum-comment-reply .forum-comment-avatar {
    width: 24px;
    height: 24px;
    background-color: #666;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 10px;
}

.forum-comment-reply .forum-comment-author {
    font-size: 13px;
    font-weight: 500;
}

.forum-comment-reply .forum-comment-time {
    font-size: 11px;
}

.forum-comment-reply .forum-comment-content {
    margin-left: 42px; /* 与主评论文字对齐：主评论头像宽度32px + 间距10px */
}

.forum-comment-reply .forum-comment-header {
    margin-left: 0; /* 楼中楼头像不需要额外左边距，让它和主评论第一个字对齐 */
}

.forum-comment-reply .forum-comment-text {
    font-size: 13px;
    margin-bottom: 8px;
    color: #555;
    word-wrap: break-word;
    word-break: break-word;
    overflow-wrap: break-word;
    max-width: 100%;
}

.forum-comment-reply .forum-comment-actions {
    justify-content: flex-end;
}

.forum-comment-reply .forum-comment-reply-btn {
    font-size: 11px;
    padding: 4px 8px;
}

.forum-no-comments {
    text-align: center;
    color: #999;
    font-size: 14px;
    padding: 40px 20px;
}

.forum-comment-input-section {
    display: flex;
    gap: 12px;
    padding-top: 15px;
    border-top: 1px solid #f0f0f0;
}

.forum-comment-input-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    flex-shrink: 0;
}

.forum-comment-input-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.forum-comment-input {
    width: 100%;
    padding: 12px;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    resize: none;
    font-size: 14px;
    font-family: inherit;
    outline: none;
    transition: border-color 0.2s;
}

.forum-comment-input:focus {
    border-color: #ff6b35;
}

.forum-comment-send-btn {
    align-self: flex-end;
    background: #ff6b35;
    color: white;
    border: none;
    padding: 8px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
}

.forum-comment-send-btn:hover {
    background: #e55a2b;
}

/* 消息界面转发论坛帖子样式 */
.message-forum-card {
    background: white;
    border-radius: 8px;
    padding: 12px;
    margin: 4px 0;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid #f0f0f0;
    max-width: 75%;
    width: 75%;
    margin-left: auto;
    margin-right: 0;
}

.message-forum-title {
    font-size: 15px;
    font-weight: 600;
    color: #333;
    margin-bottom: 6px;
    line-height: 1.3;
}

.message-forum-content {
    font-size: 13px;
    color: #555;
    line-height: 1.4;
    margin-bottom: 8px;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.message-forum-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 8px;
}

.message-forum-author {
    font-size: 11px;
    color: #666;
    font-weight: 500;
}

.message-forum-time {
    font-size: 11px;
    color: #999;
    margin-left: 8px;
}

.message-forum-stats {
    display: flex;
    align-items: center;
    gap: 12px;
}

.message-forum-likes,
.message-forum-comments {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    color: #999;
}

.message-forum-likes svg,
.message-forum-comments svg {
    color: #999;
}

/* 转发弹窗样式 */
.forum-forward-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 4000;
    display: none;
    align-items: center;
    justify-content: center;
}

.forum-forward-modal.show {
    display: flex;
}

.forum-forward-content {
    background: white;
    border-radius: 16px;
    width: 90%;
    max-width: 400px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}

.forum-forward-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px;
    border-bottom: 1px solid #f0f0f0;
}

.forum-forward-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #333;
}

.forum-forward-close {
    background: none;
    border: none;
    font-size: 24px;
    color: #999;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background 0.2s;
}

.forum-forward-close:hover {
    background: #f5f5f5;
}

.forum-forward-contacts {
    max-height: 60vh;
    overflow-y: auto;
    padding: 10px 0;
}

.forum-forward-contact {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    cursor: pointer;
    transition: background 0.2s;
    gap: 12px;
}

.forum-forward-contact:hover {
    background: #f8f9fa;
}

.forum-forward-contact-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: 500;
    color: white;
    background-color: #007AFF;
}

.forum-forward-contact-info {
    flex: 1;
}

.forum-forward-contact-name {
    font-size: 16px;
    font-weight: 500;
    color: #333;
    margin-bottom: 2px;
}

.forum-forward-contact-status {
    font-size: 12px;
    color: #999;
}

/* 底部输入框弹窗样式 */
.forum-input-modal {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    border-top: 1px solid #e0e0e0;
    padding: 12px 15px;
    z-index: 3000;
    display: none;
    box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
}

.forum-input-modal.show {
    display: block;
}

.forum-input-modal-content {
    display: flex;
    gap: 10px;
    align-items: center;
}

.forum-input-modal-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: #ff6b35;
    background-size: cover;
    background-position: center;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 14px;
}

.forum-input-modal-input-container {
    flex: 1;
    background: #f5f5f5;
    border-radius: 20px;
    padding: 8px 12px;
    border: 1px solid #e0e0e0;
}

.forum-input-modal-input {
    width: 100%;
    border: none;
    background: transparent;
    outline: none;
    font-size: 14px;
    font-family: inherit;
    resize: none;
    min-height: 20px;
    max-height: 80px;
    line-height: 20px;
}

.forum-input-modal-input::placeholder {
    color: #999;
}

.forum-input-modal-send-btn {
    background: #ff6b35;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 16px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
    flex-shrink: 0;
}

.forum-input-modal-send-btn:hover {
    background: #e55a2b;
}

.forum-input-modal-send-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}

/* 消息选择菜单样式 */
.message-context-menu {
    position: fixed;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    z-index: 4000;
    min-width: 120px;
    overflow: hidden;
    opacity: 0;
    visibility: hidden;
    transform: scale(0.8);
    transition: all 0.2s ease;
}

.message-context-menu.show {
    opacity: 1;
    visibility: visible;
    transform: scale(1);
}

.message-context-item {
    padding: 12px 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #333;
    transition: background 0.2s;
}

.message-context-item:hover {
    background: rgba(108, 140, 213, 0.1);
}

.message-context-item.delete {
    color: #333;
}

.message-context-item.pin {
    color: #333;
}

.message-context-item.unpin {
    color: #333;
}

/* 长按高亮效果 */
.message-item.long-press {
    background: rgba(108, 140, 213, 0.2);
    transform: scale(0.98);
}

/* 置顶消息样式 */
.message-item.pinned {
    background: rgba(100, 100, 100, 0.1);
    border-left: 3px solid #666;
}

.message-item.pinned .message-name {
    color: #555;
    font-weight: 600;
}

/* 添加联系人弹窗样式 */
.add-contact-modal {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 3000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.add-contact-modal.show {
    opacity: 1;
    visibility: visible;
}

.add-contact-content {
    background: white;
    border-radius: 16px;
    padding: 20px;
    width: 90%;
    max-width: 320px;
    max-height: 80vh;
    overflow-y: auto;
    transform: scale(0.9);
    transition: all 0.3s ease;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

.add-contact-modal.show .add-contact-content {
    transform: scale(1);
}

.add-contact-title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 20px;
    color: #333;
    text-align: center;
}

.add-contact-options {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
}

.add-contact-option {
    flex: 1;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 12px;
    text-align: center;
    cursor: pointer;
    color: #555;
    font-weight: 500;
    transition: all 0.2s;
}

.add-contact-option:hover {
    border-color: #6C8CD5;
    color: #6C8CD5;
}

.add-contact-option.selected {
    background: #6C8CD5;
    color: white;
    border-color: #6C8CD5;
}

.add-contact-form {
    display: none;
}

.add-contact-form.show {
    display: block;
}

.add-form-group {
    margin-bottom: 15px;
}

.add-form-group label {
    display: block;
    font-size: 14px;
    color: #666;
    margin-bottom: 5px;
}

.add-form-group input,
.add-form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    box-sizing: border-box;
}

.add-form-group textarea {
    resize: vertical;
    height: 80px;
}

.add-contact-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
}

.add-contact-btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
}

.add-contact-btn-cancel {
    background: #f5f5f5;
    color: #666;
}

.add-contact-btn-confirm {
    background: #6C8CD5;
    color: white;
}

.add-contact-btn:hover {
    opacity: 0.8;
}

/* 群聊选择样式 */
.group-members-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #eee;
    border-radius: 8px;
    padding: 8px;
}

.group-member-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
}

.group-member-item:hover {
    background-color: #f0f0f0;
}

.group-member-checkbox {
    width: 18px;
    height: 18px;
    border: 2px solid #ccc;
    border-radius: 4px;
    transition: all 0.2s;
}

.group-member-item.selected .group-member-checkbox {
    background-color: #6C8CD5;
    border-color: #6C8CD5;
}

.group-member-item.selected .group-member-checkbox::after {
    content: '✔';
    color: white;
    display: block;
    text-align: center;
    line-height: 15px;
    font-size: 12px;
}

.group-member-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
}

.group-member-name {
    font-size: 14px;
    color: #333;
}

/* 文件上传样式 */
.file-upload-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.file-upload-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    border: 2px dashed #6C8CD5;
    border-radius: 8px;
    background: #f8f9ff;
    color: #6C8CD5;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
    font-weight: 500;
}

.file-upload-btn:hover {
    background: #6C8CD5;
    color: white;
    border-color: #6C8CD5;
}

.file-upload-btn svg {
    width: 20px;
    height: 20px;
}

.file-upload-hint {
    font-size: 12px;
    color: #999;
    text-align: center;
    line-height: 1.4;
}

/* 论坛加载更多按钮样式 */
.forum-load-more-container {
    display: flex;
    justify-content: center;
    padding: 20px;
    margin: 20px 0;
}

.forum-load-more-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 25px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.forum-load-more-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.forum-load-more-btn:active {
    transform: translateY(0);
}

.forum-load-more-btn svg {
    transition: transform 0.3s ease;
}

.forum-load-more-btn:hover svg {
    transform: rotate(90deg);
}

/* 删除帖子按钮样式 */
.delete-post-btn {
    color: #ff4757 !important;
    transition: all 0.3s ease;
}

.delete-post-btn:hover {
    background-color: rgba(255, 71, 87, 0.1) !important;
    transform: scale(1.1);
}

/* 删除AI帖子按钮样式 */
.delete-ai-posts-container {
    margin-top: 10px;
}

.delete-ai-posts-btn {
    display: flex;
    align-items: center;
    padding: 16px;
    background: #fff;
    border: 2px solid #e74c3c;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 10px;
}

.delete-ai-posts-btn:hover {
    background: #fdf2f2;
    border-color: #c0392b;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.2);
}

.delete-ai-posts-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: #e74c3c;
    border-radius: 8px;
    margin-right: 16px;
    color: white;
    flex-shrink: 0;
}

.delete-ai-posts-text {
    flex: 1;
}

.delete-ai-posts-title {
    font-size: 16px;
    font-weight: 600;
    color: #e74c3c;
    margin-bottom: 4px;
}

.delete-ai-posts-desc {
    font-size: 14px;
    color: #666;
    line-height: 1.4;
}

/* 论坛评论样式 */
.forum-comment-item {
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background 0.2s;
}

.forum-comment-item:hover {
    background: rgba(0, 0, 0, 0.02);
}

.forum-comment-header {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.forum-comment-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: #007AFF;
    background-size: cover;
    background-position: center;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 14px;
    margin-right: 4px;
    flex-shrink: 0;
}

.forum-comment-info {
    flex: 1;
}

.forum-comment-author {
    font-weight: 600;
    color: #333;
    font-size: 14px;
}

.forum-comment-time {
    font-size: 12px;
    color: #999;
    margin-top: 2px;
}

.forum-comment-content {
    margin-left: 44px;
}

.forum-comment-text {
    color: #333;
    line-height: 1.5;
    font-size: 14px;
}

/* 楼中楼样式 */
.forum-comment-replies {
    margin-top: 8px;
}

.forum-reply-toggle {
    display: flex;
    align-items: center;
    gap: 4px;
    color: #007AFF;
    font-size: 12px;
    cursor: pointer;
    padding: 4px 0;
    transition: color 0.2s;
}

.forum-reply-toggle:hover {
    color: #0056b3;
}

.forum-reply-toggle-text {
    font-weight: 500;
}

.forum-reply-toggle-icon {
    font-size: 10px;
    transition: transform 0.2s;
}

.forum-reply-list {
    margin-top: 8px;
    padding-left: 1px;
    border-left: 2px solid #f0f0f000;
}

.forum-comment-reply {
    padding: 8px 0;
    border-bottom: 1px solid #f8f8f8;
    cursor: pointer;
    transition: background 0.2s;
}

.forum-comment-reply:hover {
    background: rgba(0, 0, 0, 0.02);
}

.forum-comment-reply:last-child {
    border-bottom: none;
}

.forum-comment-reply .forum-comment-header {
    margin-bottom: 4px;
}

.forum-comment-reply .forum-comment-avatar {
    width: 24px;
    height: 24px;
    font-size: 12px;
    margin-right: 6px;
}

.forum-comment-reply .forum-comment-author {
    font-size: 13px;
}

.forum-comment-reply .forum-comment-time {
    font-size: 11px;
}

.forum-comment-reply .forum-comment-text {
    font-size: 13px;
    margin-left: 0;
    text-indent: 0;
}

/* 私聊界面样式 */
.chat-app {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    z-index: 2500;
    display: none;
    flex-direction: column;
}

/* 日记界面样式 */
.diary-app {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    z-index: 2500;
    display: none;
    flex-direction: column;
}

.diary-app.show {
    display: flex;
}

.diary-header {
    height: 56px;
    background: rgba(255, 255, 255, 0.9);
    padding: 0 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    flex-shrink: 0;
}

.diary-back-btn {
    font-size: 24px;
    font-weight: bold;
    color: #333;
    cursor: pointer;
    padding: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    transition: all 0.2s;
}

.diary-back-btn:hover {
    background: rgba(0, 0, 0, 0.1);
    transform: scale(1.1);
}

.diary-back-btn svg {
    width: 20px;
    height: 20px;
}

.diary-title {
    font-size: 17px;
    font-weight: 600;
    color: #333;
    flex: 1;
    text-align: center;
    margin-right: 80px;
}

.diary-header-actions {
    display: flex;
    gap: 8px;
    align-items: center;
}

.diary-action-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #666;
    transition: all 0.2s;
    border-radius: 6px;
}

.diary-action-btn:hover {
    background: rgba(108, 140, 213, 0.1);
    color: #6C8CD5;
    transform: scale(1.1);
}

.diary-content {
    flex: 1;
    padding: 0;
    overflow-y: auto;
    background-color: white;
    position: relative;
    font-family: "MS Mincho", serif;
}

.diary-content::-webkit-scrollbar {
    width: 6px;
}

.diary-content::-webkit-scrollbar-track {
    background: transparent;
}

.diary-content::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 3px;
}

.diary-entry {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 0;
    padding: 20px;
    margin: 0;
    box-shadow: none;
    font-family: 'Noto Serif SC', serif;
    line-height: 1.8;
    color: #333;
    position: relative;
    min-height: 100%;
}

.diary-entry-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    border-bottom: 2px solid #ffb6c1;
    padding-bottom: 5px;
}

.diary-entry-date {
    font-size: 14px;
    color: #ff69b4;
    font-weight: 600;
}

.diary-entry-weather {
    font-size: 12px;
    color: #808080;
}

.diary-entry-content {
    font-size: 14px;
    line-height: 1.8;
    color: #333;
    margin-bottom: 15px;
}

.diary-entry-content p {
    margin-bottom: 15px;
}

.diary-entry-footer {
    text-align: right;
    font-size: 12px;
    color: #ff69b4;
    font-style: italic;
}

/* 日记特殊样式 */
.highlight {
    background-color: #ffeb3b40;
    padding: 0 2px;
}

.underline {
    border-bottom: 2px dotted #ff69b4;
}

.emphasis {
    color: #ff4081;
    font-weight: bold;
}

.handwritten {
    font-family: "宋体", "SimSun", serif;
    color: #4a4a4a;
    font-weight: bold;
    text-decoration: wavy underline #ff69b4;
    letter-spacing: 1px;
}

.censored {
    position: relative;
    cursor: pointer;
    color: transparent;
}

.censored::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g fill="%23000" opacity="0.8"><rect x="0" y="0" width="100" height="100" fill-opacity="0.6"/><path d="M0 50 Q 25 0, 50 50 T 100 50" stroke="%23000" fill="none" stroke-width="2" opacity="0.4"/></g></svg>');
    background-size: 10px 10px;
    background-repeat: repeat;
    z-index: 1;
}

.messy {
    font-family: "Permanent Marker", cursive;
    transform: rotate(-2deg);
    display: inline-block;
}

.strikethrough {
    text-decoration: line-through;
    color: #a9a9a9;
}

/* 日记历史样式 */
.diary-history-content {
    flex: 1;
    padding: 8px 0;
    overflow-y: auto;
    background-color: #f8f9fa;
    position: relative;
}

.diary-history-content::-webkit-scrollbar {
    width: 6px;
}

.diary-history-content::-webkit-scrollbar-track {
    background: transparent;
}

.diary-history-content::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 3px;
}

.diary-history-item {
    background: rgba(255, 255, 255, 0.95);
    margin: 12px 16px;
    padding: 16px 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    border: 1px solid rgba(0, 0, 0, 0.05);
    display: block;
    width: calc(100% - 32px);
    box-sizing: border-box;
    clear: both;
    overflow: hidden;
}

.diary-history-item:hover {
    background: rgba(255, 255, 255, 0.98);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.diary-history-item:active {
    background: rgba(108, 140, 213, 0.1);
    transform: translateY(0);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.diary-history-date {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.diary-history-date::before {
    content: "📅";
    font-size: 14px;
}

.diary-history-preview {
    font-size: 14px;
    color: #666;
    line-height: 1.5;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    background: rgba(0, 0, 0, 0.02);
    padding: 8px 12px;
    border-radius: 8px;
    margin-top: 4px;
}

/* 空状态样式 */
.diary-history-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;
    text-align: center;
    color: #999;
}

.diary-history-empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
}

.diary-history-empty-text {
    font-size: 16px;
    color: #666;
    margin-bottom: 8px;
}

.diary-history-empty-hint {
    font-size: 14px;
    color: #999;
}

/* 日记设置样式 */
.diary-settings-content {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background-image: url('https://files.catbox.moe/fym5yn.png');
    background-size: cover;
    background-position: center;
    position: relative;
}

.diary-settings-form {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.diary-form-group {
    margin-bottom: 20px;
}

.diary-form-label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
}

.diary-form-input {
    width: 100%;
    height: 40px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    background: #fff;
    padding: 0 12px;
    outline: none;
    font-size: 14px;
    color: #333;
    box-sizing: border-box;
}

.diary-form-input:focus {
    border-color: #6C8CD5;
    box-shadow: 0 0 0 2px rgba(108, 140, 213, 0.2);
}

.diary-form-hint {
    font-size: 12px;
    color: #666;
    margin-top: 4px;
    line-height: 1.4;
}

.diary-form-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
}

.diary-form-btn {
    flex: 1;
    height: 40px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.diary-form-btn-primary {
    background: #6C8CD5;
    color: white;
}

.diary-form-btn-primary:hover {
    background: #4A6FBF;
    transform: translateY(-1px);
}

.diary-form-btn-secondary {
    background: rgba(108, 140, 213, 0.1);
    color: #6C8CD5;
    border: 1px solid #6C8CD5;
}

.diary-form-btn-secondary:hover {
    background: rgba(108, 140, 213, 0.2);
    transform: translateY(-1px);
}

/* 表情包弹窗样式 */
.emoji-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10000;
}

.emoji-modal.show {
    display: flex;
}

.emoji-modal-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 400px;
    max-height: 80%;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
}

.emoji-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid #eee;
    background: #f8f9fa;
}

.emoji-upload-btn {
    width: 32px;
    height: 32px;
    border: 1px dashed #6C8CD5;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #6C8CD5;
    transition: all 0.2s;
}

.emoji-upload-btn:hover {
    background: rgba(108, 140, 213, 0.1);
}

.emoji-modal-title {
    font-size: 16px;
    font-weight: 600;
    color: #333;
}

.emoji-modal-close {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 18px;
    color: #666;
    transition: all 0.2s;
}

.emoji-modal-close:hover {
    background: #e0e0e0;
}

.emoji-modal-body {
    padding: 20px;
    max-height: 400px;
    overflow-y: auto;
}

.emoji-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
    gap: 12px;
}

.emoji-item {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
}

.emoji-item:hover {
    border-color: #6C8CD5;
    transform: scale(1.05);
}

.emoji-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* 来电弹窗样式 */
.call-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10000;
}

.call-modal.show {
    display: flex;
}

.call-modal-content {
    background: white;
    border-radius: 20px;
    width: 90%;
    max-width: 320px;
    padding: 30px 24px 24px 24px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    text-align: center;
}

.incoming-call-avatar {
    width: 120px;
    height: 120px;
    margin: 0 auto 20px auto;
    border-radius: 50%;
    overflow: hidden;
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
    display: flex;
    align-items: center;
    justify-content: center;
}

.incoming-call-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

.incoming-call-name {
    font-size: 24px;
    font-weight: bold;
    color: #333;
    margin-bottom: 8px;
}

.incoming-call-type {
    font-size: 16px;
    color: #666;
    margin-bottom: 40px;
}

.incoming-call-buttons {
    display: flex;
    justify-content: center;
    gap: 40px;
    align-items: center;
}

.call-decline-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    background: #ff3742;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(255, 55, 66, 0.3);
}

.call-decline-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(255, 55, 66, 0.4);
}

.call-accept-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    background: #4CAF50;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
}

.call-accept-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
}

.call-options {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.call-option-btn {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 16px;
    color: #333;
}

.call-option-btn:hover {
    background: #f8f9fa;
    border-color: #6C8CD5;
}

.call-option-btn.call-cancel {
    background: #f8f9fa;
    color: #666;
    justify-content: center;
}

.call-option-btn.call-cancel:hover {
    background: #e9ecef;
}

/* 通话界面样式 */
.call-interface {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: white;
    display: none;
    flex-direction: column;
    z-index: 10001;
}

.call-interface.show {
    display: flex;
}

.call-interface-content {
    display: flex;
    flex-direction: column;
    height: 100%;
    color: #333;
}

.call-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    overflow: hidden;
    margin: 0 auto 24px;
    border: 4px solid rgba(255, 255, 255, 0.3);
}

.call-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.call-name {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 8px;
}

.call-status {
    font-size: 16px;
    opacity: 0.8;
    margin-bottom: 40px;
}

.call-actions {
    display: flex;
    justify-content: center;
    gap: 40px;
}

.call-action-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
}

.call-hangup {
    background: #ff4757;
    color: white;
}

.call-hangup:hover {
    background: #ff3742;
    transform: scale(1.1);
}

.call-answer {
    background: #2ed573;
    color: white;
}

.call-answer:hover {
    background: #26d065;
    transform: scale(1.1);
}

.chat-app.show {
    display: flex;
}

.chat-header {
    height: 56px;
    background: rgba(255, 255, 255, 0.9);
    padding: 0 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    flex-shrink: 0;
}

.chat-back-btn {
    font-size: 24px;
    font-weight: bold;
    color: #333;
    cursor: pointer;
    padding: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    transition: all 0.2s;
}

.chat-back-btn:hover {
    background: rgba(0, 0, 0, 0.1);
    transform: scale(1.1);
}

.chat-back-btn svg {
    width: 20px;
    height: 20px;
}

.chat-header-info {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
    justify-content: center;
}

.chat-title-left {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-left: 8px;
}

.chat-contact-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid rgba(255, 255, 255, 0.8);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.chat-contact-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.chat-diary-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #666;
    transition: all 0.2s;
    border-radius: 6px;
}

.chat-diary-btn:hover {
    background: rgba(108, 140, 213, 0.1);
    color: #6C8CD5;
    transform: scale(1.1);
}

.chat-header-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #fff;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.chat-header-text {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.chat-contact-name {
    font-size: 16px;
    color: #333;
    font-weight: 600;
    margin-bottom: 2px;
}

.chat-status {
    font-size: 12px;
    color: #4CAF50;
    display: flex;
    align-items: center;
    gap: 4px;
}

.status-dot {
    width: 6px;
    height: 6px;
    background: #4CAF50;
    border-radius: 50%;
}

.chat-messages {
    flex: 1;
    padding: 16px;
    overflow-y: auto;
    background-image: url('https://files.catbox.moe/bihed7.jpg');
    background-size: cover;
    background-position: center;
    position: relative;
}

.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: transparent;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 3px;
}

/* 加载更多消息按钮样式 */
#load-more-btn {
    text-align: center;
    padding: 10px;
    color: #6C8CD5;
    font-size: 14px;
    cursor: pointer;
    background-color: transparent;
    border: none;
    width: 100%;
    margin-bottom: 10px;
    border-radius: 8px;
    transition: background-color 0.2s;
}

#load-more-btn:hover {
    background-color: rgba(108, 140, 213, 0.1);
    text-decoration: underline;
}

.message {
    display: flex;
    margin-bottom: 12px;
    align-items: flex-start;
    position: relative;
    animation: message-pop 0.3s ease-out;
}

@keyframes message-pop {
    0% {
        transform: translateY(10px);
        opacity: 0;
    }
    100% {
        transform: translateY(0);
        opacity: 1;
    }
}

.message.sent {
    flex-direction: row-reverse;
}

.message-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    margin-top: 4px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border: 2px solid #fff;
    transition: transform 0.2s;
}

.message-avatar:hover {
    transform: scale(1.1);
}

/* 多选模式样式 */
.chat-app.multiselect .message {
    padding-left: 30px;
}
.select-circle {
    position: absolute;
    left: -4px;
    top: 12px;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    border: 2px solid #6C8CD5;
    background: #fff;
    display: none;
}
.chat-app.multiselect .select-circle { display: block; }
.select-circle.selected { background: #6C8CD5; box-shadow: inset 0 0 0 3px #fff; }
.chat-app.multiselect .message-avatar { transform: translateX(12px); }

/* 多选操作条 */
.multiselect-toolbar {
    position: absolute;
    left: 0;
    right: 0;
    bottom: 52px;
    background: rgba(255,255,255,0.98);
    border-top: 1px solid rgba(0,0,0,0.05);
    display: none;
    height: 44px;
    align-items: center;
    justify-content: space-around;
    z-index: 20;
}
.multiselect-toolbar.show { display: flex; }
.multiselect-action { cursor: pointer; color: #6C8CD5; font-weight: 600; }

.message-wrapper {
    max-width: 75%;
    display: flex;
    flex-direction: column;
    margin: 0 10px;
}

.message-content {
    padding: 10px 14px;
    border-radius: 18px;
    font-size: 14px;
    line-height: 1.5;
    word-wrap: break-word;
    position: relative;
}

.received .message-content {
    background: #fff;
    color: #333;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    border-bottom-left-radius: 4px;
}

.sent .message-content {
    background: linear-gradient(135deg, #6C8CD5, #4A6FBF);
    color: #fff;
    border-bottom-right-radius: 4px;
}

.message-time {
    font-size: 11px;
    color: #888;
    margin-top: 4px;
    padding: 0 4px;
}

.sent .message-time {
    text-align: right;
}

.chat-input {
    height: 52px;
    background: rgba(255, 255, 255, 0.95);
    padding: 8px 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    border-top: 1px solid rgba(0, 0, 0, 0.05);
    backdrop-filter: blur(10px);
    position: relative;
    flex-shrink: 0;
}

.chat-input-field {
    flex: 1;
    height: 36px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 18px;
    background: #fff;
    padding: 0 16px;
    outline: none;
    font-size: 14px;
    color: #333;
}

.chat-input-field:focus {
    border-color: #6C8CD5;
    box-shadow: 0 0 0 2px rgba(108, 140, 213, 0.2);
}

.chat-input-field::placeholder {
    color: #999;
}

.chat-send-btn {
    width: 36px;
    height: 36px;
    border: none;
    border-radius: 50%;
    background: #6C8CD5;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
}

.chat-send-btn:hover {
    background: #4A6FBF;
    transform: scale(1.1);
}

.chat-settings-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #666;
    transition: all 0.2s;
    border-radius: 6px;
}

.chat-settings-btn:hover {
    background: rgba(108, 140, 213, 0.1);
    color: #6C8CD5;
    transform: scale(1.1);
}

/* 设置界面样式 */
.settings-app {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    z-index: 3000;
    display: none;
    flex-direction: column;
}

.settings-app.show {
    display: flex;
}

.settings-header {
    height: 56px;
    background: rgba(255, 255, 255, 0.9);
    padding: 0 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    flex-shrink: 0;
}

.settings-back-btn {
    font-size: 24px;
    font-weight: bold;
    color: #333;
    cursor: pointer;
    padding: 4px;
}

.settings-title {
    font-size: 17px;
    font-weight: 600;
    color: #333;
    text-align: center;
    flex: 1;
}

.settings-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

.settings-section {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.settings-section-title {
    font-size: 18px;
    font-weight: 600;
    color: #333;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.settings-section-icon {
    width: 20px;
    height: 20px;
    color: #6C8CD5;
}

.settings-option {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background 0.2s;
}

.settings-option:last-child {
    border-bottom: none;
}

.settings-option:hover {
    background: rgba(108, 140, 213, 0.05);
    border-radius: 8px;
    padding: 12px 8px;
}

.settings-option-label {
    font-size: 16px;
    color: #333;
}

.settings-option-value {
    font-size: 14px;
    color: #666;
}

.settings-option-arrow {
    width: 16px;
    height: 16px;
    color: #999;
}

/* AI配置弹窗样式 */
.ai-config-modal {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 4000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.ai-config-modal.show {
    opacity: 1;
    visibility: visible;
}

.ai-config-content {
    background: white;
    border-radius: 16px;
    padding: 24px;
    width: 90%;
    max-width: 400px;
    max-height: 80vh;
    overflow-y: auto;
    transform: scale(0.9);
    transition: all 0.3s ease;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

.ai-config-modal.show .ai-config-content {
    transform: scale(1);
}

.ai-config-title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 20px;
    color: #333;
    text-align: center;
}

.ai-provider-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 24px;
}

.ai-provider-option {
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 12px;
}

.ai-provider-option:hover {
    border-color: #6C8CD5;
    background: rgba(108, 140, 213, 0.05);
}

.ai-provider-option.selected {
    border-color: #6C8CD5;
    background: rgba(108, 140, 213, 0.1);
}

.ai-provider-icon {
    width: 24px;
    height: 24px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 12px;
}

.ai-provider-icon.deepseek {
    background: #1a1a1a;
}

.ai-provider-icon.google {
    background: #4285f4;
}

.ai-provider-icon.openai {
    background: #00a67e;
}

.ai-provider-icon.custom {
    background: #6c5ce7;
}

.ai-provider-name {
    font-size: 16px;
    font-weight: 500;
    color: #333;
}

.ai-config-form {
    display: none;
}

.ai-config-form.show {
    display: block;
}

.ai-form-group {
    margin-bottom: 16px;
}

.ai-form-label {
    display: block;
    font-size: 14px;
    color: #666;
    margin-bottom: 6px;
    font-weight: 500;
}

.ai-form-input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    box-sizing: border-box;
    transition: border-color 0.2s;
}

.ai-form-input:focus {
    outline: none;
    border-color: #6C8CD5;
    box-shadow: 0 0 0 2px rgba(108, 140, 213, 0.2);
}

.ai-form-select {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    background: white;
    cursor: pointer;
}

.ai-form-select:focus {
    outline: none;
    border-color: #6C8CD5;
    box-shadow: 0 0 0 2px rgba(108, 140, 213, 0.2);
}

.ai-form-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 24px;
}

.ai-form-btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
}

.ai-form-btn-cancel {
    background: #f5f5f5;
    color: #666;
}

.ai-form-btn-cancel:hover {
    background: #e0e0e0;
}

.ai-form-btn-primary {
    background: #6C8CD5;
    color: white;
}

.ai-form-btn-primary:hover {
    background: #4A6FBF;
}

/* 空状态样式 */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    text-align: center;
    color: #999;
}

.empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.6;
}

.empty-state-text {
    font-size: 18px;
    font-weight: 500;
    margin-bottom: 8px;
    color: #666;
}

.empty-state-subtext {
    font-size: 14px;
    color: #999;
    line-height: 1.4;
}

.ai-form-btn-primary:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.ai-loading {
    display: none;
    align-items: center;
    justify-content: center;
    gap: 8px;
    color: #666;
    font-size: 14px;
}

.ai-loading.show {
    display: flex;
}

.ai-loading-spinner {
    width: 16px;
    height: 16px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #6C8CD5;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.ai-status {
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    margin-top: 8px;
}

.ai-status.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.ai-status.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

/* 联系人设置弹窗样式 */
.contact-settings-modal {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 3500;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.contact-settings-modal.show {
    opacity: 1;
    visibility: visible;
}

.contact-settings-content {
    background: white;
    border-radius: 16px;
    padding: 24px;
    width: 90%;
    max-width: 400px;
    max-height: 80vh;
    overflow-y: auto;
    transform: scale(0.9);
    transition: all 0.3s ease;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

.contact-settings-modal.show .contact-settings-content {
    transform: scale(1);
}

.contact-settings-title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 20px;
    color: #333;
    text-align: center;
}

.contact-settings-tabs {
    display: flex;
    margin-bottom: 20px;
    border-bottom: 1px solid #eee;
}

.contact-settings-tab {
    flex: 1;
    padding: 12px;
    text-align: center;
    cursor: pointer;
    color: #666;
    font-weight: 500;
    transition: all 0.2s;
    border-bottom: 2px solid transparent;
}

.contact-settings-tab.active {
    color: #6C8CD5;
    border-bottom-color: #6C8CD5;
}

.contact-settings-tab:hover {
    color: #6C8CD5;
}

.contact-settings-form {
    display: none;
}

.contact-settings-form.show {
    display: block;
}

.contact-form-group {
    margin-bottom: 16px;
}

.contact-form-label {
    display: block;
    font-size: 14px;
    color: #666;
    margin-bottom: 6px;
    font-weight: 500;
}

.contact-form-input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    box-sizing: border-box;
    transition: border-color 0.2s;
}

.contact-form-input:focus {
    outline: none;
    border-color: #6C8CD5;
    box-shadow: 0 0 0 2px rgba(108, 140, 213, 0.2);
}

.contact-form-textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    box-sizing: border-box;
    resize: vertical;
    min-height: 80px;
    transition: border-color 0.2s;
}

.contact-form-textarea:focus {
    outline: none;
    border-color: #6C8CD5;
    box-shadow: 0 0 0 2px rgba(108, 140, 213, 0.2);
}

.contact-avatar-upload {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
}

.contact-avatar-preview {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #ddd;
    cursor: pointer;
    transition: all 0.2s;
}

.contact-avatar-preview:hover {
    border-color: #6C8CD5;
    transform: scale(1.05);
}

.contact-avatar-upload-btn {
    flex: 1;
    padding: 10px;
    border: 1px dashed #6C8CD5;
    border-radius: 8px;
    background: rgba(108, 140, 213, 0.05);
    color: #6C8CD5;
    cursor: pointer;
    text-align: center;
    font-size: 14px;
    transition: all 0.2s;
}

.contact-avatar-upload-btn:hover {
    background: rgba(108, 140, 213, 0.1);
}

/* 角色表情栏目样式 */
.character-emotions-section {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #eee;
}

.emotions-input-container {
    position: relative;
}

.emotions-textarea {
    width: 100%;
    min-height: 120px;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 13px;
    font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, sans-serif;
    line-height: 1.5;
    resize: vertical;
    transition: border-color 0.2s ease;
    background: #fafafa;
}

.emotions-textarea:focus {
    outline: none;
    border-color: #6C8CD5;
    box-shadow: 0 0 0 2px rgba(108, 140, 213, 0.1);
    background: white;
}

.emotions-actions {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    justify-content: flex-end;
}

.emotions-btn {
    padding: 6px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: white;
    color: #666;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.emotions-btn:hover {
    background: #f5f5f5;
    border-color: #6C8CD5;
    color: #6C8CD5;
}

/* 角色通话立绘栏目样式 */
.character-call-image-section {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #eee;
}

.call-image-description {
    margin-bottom: 12px;
}

.call-image-upload-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.call-image-preview {
    width: 100%;
    height: 200px;
    border: 2px dashed #ddd;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #fafafa;
    position: relative;
    overflow: hidden;
}

.call-image-preview img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 6px;
}

.call-image-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #999;
    font-size: 14px;
    gap: 8px;
}

.call-image-placeholder svg {
    width: 32px;
    height: 32px;
    opacity: 0.6;
}

.call-image-upload-btn, .call-image-clear-btn {
    padding: 8px 16px;
    border: 1px solid #6C8CD5;
    border-radius: 6px;
    background: white;
    color: #6C8CD5;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
}

.call-image-upload-btn:hover {
    background: #6C8CD5;
    color: white;
}

.call-image-clear-btn {
    background: #ff6b6b;
    color: white;
    border-color: #ff6b6b;
}

.call-image-clear-btn:hover {
    background: #ff5252;
    border-color: #ff5252;
}

.emotions-btn:active {
    transform: scale(0.98);
}

.contact-wallpaper-section {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #eee;
}

.contact-wallpaper-options {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}

.contact-wallpaper-option {
    aspect-ratio: 1;
    border-radius: 8px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s;
    background-size: cover;
    background-position: center;
    position: relative;
}

.contact-wallpaper-option:hover {
    transform: scale(1.05);
}

.contact-wallpaper-option.selected {
    border-color: #6C8CD5;
    box-shadow: 0 0 0 2px rgba(108, 140, 213, 0.2);
}

.contact-wallpaper-option::after {
    content: '✓';
    position: absolute;
    top: 4px;
    right: 4px;
    width: 20px;
    height: 20px;
    background: #6C8CD5;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    opacity: 0;
    transition: opacity 0.2s;
}

.contact-wallpaper-option.selected::after {
    opacity: 1;
}

/* 加好友头像上传样式 */
.avatar-upload-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
}

.avatar-upload-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 16px;
    border: 2px dashed #6C8CD5;
    border-radius: 12px;
    background: rgba(108, 140, 213, 0.05);
    cursor: pointer;
    transition: all 0.2s;
    min-width: 120px;
}

.avatar-upload-btn:hover {
    background: rgba(108, 140, 213, 0.1);
    border-color: #4A6FBF;
    transform: translateY(-2px);
}

.avatar-preview {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #ddd;
    transition: all 0.2s;
}

.avatar-upload-btn:hover .avatar-preview {
    border-color: #6C8CD5;
    transform: scale(1.05);
}

.avatar-upload-text {
    font-size: 12px;
    color: #6C8CD5;
    text-align: center;
    font-weight: 500;
}

/* 动态页面样式 */
.moment-app {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: linear-gradient(135deg, #fff5f7 0%, #fff 100%);
    z-index: 1000;
    display: none;
    flex-direction: column;
    overflow: hidden;
}

.moment-nav {
    width: 100%;
    height: 60px;
    background: rgba(255, 255, 255, 0.98);
    border-bottom: 1px solid #ffd1dc;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 20px;
    flex-shrink: 0;
    position: relative;
}

.moment-back-btn {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: #ff69b4;
    cursor: pointer;
    transition: transform 0.3s ease;
}

.moment-back-btn:hover {
    transform: scale(1.1);
}

.moment-title {
    font-size: 20px;
    font-weight: bold;
    color: #ff69b4;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
}

.moment-settings-btn {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: #ff69b4;
    cursor: pointer;
    transition: transform 0.3s ease;
}

.moment-settings-btn:hover {
    transform: rotate(90deg);
}

.moment-timeline {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    -ms-overflow-style: none;
    scrollbar-width: none;
}

.moment-timeline::-webkit-scrollbar {
    display: none;
}

.moment-post {
    background: #fff;
    border-radius: 15px;
    margin-bottom: 20px;
    padding: 20px;
    box-shadow: 0 2px 20px rgba(255, 182, 193, 0.15);
    border: 1px solid #ffe4e1;
    transition: transform 0.3s ease;
}

.moment-post:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 25px rgba(255, 182, 193, 0.25);
}

.moment-post-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 15px;
}

.moment-post-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-size: cover;
    border: 2px solid #ff9ebb;
    box-shadow: 0 0 10px rgba(255, 158, 187, 0.3);
}

.moment-post-info {
    flex: 1;
}

.moment-post-name {
    font-weight: bold;
    font-size: 16px;
    color: #333;
    margin-bottom: 2px;
}

.moment-post-time {
    font-size: 12px;
    color: #888;
}

.moment-post-content {
    font-size: 15px;
    line-height: 1.6;
    color: #333;
    margin-bottom: 15px;
}

.moment-post-image {
    width: 100%;
    height: 200px;
    border-radius: 12px;
    background-size: cover;
    background-position: center;
    margin-bottom: 15px;
    border: 1px solid #ffe4e1;
}

.moment-post-actions {
    display: flex;
    justify-content: space-around;
    font-size: 14px;
    color: #ff69b4;
    padding-top: 15px;
    border-top: 1px solid #ffe4e1;
}

.moment-post-action {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    transition: transform 0.2s ease;
    padding: 8px 12px;
    border-radius: 20px;
}

.moment-post-action:hover {
    transform: scale(1.1);
    background: rgba(255, 105, 180, 0.1);
}

/* 个人主页样式 */
.profile-app {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: linear-gradient(135deg, #fff5f7 0%, #fff 100%);
    z-index: 1000;
    display: none;
    flex-direction: column;
    overflow: hidden;
}

.profile-nav {
    width: 100%;
    height: 60px;
    background: rgba(255, 255, 255, 0.98);
    border-bottom: 1px solid #ffd1dc;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 20px;
    flex-shrink: 0;
    position: relative;
}

.profile-back-btn {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: #ff69b4;
    cursor: pointer;
    transition: transform 0.3s ease;
}

.profile-back-btn:hover {
    transform: scale(1.1);
}

.profile-title {
    font-size: 20px;
    font-weight: bold;
    color: #ff69b4;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
}

.profile-section {
    position: relative;
    width: 100%;
    min-height: 250px;
    background-image: url('https://files.catbox.moe/fym5yn.png');
    background-size: cover;
    background-position: center;
    flex-shrink: 0;
}

.profile-header-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 50%;
    background: linear-gradient(transparent, rgba(255, 255, 255, 0.95));
}

.profile-avatar {
    position: absolute;
    bottom: -40px;
    left: 30px;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 4px solid #fff;
    background-image: url('https://files.catbox.moe/6kfiza.jpg');
    background-size: cover;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    z-index: 2;
}

.profile-info {
    padding: 50px 30px 30px;
    background: #fff;
    position: relative;
    z-index: 1;
}

.profile-name {
    font-size: 24px;
    font-weight: bold;
    color: #333;
    margin-bottom: 5px;
}

.profile-username {
    font-size: 16px;
    color: #666;
    margin-bottom: 15px;
}


.profile-bio {
    font-size: 15px;
    color: #333;
    line-height: 1.5;
    margin-bottom: 20px;
}

.profile-stats {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}

.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    color: #666;
    font-size: 14px;
}

.stat-number {
    font-size: 18px;
    font-weight: bold;
    color: #ff69b4;
    margin-bottom: 2px;
}

/* 个人主页编辑功能样式 */
.stat-item {
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 8px;
    border-radius: 8px;
}

.stat-item:hover {
    background: rgba(255, 105, 180, 0.1);
    transform: scale(1.05);
}

.profile-name, .profile-username, .profile-bio {
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 4px;
    border-radius: 4px;
}

.profile-name:hover, .profile-username:hover, .profile-bio:hover {
    background: rgba(255, 105, 180, 0.1);
}

.profile-avatar {
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 5;
}

.profile-avatar:hover {
    transform: scale(1.1);
    box-shadow: 0 0 20px rgba(255, 105, 180, 0.5);
    z-index: 6;
}

.profile-section {
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 2;
}

.profile-section:hover {
    filter: brightness(1.1);
}

/* 个人主页右下角发动态按钮 */
.profile-fab-btn {
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 56px;
    height: 56px;
    background: #ff69b4;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(255, 105, 180, 0.4);
    transition: all 0.3s ease;
    z-index: 1000;
}

.profile-fab-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(255, 105, 180, 0.6);
}

/* 编辑模态框样式 */
.edit-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.edit-modal-content {
    background: white;
    padding: 20px;
    border-radius: 15px;
    width: 80%;
    max-width: 400px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.edit-modal-title {
    font-size: 18px;
    font-weight: bold;
    color: #333;
    margin-bottom: 15px;
    text-align: center;
}

.edit-modal-input {
    width: 100%;
    padding: 12px;
    border: 2px solid #ff69b4;
    border-radius: 8px;
    font-size: 16px;
    margin-bottom: 15px;
    outline: none;
}

.edit-modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
}

.edit-modal-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.edit-modal-btn.cancel {
    background: #f0f0f0;
    color: #666;
}

.edit-modal-btn.save {
    background: #ff69b4;
    color: white;
}

.edit-modal-btn:hover {
    transform: scale(1.05);
}

/* 评论样式 - 简洁清爽版 */
.comments-section {
    padding: 15px 20px 10px;
    background: transparent;
    margin-top: 0;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.comment-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    margin-bottom: 15px;
    width: 100%;
}

/* 已删除评论回复输入框样式，现在使用现有的评论输入框 */

.comment-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    flex-shrink: 0;
    border: 1px solid #ffb6c1;
    background-color: #f8f9fa;
    background-image: url('https://files.catbox.moe/r5s188.jpg');
}

.comment-bubble {
    background: #fff5f7;
    border-radius: 10px;
    padding: 8px;
    max-width: calc(100% - 50px);
    position: relative;
    border: none;
    flex: 1;
    min-height: 32px;
    display: flex;
    align-items: center;
}

.comment-author {
    font-weight: 600;
    font-size: 13px;
    color: #d63384;
    line-height: 1.4;
    display: inline;
}

.comment-text {
    font-size: 13px;
    color: #8b1538;
    line-height: 1.4;
    word-wrap: break-word;
    display: inline;
}

/* 评论输入框样式 - 简洁版 */
.comment-input-section {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 5px;
    padding: 0 20px 15px;
}

/* 删除确认弹窗样式 */
.delete-confirm-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
}

.delete-confirm-modal {
    background: white;
    border-radius: 15px;
    padding: 25px;
    max-width: 300px;
    width: 90%;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.delete-confirm-title {
    font-size: 18px;
    font-weight: bold;
    color: #333;
    margin-bottom: 10px;
}

.delete-confirm-message {
    font-size: 14px;
    color: #666;
    margin-bottom: 20px;
    line-height: 1.5;
}

.delete-confirm-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
}

.delete-confirm-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.delete-confirm-btn.cancel {
    background: #f0f0f0;
    color: #333;
}

.delete-confirm-btn.cancel:hover {
    background: #e0e0e0;
}

.delete-confirm-btn.delete {
    background: #ff4757;
    color: white;
}

.delete-confirm-btn.delete:hover {
    background: #ff3742;
}

.comment-input-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    flex-shrink: 0;
    border: 1px solid #ffb6c1;
    background-color: #f8f9fa;
    background-image: url('https://files.catbox.moe/r5s188.jpg');
}

.comment-input-bubble {
    flex: 1;
    background: #fff5f7;
    border: 1px solid #ffb6c1;
    border-radius: 10px;
    padding: 8px;
    position: relative;
    min-height: 32px;
    display: flex;
    align-items: center;
}

.comment-input {
    width: 100%;
    border: none;
    background: transparent;
    font-size: 13px;
    color: #333;
    outline: none;
    resize: none;
    min-height: 16px;
    max-height: 60px;
    line-height: 1.4;
}

.comment-input::placeholder {
    color: #999;
    font-size: 13px;
}

.comment-send-btn {
    width: 36px;
    height: 36px;
    background: #ff69b4;
    border: none;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.comment-send-btn:hover {
    transform: scale(1.05);
    background: #ff1493;
}

.comment-send-btn svg {
    width: 18px;
    height: 18px;
    fill: white;
}

/* 点赞状态样式 */
.like-action.liked {
    color: #ff69b4;
}

.like-action.liked span:first-child {
    color: #ff69b4;
}

/* 发布动态弹窗样式 */
.post-moment-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 3000;
}

.post-moment-container {
    width: 90%;
    max-width: 380px;
    background: white;
    border-radius: 24px;
    box-shadow: 0 6px 20px rgba(255, 182, 193, 0.25);
    overflow: hidden;
    position: relative;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
}

.post-moment-header {
    background: linear-gradient(135deg, #fff0f5, #ffe4ec);
    padding: 12px 16px;
    text-align: center;
    color: #ff6b95;
    position: relative;
    border-bottom: 1px solid #ffecef;
}

.post-moment-header h2 {
    font-size: 16px;
    font-weight: 600;
    margin: 0;
}

.post-moment-close-btn {
    position: absolute;
    right: 16px;
    top: 12px;
    font-size: 18px;
    color: #ff85a2;
    cursor: pointer;
    transition: transform 0.3s;
}

.post-moment-close-btn:hover {
    transform: scale(1.2);
    color: #ff4d7c;
}

.post-moment-content {
    padding: 16px;
    flex: 1;
    overflow-y: auto;
}

.post-moment-textarea {
    width: 100%;
    min-height: 100px;
    border: 2px dashed #ffe4ec;
    resize: none;
    padding: 12px;
    font-size: 14px;
    background-color: rgba(255, 250, 250, 0.7);
    border-radius: 16px;
    margin-bottom: 12px;
    outline: none;
    color: #555;
    font-family: inherit;
}

.post-moment-textarea::placeholder {
    color: #ffc2d4;
}

.post-moment-actions {
    display: flex;
    justify-content: space-around;
    margin-bottom: 16px;
    flex-wrap: wrap;
}

.post-moment-action-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: none;
    border: none;
    color: #ff85a2;
    font-size: 12px;
    cursor: pointer;
    transition: transform 0.3s;
    width: 70px;
    margin-bottom: 8px;
}

.post-moment-action-btn i {
    font-size: 18px;
    margin-bottom: 4px;
    background-color: rgba(255, 222, 229, 0.8);
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s;
}

.post-moment-action-btn:hover i {
    background-color: rgba(255, 182, 193, 0.8);
    transform: scale(1.1);
}

.post-moment-action-btn:hover {
    color: #ff4d7c;
}

.post-moment-image-preview {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-bottom: 16px;
}

.post-moment-preview-item {
    position: relative;
    aspect-ratio: 1/1;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08);
    transition: transform 0.3s;
}

.post-moment-preview-item:hover {
    transform: scale(1.05);
}

.post-moment-preview-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.post-moment-remove-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    background: rgba(255, 255, 255, 0.9);
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #ff6b95;
    font-size: 10px;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.3s;
}

.post-moment-remove-btn:hover {
    transform: scale(1.2);
    background: #ff6b95;
    color: white;
}

.post-moment-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 16px;
    background-color: #fffafa;
    border-top: 1px solid #ffecf0;
}

.post-moment-visibility {
    display: flex;
    align-items: center;
    color: #ff85a2;
    font-size: 13px;
    cursor: pointer;
    padding: 6px 12px;
    border-radius: 16px;
    background: rgba(255, 222, 229, 0.5);
    transition: all 0.3s;
}

.post-moment-visibility:hover {
    background: rgba(255, 222, 229, 0.8);
}

.post-moment-visibility i {
    margin-right: 4px;
    font-size: 13px;
}

.post-moment-btn {
    background: linear-gradient(135deg, #ffb6c1, #ff9db8);
    color: white;
    border: none;
    padding: 8px 18px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: transform 0.3s, box-shadow 0.3s;
    box-shadow: 0 3px 8px rgba(255, 157, 184, 0.4);
}

.post-moment-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 12px rgba(255, 157, 184, 0.5);
    background: linear-gradient(135deg, #ff9db8, #ff85a7);
}

.post-moment-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* 提到谁和谁可以看弹窗样式 */
.mention-modal,
.visibility-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10001;
}

.mention-modal-content,
.visibility-modal-content {
    background: white;
    border-radius: 20px;
    width: 90%;
    max-width: 400px;
    max-height: 70vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
}

.mention-modal-header,
.visibility-modal-header {
    padding: 20px;
    border-bottom: 1px solid #ffe4ec;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.mention-modal-header h3,
.visibility-modal-header h3 {
    margin: 0;
    color: #ff85a2;
    font-size: 18px;
    font-weight: 600;
}

.mention-modal-close,
.visibility-modal-close {
    background: none;
    border: none;
    font-size: 28px;
    color: #ff85a2;
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s;
}

.mention-modal-close:hover,
.visibility-modal-close:hover {
    background: rgba(255, 182, 193, 0.3);
    transform: scale(1.1);
}

.mention-modal-body,
.visibility-modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 10px 20px;
}

.mention-friends-list,
.visibility-friends-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.mention-friend-item,
.visibility-friend-item {
    display: flex;
    align-items: center;
    padding: 12px;
    border-radius: 12px;
    background: rgba(255, 222, 229, 0.3);
    cursor: pointer;
    transition: all 0.3s;
}

.mention-friend-item:hover,
.visibility-friend-item:hover {
    background: rgba(255, 182, 193, 0.5);
    transform: translateX(5px);
}

.visibility-friend-item {
    justify-content: space-between;
}

.mention-friend-avatar,
.visibility-friend-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 12px;
    object-fit: cover;
    border: 2px solid #ffb6c1;
}

.mention-friend-name,
.visibility-friend-name {
    flex: 1;
    font-size: 14px;
    color: #333;
    font-weight: 500;
}

.visibility-friend-checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid #ff85a2;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    transition: all 0.3s;
}

.visibility-friend-item.selected .visibility-friend-checkbox {
    background: #ff85a2;
}

.visibility-friend-checkbox::after {
    content: '✓';
    color: white;
    font-size: 14px;
    font-weight: bold;
    display: none;
}

.visibility-friend-item.selected .visibility-friend-checkbox::after {
    display: block;
}

.visibility-modal-footer {
    padding: 15px 20px;
    border-top: 1px solid #ffe4ec;
}

.visibility-modal-btn {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, #ffb6c1, #ff9db8);
    color: white;
    border: none;
    border-radius: 20px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 3px 8px rgba(255, 157, 184, 0.4);
}

.visibility-modal-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 12px rgba(255, 157, 184, 0.5);
}

.profile-timeline {
    flex: 1;
    padding: 0 30px 30px;
    background: #fff;
    overflow-y: auto;
    -ms-overflow-style: none;
    scrollbar-width: none;
}

.profile-timeline::-webkit-scrollbar {
    display: none;
}

.profile-tweet {
    padding: 20px;
    border-bottom: 1px solid rgba(255, 105, 180, 0.1);
    background: #fff;
    transition: all 0.3s ease;
}

.profile-tweet:hover {
    background: rgba(255, 105, 180, 0.05);
}

.profile-tweet-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 10px;
}

.profile-tweet-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-image: url('https://files.catbox.moe/6kfiza.jpg');
    background-size: cover;
}

.profile-tweet-info {
    flex: 1;
}

.profile-tweet-name {
    font-weight: bold;
    color: #333;
    font-size: 15px;
}

.profile-tweet-username {
    color: #666;
    font-size: 13px;
}

.profile-tweet-content {
    font-size: 15px;
    color: #333;
    line-height: 1.6;
    margin-bottom: 15px;
}

.profile-tweet-image {
    width: 100%;
    height: 180px;
    border-radius: 12px;
    background-image: url('https://files.catbox.moe/8mjvdg.jpg');
    background-size: cover;
    background-position: center;
    margin-bottom: 15px;
}

.profile-tweet-actions {
    display: flex;
    justify-content: space-around;
    color: #666;
    font-size: 14px;
}

.profile-tweet-action {
    display: flex;
    align-items: center;
    gap: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 8px 12px;
    border-radius: 15px;
}

.profile-tweet-action:hover {
    color: #ff69b4;
    background: rgba(255, 105, 180, 0.1);
}

/* 动态设置样式 */
.setting-item {
    display: flex;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.setting-item:hover {
    background-color: #f8f8f8;
}

.setting-item:last-child {
    border-bottom: none;
}

.setting-icon {
    font-size: 20px;
    margin-right: 15px;
    width: 30px;
    text-align: center;
}

.setting-text {
    flex: 1;
}

.setting-title {
    font-size: 16px;
    font-weight: 500;
    color: #333;
    margin-bottom: 4px;
}

.setting-desc {
    font-size: 14px;
    color: #666;
}

/* 关闭按钮样式 */
.close-btn {
    background: none;
    border: none;
    font-size: 24px;
    color: #999;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s ease;
}

.close-btn:hover {
    background: #f0f0f0;
    color: #333;
}

/* 多选工具栏样式 */
.multi-select-toolbar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-top: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 12px 20px;
    z-index: 1000;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
}

.multiselect-action {
    flex: 1;
    text-align: center;
    padding: 12px 8px;
    margin: 0 4px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    color: #333;
    background: transparent;
}

.multiselect-action:hover {
    background: rgba(108, 140, 213, 0.1);
    color: #6C8CD5;
}

.multiselect-action:active {
    transform: scale(0.95);
}

/* 多选模式下的消息样式 */
.multi-select-mode .message {
    position: relative;
    cursor: pointer;
    transition: all 0.2s ease;
}

.multi-select-mode .message:hover {
    background: rgba(108, 140, 213, 0.05);
}

.multi-select-mode .message.selected {
    background: rgba(108, 140, 213, 0.1);
    border: 2px solid #6C8CD5;
}

.multi-select-mode .message.selected::before {
    content: '✓';
    position: absolute;
    top: 8px;
    left: 8px;
    width: 20px;
    height: 20px;
    background: #6C8CD5;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    z-index: 10;
}

/* 🚀 移动端性能优化样式 */
@media (max-width: 768px) {
    /* 减少动画和过渡效果 */
    .message {
        transition: none !important;
        animation: none !important;
    }
    
    /* 优化滚动性能 */
    .chat-messages {
        -webkit-overflow-scrolling: touch;
        overflow-scrolling: touch;
        will-change: scroll-position;
    }
    
    /* 减少重绘 */
    .message-content {
        contain: layout style paint;
    }
    
    /* 优化输入框性能 */
    #chatInputField {
        -webkit-appearance: none;
        -webkit-tap-highlight-color: transparent;
        transform: translateZ(0);
    }
    
    /* 减少阴影和模糊效果 */
    .multi-select-toolbar {
        backdrop-filter: none;
        background: rgba(255, 255, 255, 0.98);
    }
    
    /* 优化按钮性能 */
    .multiselect-action {
        transform: translateZ(0);
        -webkit-tap-highlight-color: transparent;
    }
}

/* 加载更多按钮样式 */
.load-more-btn {
    margin: 20px;
    padding: 12px 20px;
    background: #fff5f7;
    border: 1px solid #ffb6c1;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
}

.load-more-btn:hover {
    background: #ff69b4;
    border-color: #ff69b4;
    transform: scale(1.02);
}

.load-more-content {
    display: flex;
    align-items: center;
    justify-content: center;
}

.load-more-text {
    font-size: 14px;
    font-weight: 500;
    color: #333;
    transition: color 0.2s ease;
}

.load-more-btn:hover .load-more-text {
    color: #fff;
}

/* 动态页面底部导航栏样式 */
.moment-bottom-nav {
    width: 100%;
    height: 60px;
    background: rgba(255, 255, 255, 0.98);
    border-top: 1px solid #ffd1dc;
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 0 20px;
    flex-shrink: 0;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 10;
    /* 适配手机浏览器安全区域 - 为旧浏览器提供回退 */
    padding-bottom: 0;
    height: 60px;
    /* 现代浏览器安全区域适配 */
    padding-bottom: env(safe-area-inset-bottom, 0);
    height: calc(60px + env(safe-area-inset-bottom, 0));
}

.moment-bottom-nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    color: #666;
    font-size: 12px;
    padding: 8px 16px;
    border-radius: 20px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.moment-bottom-nav-item.active {
    color: #ff69b4;
    background: #fff5f7;
    box-shadow: 0 2px 10px rgba(255, 105, 180, 0.2);
}

.moment-bottom-nav-icon {
    width: 24px;
    height: 24px;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    margin-bottom: 4px;
}

.moment-nav-home-icon {
    background-image: url('https://files.catbox.moe/zilfqn.png');
}

.moment-nav-profile-icon {
    background-image: url('https://files.catbox.moe/zilfqn.png');
    border-radius: 50%;
}

.moment-bottom-nav-text {
    font-size: 10px;
}

/* 动态页面内容样式 */
.moment-page-content {
    flex: 1;
    overflow-y: auto;
    padding-bottom: 60px; /* 为底部导航栏留出空间 - 旧浏览器回退 */
    padding-bottom: calc(60px + env(safe-area-inset-bottom, 0)); /* 为底部导航栏留出空间，适配安全区域 */
    -ms-overflow-style: none;
    scrollbar-width: none;
}

.moment-page-content::-webkit-scrollbar {
    display: none;
}

/* 聊天功能菜单样式 */
.chat-plus-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #6C8CD5;
    color: white;
    border: none;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 8px;
    box-shadow: 0 2px 8px rgba(108, 140, 213, 0.3);
    flex-shrink: 0;
    z-index: 10;
    position: relative;
}

.chat-plus-btn:hover {
    background: #4A6FBF;
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(108, 140, 213, 0.4);
}

.chat-plus-btn:active {
    transform: scale(0.95);
}

.chat-toolbar {
    display: none;
    position: absolute;
    bottom: 60px;
    left: 0;
    right: 0;
    height: 80px;
    background: rgba(255, 255, 255, 0.98);
    border-top: 1px solid rgba(0, 0, 0, 0.05);
    backdrop-filter: blur(10px);
    z-index: 10;
    animation: chatToolbarSlideUp 0.3s ease;
}

@keyframes chatToolbarSlideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.chat-toolbar-content {
    display: flex;
    align-items: center;
    height: 100%;
    padding: 0 16px;
    overflow-x: auto;
    gap: 16px;
    -ms-overflow-style: none;
    scrollbar-width: none;
    scroll-behavior: smooth;
}

.chat-toolbar-content::-webkit-scrollbar {
    display: none;
}

.chat-toolbar-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    padding: 8px 12px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(108, 140, 213, 0.05);
    border: 2px solid transparent;
    min-width: 60px;
    flex-shrink: 0;
}

.chat-toolbar-item:hover {
    background: rgba(108, 140, 213, 0.1);
    border-color: #6C8CD5;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(108, 140, 213, 0.2);
}

.chat-toolbar-item:active {
    transform: translateY(0) scale(0.95);
}

.chat-toolbar-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    color: #6C8CD5;
    margin-bottom: 2px;
}

.chat-toolbar-icon svg {
    width: 20px;
    height: 20px;
}

.chat-toolbar-text {
    font-size: 10px;
    color: #333;
    font-weight: 500;
    text-align: center;
    white-space: nowrap;
}


/* 屏幕共享弹窗样式 */
.screen-share-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 5000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.screen-share-modal.show {
    opacity: 1;
    visibility: visible;
}

.screen-share-content {
    background: white;
    border-radius: 16px;
    padding: 24px;
    max-width: 400px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    transform: scale(0.9);
    transition: transform 0.3s ease;
}

.screen-share-modal.show .screen-share-content {
    transform: scale(1);
}

.screen-share-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid #eee;
}

.screen-share-title {
    font-size: 20px;
    font-weight: 600;
    color: #333;
}

.screen-share-controls {
    display: flex;
    gap: 12px;
}

.screen-share-regenerate {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #f5f5f5;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    color: #666;
}

.screen-share-regenerate:hover {
    background: #e0e0e0;
    color: #333;
    transform: scale(1.1);
}

.screen-share-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 24px;
}

.screen-share-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px 12px;
    border-radius: 16px;
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid transparent;
}

.screen-share-item:hover {
    background: #e3f2fd;
    border-color: #6C8CD5;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(108, 140, 213, 0.2);
}

.screen-share-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: #6C8CD5;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 8px;
    color: white;
}

.screen-share-label {
    font-size: 12px;
    color: #333;
    font-weight: 500;
    text-align: center;
}

.screen-share-footer {
    display: flex;
    justify-content: center;
    padding-top: 16px;
    border-top: 1px solid #eee;
}

.screen-share-close {
    background: #6C8CD5;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.screen-share-close:hover {
    background: #4A6FBF;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(108, 140, 213, 0.3);
}

/* 弹窗通用样式 */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.5);
    z-index: 3000;
    justify-content: center;
    align-items: center;
}

.modal-overlay.show {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 20px;
    width: 90%;
    max-width: 400px;
    max-height: 80vh;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    overflow: hidden;
    animation: modalAppear 0.3s ease;
}

@keyframes modalAppear {
    from {
        opacity: 0;
        transform: translateY(-15px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal-header {
    background: linear-gradient(135deg, #6C8CD5, #4A6FBF);
    padding: 15px 20px;
    color: white;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 16px;
}

.modal-close {
    font-size: 20px;
    cursor: pointer;
    transition: all 0.3s;
}

.modal-close:hover {
    transform: scale(1.2);
}

.modal-body {
    padding: 20px;
}

/* 图片上传样式 */
.image-upload-area {
    border: 2px dashed #6C8CD5;
    border-radius: 12px;
    padding: 40px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(108, 140, 213, 0.05);
}

.image-upload-area:hover {
    background: rgba(108, 140, 213, 0.1);
    border-color: #4A6FBF;
}

.image-upload-icon {
    font-size: 32px;
    margin-bottom: 12px;
}

.image-upload-text {
    font-size: 16px;
    color: #6C8CD5;
    font-weight: 500;
    margin-bottom: 8px;
}

.image-upload-hint {
    font-size: 12px;
    color: #999;
}

.image-preview {
    text-align: center;
}

.image-preview img {
    max-width: 100%;
    max-height: 200px;
    border-radius: 8px;
    margin-bottom: 15px;
}

.image-preview-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
}

/* 一起听音乐样式 */
.music-together-container {
    display: flex;
    gap: 20px;
    height: 400px;
}

.music-player {
    flex: 1;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    padding: 24px;
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.music-cover {
    text-align: center;
    margin-bottom: 20px;
}

.music-cover-image {
    width: 120px;
    height: 120px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 48px;
    margin: 0 auto;
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.music-info {
    text-align: center;
    margin-bottom: 24px;
}

.music-title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 8px;
}

.music-artist {
    font-size: 14px;
    opacity: 0.8;
}

.music-controls {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-bottom: 20px;
}

.music-btn {
    width: 48px;
    height: 48px;
    border: none;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.music-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.play-btn {
    width: 64px;
    height: 64px;
    font-size: 24px;
    background: rgba(255, 255, 255, 0.3);
}

.music-progress {
    margin-top: 16px;
}

.progress-bar {
    width: 100%;
    height: 4px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 2px;
    margin-bottom: 8px;
    cursor: pointer;
}

.progress-fill {
    height: 100%;
    background: white;
    border-radius: 2px;
    width: 0%;
    transition: width 0.1s ease;
}

.time-display {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    opacity: 0.8;
}

.music-playlist {
    flex: 1;
    background: #f8f9fa;
    border-radius: 16px;
    padding: 20px;
    overflow-y: auto;
}

.playlist-header {
    font-size: 18px;
    font-weight: 600;
    color: #333;
    margin-bottom: 16px;
    text-align: center;
}

.playlist-item {
    display: flex;
    align-items: center;
    padding: 12px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 8px;
}

.playlist-item:hover {
    background: #e9ecef;
    transform: translateX(4px);
}

.playlist-cover {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    margin-right: 12px;
}

.playlist-info {
    flex: 1;
}

.playlist-title {
    font-size: 14px;
    font-weight: 500;
    color: #333;
    margin-bottom: 4px;
}

.playlist-artist {
    font-size: 12px;
    color: #666;
}

/* 转账样式 */
.transfer-amount-section,
.transfer-note-section {
    margin-bottom: 20px;
}

.transfer-amount-section label,
.transfer-note-section label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #333;
}

.transfer-amount-input {
    display: flex;
    align-items: center;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 0 12px;
    background: white;
}

.currency-symbol {
    font-size: 18px;
    color: #6C8CD5;
    font-weight: bold;
    margin-right: 8px;
}

.transfer-amount-input input {
    flex: 1;
    border: none;
    outline: none;
    padding: 12px 0;
    font-size: 16px;
}

.transfer-note-section textarea {
    width: 100%;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 12px;
    font-size: 14px;
    resize: vertical;
    outline: none;
}

.transfer-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

/* 定位样式 */
.location-address-section,
.location-image-section {
    margin-bottom: 20px;
}

/* 删除位置名称输入框后的样式清理：无内容 */

.location-address-section label,
.location-image-section label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #333;
}

.location-address-section input {
    width: 100%;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 12px;
    font-size: 14px;
    outline: none;
}

.location-image-upload {
    border: 2px dashed #6C8CD5;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(108, 140, 213, 0.05);
}

.location-image-upload:hover {
    background: rgba(108, 140, 213, 0.1);
}

.location-image-icon {
    font-size: 24px;
    margin-bottom: 8px;
}

.location-image-text {
    font-size: 14px;
    color: #6C8CD5;
}

.location-image-preview {
    position: relative;
    margin-top: 10px;
}

.location-image-preview img {
    width: 100%;
    max-height: 150px;
    object-fit: cover;
    border-radius: 8px;
}

.btn-remove {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.6);
    color: white;
    border: none;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.location-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

/* 点外卖样式 */
.food-order-section,
.food-order-amount-section,
.food-order-note-section {
    margin-bottom: 20px;
}

.food-order-section label,
.food-order-amount-section label,
.food-order-note-section label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #333;
}

.food-order-section input,
.food-order-note-section textarea {
    width: 100%;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 12px;
    font-size: 14px;
    outline: none;
}

.food-order-amount-input {
    display: flex;
    align-items: center;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 0 12px;
    background: white;
}

.food-order-amount-input input {
    flex: 1;
    border: none;
    outline: none;
    padding: 12px 0;
    font-size: 16px;
}

.food-order-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

/* 按钮样式 */
.btn-primary,
.btn-secondary {
    padding: 10px 20px;
    border-radius: 8px;
    border: none;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-primary {
    background: #6C8CD5;
    color: white;
}

.btn-primary:hover {
    background: #4A6FBF;
    transform: translateY(-1px);
}

.btn-secondary {
    background: #f5f5f5;
    color: #666;
    border: 1px solid #ddd;
}

.btn-secondary:hover {
    background: #e9e9e9;
}

/* 转发功能样式 */
.forward-modal .modal-body {
    max-height: 400px;
    overflow-y: auto;
}

.forward-friends-list {
    margin-bottom: 20px;
}

.forward-friend-item {
    display: flex;
    align-items: center;
    padding: 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-bottom: 8px;
    border: 1px solid #eee;
}

.forward-friend-item:hover {
    background: rgba(108, 140, 213, 0.1);
    border-color: #6C8CD5;
}

.forward-friend-item.selected {
    background: rgba(108, 140, 213, 0.2);
    border-color: #6C8CD5;
}

.forward-friend-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    margin-right: 12px;
    object-fit: cover;
    border: 2px solid #fff;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.forward-friend-info {
    flex: 1;
}

.forward-friend-name {
    font-size: 16px;
    font-weight: 500;
    color: #333;
    margin-bottom: 4px;
}

.forward-friend-status {
    font-size: 12px;
    color: #999;
}

.forward-friend-checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid #ccc;
    border-radius: 50%;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.forward-friend-item.selected .forward-friend-checkbox {
    background: #6C8CD5;
    border-color: #6C8CD5;
}

.forward-friend-item.selected .forward-friend-checkbox::after {
    content: '✓';
    color: white;
    font-size: 14px;
    font-weight: bold;
}

.forward-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    padding-top: 10px;
    border-top: 1px solid #eee;
}

/* 收藏功能样式 */
.favorite-modal .modal-body {
    max-height: 500px;
    overflow-y: auto;
}

.favorite-form {
    margin-bottom: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
    font-size: 14px;
}

.form-group input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s ease;
}

.form-group input:focus {
    outline: none;
    border-color: #6C8CD5;
    box-shadow: 0 0 0 2px rgba(108, 140, 213, 0.1);
}

.selected-messages-preview {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #eee;
    border-radius: 8px;
    padding: 12px;
    background: #f9f9f9;
}

.message-preview-item {
    display: flex;
    align-items: center;
    padding: 8px;
    margin-bottom: 8px;
    background: white;
    border-radius: 6px;
    border: 1px solid #eee;
}

.message-preview-item:last-child {
    margin-bottom: 0;
}

.message-preview-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    margin-right: 8px;
    object-fit: cover;
}

.message-preview-content {
    flex: 1;
    font-size: 12px;
    color: #666;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.favorite-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 20px;
}

/* 收藏列表样式 */
.favorites-modal .modal-body {
    max-height: 600px;
    overflow-y: auto;
}

.favorites-list {
    margin-bottom: 20px;
}

.favorite-item {
    display: flex;
    align-items: flex-start;
    padding: 16px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-bottom: 12px;
    border: 1px solid #eee;
    background: white;
    gap: 12px;
}

.favorite-item:hover {
    background: rgba(108, 140, 213, 0.05);
    border-color: #6C8CD5;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.favorite-item-header {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.favorite-item-title {
    font-weight: 600;
    color: #333;
    font-size: 16px;
    margin-right: 8px;
}

.favorite-item-time {
    font-size: 12px;
    color: #999;
}

.favorite-item-messages {
    display: flex;
    flex-direction: column;
    gap: 4px;
    max-height: 120px; /* 减少高度，为删除按钮留出空间 */
    overflow-y: auto;
}

.favorite-item-messages.expanded {
    max-height: 400px;
}

.favorite-expand-btn {
    background: #f0f0f0;
    border: none;
    border-radius: 20px;
    padding: 8px 16px;
    font-size: 11px;
    color: #666;
    cursor: pointer;
    margin: 8px auto 0 auto;
    display: block;
    transition: all 0.2s ease;
    width: fit-content;
}

.favorite-expand-btn:hover {
    background: #e0e0e0;
    color: #333;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.favorite-message-preview {
    display: flex;
    align-items: center;
    font-size: 13px;
    color: #666;
    padding: 4px 0;
}

.favorite-message-avatar {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    margin-right: 6px;
    object-fit: cover;
}

.favorite-message-content {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.favorite-item-actions {
    display: flex;
    gap: 8px;
    flex-shrink: 0; /* 防止按钮被压缩 */
    align-items: flex-start;
}

.favorite-action-btn {
    padding: 6px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: white;
    color: #666;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.favorite-action-btn:hover {
    background: #f5f5f5;
    border-color: #ccc;
}

.favorite-action-btn.delete {
    color: #ff4757;
    border-color: #ff4757;
}

.favorite-action-btn.delete:hover {
    background: #ff4757;
    color: white;
}

.favorite-item-content {
    flex: 1;
    min-width: 0; /* 防止内容溢出 */
}

/* 收藏详情消息容器样式 */
.favorite-detail-messages {
    overflow-y: auto;
    max-height: 400px;
    padding: 8px;
    background: #f9f9f9;
    border-radius: 8px;
}

.favorite-detail-messages::-webkit-scrollbar {
    width: 6px;
}

.favorite-detail-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.favorite-detail-messages::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.favorite-detail-messages::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* 特殊消息类型样式 */
.message-image {
    margin-bottom: 8px;
}

/* 表情包消息样式 */
.message-emotion {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0;
    margin: 4px 0;
}

.emotion-image-container {
    margin: 0;
}

.emotion-image {
    max-width: 120px;
    max-height: 120px;
    border-radius: 8px;
    object-fit: contain;
    transition: transform 0.2s ease;
}

.emotion-image:hover {
    transform: scale(1.05);
}

.message-image-content {
    max-width: 200px;
    max-height: 200px;
    border-radius: 8px;
    object-fit: cover;
    cursor: pointer;
    transition: all 0.3s ease;
}

.message-image-content:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.message-text {
    font-size: 14px;
    line-height: 1.4;
    color: #333;
    margin-top: 8px;
}

.message-transfer {
    background: linear-gradient(135deg, #6C8CD5, #4A6FBF);
    color: white;
    border-radius: 12px;
    padding: 14px 16px;
    max-width: 340px;
    box-shadow: 0 4px 12px rgba(108, 140, 213, 0.3);
}

.transfer-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
}

.transfer-icon {
    width: 24px;
    height: 24px;
    background: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    color: #2196F3;
}

.transfer-amount {
    font-size: 24px;
    font-weight: bold;
    line-height: 1;
}

.transfer-status {
    font-size: 14px;
    opacity: 0.9;
}

.transfer-note {
    font-size: 12px;
    opacity: 0.8;
    margin-top: 4px;
    padding-top: 4px;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
}

/* 新定位卡片样式（仿微信卡片） */
.message-location {
    background: transparent;
    padding: 0;
    border-radius: 12px;
    max-width: 170px;
    width: min(460px, 68vw);
    box-shadow: none;
    overflow: hidden;
}

.location-card {
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 6px 22px rgba(0, 0, 0, 0.08);
    background: transparent;
    width: 100%;
}

.location-card-header {
    background: #6C8CD5;
    color: #fff;
    padding: 10px 12px;
}

.location-card-title {
    font-size: 14px;
    font-weight: 700;
    line-height: 1.2;
}

.location-card-subtitle {
    margin-top: 4px;
    font-size: 12px;
    opacity: 0.95;
}

.location-card-body {
    background: rgba(108, 140, 213, 0.18);
    padding: 6px;
}

.location-card-image {
    width: 100%;
    max-height: 56px;
    object-fit: cover;
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.4);
}

.location-card-placeholder {
    width: 100%;
    height: 56px;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    color: #6C8CD5;
    font-size: 20px;
    font-weight: 800;
}

.location-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
}

.location-icon {
    width: 24px;
    height: 24px;
    background: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    color: #2196F3;
}

.location-address {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 8px;
}

.location-status {
    font-size: 14px;
    opacity: 0.9;
    margin-bottom: 12px;
}

.location-image {
    margin-top: 8px;
}

.location-image-content {
    width: 100%;
    max-height: 120px;
    border-radius: 8px;
    object-fit: cover;
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.message-food-order {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 16px;
    max-width: 340px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.food-order-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}

.food-order-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #ffa726, #ffb74d);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: white;
}

.food-order-info {
    flex: 1;
}

.food-order-name {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin-bottom: 4px;
}

.food-order-price {
    font-size: 20px;
    font-weight: bold;
    color: #ff9800;
}

.food-order-status {
    font-size: 14px;
    color: #666;
    margin-top: 8px;
}

.food-order-image {
    margin-top: 12px;
}

.food-order-image-content {
    width: 100%;
    max-height: 120px;
    border-radius: 8px;
    object-fit: cover;
    border: 1px solid #f0f0f0;
}

.message-voice {
    background: linear-gradient(135deg, #6C8CD5, #4A6FBF);
    color: #fff;
    border-radius: 12px;
    padding: 12px 16px;
    max-width: 200px;
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
    display: flex;
    align-items: center;
    gap: 12px;
}

.voice-play-btn {
    width: 32px;
    height: 32px;
    background: #ffffff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.voice-play-btn:hover {
    background: #f2f5ff;
    transform: scale(1.05);
}

.voice-play-icon {
    width: 0;
    height: 0;
    border-left: 8px solid #6C8CD5;
    border-top: 6px solid transparent;
    border-bottom: 6px solid transparent;
    margin-left: 2px;
}

.voice-waveform {
    display: flex;
    align-items: center;
    gap: 2px;
    flex: 1;
}

.voice-bar {
    width: 3px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 2px;
}

.voice-bar:nth-child(1) { height: 8px; }
.voice-bar:nth-child(2) { height: 16px; }
.voice-bar:nth-child(3) { height: 12px; }
.voice-bar:nth-child(4) { height: 20px; }
.voice-bar:nth-child(5) { height: 10px; }
.voice-bar:nth-child(6) { height: 14px; }
.voice-bar:nth-child(7) { height: 18px; }

.voice-duration {
    font-size: 12px;
    opacity: 0.95;
    font-family: monospace;
}

/* 语音文字样式 */
.voice-text-section {
    margin-bottom: 20px;
}

.voice-text-section label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #333;
}

.voice-text-section textarea {
    width: 100%;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 12px;
    font-size: 14px;
    resize: vertical;
    outline: none;
    font-family: inherit;
}

.voice-text-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

/* 视频通话样式 */
.video-call-info {
    text-align: center;
    padding: 40px 20px;
    background: linear-gradient(135deg, #6C8CD5, #4A6FBF);
    border-radius: 12px;
    color: white;
    margin-bottom: 20px;
}

.video-call-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    margin: 0 auto 16px;
    overflow: hidden;
    border: 3px solid rgba(255, 255, 255, 0.3);
}

.video-call-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.video-call-name {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 8px;
}

.video-call-status {
    font-size: 14px;
    opacity: 0.9;
}

.video-call-actions {
    display: flex;
    justify-content: center;
}

.btn-call-end {
    background: #ff6b6b;
    color: white;
    border: none;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-call-end:hover {
    background: #ff5252;
    transform: scale(1.05);
}

.contact-wallpaper-option.custom-wallpaper {
    position: relative;
}

.contact-wallpaper-option .delete-wallpaper-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 24px;
    height: 24px;
    background: #ff4757;
    color: white;
    border: 2px solid white;
    border-radius: 50%;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 1;
    transition: all 0.2s;
    z-index: 10;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.contact-wallpaper-option.custom-wallpaper:hover .delete-wallpaper-btn {
    opacity: 1;
    transform: scale(1.1);
}

.contact-wallpaper-option .delete-wallpaper-btn:hover {
    background: #ff3742;
    transform: scale(1.1);
}


.contact-wallpaper-upload {
    margin-bottom: 16px;
}

.wallpaper-upload-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    border: 2px dashed #6C8CD5;
    border-radius: 8px;
    background: rgba(108, 140, 213, 0.05);
    color: #6C8CD5;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    width: 100%;
    justify-content: center;
}

.wallpaper-upload-btn:hover {
    background: rgba(108, 140, 213, 0.1);
    border-color: #4A6FBF;
    color: #4A6FBF;
}

.contact-settings-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
}

.contact-settings-btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
}

.contact-settings-btn-cancel {
    background: #f5f5f5;
    color: #666;
}

.contact-settings-btn-cancel:hover {
    background: #e0e0e0;
}

.contact-settings-btn-save {
    background: #6C8CD5;
    color: white;
}

.contact-settings-btn-save:hover {
    background: #4A6FBF;
}

/* 群聊设置弹窗样式 */
.group-settings-modal {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 3600;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.group-settings-modal.show {
    opacity: 1;
    visibility: visible;
}

.group-settings-content {
    background: white;
    border-radius: 16px;
    padding: 24px;
    width: 90%;
    max-width: 400px;
    max-height: 80vh;
    overflow-y: auto;
    transform: scale(0.9);
    transition: all 0.3s ease;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

.group-settings-modal.show .group-settings-content {
    transform: scale(1);
}

.group-settings-title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 20px;
    color: #333;
    text-align: center;
}

.group-info-section {
    margin-bottom: 24px;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
}

.group-avatar-upload {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
}

.group-avatar-preview {
    width: 80px;
    height: 80px;
    border-radius: 12px;
    object-fit: cover;
    border: 2px solid #ddd;
    cursor: pointer;
    transition: all 0.2s;
}

.group-avatar-preview:hover {
    border-color: #6C8CD5;
    transform: scale(1.05);
}

.group-avatar-upload-btn {
    flex: 1;
    padding: 12px;
    border: 1px dashed #6C8CD5;
    border-radius: 8px;
    background: rgba(108, 140, 213, 0.05);
    color: #6C8CD5;
    cursor: pointer;
    text-align: center;
    font-size: 14px;
    transition: all 0.2s;
}

.group-avatar-upload-btn:hover {
    background: rgba(108, 140, 213, 0.1);
}

.group-members-section {
    margin-bottom: 24px;
}

.group-members-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
}

.group-members-title {
    font-size: 16px;
    font-weight: 600;
    color: #333;
}

.group-add-member-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #6C8CD5;
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: bold;
    transition: all 0.2s;
}

.group-add-member-btn:hover {
    background: #4A6FBF;
    transform: scale(1.1);
}

.group-members-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.group-member-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    transition: all 0.2s;
}

.group-member-item:hover {
    background: #e9ecef;
}

.group-member-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.group-member-info {
    flex: 1;
}

.group-member-name {
    font-size: 14px;
    font-weight: 500;
    color: #333;
    margin-bottom: 2px;
}

.group-member-role {
    font-size: 12px;
    color: #666;
}

.group-member-actions {
    display: flex;
    gap: 8px;
}

.group-member-action-btn {
    padding: 4px 8px;
    border: none;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
}

.group-member-action-btn.promote {
    background: #28a745;
    color: white;
}

.group-member-action-btn.promote:hover {
    background: #218838;
}

.group-member-action-btn.remove {
    background: #dc3545;
    color: white;
}

.group-member-action-btn.remove:hover {
    background: #c82333;
}

.group-member-action-btn.transfer {
    background: #ffc107;
    color: #212529;
}

.group-member-action-btn.transfer:hover {
    background: #e0a800;
}

.group-owner-badge {
    background: #6C8CD5;
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 500;
}

.group-admin-badge {
    background: #28a745;
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 500;
}

.group-actions-section {
    margin-bottom: 24px;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
}

.group-action-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 0;
    cursor: pointer;
    transition: all 0.2s;
}

.group-action-item:hover {
    background: rgba(108, 140, 213, 0.05);
    border-radius: 8px;
    padding: 12px 8px;
}

.group-action-label {
    font-size: 14px;
    color: #333;
}

.group-action-value {
    font-size: 12px;
    color: #666;
}

.group-danger-actions {
    margin-top: 20px;
}

.group-danger-action {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    padding: 12px;
    border: 1px solid #dc3545;
    border-radius: 8px;
    background: transparent;
    color: #dc3545;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.group-danger-action:hover {
    background: #dc3545;
    color: white;
}

.group-settings-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
}

.group-settings-btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
}

.group-settings-btn-cancel {
    background: #f5f5f5;
    color: #666;
}

.group-settings-btn-cancel:hover {
    background: #e0e0e0;
}

.group-settings-btn-save {
    background: #6C8CD5;
    color: white;
}

.group-settings-btn-save:hover {
    background: #4A6FBF;
}

/* 大图预览 Lightbox */
.image-lightbox {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.85);
    z-index: 5000;
    align-items: center;
    justify-content: center;
}

.image-lightbox.show {
    display: flex;
}

.image-lightbox img {
    max-width: 90vw;
    max-height: 90vh;
    border-radius: 12px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
}

/* 系统提示消息（撤回等） */
.message-system {
    text-align: center;
    color: #888;
    font-size: 12px;
    margin: 10px 0;
}

/* 引用块（消息内展示） */
.reply-block {
    background: rgba(255,255,255,0.7);
    border-left: 3px solid #6C8CD5;
    border-radius: 8px;
    padding: 6px 8px;
    margin-bottom: 6px;
    color: #333;
    font-size: 12px;
}
.sent .reply-block {
    background: rgba(255,255,255,0.88);
    color: #2c3e50;
    border-left-color: #ffffff;
}
.reply-block-title { font-weight: 600; margin-bottom: 2px; }
.reply-block-text { opacity: 0.9; }

/* 输入框上的引用预览 */
.reply-preview {
    position: absolute;
    left: 16px;
    right: 60px;
    top: -40px;
    background: rgba(255,255,255,0.95);
    border-left: 3px solid #6C8CD5;
    border-radius: 8px;
    padding: 6px 8px;
    font-size: 12px;
    color: #333;
    display: none;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}
.reply-preview .close-reply { float: right; cursor: pointer; color: #999; }

/* 长按菜单 */
.message-menu {
    position: absolute;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    padding: 6px 0;
    z-index: 6000;
    display: none;
    min-width: 120px;
}
.message-menu.show { display: block; }
.message-menu-item {
    padding: 8px 14px;
    font-size: 14px;
    color: #333;
    cursor: pointer;
    white-space: nowrap;
}
.message-menu-item:hover { background: rgba(108,140,213,0.08); color: #4A6FBF; }

/* 多选工具栏样式 */
.multiselect-toolbar {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 60px;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(10px);
    border-top: 1px solid #eee;
    display: none;
    align-items: center;
    justify-content: space-around;
    padding: 0 16px;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
    z-index: 2000;
}

.multiselect-toolbar.show {
    display: flex;
}

.multiselect-action {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    padding: 8px;
    cursor: pointer;
    transition: all 0.2s;
    border-radius: 8px;
    font-size: 14px;
    color: #333;
    font-weight: 500;
}

.multiselect-action:hover {
    background: rgba(108, 140, 213, 0.1);
    color: #6C8CD5;
}

.multiselect-action.multiselect-cancel {
    color: #999;
}

.multiselect-action.multiselect-cancel:hover {
    background: rgba(0, 0, 0, 0.05);
    color: #666;
}

/* 聊天记录消息样式 */
.message-chat-history {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 0;
    max-width: 280px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    cursor: pointer;
    transition: all 0.2s ease;
}

.message-chat-history:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}

.chat-history-header {
    background: linear-gradient(135deg, #6C8CD5, #4A6FBF);
    color: white;
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.chat-history-icon {
    width: 32px;
    height: 32px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
}

.chat-history-title {
    flex: 1;
    font-size: 15px;
    font-weight: 600;
}

.chat-history-body {
    padding: 12px;
    background: #f8f9fa;
    max-height: 200px;
    overflow-y: auto;
}

.chat-history-item {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    margin-bottom: 10px;
    padding: 8px;
    background: white;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.chat-history-item:last-child {
    margin-bottom: 0;
}

.chat-history-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    flex-shrink: 0;
    object-fit: cover;
    border: 2px solid #fff;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.chat-history-content {
    flex: 1;
    min-width: 0;
}

.chat-history-name {
    font-size: 12px;
    font-weight: 600;
    color: #6C8CD5;
    margin-bottom: 4px;
}

.chat-history-text {
    font-size: 13px;
    color: #333;
    line-height: 1.4;
    word-break: break-word;
}

.chat-history-footer {
    padding: 8px 16px;
    background: white;
    border-top: 1px solid #e0e0e0;
    font-size: 12px;
    color: #999;
    text-align: center;
}

/* 语音消息容器 */
.message-voice-container {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
}

/* 语音文本滑出效果 */
.voice-text-content {
    margin-top: 8px;
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    font-size: 14px;
    line-height: 1.4;
    color: #333;
    max-width: 200px;
    word-wrap: break-word;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.voice-text {
    margin: 0;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideUp {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(-10px);
    }
}

/* 语音通话界面新增样式 */
.call-avatar-section {
    text-align: center;
    padding: 40px 20px 20px 20px;
    flex-shrink: 0;
}

.call-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    overflow: hidden;
    margin: 0 auto 16px;
    border: 4px solid rgba(255, 255, 255, 0.3);
}

.call-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.call-name {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 8px;
}

.call-status {
    font-size: 16px;
    opacity: 0.8;
}

/* 聊天区域 */
.call-chat-section {
    flex: 1;
    background: rgba(255, 255, 255, 0.1);
    margin: 0 20px;
    border-radius: 16px;
    padding: 16px;
    overflow-y: auto;
    backdrop-filter: blur(10px);
}

.call-chat-messages {
    display: flex;
    flex-direction: column;
    gap: 12px;
    min-height: 200px;
}

/* 通话消息气泡 */
.call-message {
    max-width: 80%;
    padding: 12px 16px;
    border-radius: 18px;
    font-size: 14px;
    word-wrap: break-word;
    animation: messageSlide 0.3s ease-out;
}

.call-message.sent {
    background: linear-gradient(135deg, #6C8CD5, #4A6FBF);
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
}

.call-message.received {
    background: rgba(255, 255, 255, 0.9);
    color: #333;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
}

.call-message.system {
    background: rgba(0, 0, 0, 0.1);
    color: #666;
    align-self: center;
    font-size: 12px;
    text-align: center;
    border-radius: 12px;
    padding: 8px 12px;
}

@keyframes messageSlide {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* 输入区域 */
.call-input-section {
    padding: 16px 20px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
}

.call-input-container {
    display: flex;
    gap: 12px;
    align-items: center;
}

.call-text-input {
    flex: 1;
    padding: 12px 16px;
    border: none;
    border-radius: 20px;
    background: rgba(255, 255, 255, 0.9);
    color: #333;
    font-size: 14px;
    outline: none;
}

.call-text-input::placeholder {
    color: #999;
}

.call-send-btn {
    padding: 12px 20px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.2s ease;
}

.call-send-btn:hover {
    background: #45a049;
    transform: scale(1.05);
}

/* 更新底部操作按钮 */
.call-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 40px 40px 40px;
    gap: 40px;
}

.call-record {
    background: #4CAF50;
    color: white;
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
}

.call-record:hover {
    background: #45a049;
    transform: scale(1.1);
}

/* 视频通话界面样式 - 视觉小说风格 */
.video-call-interface {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: none;
    flex-direction: column;
    z-index: 10001;
}

.video-call-interface.show {
    display: flex;
}

.video-call-interface-content {
    display: flex;
    flex-direction: column;
    height: 100%;
    color: white;
    position: relative;
}

/* 挂断按钮 - 左上角 */
.video-call-hangup-btn {
    position: absolute;
    top: 20px;
    left: 20px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: none;
    background: rgba(255, 55, 66, 0.9);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(255, 55, 66, 0.3);
    z-index: 10;
}

.video-call-hangup-btn:hover {
    background: #ff3742;
    transform: scale(1.1);
}

/* 人物立绘区域 - 自由显示 */
.video-call-character-section {
    position: fixed;
    bottom: 300px; /* 往上移一点，让人物立绘的底部贴着对话框顶部 */
    left: 20px;
    right: 20px;
    height: 300px; /* 恢复高度，让人物立绘完整显示 */
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding: 0;
    z-index: 10000; /* 确保在对话框下面 */
}

.video-call-character {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    position: relative;
}

.video-call-character img {
    max-width: 200%;
    max-height: 200%;
    object-fit: contain;
    /* 移除边框和阴影，让立绘自由显示 */
}

/* 对话框区域 - 重新设计 */
.video-call-dialog-section {
    position: fixed;
    bottom: 50px; /* 贴得更紧，减少间距 */
    left: 0; /* 左右两边贴合屏幕 */
    right: 0;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 0; /* 去掉圆角，贴合屏幕 */
    padding: 15px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    height: 200px; /* 增加高度，让它更高 */
    overflow-y: auto;
    z-index: 10001;
}

.video-call-dialog-box {
    background: transparent;
    border-radius: 0;
    padding: 0;
    flex: 1;
    overflow-y: auto;
    box-shadow: none;
    min-height: auto;
}

.video-call-dialog-content {
    color: #333;
    font-size: 16px;
    line-height: 1.6;
    min-height: 60px;
}

/* 对话消息样式 - 重新设计，去掉气泡 */
.video-call-message {
    margin: 6px 0;
    padding: 8px 0; /* 去掉左右padding */
    border-radius: 0; /* 去掉圆角 */
    font-size: 14px;
    line-height: 1.4;
    background: transparent; /* 去掉背景 */
}

.video-call-message.user {
    color: #333;
    text-align: right; /* 用户文字在右边 */
    margin-left: 20px;
    margin-right: 0;
}

.video-call-message.ai {
    color: #333;
    text-align: left; /* 角色文字在左边 */
    margin-right: 20px;
    margin-left: 0;
}

/* 输入区域 - 重新设计 */
.video-call-input-section {
    position: fixed;
    bottom: 0; /* 直接贴合屏幕底部，没有空间 */
    left: 0; /* 左右两边贴合屏幕 */
    right: 0;
    background: white;
    border-radius: 0; /* 去掉圆角，贴合屏幕 */
    padding: 12px 20px;
    display: flex;
    gap: 12px;
    align-items: center;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    z-index: 10002;
    min-height: 50px;
    box-sizing: border-box;
}

.video-call-text-input {
    flex: 1;
    padding: 8px 16px;
    border: none;
    border-radius: 20px;
    background: #f5f5f5;
    color: #333;
    font-size: 14px;
    outline: none;
}

.video-call-text-input:focus {
    border-color: #6C8CD5;
    box-shadow: 0 0 0 2px rgba(108, 140, 213, 0.1);
}

.video-call-text-input::placeholder {
    color: #999;
}

.video-call-send-btn {
    padding: 8px 16px;
    background: #6C8CD5;
    color: white;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.2s ease;
    min-width: 60px;
}

.video-call-send-btn:hover {
    background: #5a7bc7;
    transform: scale(1.05);
}

/* 语音通话界面样式 */
.voice-call-interface {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: white;
    display: none;
    flex-direction: column;
    z-index: 10001;
}

.voice-call-interface.show {
    display: flex;
}

.voice-call-interface-content {
    display: flex;
    flex-direction: column;
    height: 100%;
    color: #333;
}
</style>
</head>
<body>
<script>
// 修复移动端 100vh 被浏览器地址栏挤压：使用 --vh 单位
(function(){
    function setVh(){
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    setVh();
    window.addEventListener('resize', setVh);
    window.addEventListener('orientationchange', setVh);
})();
function playClickSound() {
    const sound = document.getElementById('clickSound');
    if (sound) {
        sound.currentTime = 0;
        sound.play().catch(err => console.log('音频播放失败:', err));
    }
}

// 播放角色发消息音效
function playMessageSound() {
    const sound = document.getElementById('messageSound');
    if (sound) {
        sound.currentTime = 0;
        sound.play().catch(err => console.log('角色消息音效播放失败:', err));
    }
}

// 播放发送消息音效
function playSendSound() {
    const sound = document.getElementById('sendSound');
    if (sound) {
        sound.currentTime = 0;
        sound.play().catch(err => console.log('发送音效播放失败:', err));
    }
}

// 播放点击头像音效
function playAvatarSound() {
    const sound = document.getElementById('avatarSound');
    if (sound) {
        sound.currentTime = 0;
        sound.play().catch(err => console.log('头像音效播放失败:', err));
    }
}

// 发布动态相关变量
let momentVisibility = 'public'; // 'public' or 'private'
let mentionedFriends = [];
let visibleToFriends = [];
let selectedVisibilityFriends = new Set();
let momentImages = [];

// 打开提到谁弹窗
function openMentionModal() {
    playClickSound();
    const modal = document.getElementById('mentionModal');
    const friendsList = document.getElementById('mentionFriendsList');
    
    // 获取好友列表
    const friends = currentMessages.filter(msg => !msg.isGroup);
    
    // 渲染好友列表
    friendsList.innerHTML = '';
    friends.forEach(friend => {
        const friendItem = document.createElement('div');
        friendItem.className = 'mention-friend-item';
        friendItem.innerHTML = `
            <img src="${friend.avatar}" alt="${friend.name}" class="mention-friend-avatar">
            <div class="mention-friend-name">${friend.name}</div>
        `;
        friendItem.onclick = () => selectMentionFriend(friend);
        friendsList.appendChild(friendItem);
    });
    
    modal.style.display = 'flex';
}

// 选择提到的好友
function selectMentionFriend(friend) {
    playClickSound();
    const textarea = document.getElementById('postMomentText');
    const currentText = textarea.value;
    
    // 在输入框中添加@好友
    textarea.value = currentText + (currentText ? ' ' : '') + '@' + friend.name + ' ';
    
    // 记录被提到的好友
    if (!mentionedFriends.find(f => f.id === friend.id)) {
        mentionedFriends.push(friend);
    }
    
    closeMentionModal();
    
    // 聚焦到输入框
    textarea.focus();
}

// 关闭提到谁弹窗
function closeMentionModal() {
    playClickSound();
    const modal = document.getElementById('mentionModal');
    modal.style.display = 'none';
}

// 打开谁可以看弹窗
function openVisibilityModal() {
    playClickSound();
    const modal = document.getElementById('visibilityModal');
    const friendsList = document.getElementById('visibilityFriendsList');
    
    // 获取好友列表
    const friends = currentMessages.filter(msg => !msg.isGroup);
    
    // 渲染好友列表
    friendsList.innerHTML = '';
    friends.forEach(friend => {
        const friendItem = document.createElement('div');
        friendItem.className = 'visibility-friend-item';
        if (selectedVisibilityFriends.has(friend.id)) {
            friendItem.classList.add('selected');
        }
        friendItem.innerHTML = `
            <img src="${friend.avatar}" alt="${friend.name}" class="visibility-friend-avatar">
            <div class="visibility-friend-name">${friend.name}</div>
            <div class="visibility-friend-checkbox"></div>
        `;
        friendItem.onclick = () => toggleVisibilityFriend(friend, friendItem);
        friendsList.appendChild(friendItem);
    });
    
    modal.style.display = 'flex';
}

// 切换好友可见性选择
function toggleVisibilityFriend(friend, element) {
    playClickSound();
    if (selectedVisibilityFriends.has(friend.id)) {
        selectedVisibilityFriends.delete(friend.id);
        element.classList.remove('selected');
    } else {
        selectedVisibilityFriends.add(friend.id);
        element.classList.add('selected');
    }
}

// 确认可见性设置
function confirmVisibility() {
    playClickSound();
    visibleToFriends = Array.from(selectedVisibilityFriends);
    closeVisibilityModal();
}

// 关闭谁可以看弹窗
function closeVisibilityModal() {
    playClickSound();
    const modal = document.getElementById('visibilityModal');
    modal.style.display = 'none';
}

// 获取可见的联系人列表
function getVisibleFriends() {
    // 如果选择了特定联系人，返回选中的联系人
    if (visibleToFriends.length > 0) {
        return currentMessages.filter(msg => 
            !msg.isGroup && visibleToFriends.includes(msg.id)
        );
    }
    
    // 如果是公开动态，返回所有非群聊联系人
    if (momentVisibility === 'public') {
        return currentMessages.filter(msg => !msg.isGroup);
    }
    
    // 如果是私密动态，返回空列表（不评论）
    return [];
}

// 切换公开/私密
function toggleMomentVisibility() {
    playClickSound();
    const display = document.getElementById('postVisibilityDisplay');
    
    if (momentVisibility === 'public') {
        momentVisibility = 'private';
        display.innerHTML = `
            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                <path d="M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8A2,2 0 0,1 20,10V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V10C4,8.89 4.9,8 6,8H7V6A5,5 0 0,1 12,1A5,5 0 0,1 17,6V8H18M12,3A3,3 0 0,0 9,6V8H15V6A3,3 0 0,0 12,3Z"/>
            </svg>
            <span>私密</span>
        `;
    } else {
        momentVisibility = 'public';
        display.innerHTML = `
            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
            </svg>
            <span>公开</span>
        `;
    }
}

// 图片预览处理
function handlePostImageUpload() {
    const input = document.getElementById('postImageUpload');
    input.addEventListener('change', (e) => {
        const files = e.target.files;
        if (!files || files.length === 0) return;
        
        Array.from(files).forEach(file => {
            if (!file.type.startsWith('image/')) {
                alert('请选择图片文件！');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                alert('图片文件大小不能超过5MB！');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (event) => {
                momentImages.push(event.target.result);
                renderPostImagePreview();
            };
            reader.readAsDataURL(file);
        });
        
        // 清空input以便再次选择
        e.target.value = '';
    });
}

// 渲染图片预览
function renderPostImagePreview() {
    const preview = document.getElementById('postImagePreview');
    preview.innerHTML = '';
    
    momentImages.forEach((image, index) => {
        const previewItem = document.createElement('div');
        previewItem.className = 'post-moment-preview-item';
        previewItem.innerHTML = `
            <img src="${image}" alt="预览">
            <div class="post-moment-remove-btn" onclick="removePostImage(${index})">×</div>
        `;
        preview.appendChild(previewItem);
    });
}

// 删除预览图片
function removePostImage(index) {
    playClickSound();
    momentImages.splice(index, 1);
    renderPostImagePreview();
}

function showDialog(dialogId) {
    const dialog = document.getElementById(dialogId);
    if (dialog) {
        dialog.style.display = 'flex';
        // 添加一个短暂延迟以确保过渡效果正常工作
        setTimeout(() => {
            dialog.classList.add('show');
        }, 10);
    }
}

function closeDialog(dialogId) {
    const dialog = document.getElementById(dialogId);
    if (dialog) {
        dialog.classList.remove('show');
        // 等待过渡效果完成后再隐藏元素
        setTimeout(() => {
            dialog.style.display = 'none';
        }, 300);
    }
}

function makeCall() {
    const target = document.getElementById('callTarget').value.trim();
    if (target) {
        if (typeof triggerSlash === 'function') {
            triggerSlash(`/send ${target}接听了语音通话|/trigger`);
        } else {
            console.error('triggerSlash 函数不可用');
        }
        closeDialog('phoneDialog');
        document.getElementById('callTarget').value = '';
    }
}

function search() {
    const query = document.getElementById('searchQuery').value.trim();
    if (query) {
        if (typeof triggerSlash === 'function') {
            triggerSlash(`/send 查看${query}浏览器内容|/trigger`);
        } else {
            console.error('triggerSlash 函数不可用');
        }
        closeDialog('searchDialog');
        document.getElementById('searchQuery').value = '';
    }
}

// 新增：切换聊天头部状态为"正在输入…"或"在线"
function setChatTyping(isTyping) {
  const statusEl = document.querySelector('.chat-status');
  if (!statusEl) return;
  if (isTyping) {
    statusEl.innerHTML = '<div class="status-dot"></div> 正在输入…';
  } else {
    statusEl.innerHTML = '<div class="status-dot"></div> 在线';
  }
}

// ========== AI 文字规则（陪伴式，无动作，1-20条） ==========
const AI_TEXT_RULES = {
  minMessages: 1,
  maxMessages: 20,
  denyActions: true,
  typingDelayMs: { min: 1500, max: 4000 } // 逐条发送间隔
};

// 解析 AI 回复中的可选动作块 ```ai_actions { ... }```
function parseAndExtractAIActions(rawText) {
  if (!rawText) return { cleanText: '', actions: [] };
  let text = String(rawText);
  const actions = [];

  // 支持三种包裹：```ai_actions ...```, <ai_actions>...</ai_actions>, ```json ai_actions ...```
  const patterns = [
    /```\s*ai_actions\s*([\s\S]*?)```/i,
    /<ai_actions>([\s\S]*?)<\/ai_actions>/i,
    /```\s*json\s*ai_actions\s*([\s\S]*?)```/i
  ];
  for (const re of patterns) {
    const m = text.match(re);
    if (m && m[1]) {
      try {
        const jsonStr = m[1].trim();
        const parsed = JSON.parse(jsonStr);
        if (Array.isArray(parsed)) actions.push(...parsed);
        else if (parsed && typeof parsed === 'object') actions.push(parsed);
      } catch (e) {
        console.warn('AI 动作块解析失败:', e);
      }
      text = text.replace(re, '').trim();
    }
  }
  return { cleanText: text, actions };
}

async function executeAIActions(actions) {
  if (!actions || actions.length === 0) return;
  for (const act of actions) {
    try {
      switch (act.type) {
        case 'transfer': {
          const amount = Number(act.amount) || 0;
          const note = act.note ? String(act.note) : '';
          const msg = {
            id: Date.now() + Math.random(),
            sender: 'received',
            content: `转账 ¥${amount}${note ? '\n备注：' + note : ''}\n对方向你发起了转账`,
            time: `${new Date().getHours()}:${String(new Date().getMinutes()).padStart(2, '0')}`,
            avatar: currentChatContact.avatar,
            type: 'transfer'
          };
          chatMessages.push(msg);
          break;
        }
        case 'food_order': {
          const name = act.name ? String(act.name) : '外卖订单';
          const amount = Number(act.amount) || 0;
          const note = act.note ? String(act.note) : '';
          const msg = {
            id: Date.now() + Math.random(),
            sender: 'received',
            content: `🍔 ${name}\n💰 ¥${amount}${note ? '\n备注：' + note : ''}\n对方向你发送了外卖订单`,
            time: `${new Date().getHours()}:${String(new Date().getMinutes()).padStart(2, '0')}`,
            avatar: currentChatContact.avatar,
            type: 'food_order'
          };
          chatMessages.push(msg);
          break;
        }
        case 'location': {
          const address = act.address ? String(act.address) : '位置';
          const msg = {
            id: Date.now() + Math.random(),
            sender: 'received',
            content: `📍 ${address}`,
            time: `${new Date().getHours()}:${String(new Date().getMinutes()).padStart(2, '0')}`,
            avatar: currentChatContact.avatar,
            type: 'location',
            image: null
          };
          chatMessages.push(msg);
          break;
        }
        case 'voice': {
          const content = act.content ? String(act.content) : '语音消息';
          const msg = {
            id: Date.now() + Math.random(),
            sender: 'received',
            content,
            time: `${new Date().getHours()}:${String(new Date().getMinutes()).padStart(2, '0')}`,
            avatar: currentChatContact.avatar,
            type: 'voice'
          };
          chatMessages.push(msg);
          break;
        }
        default:
          break;
      }
    } catch (e) {
      console.warn('执行 AI 动作失败:', e);
    }
  }
  await saveChatMessages(currentChatContact.id, chatMessages);
  await renderChatMessages();
}

// 从纯文本中模糊识别动作（兜底逻辑，避免触发条件过于死板）
function detectFallbackActionsFromText(text) {
  if (!text) return [];
  const result = [];
  const t = String(text).replace(/\s+/g, '');

  // 金额抓取：￥52、¥52、52块、52元
  const moneyMatch = t.match(/[¥￥]?\s?(\d{1,6}(?:\.\d{1,2})?)(?:元|块|塊)?/);
  const amount = moneyMatch ? Number(moneyMatch[1]) : null;

  // 转账意图
  if (/(转给你|转账给你|给你转|打钱|发红包|给我转|转我|转一下|转账)/.test(t)) {
    if (amount && amount > 0) {
      result.push({ type: 'transfer', amount });
    } else {
      // 没金额也允许语义触发，默认小额
      result.push({ type: 'transfer', amount: 20 });
    }
  }

  // 外卖意图
  if (/(点外卖|点吃的|给你点|下单|订餐|送餐|奶茶|粥|饭|晚餐)/.test(t)) {
    const nameMatch = t.match(/点(?:一|个|杯|份)?([\u4e00-\u9fa5A-Za-z0-9]{1,12})/);
    const name = nameMatch ? nameMatch[1] : '外卖订单';
    result.push({ type: 'food_order', name, amount: amount && amount > 0 ? amount : 18 });
  }

  // 位置意图
  if (/(定位|位置|在这|地址|见面地点|公园|咖啡店)/.test(t)) {
    const addrMatch = t.match(/在([\u4e00-\u9fa5A-Za-z0-9·\-]{2,20})/);
    const address = addrMatch ? addrMatch[1] : '约定地点';
    result.push({ type: 'location', address });
  }

  // 语音意图
  if (/(语音|说给你听|我念给你|我读给你)/.test(t)) {
    // 取一句短句当语音内容
    const sentence = (text.match(/([^。！？!?\n]{2,40})[。！？!?\n]/) || [,'我在，慢慢说。'])[1];
    result.push({ type: 'voice', content: sentence });
  }

  return result;
}

// 去动作/舞台指令清洗（过滤 [], (), <> 及 *...* 内的动作描述）
function sanitizeNoActions(text) {
  if (!text) return '';
  let stripped = String(text)
    .replace(/\[[^\]]+\]/g, '')
    .replace(/\([^\)]+\)/g, '')
    .replace(/<[^>]+>/g, '')
    .replace(/\*[^\*]+\*/g, '');
  // 去除多余空白
  stripped = stripped.replace(/\s+/g, ' ').trim();
  return stripped;
}

// 新增：将AI文本按句子拆分为多条（中文。！？、省略号…/..., 英文! ?.）
function splitAIMessage(text) {
  if (!text) return [];
  // 兼容中文省略号（… 或 ……）与英文省略号（...）
  const segments = [];
  let buffer = '';
  for (let i = 0; i < text.length; i++) {
    buffer += text[i];
    const ch = text[i];
    const next2 = text.slice(i, i + 2);
    const next3 = text.slice(i, i + 3);
    if (next3 === '...') {
      buffer = buffer.slice(0, -2);
      segments.push((buffer + '...').trim());
      buffer = '';
      i += 2;
      continue;
    }
    if (next2 === '……') {
      buffer = buffer.slice(0, -1);
      segments.push((buffer + '……').trim());
      buffer = '';
      i += 1;
      continue;
    }
    if (ch === '…') {
      segments.push(buffer.trim());
      buffer = '';
      continue;
    }
    if (ch === '。' || ch === '！' || ch === '!' || ch === '？' || ch === '?') {
      segments.push(buffer.trim());
      buffer = '';
    }
  }
  if (buffer.trim()) segments.push(buffer.trim());
  return segments.filter(s => s && s.replace(/\s+/g, '').length > 0);
}

// 新增：渲染并保存AI多条回复（顺序逐条，规则限流与无动作过滤）- 高性能版本
async function renderAndSaveAIReplies(replyText, contact = null) {
  let parts = splitAIMessage(replyText).map(p => sanitizeNoActions(p)).filter(p => p);
  if (parts.length === 0) return;
  
  // 🚀 修复：使用传入的联系人或当前聊天联系人
  const targetContact = contact || currentChatContact;
  if (!targetContact) {
    console.error('没有目标联系人，无法保存AI回复');
    return;
  }

  // 限制到 maxMessages：超出的合并到最后一条，避免丢信息
  if (parts.length > AI_TEXT_RULES.maxMessages) {
    const keep = parts.slice(0, AI_TEXT_RULES.maxMessages - 1);
    const rest = parts.slice(AI_TEXT_RULES.maxMessages - 1).join(' ');
    parts = [...keep, rest];
  }

  const pad2 = (n) => String(n).padStart(2, '0');

  for (const part of parts) {
    const now = new Date();
    const timeStr = `${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
    
    // 创建AI消息对象
    const aiMessage = {
      id: Date.now() + Math.random(),
      sender: 'received',
      content: part,
      time: timeStr,
      avatar: targetContact ? targetContact.avatar : 'https://placehold.co/40x40/E8E8E8/999?text=AI'
    };
    
    // 添加到消息数组
    chatMessages.push(aiMessage);
    
    // 使用高性能渲染函数（只渲染单条消息）
    if (targetContact) {
        await renderNewAIMessage(aiMessage);
        // 播放角色发消息音效
        playMessageSound();
    }
    
    // 异步保存（不阻塞UI）
    setTimeout(async () => {
      if (targetContact) {
        await saveChatMessages(targetContact.id, chatMessages);
        
        // 🚀 修复：更新消息列表预览
        const messageInList = currentMessages.find(m => m.id === targetContact.id);
        if (messageInList) {
          messageInList.lastMessage = part.substring(0, 30) + (part.length > 30 ? '...' : '');
          messageInList.time = timeStr;
          
          // 🚀 新增：如果用户不在聊天界面，增加未读消息数量
          const chatApp = document.getElementById('chatApp');
          if (!chatApp || !chatApp.classList.contains('show')) {
            // 用户不在聊天界面，增加未读消息数量
            messageInList.unread = (messageInList.unread || 0) + 1;
            console.log(`📱 用户不在聊天界面，增加未读消息数量: ${messageInList.unread}`);
          }
          
          // 重新渲染消息列表以显示更新
          await renderMessagesList();
        }
      }
    }, 0);

    // 逐条发送延迟（规则控制）
    const { min, max } = AI_TEXT_RULES.typingDelayMs;
    const delay = Math.floor(min + Math.random() * (max - min));
    await new Promise(r => setTimeout(r, delay));
  }
  
  // 显示AI回复完成的通知（如果页面在后台）
  if (document.hidden) {
    showNotification('AI回复已完成');
  }
}
</script>
<div class="phone-container">
<div id="phoneDialog" class="dialog" style="display: none;">
    <div class="dialog-content">
        <h3></h3>
        <input type="text" id="callTarget" placeholder="请输入联系人">
        <div class="dialog-buttons">
            <button onclick="makeCall()">确定</button>
            <button onclick="closeDialog('phoneDialog')">取消</button>
        </div>
    </div>
</div>

<div id="searchDialog" class="dialog" style="display: none;">
    <div class="dialog-content">
        <h3>搜索</h3>
        <input type="text" id="searchQuery" placeholder="请输入搜索内容">
        <div class="dialog-buttons">
            <button onclick="search()">确定</button>
            <button onclick="closeDialog('searchDialog')">取消</button>
        </div>
    </div>
    </div>
    <div class="status-bar">
        <div class="status-bar-left">
            <span>12:00</span>
        </div>
        <div class="status-bar-right">
            <svg class="status-icon-svg" viewBox="0 0 24 24">
                <path d="M20,20h2v-2h-2V20z M18,20h-2v-4h2V20z M14,20h-2v-6h2V20z M10,20H8v-8h2V20z M6,20H4v-10h2V20z"></path>
            </svg>
            <svg class="status-icon-svg" viewBox="0 0 24 24">
                <path d="M12,3C7.41,3,3.86,4.53,0.96,7.03L2.37,8.44C4.89,6.31,8.06,5,12,5s7.11,1.31,9.63,3.44l1.41-1.41C20.14,4.53,16.59,3,12,3z M12,7C9.3,7,6.81,7.89,4.8,9.4l1.4,1.4C7.6,9.67,9.69,9,12,9s4.4,0.67,5.8,1.8l1.4-1.4C17.19,7.89,14.7,7,12,7z M12,11c-1.94,0-3.5,0.5-4.7,1.3l1.4,1.4c0.8-0.5,2-0.7,3.3-0.7s2.5,0.2,3.3,0.7l1.4-1.4C15.5,11.5,13.94,11,12,11z M12,15c-0.85,0-1.5,0.15-2,0.4l2,2l2-2C13.5,15.15,12.85,15,12,15z"></path>
            </svg>
            <svg class="status-icon-svg" viewBox="0 0 24 24">
                <path d="M15.67,4H14V2h-4v2H8.33C7.6,4,7,4.6,7,5.33v15.33C7,21.4,7.6,22,8.33,22h7.33c0.74,0,1.33-0.6,1.33-1.33V5.33C17,4.6,16.4,4,15.67,4z M15,20H9V6h6V20z"></path>
            </svg>
        </div>
    </div>
    <div class="widget-container">
        <div class="widget widget-clock" onclick="playClickSound()">
            <div class="time">12:00</div>
            <div class="date">Sunday, Dec 15</div>
        </div>
        <div class="widget widget-weather" onclick="playClickSound()">
            <div class="temp">23°C</div>
            <div class="condition">Sunny</div>
        </div>
    </div>
    <!-- 桌面容器 -->
    <div class="desktop-container" id="desktopContainer">
        <!-- 第一页 -->
        <div class="desktop-page active" id="desktopPage1">
            <div class="app-grid">
                <div class="app-block" onclick="playClickSound(); if(typeof openMessagesApp === 'function') { openMessagesApp(); } else { console.error('openMessagesApp function not found'); }">
                    <img src="https://files.catbox.moe/14op6b.jpg">
                    <span>Messages</span>
                </div>
                <div class="app-block" onclick="playClickSound(); if(typeof openMomentApp === 'function') { openMomentApp(); } else { console.error('openMomentApp function not found'); }">
                    <img src="https://files.catbox.moe/gvs6a5.jpg">
                    <span>Moments</span>
                </div>
                <div class="app-block" onclick="playClickSound(); triggerSlash('/send 施工中…⚒️|/trigger')">
                    <img src="https://files.catbox.moe/mg3qg0.jpg">
                    <span>Live</span>
                </div>
                <div class="app-block" onclick="playClickSound(); openForumApp()">
                    <img src="https://files.catbox.moe/zd5hig.png">
                    <span>forum</span>
                </div>
            </div>
        </div>
        
        <!-- 第二页 -->
        <div class="desktop-page" id="desktopPage2">
            <div class="app-grid">
                <div class="app-block" onclick="playClickSound(); alert('计算器功能开发中...')">
                    <img src="https://files.catbox.moe/jpd1lk.jpg">
                    <span>suk</span>
                </div>
                <div class="app-block" onclick="playClickSound(); alert('相机功能开发中...')">
                    <img src="https://files.catbox.moe/camera.png">
                    <span>Game</span>
                </div>
                <div class="app-block" onclick="playClickSound(); alert('地图功能开发中...')">
                    <img src="https://files.catbox.moe/maps.png">
                    <span>地图</span>
                </div>
                <div class="app-block" onclick="playClickSound(); alert('游戏功能开发中...')">
                    <img src="https://files.catbox.moe/games.png">
                    <span>游戏</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 页面指示器 -->
    <div class="page-indicators">
        <div class="page-indicator active" data-page="1"></div>
        <div class="page-indicator" data-page="2"></div>
    </div>
    <div class="bottom-bar">
    <div class="app" onclick="playClickSound(); showDialog('phoneDialog')">
        <img src="https://files.catbox.moe/7ji6fb.png">
        <span>Phone</span>
    </div>
        <div class="app" onclick="playClickSound(); triggerSlash('/send 查看我的邮箱|/trigger')">
            <img src="https://files.catbox.moe/edai70.png">
            <span>Mail</span>
        </div>
        <div class="app" onclick="playClickSound(); showDialog('searchDialog')">
    <img src="https://files.catbox.moe/it221m.png">
    <span>Safari</span>
</div>
        <div class="app" onclick="playClickSound(); openSettingsApp()">
            <img src="https://files.catbox.moe/2khrtz.png">
            <span>Setting</span>
        </div>
    </div>
    
    <!-- 消息列表应用 -->
    <div id="messagesApp" class="messages-app">
        <div class="messages-header">
            <div class="messages-back-btn" onclick="closeMessagesApp()">‹</div>
            <h1 class="messages-title">消息</h1>
            <div style="width: 32px;"></div>
        </div>
        <div class="messages-list" id="messagesList">
            <!-- 消息列表项将由JavaScript动态生成 -->
        </div>
        
        <!-- 右下角浮动加号按钮 -->
        <div class="messages-fab-btn" onclick="openAddContactModal()">+</div>
    </div>
    
    <!-- 消息选择菜单 -->
    <div id="messageContextMenu" class="message-context-menu">
        <div class="message-context-item pin" onclick="pinMessage()">
            <span>置顶</span>
        </div>
        <div class="message-context-item unpin" onclick="unpinMessage()" style="display: none;">
            <span>取消置顶</span>
        </div>
        <div class="message-context-item delete" onclick="deleteMessage()">
            <span>删除</span>
        </div>
    </div>
    
    <!-- 动态页面 -->
    <div id="momentApp" class="moment-app">
        <div class="moment-nav">
            <div class="moment-back-btn" onclick="closeMomentApp()">‹</div>
            <div class="moment-title" id="momentPageTitle">✧Moment✧</div>
            <div style="display: flex; gap: 10px;">
                <div class="moment-settings-btn" onclick="testAIPublishAll()">🤖</div>
                <div class="moment-settings-btn" onclick="openMomentSettings()">⚙️</div>
            </div>
        </div>
        
        <!-- 动态页面内容 -->
        <div id="momentPage" class="moment-page-content">
            <div class="moment-timeline" id="momentTimeline">
                <!-- 动态内容将由JavaScript动态生成 -->
            </div>
        </div>
        
        <!-- 个人主页内容 -->
        <div id="profilePage" class="moment-page-content" style="display: none;">
            <div class="profile-section" id="profileSection" onclick="editProfileBackground()">
                <div class="profile-header-overlay"></div>
                <div class="profile-avatar" id="profileAvatar" onclick="editProfileAvatar(event)"></div>
            </div>
            <div class="profile-info">
                <div class="profile-name" id="profileName" onclick="editProfileName()">桜酱</div>
                <div class="profile-username" id="profileUsername" onclick="editProfileUsername()">@sakura_kawaii</div>
                <div class="profile-bio" id="profileBio" onclick="editProfileBio()">✨ 夢見る少女 | 毎日がキラキラ ✨ | 🍰 甘いものが大好き 💖 | フォローしてね！</div>
                <div class="profile-stats">
                    <div class="stat-item" onclick="editProfileStat('following')">
                        <div class="stat-number" id="statFollowing">256</div>
                        <div>关注中</div>
                    </div>
                    <div class="stat-item" onclick="editProfileStat('followers')">
                        <div class="stat-number" id="statFollowers">10.8k</div>
                        <div>追随者</div>
                    </div>
                    <div class="stat-item" onclick="editProfileStat('likes')">
                        <div class="stat-number" id="statLikes">150.2k</div>
                        <div>获得💖</div>
                    </div>
                </div>
            </div>
            <div class="profile-timeline" id="profileTimeline">
                <!-- 个人动态内容将由JavaScript动态生成 -->
            </div>
            
            <!-- 右下角发动态按钮 -->
            <div class="profile-fab-btn" onclick="openCreateMomentModal()">+</div>
        </div>
        
        <!-- 编辑模态框 -->
        <div id="editModal" class="edit-modal" style="display: none;">
            <div class="edit-modal-content">
                <div class="edit-modal-title" id="editModalTitle">编辑信息</div>
                <input type="text" class="edit-modal-input" id="editModalInput" placeholder="请输入新内容">
                <div class="edit-modal-buttons">
                    <button class="edit-modal-btn cancel" onclick="closeEditModal()">取消</button>
                    <button class="edit-modal-btn save" onclick="saveEdit()">保存</button>
                </div>
            </div>
        </div>
        
        <!-- 文件选择器（隐藏） -->
        <input type="file" id="avatarFileInput" accept="image/*" style="display: none;" onchange="handleAvatarChange(event)">
        <input type="file" id="backgroundFileInput" accept="image/*" style="display: none;" onchange="handleBackgroundChange(event)">
        
        <!-- 评论模态框 -->
        <div id="commentModal" class="edit-modal" style="display: none;">
            <div class="edit-modal-content">
                <div class="edit-modal-title">发表评论</div>
                <textarea class="edit-modal-input" id="commentInput" placeholder="写下你的评论..." rows="4" style="resize: none;"></textarea>
                <div class="edit-modal-buttons">
                    <button class="edit-modal-btn cancel" onclick="closeCommentModal()">取消</button>
                    <button class="edit-modal-btn save" onclick="submitComment()">发送</button>
                </div>
            </div>
        </div>
        
        <!-- 删除确认弹窗 -->
        <div id="deleteConfirmOverlay" class="delete-confirm-overlay" style="display: none;">
            <div class="delete-confirm-modal">
                <div class="delete-confirm-title">删除动态</div>
                <div class="delete-confirm-message">确定要删除这条动态吗？删除后无法恢复。</div>
                <div class="delete-confirm-buttons">
                    <button class="delete-confirm-btn cancel" onclick="closeDeleteConfirm()">取消</button>
                    <button class="delete-confirm-btn delete" onclick="confirmDeleteMoment()">删除</button>
                </div>
            </div>
        </div>
        
        <!-- 发布动态弹窗 -->
        <div id="postMomentModal" class="post-moment-modal" style="display: none;">
            <div class="post-moment-container">
                <div class="post-moment-header">
                    <h2>发布动态</h2>
                    <div class="post-moment-close-btn" onclick="closePostMomentModal()">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                            <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                        </svg>
                    </div>
                </div>
                
                <div class="post-moment-content">
                    <textarea class="post-moment-textarea" id="postMomentText" placeholder="分享你的美好瞬间..."></textarea>
                    
                    <div class="post-moment-actions">
                        <label class="post-moment-action-btn">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                                <path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z"/>
                            </svg>
                            <span>照片</span>
                            <input type="file" id="postImageUpload" accept="image/*" multiple style="display: none;">
                        </label>
                        
                        <div class="post-moment-action-btn" id="postMentionBtn" onclick="openMentionModal()">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                                <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
                            </svg>
                            <span>提到谁</span>
                        </div>
                        
                        <div class="post-moment-action-btn" id="postVisibilityBtn" onclick="openVisibilityModal()">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                                <path d="M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8A2,2 0 0,1 20,10V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V10C4,8.89 4.9,8 6,8H7V6A5,5 0 0,1 12,1A5,5 0 0,1 17,6V8H18M12,3A3,3 0 0,0 9,6V8H15V6A3,3 0 0,0 12,3Z"/>
                            </svg>
                            <span>谁可以看</span>
                        </div>
                    </div>
                    
                    <div class="post-moment-image-preview" id="postImagePreview">
                        <!-- 图片预览区域 -->
                    </div>
                </div>
                
                <div class="post-moment-footer">
                    <div class="post-moment-visibility" id="postVisibilityDisplay" onclick="toggleMomentVisibility()">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                            <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
                        </svg>
                        <span>公开</span>
                    </div>
                    
                    <button class="post-moment-btn" onclick="submitMoment()">发布</button>
                </div>
            </div>
        </div>
        
        <!-- 提到谁弹窗 -->
        <div id="mentionModal" class="mention-modal" style="display: none;">
            <div class="mention-modal-content">
                <div class="mention-modal-header">
                    <h3>提到谁</h3>
                    <button class="mention-modal-close" onclick="closeMentionModal()">×</button>
                </div>
                <div class="mention-modal-body">
                    <div id="mentionFriendsList" class="mention-friends-list">
                        <!-- 好友列表将由JavaScript动态生成 -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 谁可以看弹窗 -->
        <div id="visibilityModal" class="visibility-modal" style="display: none;">
            <div class="visibility-modal-content">
                <div class="visibility-modal-header">
                    <h3>谁可以看</h3>
                    <button class="visibility-modal-close" onclick="closeVisibilityModal()">×</button>
                </div>
                <div class="visibility-modal-body">
                    <div id="visibilityFriendsList" class="visibility-friends-list">
                        <!-- 好友列表将由JavaScript动态生成 -->
                    </div>
                </div>
                <div class="visibility-modal-footer">
                    <button class="visibility-modal-btn" onclick="confirmVisibility()">确定</button>
                </div>
            </div>
        </div>
        
        <!-- 底部导航栏 -->
        <div class="moment-bottom-nav">
            <div id="moment-nav-home-btn" class="moment-bottom-nav-item active" onclick="switchMomentPage('home')">
                <div class="moment-bottom-nav-icon moment-nav-home-icon"></div>
                <div class="moment-bottom-nav-text">ホーム</div>
            </div>
            <div id="moment-nav-profile-btn" class="moment-bottom-nav-item" onclick="switchMomentPage('profile')">
                <div class="moment-bottom-nav-icon moment-nav-profile-icon"></div>
                <div class="moment-bottom-nav-text">プロフィール</div>
            </div>
        </div>
    </div>
    
    <!-- 论坛应用 -->
    <div id="forumApp" class="forum-app">
        <div class="forum-nav">
            <div class="forum-back-btn" onclick="closeForumApp()">‹</div>
            <div class="forum-title">论坛</div>
            <div class="forum-nav-buttons">
                <div class="forum-debug-btn" onclick="generateAIPostsDebug()" title="生成AI帖子（调试）">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                    </svg>
                </div>
                <div class="forum-settings-btn" onclick="showForumSettings()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                </div>
            </div>
        </div>
        
        <div class="forum-page-content">
            <!-- 首页帖子列表 -->
            <div class="forum-posts-container" id="forumHomePage">
                <div id="forumPostsList">
                    <!-- 置顶帖子 -->
                    <div class="forum-post-card pinned-post-card">
                        <div class="forum-post pinned">
                            <div style="text-align: center; margin-bottom: 15px;">
                                <h1 style="color: #ff6b35; font-size: 2.5em; margin: 0; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <path d="M2 12h20"></path>
                                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                    </svg>
                                    地球Online
                                </h1>
                                <p style="color: #666; font-size: 14px; margin: 8px 0 0 0;">这里是最新动态和八卦消息的聚集地!</p>
                            </div>
                            <p class="forum-post-content">
                                欢迎来到"地球online"！这里是分享生活点滴的地方，希望大家能够保持良好的社区氛围。请仔细阅读版规，禁止人身攻击、恶意挑拨、发布违规内容。祝大家冲浪愉快！
                            </p>
                            <div class="forum-post-footer">
                                <span class="forum-post-author">Admin</span>
                                <div class="forum-post-stats">
                                    <span class="forum-stat-item">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                            <circle cx="12" cy="12" r="3"></circle>
                                        </svg>
                                        999k
                                    </span>
                                    <span class="forum-stat-item">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                        </svg>
                                        1.2k
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            
            <!-- 右下角发帖按钮 -->
            <div class="forum-fab-btn" onclick="openPostModal()">+</div>
        </div>
        
        <!-- 贴文详情页面 -->
        <div class="forum-detail-page" id="forumDetailPage">
            <div class="forum-detail-header">
                <div class="forum-detail-back-btn" onclick="closeForumPostDetail()">‹</div>
                <div class="forum-detail-title">贴文详情</div>
                <div style="width: 32px;"></div>
            </div>
            <div class="forum-detail-content" id="forumDetailContent">
                <!-- 贴文详情内容将在这里显示 -->
            </div>
        </div>
        
        <!-- 我的页面 -->
        <div class="forum-profile-page" id="forumProfilePage">
            <div class="forum-profile-header" onclick="openForumProfileEdit()">
                <div class="forum-profile-avatar" id="forumProfileAvatar"></div>
                <div class="forum-profile-name" id="forumProfileName">用户</div>
                <div class="forum-profile-stats">
                    <div class="forum-profile-stat">
                        <span class="forum-profile-stat-number" id="forumPostCount">0</span>
                        <span class="forum-profile-stat-label">贴文</span>
                    </div>
                    <div class="forum-profile-stat">
                        <span class="forum-profile-stat-number" id="forumLikeCount">0</span>
                        <span class="forum-profile-stat-label">获赞</span>
                    </div>
                    <div class="forum-profile-stat">
                        <span class="forum-profile-stat-number" id="forumCommentCount">0</span>
                        <span class="forum-profile-stat-label">评论</span>
                    </div>
                </div>
            </div>
            <div class="forum-profile-posts" id="forumProfilePosts">
                <!-- 用户发过的贴文将在这里显示 -->
            </div>
        </div>
        
        <!-- 底部导航栏 -->
        <div class="forum-bottom-nav">
            <div class="forum-bottom-nav-item active" onclick="showForumHome()">
                <div class="forum-bottom-nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9,22 9,12 15,12 15,22"></polyline>
                    </svg>
                </div>
                <div class="forum-bottom-nav-text">首页</div>
            </div>
            <div class="forum-bottom-nav-item" onclick="showForumProfile()">
                <div class="forum-bottom-nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <div class="forum-bottom-nav-text">我的</div>
            </div>
        </div>
    </div>
    
    <!-- 论坛设置弹窗 -->
    <div id="forumSettingsModal" class="edit-modal" style="display: none;">
        <div class="edit-modal-content forum-settings-content">
            <div class="edit-modal-title">论坛设置</div>
            
            <!-- 主题设置 -->
            <div class="settings-section">
                <h3 class="settings-section-title">主题设置</h3>
                <div class="color-picker-container">
                    <label class="settings-label">选择主题色：</label>
                    <div class="color-picker-wrapper">
                        <input type="color" id="themeColorPicker" class="color-picker" value="#ff6b35">
                        <div class="color-preview" id="colorPreview"></div>
                        <span class="color-value" id="colorValue">#ff6b35</span>
                    </div>
                    <div class="preset-colors">
                        <div class="preset-color" data-color="#ff6b35" style="background: #ff6b35;"></div>
                        <div class="preset-color" data-color="#e74c3c" style="background: #e74c3c;"></div>
                        <div class="preset-color" data-color="#3498db" style="background: #3498db;"></div>
                        <div class="preset-color" data-color="#2ecc71" style="background: #2ecc71;"></div>
                        <div class="preset-color" data-color="#9b59b6" style="background: #9b59b6;"></div>
                        <div class="preset-color" data-color="#f39c12" style="background: #f39c12;"></div>
                        <div class="preset-color" data-color="#1abc9c" style="background: #1abc9c;"></div>
                        <div class="preset-color" data-color="#34495e" style="background: #34495e;"></div>
                    </div>
                </div>
            </div>

            <!-- 世界观设置 -->
            <div class="settings-section">
                <h3 class="settings-section-title">世界观设置</h3>
                <div class="worldview-container">
                    <label class="settings-label">自定义世界观：</label>
                    <textarea id="worldviewInput" class="worldview-textarea" placeholder="请描述你想要的世界观，例如：魔法世界、未来科技、古代江湖、校园生活等..."></textarea>
                    <div class="worldview-tips">
                        💡 提示：AI会根据你设定的世界观来生成相关的帖子内容，让论坛更符合你的想象！
                    </div>
                </div>
            </div>

            <!-- 联系人参与设置 -->
            <div class="settings-section">
                <h3 class="settings-section-title">联系人参与</h3>
                <div class="contact-integration">
                    <label class="settings-label">允许联系人参与论坛：</label>
                    <div class="toggle-switch">
                        <input type="checkbox" id="contactIntegrationToggle" class="toggle-input">
                        <label for="contactIntegrationToggle" class="toggle-label"></label>
                    </div>
                    <div class="contact-list" id="contactList" style="display: none;">
                        <div class="contact-list-header">
                            选择参与论坛的联系人：
                            <button class="refresh-contacts-btn" onclick="refreshContactData(); loadContactList();" title="刷新联系人列表">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                                    <path d="M21 3v5h-5"></path>
                                    <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                                    <path d="M3 21v-5h5"></path>
                                </svg>
                                刷新
                            </button>
                        </div>
                        <div class="contact-items" id="contactItems">
                            <!-- 联系人列表将在这里动态生成 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 删除AI帖子选项 -->
            <div class="settings-section">
                <h3 class="settings-section-title">数据管理</h3>
                <div class="delete-ai-posts-container">
                    <div class="delete-ai-posts-btn" onclick="clearAIPostsDebug()">
                        <div class="delete-ai-posts-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 6h18"></path>
                                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                <line x1="14" y1="11" x2="14" y2="17"></line>
                            </svg>
                        </div>
                        <div class="delete-ai-posts-text">
                            <div class="delete-ai-posts-title">删除所有AI帖子</div>
                            <div class="delete-ai-posts-desc">清除所有AI生成的帖子，此操作不可恢复</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="settings-actions">
                <button class="settings-btn settings-btn-secondary" onclick="closeForumSettings()">取消</button>
                <button class="settings-btn settings-btn-primary" onclick="saveForumSettings()">保存设置</button>
            </div>
        </div>
    </div>

    <!-- 论坛发帖弹窗 -->
    <div id="forumPostModal" class="edit-modal" style="display: none;">
        <div class="edit-modal-content">
            <div class="edit-modal-title">发布贴文</div>
            <input type="text" id="forumPostTitle" class="edit-modal-input" placeholder="贴文标题（可选）" style="margin-bottom: 15px;">
            <textarea class="edit-modal-input" id="forumPostContent" placeholder="分享你的想法..." rows="6" style="resize: none;"></textarea>
            <div class="edit-modal-buttons">
                <button class="edit-modal-btn cancel" onclick="closePostModal()">取消</button>
                <button class="edit-modal-btn save" onclick="submitForumPost()">发布</button>
            </div>
        </div>
    </div>
    
    <!-- 论坛个人资料编辑弹窗 -->
    <div id="forumProfileEditModal" class="edit-modal" style="display: none;">
        <div class="edit-modal-content">
            <div class="edit-modal-title">编辑论坛资料</div>
            <div class="forum-profile-edit-section">
                <div class="forum-profile-edit-avatar-section">
                    <div class="forum-profile-edit-avatar" id="forumProfileEditAvatar" onclick="selectForumAvatar()"></div>
                    <button class="forum-profile-edit-avatar-btn" onclick="selectForumAvatar()">更换头像</button>
                </div>
                <div class="forum-profile-edit-form">
                    <label class="forum-profile-edit-label">论坛昵称</label>
                    <input type="text" id="forumProfileEditName" class="edit-modal-input" placeholder="输入你的论坛昵称">
                </div>
                <div class="forum-profile-edit-card-section">
                    <label class="forum-profile-edit-label">个人名片</label>
                    <div class="forum-profile-edit-card" id="forumProfileEditCard" onclick="selectForumCard()">
                        <div class="forum-profile-edit-card-placeholder" id="forumProfileEditCardPlaceholder">
                            <span>点击选择名片图片</span>
                        </div>
                    </div>
                    <button class="forum-profile-edit-card-btn" onclick="selectForumCard()">更换名片</button>
                </div>
            </div>
            <div class="edit-modal-buttons">
                <button class="edit-modal-btn cancel" onclick="closeForumProfileEdit()">取消</button>
                <button class="edit-modal-btn save" onclick="confirmSaveForumProfile()">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 底部输入框弹窗 -->
    <div id="forumInputModal" class="forum-input-modal">
        <div class="forum-input-modal-content">
            <div class="forum-input-modal-avatar" id="forumInputModalAvatar"></div>
            <div class="forum-input-modal-input-container">
                <textarea class="forum-input-modal-input" id="forumInputModalInput" placeholder="写下你的评论..." rows="1"></textarea>
            </div>
            <button class="forum-input-modal-send-btn" id="forumInputModalSendBtn" onclick="submitForumInput()">发</button>
        </div>
    </div>
    
    <!-- 转发弹窗 -->
    <div id="forumForwardModal" class="forum-forward-modal">
        <div class="forum-forward-content">
            <div class="forum-forward-header">
                <h3>转发到</h3>
                <button class="forum-forward-close" onclick="closeForumForwardModal()">×</button>
            </div>
            <div class="forum-forward-contacts" id="forumForwardContacts">
                <!-- 联系人列表将在这里动态生成 -->
            </div>
        </div>
    </div>
    
    <!-- 添加联系人弹窗 -->
    <div id="addContactModal" class="add-contact-modal">
        <div class="add-contact-content">
            <h2 class="add-contact-title">新建</h2>
            <div class="add-contact-options">
                <div class="add-contact-option selected" data-form="add-friend-form">添加好友</div>
                <div class="add-contact-option" data-form="group-chat-form">发起群聊</div>
            </div>
            
            <form class="add-contact-form show" id="add-friend-form">
                <div class="add-form-group">
                    <label for="friend-name">姓名</label>
                    <input type="text" id="friend-name" placeholder="请输入好友姓名">
                </div>
                
                <div class="add-form-group">
                    <label for="friend-avatar">头像</label>
                    <div class="avatar-upload-container">
                        <input type="file" id="friend-avatar" accept="image/*" style="display: none;">
                        <div class="avatar-upload-btn" onclick="document.getElementById('friend-avatar').click()">
                            <img id="friend-avatar-preview" src="https://placehold.co/60x60/E8E8E8/999?text=头像" alt="头像预览" class="avatar-preview">
                            <div class="avatar-upload-text">点击上传头像</div>
                        </div>
                    </div>
                </div>
                
                <div class="add-form-group">
                    <label for="friend-persona">人设</label>
                    <textarea id="friend-persona" placeholder="简单描述一下ta的性格特点"></textarea>
                </div>
                
                <div class="add-form-group">
                    <label for="character-file-upload">角色卡文件</label>
                    <div class="file-upload-container">
                        <input type="file" id="character-file-upload" accept=".json" style="display: none;">
                        <div class="file-upload-btn" onclick="document.getElementById('character-file-upload').click()">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                            </svg>
                            <span>上传角色卡文件</span>
                        </div>
                        <div class="file-upload-hint">支持JSON格式的角色卡文件，将自动提取角色信息</div>
                    </div>
                </div>
            </form>
            
            <div class="add-contact-form" id="group-chat-form">
                <div class="add-form-group">
                    <label>选择群成员</label>
                    <div class="group-members-list" id="groupMembersList">
                        <!-- 群成员列表将由JavaScript动态生成 -->
                    </div>
                </div>
            </div>
            
            <div class="add-contact-actions">
                <button class="add-contact-btn add-contact-btn-cancel" onclick="closeAddContactModal()">取消</button>
                <button class="add-contact-btn add-contact-btn-confirm" onclick="confirmAddContact()">确认</button>
            </div>
        </div>
    </div>
    
    <!-- 私聊界面 -->
    <div id="chatApp" class="chat-app">
        <div class="chat-header">
            <div class="chat-title-left">
                <img id="chatContactAvatar" src="https://placehold.co/40x40/E8E8E8/999?text=头像" alt="联系人头像" class="chat-contact-avatar">
                <div class="chat-contact-info">
                    <div id="chatContactName" class="chat-contact-name">联系人</div>
                    <div class="chat-status">
                        <div class="status-dot"></div>
                        在线
                    </div>
                </div>
            </div>
            <div style="flex:1"></div>
            <div class="chat-back-btn" onclick="closeChatApp()">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                    <path d="M10, 20V14H14V20H19V12H22L12, 3L2, 12H5V20H10Z"/>
                </svg>
            </div>
            <div class="chat-diary-btn" onclick="openDiaryModal()" title="角色日记">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M19,3H14.82C14.4,1.84 13.3,1 12,1C10.7,1 9.6,1.84 9.18,3H5C3.9,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.9 20.1,3 19,3M12,3C12.55,3 13,3.45 13,4C13,4.55 12.55,5 12,5C11.45,5 11,4.55 11,4C11,3.45 11.45,3 12,3M7,7H17V5H19V19H5V5H7V7Z"/>
                </svg>
            </div>
            <div class="chat-settings-btn" onclick="openContactSettings()">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z"/>
                </svg>
            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <!-- 聊天消息将由JavaScript动态生成 -->
        </div>
        <div id="multiselectToolbar" class="multiselect-toolbar">
            <div class="multiselect-action" onclick="forwardSelectedMessages()">转发</div>
            <div class="multiselect-action" onclick="deleteSelectedMessages()">删除</div>
            <div class="multiselect-action" onclick="favoriteSelectedMessages()">收藏</div>
            <div class="multiselect-action multiselect-cancel" onclick="exitMultiselectMode()">取消</div>
        </div>
        
        <!-- 聊天功能条 -->
        <div id="chatToolbar" class="chat-toolbar">
            <div class="chat-toolbar-content">
                <div class="chat-toolbar-item" onclick="openMusicTogether()">
                    <div class="chat-toolbar-icon">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path d="M12,3V13.55C11.41,13.21 10.73,13 10,13A4,4 0 0,0 6,17A4,4 0 0,0 10,21A4,4 0 0,0 14,17V7H18V3H12Z"/>
                        </svg>
                    </div>
                    <div class="chat-toolbar-text">一起听</div>
                </div>
                <div class="chat-toolbar-item" onclick="sendImage()">
                    <div class="chat-toolbar-icon">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z"/>
                        </svg>
                    </div>
                    <div class="chat-toolbar-text">图片</div>
                </div>
                <div class="chat-toolbar-item" onclick="sendTransfer()">
                    <div class="chat-toolbar-icon">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path d="M7,15H9C9,16.08 10.37,17 12,17C13.63,17 15,16.08 15,15C15,13.9 13.96,13.5 11.76,12.97C9.64,12.44 7,11.78 7,9C7,7.21 8.47,5.69 10.5,5.18V3H13.5V5.18C15.53,5.69 17,7.21 17,9H15C15,7.92 13.63,7 12,7C10.37,7 9,7.92 9,9C9,10.1 10.04,10.5 12.24,11.03C14.36,11.56 17,12.22 17,15C17,16.79 15.53,18.31 13.5,18.82V21H10.5V18.82C8.47,18.31 7,16.79 7,15Z"/>
                        </svg>
                    </div>
                    <div class="chat-toolbar-text">转账</div>
                </div>
                <div class="chat-toolbar-item" onclick="sendLocation()">
                    <div class="chat-toolbar-icon">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path d="M12,11.5A2.5,2.5 0 0,1 9.5,9A2.5,2.5 0 0,1 12,6.5A2.5,2.5 0 0,1 14.5,9A2.5,2.5 0 0,1 12,11.5M12,2A7,7 0 0,0 5,9C5,14.25 12,22 12,22S19,14.25 19,9A7,7 0 0,0 12,2Z"/>
                        </svg>
                    </div>
                    <div class="chat-toolbar-text">定位</div>
                </div>
                <div class="chat-toolbar-item" onclick="orderFood()">
                    <div class="chat-toolbar-icon">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
                        </svg>
                    </div>
                    <div class="chat-toolbar-text">点外卖</div>
                </div>
                <div class="chat-toolbar-item" onclick="sendEmoji()">
                    <div class="chat-toolbar-icon">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path d="M12,2C6.48,2 2,6.48 2,12C2,17.52 6.48,22 12,22C17.52,22 22,17.52 22,12C22,6.48 17.52,2 12,2M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M16.5,6C15.67,6 15,6.67 15,7.5C15,8.33 15.67,9 16.5,9C17.33,9 18,8.33 18,7.5C18,6.67 17.33,6 16.5,6M7.5,6C6.67,6 6,6.67 6,7.5C6,8.33 6.67,9 7.5,9C8.33,9 9,8.33 9,7.5C9,6.67 8.33,6 7.5,6M12,17.5C14.33,17.5 16.31,16.04 17.11,14H6.89C7.69,16.04 9.67,17.5 12,17.5Z"/>
                        </svg>
                    </div>
                    <div class="chat-toolbar-text">表情包</div>
                </div>
                <div class="chat-toolbar-item" onclick="sendVoice()">
                    <div class="chat-toolbar-icon">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path d="M12,14C13.66,14 15,12.66 15,11V5C15,3.34 13.66,2 12,2C10.34,2 9,3.34 9,5V11C9,12.66 10.34,14 12,14M19.1,9L20.5,10.4C20.8,10.7 20.8,11.2 20.5,11.5C20.2,11.8 19.7,11.8 19.4,11.5L18,10.1C17.7,9.8 17.7,9.3 18,9C18.3,8.7 18.8,8.7 19.1,9M4.9,9C5.2,8.7 5.7,8.7 6,9C6.3,9.3 6.3,9.8 6,10.1L4.6,11.5C4.3,11.8 3.8,11.8 3.5,11.5C3.2,11.2 3.2,10.7 3.5,10.4L4.9,9M12,16C8.13,16 5,12.87 5,9H7C7,11.76 9.24,14 12,14C14.76,14 17,11.76 17,9H19C19,12.87 15.87,16 12,16Z"/>
                        </svg>
                    </div>
                    <div class="chat-toolbar-text">语音</div>
                </div>
                <div class="chat-toolbar-item" onclick="videoCall()">
                    <div class="chat-toolbar-icon">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path d="M17,10.5V7A1,1 0 0,0 16,6H4A1,1 0 0,0 3,7V17A1,1 0 0,0 4,18H16A1,1 0 0,0 17,17V13.5L21,17.5V6.5L17,10.5Z"/>
                        </svg>
                    </div>
                    <div class="chat-toolbar-text">通话</div>
                </div>
                <div class="chat-toolbar-item" onclick="openFavorites()">
                    <div class="chat-toolbar-icon">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path d="M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z"/>
                        </svg>
                    </div>
                    <div class="chat-toolbar-text">收藏</div>
                </div>
                <div class="chat-toolbar-item" onclick="openScreenShare()">
                    <div class="chat-toolbar-icon">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path d="M8,5.14V19.14L19,12.14L8,5.14Z"/>
                        </svg>
                    </div>
                    <div class="chat-toolbar-text">屏幕共享</div>
                </div>
            </div>
        </div>
        
        <div class="chat-input">
            <div id="replyPreview" class="reply-preview"><span id="replyPreviewText"></span><span class="close-reply" onclick="clearReplyTarget()">×</span></div>
            <button class="chat-plus-btn" onclick="openChatMenu()" title="打开功能菜单">+</button>
            <input type="text" id="chatInputField" class="chat-input-field" placeholder="输入消息..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
            <button class="chat-send-btn" onclick="sendComplete()">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
            </button>
        </div>
        <div id="messageMenu" class="message-menu">
            <div class="message-menu-item" id="menuSelectMany" onclick="enterMultiselectMode()">多选</div>
            <div class="message-menu-item" id="menuQuote" onclick="quoteSelectedMessage()">引用</div>
            <div class="message-menu-item" id="menuRecall" onclick="recallSelectedMessage()">撤回</div>
        </div>
    </div>
    
    <!-- 屏幕共享弹窗 -->
    <div id="screenShareModal" class="screen-share-modal">
        <div class="screen-share-content">
            <div class="screen-share-header">
                <div class="screen-share-title">屏幕共享</div>
                <div class="screen-share-controls">
                    <div class="screen-share-regenerate" onclick="regenerateScreenShare()" title="重新生成">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"/>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="screen-share-grid">
                <div class="screen-share-item" onclick="openSMS()">
                    <div class="screen-share-icon">
                        <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
                            <path d="M20,2H4A2,2 0 0,0 2,4V22L6,18H20A2,2 0 0,0 22,16V4A2,2 0 0,0 20,2M20,16H5.17L4,17.17V4H20V16Z"/>
                        </svg>
                    </div>
                    <div class="screen-share-label">短信</div>
                </div>
                
                <div class="screen-share-item" onclick="openShopping()">
                    <div class="screen-share-icon">
                        <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
                            <path d="M7,4V2A1,1 0 0,1 8,1H16A1,1 0 0,1 17,2V4H20A1,1 0 0,1 21,5V7A1,1 0 0,1 20,8H19V19A1,1 0 0,1 18,20H6A1,1 0 0,1 5,19V8H4A1,1 0 0,1 3,7V5A1,1 0 0,1 4,4H7M9,3V4H15V3H9M7,6V19H17V6H7Z"/>
                        </svg>
                    </div>
                    <div class="screen-share-label">购物</div>
                </div>
                
                <div class="screen-share-item" onclick="openBrowser()">
                    <div class="screen-share-icon">
                        <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
                            <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
                        </svg>
                    </div>
                    <div class="screen-share-label">浏览器</div>
                </div>
                
                <div class="screen-share-item" onclick="openMemo()">
                    <div class="screen-share-icon">
                        <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                    </div>
                    <div class="screen-share-label">备忘录</div>
                </div>
                
                <div class="screen-share-item" onclick="openFootprint()">
                    <div class="screen-share-icon">
                        <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
                            <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
                        </svg>
                    </div>
                    <div class="screen-share-label">足迹</div>
                </div>
            </div>
            
            <div class="screen-share-footer">
                <button class="screen-share-close" onclick="closeScreenShare()">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- 图片上传弹窗 -->
    <div id="imageUploadModal" class="modal-overlay">
        <div class="modal-content image-upload-modal">
            <div class="modal-header">
                <h3>选择图片</h3>
                <span class="modal-close" onclick="closeImageUploadModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="image-upload-area" onclick="document.getElementById('imageFileInput').click()">
                    <div class="image-upload-icon">📷</div>
                    <div class="image-upload-text">点击选择图片</div>
                    <div class="image-upload-hint">支持 JPG、PNG、GIF 格式</div>
                </div>
                <input type="file" id="imageFileInput" accept="image/*" style="display: none;">
                <div id="imagePreview" class="image-preview" style="display: none;">
                    <img id="previewImage" src="" alt="预览图片">
                    <div class="image-preview-actions">
                        <button class="btn-secondary" onclick="clearImagePreview()">重新选择</button>
                        <button class="btn-primary" onclick="sendImageMessage()">发送</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 一起听音乐弹窗 -->
    <div id="musicTogetherModal" class="modal-overlay">
        <div class="modal-content music-together-modal">
            <div class="modal-header">
                <h3>🎵 和${currentChatContact ? currentChatContact.name : '角色'}一起听音乐</h3>
                <span class="modal-close" onclick="closeMusicTogetherModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="music-together-container">
                    <div class="music-player">
                        <div class="music-cover">
                            <div class="music-cover-image" id="musicCoverImage">🎵</div>
                        </div>
                        <div class="music-info">
                            <div class="music-title" id="musicTitle">选择一首歌开始</div>
                            <div class="music-artist" id="musicArtist">和${currentChatContact ? currentChatContact.name : '角色'}一起听</div>
                        </div>
                        <div class="music-controls">
                            <button class="music-btn" onclick="previousMusic()">⏮</button>
                            <button class="music-btn play-btn" id="playPauseBtn" onclick="togglePlayPause()">▶</button>
                            <button class="music-btn" onclick="nextMusic()">⏭</button>
                        </div>
                        <div class="music-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="time-display">
                                <span id="currentTime">0:00</span>
                                <span id="totalTime">0:00</span>
                            </div>
                        </div>
                    </div>
                    <div class="music-playlist">
                        <div class="playlist-header">推荐歌单</div>
                        <div class="playlist-items" id="musicPlaylist">
                            <div class="playlist-item" onclick="selectMusic('安静', '周杰伦', 'https://files.catbox.moe/quiet.mp3')">
                                <div class="playlist-cover">🎵</div>
                                <div class="playlist-info">
                                    <div class="playlist-title">安静</div>
                                    <div class="playlist-artist">周杰伦</div>
                                </div>
                            </div>
                            <div class="playlist-item" onclick="selectMusic('稻香', '周杰伦', 'https://files.catbox.moe/daoxiang.mp3')">
                                <div class="playlist-cover">🌾</div>
                                <div class="playlist-info">
                                    <div class="playlist-title">稻香</div>
                                    <div class="playlist-artist">周杰伦</div>
                                </div>
                            </div>
                            <div class="playlist-item" onclick="selectMusic('青花瓷', '周杰伦', 'https://files.catbox.moe/qinghuaci.mp3')">
                                <div class="playlist-cover">🏺</div>
                                <div class="playlist-info">
                                    <div class="playlist-title">青花瓷</div>
                                    <div class="playlist-artist">周杰伦</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 转账弹窗 -->
    <div id="transferModal" class="modal-overlay">
        <div class="modal-content transfer-modal">
            <div class="modal-header">
                <h3>转账</h3>
                <span class="modal-close" onclick="closeTransferModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="transfer-amount-section">
                    <label>金额</label>
                    <div class="transfer-amount-input">
                        <span class="currency-symbol">¥</span>
                        <input type="number" id="transferAmount" placeholder="0.00" step="0.01" min="0.01">
                    </div>
                </div>
                <div class="transfer-note-section">
                    <label>备注</label>
                    <textarea id="transferNote" placeholder="添加转账备注..." rows="3"></textarea>
                </div>
                <div class="transfer-actions">
                    <button class="btn-secondary" onclick="closeTransferModal()">取消</button>
                    <button class="btn-primary" onclick="sendTransferMessage()">发送</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 定位弹窗 -->
    <div id="locationModal" class="modal-overlay">
        <div class="modal-content location-modal">
            <div class="modal-header">
                <h3>发送位置</h3>
                <span class="modal-close" onclick="closeLocationModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="location-address-section">
                    <label>地址</label>
                    <input type="text" id="locationAddress" placeholder="请输入地址...">
                </div>
                <div class="location-actions">
                    <button class="btn-secondary" onclick="closeLocationModal()">取消</button>
                    <button class="btn-primary" onclick="sendLocationMessage()">发送</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 点外卖弹窗 -->
    <div id="foodOrderModal" class="modal-overlay">
        <div class="modal-content food-order-modal">
            <div class="modal-header">
                <h3>点外卖</h3>
                <span class="modal-close" onclick="closeFoodOrderModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="food-order-section">
                    <label>餐厅/菜品</label>
                    <input type="text" id="foodOrderName" placeholder="请输入餐厅或菜品名称...">
                </div>
                <div class="food-order-amount-section">
                    <label>金额</label>
                    <div class="food-order-amount-input">
                        <span class="currency-symbol">¥</span>
                        <input type="number" id="foodOrderAmount" placeholder="0.00" step="0.01" min="0.01">
                    </div>
                </div>
                <div class="food-order-note-section">
                    <label>备注</label>
                    <textarea id="foodOrderNote" placeholder="添加订单备注..." rows="3"></textarea>
                </div>
                <div class="food-order-image-section">
                    <label>食物图片（可选）</label>
                    <div class="food-order-image-upload" onclick="document.getElementById('foodOrderImageInput').click()">
                        <div class="food-order-image-icon">📷</div>
                        <div class="food-order-image-text">点击添加食物图片</div>
                    </div>
                    <input type="file" id="foodOrderImageInput" accept="image/*" style="display: none;">
                    <div id="foodOrderImagePreview" class="food-order-image-preview" style="display: none;">
                        <img id="foodOrderPreviewImage" src="" alt="食物图片预览">
                        <button class="btn-remove" onclick="clearFoodOrderImagePreview()">×</button>
                    </div>
                </div>
                <div class="food-order-actions">
                    <button class="btn-secondary" onclick="closeFoodOrderModal()">取消</button>
                    <button class="btn-primary" onclick="sendFoodOrderMessage()">发送</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 语音文字弹窗 -->
    <div id="voiceTextModal" class="modal-overlay">
        <div class="modal-content voice-text-modal">
            <div class="modal-header">
                <h3>语音消息</h3>
                <span class="modal-close" onclick="closeVoiceTextModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="voice-text-section">
                    <label>语音内容</label>
                    <textarea id="voiceTextContent" placeholder="输入语音转文字的内容..." rows="4"></textarea>
                </div>
                <div class="voice-text-actions">
                    <button class="btn-secondary" onclick="closeVoiceTextModal()">取消</button>
                    <button class="btn-primary" onclick="sendVoiceTextMessage()">发送</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 转发消息弹窗 -->
    <div id="forwardModal" class="modal-overlay">
        <div class="modal-content forward-modal">
            <div class="modal-header">
                <h3>转发给谁</h3>
                <span class="modal-close" onclick="closeForwardModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="forward-friends-list" id="forwardFriendsList">
                    <!-- 好友列表将由JavaScript动态生成 -->
                </div>
                <div class="forward-actions">
                    <button class="btn-secondary" onclick="closeForwardModal()">取消</button>
                    <button class="btn-primary" onclick="confirmForwardMessages()">确认转发</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 收藏标题输入弹窗 -->
    <div id="favoriteModal" class="modal-overlay">
        <div class="modal-content favorite-modal">
            <div class="modal-header">
                <h3>收藏消息</h3>
                <span class="modal-close" onclick="closeFavoriteModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="favorite-form">
                    <div class="form-group">
                        <label for="favoriteTitle">收藏标题</label>
                        <input type="text" id="favoriteTitle" placeholder="请输入收藏标题..." maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>选中的消息</label>
                        <div class="selected-messages-preview" id="selectedMessagesPreview">
                            <!-- 选中的消息预览 -->
                        </div>
                    </div>
                </div>
                <div class="favorite-actions">
                    <button class="btn-secondary" onclick="closeFavoriteModal()">取消</button>
                    <button class="btn-primary" onclick="confirmFavorite()">收藏</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 收藏列表弹窗 -->
    <div id="favoritesListModal" class="modal-overlay">
        <div class="modal-content favorites-modal">
            <div class="modal-header">
                <h3>我的收藏</h3>
                <span class="modal-close" onclick="closeFavoritesListModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="favorites-list" id="favoritesList">
                    <!-- 收藏列表将由JavaScript动态生成 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 视频通话弹窗 -->
    <div id="videoCallModal" class="modal-overlay">
        <div class="modal-content video-call-modal">
            <div class="modal-header">
                <h3>视频通话</h3>
                <span class="modal-close" onclick="closeVideoCallModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="video-call-info">
                    <div class="video-call-avatar">
                        <img id="videoCallAvatar" src="" alt="联系人头像">
                    </div>
                    <div class="video-call-name" id="videoCallName">正在呼叫...</div>
                    <div class="video-call-status" id="videoCallStatus">等待对方接听</div>
                </div>
                <div class="video-call-actions">
                    <button class="btn-call-end" onclick="endVideoCall()">挂断</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 图片大图预览层 -->
    <div id="imageLightbox" class="image-lightbox" onclick="closeImageLightbox()">
        <img id="lightboxImage" src="" alt="预览大图">
    </div>

    <!-- 表情包弹窗 -->
    <div id="emojiModal" class="emoji-modal">
        <div class="emoji-modal-content">
            <div class="emoji-modal-header">
                <div class="emoji-upload-btn" onclick="uploadEmoji()">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                </div>
                <div class="emoji-modal-title">表情包</div>
                <div class="emoji-modal-close" onclick="closeEmojiModal()">×</div>
            </div>
            <div class="emoji-modal-body" id="emojiContainer">
                <!-- 表情包内容将由JavaScript动态生成 -->
            </div>
        </div>
    </div>

    <!-- 通话选择弹窗 -->
    <div id="callModal" class="call-modal">
        <div class="call-modal-content">
            <div class="call-modal-title"></div>
            <div class="call-options">
                <button class="call-option-btn" onclick="initiateVoiceCall()">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z"/>
                    </svg>
                    <span>语音通话</span>
                </button>
                <button class="call-option-btn" onclick="initiateVideoCall()">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M17,10.5V7A1,1 0 0,0 16,6H4A1,1 0 0,0 3,7V17A1,1 0 0,0 4,18H16A1,1 0 0,0 17,17V13.5L21,17.5V6.5L17,10.5Z"/>
                    </svg>
                    <span>视频通话</span>
                </button>
                <button class="call-option-btn call-cancel" onclick="closeCallModal()">
                    <span>取消</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 语音通话来电弹窗 -->
    <div id="voiceInviteModal" class="call-modal">
        <div class="call-modal-content">
            <div class="incoming-call-avatar">
                <img id="voiceInviteAvatar" src="" alt="头像">
            </div>
            <div class="incoming-call-name" id="voiceInviteName">联系人</div>
            <div class="incoming-call-type">向你发起语音通话</div>
            <div class="incoming-call-buttons">
                <button class="call-decline-btn" onclick="declineVoiceCall()">
                    <svg viewBox="0 0 24 24" width="22" height="22" fill="white">
                        <path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9c-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/>
                    </svg>
                </button>
                <button class="call-accept-btn" onclick="acceptVoiceCall()">
                    <svg viewBox="0 0 24 24" width="22" height="22" fill="white">
                        <path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- 视频通话来电弹窗 -->
    <div id="videoInviteModal" class="call-modal">
        <div class="call-modal-content">
            <div class="incoming-call-avatar">
                <img id="videoInviteAvatar" src="" alt="头像">
            </div>
            <div class="incoming-call-name" id="videoInviteName">联系人</div>
            <div class="incoming-call-type">向你发起视频通话</div>
            <div class="incoming-call-buttons">
                <button class="call-decline-btn" onclick="declineVideoCall()">
                    <svg viewBox="0 0 24 24" width="22" height="22" fill="white">
                        <path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9c-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/>
                    </svg>
                </button>
                <button class="call-accept-btn" onclick="acceptVideoCall()">
                    <svg viewBox="0 0 24 24" width="22" height="22" fill="white">
                        <path d="M17,10.5V7A1,1 0 0,0 16,6H4A1,1 0 0,0 3,7V17A1,1 0 0,0 4,18H16A1,1 0 0,0 17,17V13.5L21,17.5V6.5L17,10.5Z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- 语音通话界面 -->
    <div id="voiceCallInterface" class="voice-call-interface">
        <div class="voice-call-interface-content">
            <!-- 头像区域 -->
            <div class="call-avatar-section">
                <div class="call-avatar">
                    <img id="voiceCallAvatar" src="" alt="头像">
                </div>
                <div class="call-name" id="voiceCallName">联系人</div>
                <div class="call-status" id="voiceCallStatus">正在通话中...</div>
            </div>
            
            <!-- 聊天区域 -->
            <div class="call-chat-section">
                <div class="call-chat-messages" id="voiceCallChatMessages">
                    <!-- 聊天消息将在这里显示 -->
                </div>
            </div>
            
            <!-- 输入区域 -->
            <div class="call-input-section" id="voiceCallInputSection" style="display: none;">
                <div class="call-input-container">
                    <input type="text" id="voiceCallTextInput" placeholder="输入消息..." class="call-text-input">
                    <button class="call-send-btn" onclick="sendVoiceCallMessage()">发送</button>
                </div>
            </div>
            
            <!-- 底部操作按钮 -->
            <div class="call-actions">
                <button class="call-action-btn call-record" onclick="toggleVoiceCallInput()">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M12,14C13.66,14 15,12.66 15,11V5C15,3.34 13.66,2 12,2C10.34,2 9,3.34 9,5V11C9,12.66 10.34,14 12,14M17,11C17,14.53 14.39,17.43 11,17.92V21H13V19H15V21H17V17.92C13.61,17.43 11,14.53 11,11H9C9,14.53 11.61,17.43 15,17.92V21H17V17.92C20.39,17.43 23,14.53 23,11H21C21,14.53 18.39,17.43 15,17.92V21H13V17.92C16.39,17.43 19,14.53 19,11H17Z"/>
                    </svg>
                </button>
                <button class="call-action-btn call-hangup" onclick="hangupVoiceCall()">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9c-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11-.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- 视频通话界面 -->
    <div id="videoCallInterface" class="video-call-interface">
        <div class="video-call-interface-content">
            <!-- 挂断按钮 - 左上角 -->
            <button class="video-call-hangup-btn" onclick="hangupVideoCall()">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                    <path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9c-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/>
                </svg>
            </button>
            
            <!-- 人物立绘区域 -->
            <div class="video-call-character-section">
                <div class="video-call-character" id="videoCallCharacter">
                    <img id="videoCallCharacterImage" src="" alt="角色立绘">
                </div>
            </div>
            
            <!-- 对话框区域 -->
            <div class="video-call-dialog-section">
                <div class="video-call-dialog-box">
                    <div class="video-call-dialog-content" id="videoCallDialogContent">
                        <!-- 对话内容将在这里显示 -->
                    </div>
                </div>
                
                <!-- 输入区域 - 在对话框底部 -->
                <div class="video-call-input-section">
                    <input type="text" id="videoCallTextInput" placeholder="输入消息..." class="video-call-text-input">
                    <button class="video-call-send-btn" onclick="sendVideoCallMessage()">发送</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 角色日记全屏页面 -->
    <div id="diaryApp" class="diary-app">
        <div class="diary-header">
            <div class="diary-back-btn" onclick="closeDiaryDetail()">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M10, 20V14H14V20H19V12H22L12, 3L2, 12H5V20H10Z"/>
                </svg>
            </div>
            <div class="diary-title" id="diaryTitle">角色日记</div>
            <div class="diary-header-actions">
                <div class="diary-action-btn" onclick="openDiaryHistory()" title="日记历史">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
                    </svg>
                </div>
                <div class="diary-action-btn" onclick="openDiarySettings()" title="日记设置">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                    </svg>
                </div>
            </div>
        </div>
        <div class="diary-content" id="diaryContent">
            <!-- 日记内容将由JavaScript动态生成 -->
        </div>
    </div>

    <!-- 日记历史页面 -->
    <div id="diaryHistoryApp" class="diary-app">
        <div class="diary-header">
            <div class="diary-back-btn" onclick="closeDiaryHistory()">‹</div>
            <div class="diary-title">日记历史</div>
        </div>
        <div class="diary-history-content" id="diaryHistoryContent">
            <!-- 日记历史列表将由JavaScript动态生成 -->
        </div>
    </div>

    <!-- 日记设置页面 -->
    <div id="diarySettingsApp" class="diary-app">
        <div class="diary-header">
            <div class="diary-back-btn" onclick="closeDiarySettings()">‹</div>
            <div class="diary-title">日记设置</div>
        </div>
        <div class="diary-settings-content" id="diarySettingsContent">
            <div class="diary-settings-form">
                <div class="diary-form-group">
                    <label class="diary-form-label" for="diarySummaryCount">AI总结条数（0-500）</label>
                    <input type="number" id="diarySummaryCount" class="diary-form-input" min="0" max="500" step="10" placeholder="默认 200">
                    <div class="diary-form-hint">AI将根据最近多少条聊天记录来生成日记，数值越大包含的内容越丰富。</div>
                </div>
                <div class="diary-form-actions">
                    <button class="diary-form-btn diary-form-btn-primary" onclick="saveDiarySettings()">保存设置</button>
                    <button class="diary-form-btn diary-form-btn-secondary" onclick="generateDiary()">生成新日记</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 设置界面 -->
    <div id="settingsApp" class="settings-app">
        <div class="settings-header">
            <div class="settings-back-btn" onclick="closeSettingsApp()">‹</div>
            <h1 class="settings-title">设置</h1>
            <div style="width: 32px;"></div>
        </div>
        
        <div class="settings-content">
            <div class="settings-section">
                <div class="settings-section-title">
                    <svg class="settings-section-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
                    </svg>
                    AI 配置
                </div>
                
                <div class="settings-option">
                    <div class="settings-option-label">当前模型</div>
                    <div class="settings-option-value" id="aiModelValue">未选择</div>
                </div>
                
                <div class="settings-option" onclick="openAIConfig()">
                    <div class="settings-option-label">AI 服务商</div>
                    <div class="settings-option-value" id="aiProviderValue">未配置</div>
                    <svg class="settings-option-arrow" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/>
                    </svg>
                </div>
                
                <div class="settings-option">
                    <div class="settings-option-label">AI 状态</div>
                    <div class="settings-option-value" id="aiStatusValue">未连接</div>
                </div>
                
                <div class="settings-option">
                    <div class="settings-option-label">语音模型</div>
                    <div class="settings-option-value" id="voiceModelValue">MiniMax</div>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">
                    <svg class="settings-section-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                    </svg>
                    其他设置
                </div>
                
                <div class="settings-option">
                    <div class="settings-option-label">主题</div>
                    <div class="settings-option-value">默认</div>
                    <svg class="settings-option-arrow" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/>
                    </svg>
                </div>
                
                <div class="settings-option" onclick="openDesktopWallpaperModal()">
                    <div class="settings-option-label">桌面壁纸</div>
                    <div class="settings-option-value" id="desktopWallpaperValue">默认</div>
                    <svg class="settings-option-arrow" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/>
                    </svg>
                </div>
                
                <div class="settings-option">
                    <div class="settings-option-label">通知</div>
                    <div class="settings-option-value">已开启</div>
                    <svg class="settings-option-arrow" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/>
                    </svg>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">
                    <svg class="settings-section-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
                    </svg>
                    数据管理
                </div>
                
                <div class="settings-option" onclick="exportAllData()">
                    <div class="settings-option-label">导出数据</div>
                    <div class="settings-option-value">备份所有数据</div>
                    <svg class="settings-option-arrow" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/>
                    </svg>
                </div>
                
                <div class="settings-option" onclick="importData()">
                    <div class="settings-option-label">导入数据</div>
                    <div class="settings-option-value">覆盖现有数据</div>
                    <svg class="settings-option-arrow" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/>
                    </svg>
                </div>
                
                <div class="settings-option" onclick="cleanupRedundantData()">
                    <div class="settings-option-label">清理冗余数据</div>
                    <div class="settings-option-value">删除历史数据</div>
                    <svg class="settings-option-arrow" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI配置弹窗 -->
    <div id="aiConfigModal" class="ai-config-modal">
        <div class="ai-config-content">
            <h2 class="ai-config-title">AI 配置</h2>
            
            <div class="ai-provider-options">
                <div class="ai-provider-option" data-provider="deepseek">
                    <div class="ai-provider-icon deepseek">DS</div>
                    <div class="ai-provider-name">DeepSeek</div>
                </div>
                <div class="ai-provider-option" data-provider="google">
                    <div class="ai-provider-icon google">G</div>
                    <div class="ai-provider-name">Google AI</div>
                </div>
                <div class="ai-provider-option" data-provider="openai">
                    <div class="ai-provider-icon openai">O</div>
                    <div class="ai-provider-name">OpenAI</div>
                </div>
                <div class="ai-provider-option" data-provider="custom">
                    <div class="ai-provider-icon custom">C</div>
                    <div class="ai-provider-name">自定义反代</div>
                </div>
            </div>
            
            <div class="ai-config-form" id="aiConfigForm">
                <div class="ai-form-group" id="customUrlGroup" style="display: none;">
                    <label class="ai-form-label" for="aiCustomUrl">自定义 API 地址</label>
                    <input type="url" id="aiCustomUrl" class="ai-form-input" placeholder="https://api.example.com/v1">
                </div>
                
                <div class="ai-form-group">
                    <label class="ai-form-label" for="aiApiKey">API 密钥</label>
                    <input type="password" id="aiApiKey" class="ai-form-input" placeholder="请输入 API 密钥">
                </div>
                
                <div class="ai-form-group">
                    <label class="ai-form-label" for="aiModel">AI 模型</label>
                    <select id="aiModel" class="ai-form-input">
                        <option value="">请选择模型</option>
                    </select>
                    <button class="ai-form-btn ai-form-btn-primary" type="button" onclick="fetchModelsToSelect()" style="margin-top:8px; width:100%;">拉取模型</button>
                    <div id="aiModelFetchedList" style="margin-top:8px; display:none;"></div>
                </div>
                
                <div class="ai-loading" id="aiLoading">
                    <div class="ai-loading-spinner"></div>
                    <span>正在拉取模型列表...</span>
                </div>
                
                <div class="ai-form-actions">
                    <button class="ai-form-btn ai-form-btn-primary" id="aiTestBtn" onclick="testAIConnection()" style="width:100%; margin-bottom:12px;">测试连接</button>
                    <div style="display:flex; gap:8px;">
                        <button class="ai-form-btn ai-form-btn-cancel" onclick="closeAIConfig()" style="flex:1;">取消</button>
                        <button class="ai-form-btn ai-form-btn-primary" id="aiSaveBtn" onclick="saveAIConfig()" style="flex:1;">保存配置</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 动态规则设置弹窗 -->
    <div id="momentRulesModal" class="ai-config-modal">
        <div class="ai-config-content">
            <h2 class="ai-config-title">动态规则设置</h2>
            
            <div class="ai-form-group">
                <label class="ai-form-label">AI发动态的内容规则</label>
                <textarea id="momentRulesText" class="ai-form-input" rows="6" placeholder="例如：让AI发一些日常生活、心情感悟、美食分享等内容">让AI根据角色人设，发布一些日常生活动态，如：心情感悟、美食分享、天气感受、读书心得、朋友聚会等内容。要求真实自然，不要太刻意。</textarea>
            </div>
            
            <div class="ai-form-actions">
                <button class="ai-form-btn ai-form-btn-cancel" onclick="closeMomentRulesModal()">取消</button>
                <button class="ai-form-btn ai-form-btn-primary" onclick="saveMomentRules()">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 桌面壁纸选择弹窗 -->
    <div id="desktopWallpaperModal" class="ai-config-modal">
        <div class="ai-config-content">
            <h2 class="ai-config-title">桌面壁纸</h2>
            
            <div class="contact-wallpaper-upload">
                <button type="button" class="wallpaper-upload-btn" onclick="document.getElementById('desktopWallpaperUploadInput').click()">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                    上传自定义壁纸
                </button>
                <input type="file" id="desktopWallpaperUploadInput" accept="image/*" style="display: none;" onchange="handleDesktopWallpaperUpload('desktopWallpaperUploadInput')">
            </div>
            
            <div class="contact-wallpaper-options" id="desktopWallpaperOptions">
                <!-- 自定义壁纸将在这里动态添加 -->
            </div>
            
            <div class="ai-form-actions">
                <button class="ai-form-btn ai-form-btn-cancel" onclick="closeDesktopWallpaperModal()">取消</button>
                <button class="ai-form-btn ai-form-btn-primary" onclick="saveDesktopWallpaper()">确定</button>
            </div>
        </div>
    </div>
    
    
    <!-- 联系人设置弹窗 -->
    <div id="contactSettingsModal" class="contact-settings-modal">
        <div class="contact-settings-content">
            <h2 class="contact-settings-title">联系人设置</h2>
            
            <div class="contact-settings-tabs">
                <div class="contact-settings-tab active" data-tab="contact">联系人</div>
                <div class="contact-settings-tab" data-tab="self">自己</div>
            </div>
            
            <!-- 联系人设置表单 -->
            <div class="contact-settings-form show" id="contactForm">
                <div class="contact-form-group">
                    <label class="contact-form-label">联系人头像</label>
                    <div class="contact-avatar-upload">
                        <img id="contactAvatarPreview" src="" alt="" class="contact-avatar-preview" onclick="document.getElementById('contactAvatarInput').click()">
                        <input type="file" id="contactAvatarInput" accept="image/*" style="display: none;">
                    </div>
                </div>
                
                <div class="contact-form-group">
                    <label class="contact-form-label" for="contactName">联系人姓名</label>
                    <input type="text" id="contactName" class="contact-form-input" placeholder="请输入联系人姓名">
                </div>
                
                <div class="contact-form-group">
                    <label class="contact-form-label" for="contactPersona">联系人人设</label>
                    <textarea id="contactPersona" class="contact-form-textarea" placeholder="请描述联系人的性格特点、说话方式等..."></textarea>
                </div>
                
                <div class="contact-form-group">
                    <label class="contact-form-label" for="contactContextTurns">AI 上下文条数（0-200）</label>
                    <input type="number" id="contactContextTurns" class="contact-form-input" min="0" max="200" step="1" placeholder="默认 20">
                    <div style="font-size:12px;color:#777;margin-top:4px;">用于决定AI回复时读取的最近聊天条数。</div>
                </div>
                
                <!-- 角色表情栏目 -->
                <div class="character-emotions-section">
                    <label class="contact-form-label">角色表情</label>
                    <div class="emotions-description">
                        <p style="font-size: 12px; color: #666; margin: 4px 0 8px 0;">
                            设置AI角色的表情包，格式：名字：链接，例如：开心：https://example.com/happy.gif
                        </p>
                    </div>
                    <div class="emotions-input-container">
                        <textarea 
                            id="characterEmotions" 
                            class="emotions-textarea" 
                            placeholder="开心：https://example.com/happy.gif&#10;难过：https://example.com/sad.gif&#10;生气：https://example.com/angry.gif&#10;惊讶：https://example.com/surprised.gif"
                            rows="6"
                        ></textarea>
                        <div class="emotions-actions">
                            <button type="button" class="emotions-btn" onclick="addEmotionTemplate()">添加模板</button>
                            <button type="button" class="emotions-btn" onclick="testEmotion()">测试表情</button>
                            <button type="button" class="emotions-btn" onclick="clearEmotions()">清空</button>
                        </div>
                    </div>
                </div>

                <!-- 角色通话立绘栏目 -->
                <div class="character-call-image-section">
                    <label class="contact-form-label">角色通话立绘</label>
                    <div class="call-image-description">
                        <p style="font-size: 12px; color: #666; margin: 4px 0 8px 0;">
                            视频通话时显示的角色立绘，非图片
                        </p>
                    </div>
                    <div class="call-image-upload-container">
                        <div class="call-image-preview" id="callImagePreview">
                            <img id="callImagePreviewImg" src="" alt="通话立绘预览" style="display: none;">
                            <div id="callImagePlaceholder" class="call-image-placeholder">
                                <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                                    <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1H5C3.89 1 3 1.89 3 3V21C3 22.11 3.89 23 5 23H19C20.11 23 21 22.11 21 21V9M19 9H14V4H19V9Z"/>
                                </svg>
                                <span>点击上传立绘</span>
                            </div>
                        </div>
                        <input type="file" id="callImageUpload" accept="image/*" style="display: none;" onchange="handleCallImageUpload(event)">
                        <button type="button" class="call-image-upload-btn" onclick="document.getElementById('callImageUpload').click()">
                            选择立绘图片
                        </button>
                        <button type="button" class="call-image-clear-btn" id="callImageClearBtn" onclick="clearCallImage()" style="display: none;">
                            清除立绘
                        </button>
                    </div>
                </div>

                <div class="contact-wallpaper-section">
                    <label class="contact-form-label">聊天壁纸</label>
                    <div class="contact-wallpaper-upload">
                        <button type="button" class="wallpaper-upload-btn" onclick="document.getElementById('wallpaperUploadInput').click()">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                            </svg>
                            上传自定义壁纸
                        </button>
                        <input type="file" id="wallpaperUploadInput" accept="image/*" style="display: none;" onchange="handleWallpaperUpload('wallpaperUploadInput', false)">
                    </div>

                    <!-- 联系人操作 -->
                    <div class="contact-danger-actions" style="margin-top: 16px; display: grid; grid-template-columns: 1fr; gap: 8px;">
                        <button type="button" class="contact-settings-btn" style="background:#fff;color:#6C8CD5;border:1px solid #6C8CD5" onclick="blockCurrentContact()">拉黑好友</button>
                        <button type="button" class="contact-settings-btn" style="background:#fff;color:#6C8CD5;border:1px solid #6C8CD5" onclick="clearCurrentChatHistory()">清空聊天记录</button>
                        <button type="button" class="contact-settings-btn" style="background:#fff;color:#dc3545;border:1px solid #dc3545" onclick="deleteCurrentContact()">删除好友</button>
                    </div>
                </div>
            </div>
            
            <!-- 自己设置表单 -->
            <div class="contact-settings-form" id="selfForm">
                <div class="contact-form-group">
                    <label class="contact-form-label">我的头像</label>
                    <div class="contact-avatar-upload">
                        <img id="selfAvatarPreview" src="https://placehold.co/60x60/E8E8E8/999?text=我" alt="" class="contact-avatar-preview" onclick="document.getElementById('selfAvatarInput').click()">
                        <input type="file" id="selfAvatarInput" accept="image/*" style="display: none;">
                    </div>
                </div>
                
                <div class="contact-form-group">
                    <label class="contact-form-label" for="selfName">我的姓名</label>
                    <input type="text" id="selfName" class="contact-form-input" placeholder="请输入你的姓名" value="我">
                </div>
                
                <div class="contact-form-group">
                    <label class="contact-form-label" for="selfPersona">我的人设</label>
                    <textarea id="selfPersona" class="contact-form-textarea" placeholder="请描述你的性格特点、说话方式等..."></textarea>
                </div>
            </div>
            
            <div class="contact-settings-actions">
                <button class="contact-settings-btn contact-settings-btn-cancel" onclick="closeContactSettings()">取消</button>
                <button class="contact-settings-btn contact-settings-btn-save" onclick="saveContactSettings()">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 群聊设置弹窗 -->
    <div id="groupSettingsModal" class="group-settings-modal">
        <div class="group-settings-content">
            <h2 class="group-settings-title">群聊设置</h2>
            
            <!-- 群聊信息设置 -->
            <div class="group-info-section">
                <div class="contact-form-group">
                    <label class="contact-form-label">群聊头像</label>
                    <div class="group-avatar-upload">
                        <img id="groupAvatarPreview" src="" alt="" class="group-avatar-preview" onclick="document.getElementById('groupAvatarInput').click()">
                        <div class="group-avatar-upload-btn" onclick="document.getElementById('groupAvatarInput').click()">
                            点击更换群头像
                        </div>
                        <input type="file" id="groupAvatarInput" accept="image/*" style="display: none;">
                    </div>
                </div>
                
                <div class="contact-form-group">
                    <label class="contact-form-label" for="groupName">群聊名称</label>
                    <input type="text" id="groupName" class="contact-form-input" placeholder="请输入群聊名称">
                </div>
            </div>
            
            <!-- 群成员管理 -->
            <div class="group-members-section">
                <div class="group-members-header">
                    <div class="group-members-title">群成员</div>
                    <button class="group-add-member-btn" onclick="openAddMemberModal()">+</button>
                </div>
                
                <div class="group-members-list" id="groupMembersList">
                    <!-- 群成员列表将由JavaScript动态生成 -->
                </div>
            </div>
            
            <!-- 群聊操作 -->
            <div class="group-actions-section">
                <div class="group-action-item" onclick="openGroupWallpaperModal()">
                    <div class="group-action-label">更换群聊壁纸</div>
                    <div class="group-action-value">点击更换</div>
                </div>
            </div>
            
            <!-- 危险操作 -->
            <div class="group-danger-actions">
                <button class="group-danger-action" onclick="disbandGroup()">
                    解散群聊
                </button>
            </div>
            
            <div class="group-settings-actions">
                <button class="group-settings-btn group-settings-btn-cancel" onclick="closeGroupSettings()">取消</button>
                <button class="group-settings-btn group-settings-btn-save" onclick="saveGroupSettings()">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 添加成员弹窗 -->
    <div id="addMemberModal" class="ai-config-modal">
        <div class="ai-config-content">
            <h2 class="ai-config-title">添加群成员</h2>
            
            <div class="ai-form-group">
                <label class="ai-form-label">选择要添加的联系人</label>
                <div class="group-members-list" id="availableContactsList">
                    <!-- 可用联系人列表将由JavaScript动态生成 -->
                </div>
            </div>
            
            <div class="ai-form-actions">
                <button class="ai-form-btn ai-form-btn-cancel" onclick="closeAddMemberModal()">取消</button>
                <button class="ai-form-btn ai-form-btn-primary" onclick="confirmAddMembers()">添加</button>
            </div>
        </div>
    </div>
    
    <!-- 群聊壁纸选择弹窗 -->
    <div id="groupWallpaperModal" class="ai-config-modal">
        <div class="ai-config-content">
            <h2 class="ai-config-title">群聊壁纸</h2>
            
            <div class="contact-wallpaper-upload">
                <button type="button" class="wallpaper-upload-btn" onclick="document.getElementById('groupWallpaperUploadInput').click()">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                    上传自定义壁纸
                </button>
                <input type="file" id="groupWallpaperUploadInput" accept="image/*" style="display: none;" onchange="handleWallpaperUpload('groupWallpaperUploadInput', true)">
            </div>
            <div class="contact-wallpaper-options">
                <div class="contact-wallpaper-option selected" data-wallpaper="default" style="background-image: url('https://files.catbox.moe/bihed7.jpg')"></div>
                <div class="contact-wallpaper-option" data-wallpaper="wallpaper1" style="background-image: url('https://files.catbox.moe/bpqrv2.jpg')"></div>
                <div class="contact-wallpaper-option" data-wallpaper="wallpaper2" style="background-image: url('https://files.catbox.moe/un7ruv.jpg')"></div>
                <div class="contact-wallpaper-option" data-wallpaper="wallpaper3" style="background-image: url('https://files.catbox.moe/vet3g0.jpg')"></div>
                <div class="contact-wallpaper-option" data-wallpaper="wallpaper4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%)"></div>
                <div class="contact-wallpaper-option" data-wallpaper="wallpaper5" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%)"></div>
            </div>
            
            <div class="ai-form-actions">
                <button class="ai-form-btn ai-form-btn-cancel" onclick="closeGroupWallpaperModal()">取消</button>
                <button class="ai-form-btn ai-form-btn-primary" onclick="saveGroupWallpaper()">确定</button>
            </div>
        </div>
    </div>
</div>

<audio id="clickSound" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" preload="auto"></audio>
<audio id="messageSound" src="https://files.catbox.moe/b4amzm.mp3" preload="auto"></audio>
<audio id="sendSound" src="https://assets.mixkit.co/active_storage/sfx/2570/2570-preview.mp3" preload="auto"></audio>
<audio id="avatarSound" src="https://assets.mixkit.co/active_storage/sfx/2575/2575-preview.mp3" preload="auto"></audio>
<script>

// 消息列表功能
async function openMessagesApp() {
    const messagesApp = document.getElementById('messagesApp');
    messagesApp.classList.add('show');
    await renderMessagesList();
}

function closeMessagesApp() {
    const messagesApp = document.getElementById('messagesApp');
    messagesApp.classList.remove('show');
}

async function renderMessagesList() {
    const messagesList = document.getElementById('messagesList');
    
    console.log('renderMessagesList called, currentMessages length:', currentMessages ? currentMessages.length : 'undefined'); // 调试信息
    
    // 只有在currentMessages为空时才加载保存的消息数据
    if (!currentMessages || currentMessages.length === 0) {
        console.log('Loading messages from storage...'); // 调试信息
    await loadMessagesFromStorage();
        console.log('Loaded messages from storage, length:', currentMessages.length); // 调试信息
    }
    
    messagesList.innerHTML = '';
    
    // 按置顶状态和时间排序：置顶的在前，然后按时间倒序
    const sortedMessages = [...currentMessages].sort((a, b) => {
        if (a.pinned && !b.pinned) return -1;
        if (!a.pinned && b.pinned) return 1;
        return new Date(b.time) - new Date(a.time);
    });
    
    console.log('Sorted messages to render:', sortedMessages.length); // 调试信息
    
    // 为每个消息项加载最新的头像和名字数据
    for (const message of sortedMessages) {
        let displayAvatar = message.avatar;
        let displayName = message.name;
        
        // 如果不是群聊，从IndexedDB加载最新的联系人数据
        if (!message.isGroup) {
            const contactKey = `contact_${message.id}`;
            const savedContact = await AppStorage.getItem(contactKey);
            if (savedContact) {
                const contactData = JSON.parse(savedContact);
                displayAvatar = contactData.avatar || message.avatar;
                displayName = contactData.name || message.name;
            }
        } else {
            // 如果是群聊，从IndexedDB加载最新的群聊数据
            const groupKey = `group_${message.id}`;
            const savedGroup = await AppStorage.getItem(groupKey);
            if (savedGroup) {
                const groupData = JSON.parse(savedGroup);
                displayAvatar = groupData.avatar || message.avatar;
                displayName = groupData.name || message.name;
            }
        }
        
        const messageItem = document.createElement('div');
        messageItem.className = 'message-item';
        if (message.pinned) {
            messageItem.classList.add('pinned');
        }
        messageItem.innerHTML = `
            <img src="${displayAvatar}" alt="${displayName}" class="message-avatar">
            <div class="message-info">
                <div class="message-header">
                    <span class="message-name">${displayName}</span>
                    <span class="message-time">${message.time}</span>
                </div>
                <div class="message-preview">${message.lastMessage}</div>
            </div>
            ${message.unread > 0 ? `<div class="unread-badge">${message.unread}</div>` : ''}
        `;
        
        // 添加长按事件（支持鼠标和触摸）
        let longPressTimer;
        let isLongPress = false;
        
        // 在元素上添加状态标记
        messageItem.hasShownContextMenu = false;
        
        const startLongPress = (e) => {
            // 只在长按触发时才preventDefault，避免阻止正常点击
            isLongPress = false;
            messageItem.hasShownContextMenu = false;
            longPressTimer = setTimeout(() => {
                isLongPress = true;
                messageItem.hasShownContextMenu = true;
                e.preventDefault(); // 只在长按触发时阻止默认行为
                showMessageContextMenu(e, message, messageItem);
                messageItem.classList.add('long-press');
            }, 500); // 500ms长按
        };
        
        const cancelLongPress = () => {
            clearTimeout(longPressTimer);
            if (isLongPress) {
                messageItem.classList.remove('long-press');
            }
        };
        
        // 添加点击事件（只有在没有显示上下文菜单时才执行）
        messageItem.addEventListener('click', (e) => {
            // 如果刚刚显示了上下文菜单，则不执行点击事件
            if (messageItem.hasShownContextMenu) {
                e.preventDefault();
                e.stopPropagation();
                // 重置状态，允许下次正常点击
                setTimeout(() => {
                    messageItem.hasShownContextMenu = false;
                }, 100);
                return;
            }
            playClickSound();
            openChatApp(message);
        });
        
        // 添加触摸点击事件（专门处理手机端）
        messageItem.addEventListener('touchend', (e) => {
            // 只有在没有长按且没有显示上下文菜单时才执行点击
            if (!isLongPress && !messageItem.hasShownContextMenu) {
                e.preventDefault();
                playClickSound();
                openChatApp(message);
            }
        });
        
        // 鼠标事件
        messageItem.addEventListener('mousedown', startLongPress);
        messageItem.addEventListener('mouseup', cancelLongPress);
        messageItem.addEventListener('mouseleave', cancelLongPress);
        
        // 触摸事件
        messageItem.addEventListener('touchstart', startLongPress, { passive: true });
        messageItem.addEventListener('touchend', (e) => {
            cancelLongPress();
            // 触摸点击事件在上面已经处理了
        });
        messageItem.addEventListener('touchmove', cancelLongPress);
        
        messagesList.appendChild(messageItem);
    }
}

// 消息选择菜单相关变量
let currentSelectedMessage = null;
let currentSelectedMessageElement = null;

// 显示消息选择菜单
function showMessageContextMenu(e, message, messageElement) {
    const contextMenu = document.getElementById('messageContextMenu');
    currentSelectedMessage = message;
    currentSelectedMessageElement = messageElement;
    
    // 获取鼠标/触摸位置
    let x, y;
    if (e.touches && e.touches.length > 0) {
        x = e.touches[0].clientX;
        y = e.touches[0].clientY;
    } else {
        x = e.clientX;
        y = e.clientY;
    }
    
    // 设置菜单位置
    contextMenu.style.left = x + 'px';
    contextMenu.style.top = y + 'px';
    
    // 检查是否已置顶
    const pinItem = contextMenu.querySelector('.message-context-item.pin');
    const unpinItem = contextMenu.querySelector('.message-context-item.unpin');
    
    if (message.pinned) {
        pinItem.style.display = 'none';
        unpinItem.style.display = 'flex';
    } else {
        pinItem.style.display = 'flex';
        unpinItem.style.display = 'none';
    }
    
    // 显示菜单
    contextMenu.classList.add('show');
    
    // 添加点击外部关闭菜单的事件
    setTimeout(() => {
        document.addEventListener('click', hideMessageContextMenu);
        document.addEventListener('touchstart', hideMessageContextMenu);
    }, 100);
}

// 隐藏消息选择菜单
function hideMessageContextMenu(e) {
    const contextMenu = document.getElementById('messageContextMenu');
    if (contextMenu && !contextMenu.contains(e.target)) {
        contextMenu.classList.remove('show');
        if (currentSelectedMessageElement) {
            currentSelectedMessageElement.classList.remove('long-press');
            // 重置长按状态，允许下次正常点击
            setTimeout(() => {
                if (currentSelectedMessageElement) {
                    currentSelectedMessageElement.hasShownContextMenu = false;
                }
            }, 100);
        }
        currentSelectedMessage = null;
        currentSelectedMessageElement = null;
        
        // 移除事件监听器
        document.removeEventListener('click', hideMessageContextMenu);
        document.removeEventListener('touchstart', hideMessageContextMenu);
    }
}

// 置顶消息
async function pinMessage() {
    if (!currentSelectedMessage) return;
    
    currentSelectedMessage.pinned = true;
    currentSelectedMessage.pinTime = new Date().toISOString();
    
    // 保存到本地存储
    await saveMessagesToStorage();
    
    // 重新渲染消息列表
    renderMessagesList();
    
    // 隐藏菜单
    const contextMenu = document.getElementById('messageContextMenu');
    contextMenu.classList.remove('show');
    
    playClickSound();
}

// 取消置顶消息
async function unpinMessage() {
    if (!currentSelectedMessage) return;
    
    currentSelectedMessage.pinned = false;
    delete currentSelectedMessage.pinTime;
    
    // 保存到本地存储
    await saveMessagesToStorage();
    
    // 重新渲染消息列表
    renderMessagesList();
    
    // 隐藏菜单
    const contextMenu = document.getElementById('messageContextMenu');
    contextMenu.classList.remove('show');
    
    playClickSound();
}

// 删除消息
async function deleteMessage() {
    if (!currentSelectedMessage) return;
    
    // 确认删除
    if (confirm(`确定要删除与 ${currentSelectedMessage.name} 的对话吗？`)) {
        // 从消息列表中移除
        const messageIndex = currentMessages.findIndex(m => m.id === currentSelectedMessage.id);
        if (messageIndex > -1) {
            currentMessages.splice(messageIndex, 1);
        }
        
        // 保存到本地存储
        await saveMessagesToStorage();
        
        // 重新渲染消息列表
        renderMessagesList();
        
        // 隐藏菜单
        const contextMenu = document.getElementById('messageContextMenu');
        contextMenu.classList.remove('show');
        
        playClickSound();
    }
}

// 消息数据
let currentMessages = [];

// 将currentMessages暴露到全局作用域，供论坛设置使用
window.currentMessages = currentMessages;

// 保存消息数据到本地存储
async function saveMessagesToStorage() {
    try {
        await AppStorage.setItem('currentMessages', JSON.stringify(currentMessages));
    } catch (error) {
        console.error('保存消息数据失败:', error);
    }
}

// 从本地存储加载消息数据
async function loadMessagesFromStorage() {
    try {
        const savedMessages = await AppStorage.getItem('currentMessages');
        if (savedMessages) {
            currentMessages = JSON.parse(savedMessages);
            // 同步到全局变量
            window.currentMessages = currentMessages;
        }
    } catch (error) {
        console.error('加载消息数据失败:', error);
        currentMessages = [];
        window.currentMessages = currentMessages;
    }
}

// 清理历史示例联系人与其聊天记录
async function cleanupDefaultSeedContacts() {
    try {
        if (!Array.isArray(currentMessages) || currentMessages.length === 0) return;
        const seedNames = new Set(['小雨','阿明','苏凛泽','苍介']);
        const before = currentMessages.length;
        currentMessages = currentMessages.filter(m => !seedNames.has(m.name));
        if (currentMessages.length !== before) {
            // 删除关联的联系人与聊天存档
            const removed = [];
            for (const name of seedNames) {
                const contact = (await (async () => currentMessages.find(m => m.name === name))) || null;
                if (contact) continue; // 仍在列表中则不删
                // 尝试扫描最近常用的ID范围（1..10）以及所有存储项过重，这里不穷举，只删除可能残留的0..10
                for (let id = 0; id <= 10; id++) {
                    const cKey = `contact_${id}`;
                    const gKey = `group_${id}`;
                    const chatKey = `chat_${id}`;
                    await AppStorage.removeItem(cKey);
                    await AppStorage.removeItem(gKey);
                    await AppStorage.removeItem(chatKey);
                }
                removed.push(name);
            }
            await saveMessagesData();
        }
    } catch (e) {
        console.warn('清理示例联系人失败:', e);
    }
}

// 添加联系人功能
let selectedGroupMembers = new Set();

function openAddContactModal() {
    playClickSound();
    const modal = document.getElementById('addContactModal');
    modal.classList.add('show');
    renderGroupMembersList();
}

function closeAddContactModal() {
    playClickSound();
    const modal = document.getElementById('addContactModal');
    modal.classList.remove('show');
    // 重置表单
    document.getElementById('friend-name').value = '';
    document.getElementById('friend-avatar').value = '';
    document.getElementById('friend-avatar-preview').src = 'https://placehold.co/60x60/E8E8E8/999?text=头像';
    document.getElementById('friend-persona').value = '';
    document.getElementById('character-file-upload').value = '';
    selectedGroupMembers.clear();
    renderGroupMembersList();
}

function renderGroupMembersList() {
    const groupMembersList = document.getElementById('groupMembersList');
    
    // 从消息列表中获取所有联系人（排除群聊）
    const existingContacts = currentMessages.filter(msg => 
        !msg.isGroup && msg.id !== 'owner' && msg.id !== 'self'
    );
    
    groupMembersList.innerHTML = '';
    
    if (existingContacts.length === 0) {
        groupMembersList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">暂无联系人，请先添加好友</div>';
        return;
    }
    
    existingContacts.forEach(contact => {
        const memberItem = document.createElement('div');
        memberItem.className = 'group-member-item';
        if (selectedGroupMembers.has(contact.id)) {
            memberItem.classList.add('selected');
        }
        
        memberItem.innerHTML = `
            <div class="group-member-checkbox"></div>
            <img src="${contact.avatar}" alt="${contact.name}" class="group-member-avatar">
            <span class="group-member-name">${contact.name}</span>
        `;
        
        memberItem.addEventListener('click', () => {
            playClickSound();
            memberItem.classList.toggle('selected');
            if (memberItem.classList.contains('selected')) {
                selectedGroupMembers.add(contact.id);
        } else {
                selectedGroupMembers.delete(contact.id);
            }
        });
        
        groupMembersList.appendChild(memberItem);
    });
}

// 处理角色卡文件上传
function handleCharacterFileUpload() {
    const fileInput = document.getElementById('character-file-upload');
    const file = fileInput.files[0];
    
    if (!file) {
        return;
    }
    
    // 检查文件类型
    if (!file.name.toLowerCase().endsWith('.json')) {
        alert('请选择JSON格式的角色卡文件！');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const characterData = JSON.parse(e.target.result);
            parseCharacterData(characterData);
        } catch (error) {
            alert('文件解析失败，请确保是有效的JSON格式！');
            console.error('JSON解析错误:', error);
        }
    };
    reader.readAsText(file);
}

// 解析角色卡数据并自动填充表单
function parseCharacterData(characterData) {
    try {
        // 提取角色名称
        const name = characterData.name || characterData.data?.name || '';
        if (name) {
            document.getElementById('friend-name').value = name;
        }
        
        // 提取角色描述/人设
        let persona = '';
        if (characterData.description) {
            // 如果是复杂的描述，使用增强版提取函数
            persona = extractPersonaFromDescriptionEnhanced(characterData.description);
        } else if (characterData.data?.description) {
            persona = extractPersonaFromDescriptionEnhanced(characterData.data.description);
        } else if (characterData.personality) {
            persona = characterData.personality;
        }
        
        if (persona) {
            document.getElementById('friend-persona').value = persona;
        }
        
        // 如果有头像信息，尝试设置
        if (characterData.avatar && characterData.avatar !== 'none') {
            // 如果是URL，直接设置
            if (characterData.avatar.startsWith('http')) {
                document.getElementById('friend-avatar-preview').src = characterData.avatar;
            }
        }
        
        alert('角色信息已自动填充！');
        
    } catch (error) {
        console.error('解析角色数据失败:', error);
        alert('角色数据解析失败，请检查文件格式！');
    }
}

// 从复杂描述中提取人设信息
function extractPersonaFromDescription(description) {
    try {
        // 如果是包含YAML格式的描述，尝试提取关键信息
        if (description.includes('```yaml') || description.includes('character:')) {
            const lines = description.split('\n');
            let persona = '';
            let inPersonalitySection = false;
            let inTraitsSection = false;
            let indentLevel = 0;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();
                
                // 检测personality部分开始
                if (trimmedLine.includes('personality:')) {
                    inPersonalitySection = true;
                    indentLevel = line.indexOf('personality:');
                    continue;
                }
                
                // 检测traits部分开始
                if (inPersonalitySection && trimmedLine.includes('traits:')) {
                    inTraitsSection = true;
                    continue;
                }
                
                // 如果在personality部分内
                if (inPersonalitySection) {
                    const currentIndent = line.length - line.trimStart().length;
                    
                    // 如果缩进级别回到personality级别或更少，说明personality部分结束
                    if (currentIndent <= indentLevel && trimmedLine && !trimmedLine.includes('traits:')) {
                        inPersonalitySection = false;
                        inTraitsSection = false;
                        continue;
                    }
                    
                    // 提取性格特点
                    if (inTraitsSection && trimmedLine.startsWith('- ')) {
                        const trait = trimmedLine.substring(2).trim();
                        if (trait) {
                            persona += trait + ' ';
                        }
                    }
                    
                    // 提取其他personality信息
                    if (!inTraitsSection && trimmedLine && !trimmedLine.includes('traits:')) {
                        if (trimmedLine.includes(':') && !trimmedLine.includes('personality:')) {
                            persona += trimmedLine + ' ';
                        }
                    }
                }
                
                // 提取基本信息（年龄、性别、身高等）
                if (trimmedLine.includes('age:') || trimmedLine.includes('gender:') || 
                    trimmedLine.includes('height:') || trimmedLine.includes('birthday:')) {
                    persona += trimmedLine + ' ';
                }
                
                // 提取身份信息
                if (trimmedLine.includes('identity:') || trimmedLine.includes('archetype:')) {
                    persona += trimmedLine + ' ';
                }
                
                // 提取外貌特征
                if (trimmedLine.includes('appearance:') || trimmedLine.includes('hair:') || 
                    trimmedLine.includes('eyes:') || trimmedLine.includes('body:')) {
                    persona += trimmedLine + ' ';
                }
            }
            
            // 如果提取到了内容，返回处理后的结果
            if (persona.trim()) {
                // 清理和格式化输出
                let cleanPersona = persona.trim()
                    .replace(/\s+/g, ' ') // 合并多个空格
                    .replace(/:\s*/g, ': ') // 统一冒号格式
                    .substring(0, 500); // 限制长度
                
                return cleanPersona;
            }
            
            return '从角色卡导入的角色';
        }
        
        // 如果是简单描述，直接返回
        return description.length > 200 ? description.substring(0, 200) + '...' : description;
        
    } catch (error) {
        console.error('提取人设信息失败:', error);
        return '从角色卡导入的角色';
    }
}

// 增强版人设提取函数 - 专门处理复杂的YAML格式
function extractPersonaFromDescriptionEnhanced(description) {
    try {
        // 检查是否包含YAML格式的角色信息
        if (description.includes('```yaml') && description.includes('名字:')) {
            // 提取YAML部分
            const yamlStart = description.indexOf('```yaml');
            const yamlEnd = description.indexOf('```', yamlStart + 7);
            
            if (yamlStart !== -1 && yamlEnd !== -1) {
                const yamlContent = description.substring(yamlStart + 7, yamlEnd);
                // 直接返回完整的YAML内容，不做任何截断
                return yamlContent.trim();
            }
        }
        
        // 如果不是YAML格式，返回完整描述
        return description;
        
    } catch (error) {
        console.error('提取人设信息失败:', error);
        return '从角色卡导入的角色';
    }
}

async function confirmAddContact() {
    playClickSound();
    console.log('confirmAddContact called'); // 调试信息
    
    const selectedForm = document.querySelector('.add-contact-option.selected').dataset.form;
    console.log('Selected form:', selectedForm); // 调试信息
    
    if (selectedForm === 'add-friend-form') {
        const name = document.getElementById('friend-name').value.trim();
        const avatarFile = document.getElementById('friend-avatar').files[0];
        const persona = document.getElementById('friend-persona').value.trim();
        
        console.log('Form data:', { name, avatarFile: !!avatarFile, persona }); // 调试信息
        
        if (!name) {
            alert('请输入好友姓名！');
            return;
        }
        
        if (!avatarFile) {
            alert('请选择头像图片！');
            return;
        }
        
        // 将文件转换为base64
        const avatar = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(e);
            reader.readAsDataURL(avatarFile);
        });
        
        // 添加新好友到消息列表
        const newMessage = {
            id: Date.now(),
            name: name,
            avatar: avatar,
            lastMessage: '你们现在是好友了...',
            time: `${new Date().getHours()}:${String(new Date().getMinutes()).padStart(2, '0')}`,
            unread: 0,
            isGroup: false
        };
        
        try {
        // 保存联系人的人设信息
        const contactData = {
            avatar: avatar,
            name: name,
            persona: persona
        };
        const contactKey = `contact_${newMessage.id}`;
        await AppStorage.setItem(contactKey, JSON.stringify(contactData));
        
        currentMessages.unshift(newMessage);
            console.log('New message added to currentMessages:', newMessage); // 调试信息
            console.log('Current messages array length:', currentMessages.length); // 调试信息
            console.log('Current messages array:', currentMessages); // 调试信息
        await renderMessagesList();
            console.log('Messages list rendered'); // 调试信息
        // 保存更新后的消息列表
        await saveMessagesData();
            console.log('Messages data saved'); // 调试信息
        closeAddContactModal();
            
            // 显示成功提示
            alert('好友添加成功！');
        } catch (error) {
            console.error('添加好友失败:', error);
            alert('添加好友失败，请重试！');
        }
        
    } else if (selectedForm === 'group-chat-form') {
        if (selectedGroupMembers.size < 2) {
            alert('请至少选择两位好友创建群聊！');
            return;
        }
        
        // 创建群聊
        const selectedMembers = Array.from(selectedGroupMembers);
        const memberNames = selectedMembers.map(id => {
            const contact = currentMessages.find(c => c.id === id);
            return contact ? contact.name : '未知';
        });
        
        const groupName = memberNames.slice(0, 3).join('、') + (memberNames.length > 3 ? '...' : '');
        
        const newGroupMessage = {
            id: Date.now(),
            name: groupName,
            avatar: 'https://placehold.co/48x48/7F8C8D/FFFFFF?text=群',
            lastMessage: '你创建了群聊',
            time: `${new Date().getHours()}:${String(new Date().getMinutes()).padStart(2, '0')}`,
            unread: 0,
            isGroup: true
        };
        
        // 初始化群成员（包含群主和选中的好友）
        const selfAvatar = await getSelfAvatar();
        const groupMembers = [
            {
                id: 'owner',
                name: '我',
                avatar: selfAvatar,
                role: 'owner'
            }
        ];
        
        // 添加选中的好友到群成员
        selectedMembers.forEach(memberId => {
            const contact = currentMessages.find(c => c.id === memberId);
            if (contact) {
                groupMembers.push({
                    id: contact.id,
                    name: contact.name,
                    avatar: contact.avatar,
                    role: 'member'
                });
            }
        });
        
        // 保存群聊数据
        const groupData = {
            name: groupName,
            avatar: newGroupMessage.avatar,
            members: groupMembers
        };
        const groupKey = `group_${newGroupMessage.id}`;
        await AppStorage.setItem(groupKey, JSON.stringify(groupData));
        
        currentMessages.unshift(newGroupMessage);
        await renderMessagesList();
        // 保存更新后的消息列表
        await saveMessagesData();
        closeAddContactModal();
    }
}

// 切换表单选项
document.addEventListener('DOMContentLoaded', () => {
    // 初始化论坛主题色
    const savedSettings = localStorage.getItem('forumSettings');
    if (savedSettings) {
        const settings = JSON.parse(savedSettings);
        if (settings.themeColor) {
            applyThemeColor(settings.themeColor);
        }
    }
    
    const options = document.querySelectorAll('.add-contact-option');
    const forms = document.querySelectorAll('.add-contact-form');
    
    options.forEach(option => {
        option.addEventListener('click', () => {
            playClickSound();
            options.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            
            forms.forEach(form => form.classList.remove('show'));
            document.getElementById(option.dataset.form).classList.add('show');
        });
    });
    
    // 点击弹窗外部关闭
    document.getElementById('addContactModal').addEventListener('click', (e) => {
        if (e.target.id === 'addContactModal') {
            closeAddContactModal();
        }
    });
});

// 联系人设置功能
let currentContactSettings = {
    contact: {
        avatar: '',
        name: '',
        persona: '',
        wallpaper: 'default'
    },
    self: {
        avatar: 'https://placehold.co/60x60/E8E8E8/999?text=我',
        name: '我',
        persona: ''
    }
};

function openContactSettings() {
    playClickSound();
    const modal = document.getElementById('contactSettingsModal');
    modal.classList.add('show');
    
    // 加载当前联系人信息
    loadContactSettings();
}

function closeContactSettings() {
    playClickSound();
    const modal = document.getElementById('contactSettingsModal');
    modal.classList.remove('show');
}

async function loadContactSettings() {
    // 加载联系人信息
    if (currentChatContact) {
        document.getElementById('contactAvatarPreview').src = currentChatContact.avatar;
        document.getElementById('contactName').value = currentChatContact.name;
        
        // 从IndexedDB加载联系人的人设
        const contactKey = `contact_${currentChatContact.id}`;
        const savedContact = await AppStorage.getItem(contactKey);
        if (savedContact) {
            const contactData = JSON.parse(savedContact);
            document.getElementById('contactPersona').value = contactData.persona || '';
            document.getElementById('contactName').value = contactData.name || currentChatContact.name;
            document.getElementById('contactAvatarPreview').src = contactData.avatar || currentChatContact.avatar;
            document.getElementById('contactContextTurns').value = (typeof contactData.contextTurns === 'number') ? contactData.contextTurns : '';
        }
    }
    
    // 加载自己的人设
    const savedSelf = await AppStorage.getItem('selfSettings');
    if (savedSelf) {
        const selfData = JSON.parse(savedSelf);
        document.getElementById('selfAvatarPreview').src = selfData.avatar || 'https://placehold.co/60x60/E8E8E8/999?text=我';
        document.getElementById('selfName').value = selfData.name || '我';
        document.getElementById('selfPersona').value = selfData.persona || '';
    }
    
    // 加载角色表情
    await loadCharacterEmotions();
    
    // 加载角色通话立绘
    await loadCallImage();
    
    // 加载聊天壁纸
    const savedWallpaper = await AppStorage.getItem('chatWallpaper');
    if (savedWallpaper) {
        // 先移除所有选中状态
        document.querySelectorAll('.contact-wallpaper-option').forEach(option => {
            option.classList.remove('selected');
        });
        
        // 查找匹配的壁纸选项
        const matchingOption = document.querySelector(`.contact-wallpaper-option[data-wallpaper="${savedWallpaper}"]`);
        if (matchingOption) {
            matchingOption.classList.add('selected');
        } else if (savedWallpaper.startsWith('data:') || savedWallpaper.startsWith('blob:')) {
            // 如果是自定义壁纸，创建新的选项
            const wallpaperOptions = document.querySelector('.contact-wallpaper-options');
            const customOption = document.createElement('div');
            customOption.className = 'contact-wallpaper-option custom-wallpaper selected';
            customOption.dataset.wallpaper = savedWallpaper;
            customOption.style.backgroundImage = `url("${savedWallpaper}")`;
            
            // 创建删除按钮
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-wallpaper-btn';
            deleteBtn.innerHTML = '×';
            deleteBtn.title = '删除此壁纸';
            deleteBtn.onclick = function(e) {
                e.stopPropagation();
                deleteCustomWallpaper(customOption, false);
            };
            
            customOption.appendChild(deleteBtn);
            
            // 插入到第一个位置
            wallpaperOptions.insertBefore(customOption, wallpaperOptions.firstChild);
            
            // 添加点击事件
            customOption.addEventListener('click', function() {
                wallpaperOptions.querySelectorAll('.contact-wallpaper-option').forEach(option => {
                    option.classList.remove('selected');
                });
                this.classList.add('selected');
            });
        }
    }
}

async function saveContactSettings() {
    playClickSound();
    
    // 保存联系人信息
    if (currentChatContact) {
        const contactData = {
            avatar: document.getElementById('contactAvatarPreview').src,
            name: document.getElementById('contactName').value,
            persona: document.getElementById('contactPersona').value,
            contextTurns: (function(){
                const v = parseInt(document.getElementById('contactContextTurns').value, 10);
                if (Number.isFinite(v) && v >= 0 && v <= 200) return v;
                return undefined;
            })()
        };
        
        const contactKey = `contact_${currentChatContact.id}`;
        await AppStorage.setItem(contactKey, JSON.stringify(contactData));
        
        // 更新聊天界面的联系人信息
        currentChatContact.avatar = contactData.avatar;
        currentChatContact.name = contactData.name;
        document.getElementById('chatContactName').textContent = contactData.name;
        
        // 同步更新消息列表中的联系人信息
        const messageIndex = currentMessages.findIndex(msg => msg.id === currentChatContact.id);
        if (messageIndex !== -1) {
            currentMessages[messageIndex].avatar = contactData.avatar;
            currentMessages[messageIndex].name = contactData.name;
            await renderMessagesList();
            // 保存更新后的消息列表
            await saveMessagesData();
        }
    }
    
    // 保存自己的信息
    const selfData = {
        avatar: document.getElementById('selfAvatarPreview').src,
        name: document.getElementById('selfName').value,
        persona: document.getElementById('selfPersona').value
    };
    await AppStorage.setItem('selfSettings', JSON.stringify(selfData));
    
    // 如果当前在聊天界面，重新渲染聊天消息以更新头像
    if (currentChatContact) {
        renderChatMessages();
    }
    
    // 保存角色表情
    await saveCharacterEmotions();
    
    // 保存聊天壁纸
    const selectedWallpaper = document.querySelector('.contact-wallpaper-option.selected');
    if (selectedWallpaper) {
        const wallpaperValue = selectedWallpaper.dataset.wallpaper;
        await AppStorage.setItem('chatWallpaper', wallpaperValue);
        applyChatWallpaper(wallpaperValue);
    }
    
    closeContactSettings();
    alert('设置已保存！');
}

function applyChatWallpaper(wallpaper) {
    const chatMessages = document.getElementById('chatMessages');
    const wallpaperMap = {
        'default': 'url("https://files.catbox.moe/bihed7.jpg")',
        'wallpaper1': 'url("https://files.catbox.moe/bpqrv2.jpg")',
        'wallpaper2': 'url("https://files.catbox.moe/un7ruv.jpg")',
        'wallpaper3': 'url("https://files.catbox.moe/vet3g0.jpg")',
        'wallpaper4': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        'wallpaper5': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)'
    };
    
    if (wallpaperMap[wallpaper]) {
        chatMessages.style.backgroundImage = wallpaperMap[wallpaper];
    } else if (wallpaper.startsWith('data:') || wallpaper.startsWith('blob:')) {
        // 处理自定义上传的壁纸
        chatMessages.style.backgroundImage = `url("${wallpaper}")`;
    }
}

// 联系人管理：拉黑/删除/清空聊天
async function blockCurrentContact() {
    if (!currentChatContact || currentChatContact.isGroup) { alert('仅支持私聊联系人'); return; }
    if (!confirm(`确认要拉黑 ${currentChatContact.name} 吗？`)) return;
    const blockKey = 'blockedContacts';
    const val = await AppStorage.getItem(blockKey);
    const set = new Set(val ? JSON.parse(val) : []);
    set.add(String(currentChatContact.id));
    await AppStorage.setItem(blockKey, JSON.stringify(Array.from(set)));
    alert('已拉黑，对方消息将不再显示。');
}

async function clearCurrentChatHistory() {
    if (!currentChatContact) return;
    if (!confirm('清空当前聊天的所有消息？此操作不可恢复。')) return;
    const chatKey = `chat_${currentChatContact.id}`;
    await AppStorage.removeItem(chatKey);
    chatMessages = [];
    await renderChatMessages();
    alert('聊天记录已清空。');
}

async function deleteCurrentContact() {
    if (!currentChatContact || currentChatContact.isGroup) { alert('仅支持私聊联系人'); return; }
    if (!confirm(`删除好友 ${currentChatContact.name}？此操作将移除会话与资料。`)) return;
    // 删除联系人存档
    const contactKey = `contact_${currentChatContact.id}`;
    await AppStorage.removeItem(contactKey);
    // 删除聊天记录
    const chatKey = `chat_${currentChatContact.id}`;
    await AppStorage.removeItem(chatKey);
    // 从消息列表移除并保存
    currentMessages = currentMessages.filter(m => m.id !== currentChatContact.id);
    await saveMessagesData();
    await renderMessagesList();
    // 关闭聊天与设置
    closeContactSettings();
    closeChatApp();
    alert('好友已删除。');
}

// 处理壁纸文件上传
function handleWallpaperUpload(inputId, isGroup = false) {
    const input = document.getElementById(inputId);
    const file = input.files[0];
    
    if (!file) return;
    
    // 检查文件类型
    if (!file.type.startsWith('image/')) {
        alert('请选择图片文件！');
        return;
    }
    
    // 检查文件大小（限制为5MB）
    if (file.size > 5 * 1024 * 1024) {
        alert('图片文件大小不能超过5MB！');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const imageUrl = e.target.result;
        
        // 创建新的壁纸选项
        const wallpaperOptions = document.querySelector(isGroup ? '#groupWallpaperModal .contact-wallpaper-options' : '.contact-wallpaper-options');
        
        // 移除之前的选中状态
        wallpaperOptions.querySelectorAll('.contact-wallpaper-option').forEach(option => {
            option.classList.remove('selected');
        });
        
        // 创建新的自定义壁纸选项
        const customOption = document.createElement('div');
        customOption.className = 'contact-wallpaper-option custom-wallpaper selected';
        customOption.dataset.wallpaper = imageUrl;
        customOption.style.backgroundImage = `url("${imageUrl}")`;
        
        // 创建删除按钮
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-wallpaper-btn';
        deleteBtn.innerHTML = '×';
        deleteBtn.title = '删除此壁纸';
        deleteBtn.onclick = function(e) {
            e.stopPropagation(); // 阻止触发壁纸选择事件
            deleteCustomWallpaper(customOption, isGroup);
        };
        
        customOption.appendChild(deleteBtn);
        
        // 插入到第一个位置
        wallpaperOptions.insertBefore(customOption, wallpaperOptions.firstChild);
        
        // 添加点击事件
        customOption.addEventListener('click', function() {
            wallpaperOptions.querySelectorAll('.contact-wallpaper-option').forEach(option => {
                option.classList.remove('selected');
            });
            this.classList.add('selected');
        });
        
        // 预览效果
        if (!isGroup) {
            applyChatWallpaper(imageUrl);
        } else {
            applyGroupWallpaper(imageUrl);
        }
    };
    
    reader.readAsDataURL(file);
}

// 删除自定义壁纸
async function deleteCustomWallpaper(wallpaperElement, isGroup = false) {
    playClickSound();
    
    if (!confirm('确定要删除这个自定义壁纸吗？')) {
        return;
    }
    
    const wallpaperUrl = wallpaperElement.dataset.wallpaper;
    
    // 如果当前选中的是要删除的壁纸，需要切换到默认壁纸
    if (wallpaperElement.classList.contains('selected')) {
        const wallpaperOptions = wallpaperElement.parentElement;
        const defaultOption = wallpaperOptions.querySelector('.contact-wallpaper-option[data-wallpaper="default"]');
        if (defaultOption) {
            defaultOption.classList.add('selected');
            // 应用默认壁纸
            if (!isGroup) {
                applyChatWallpaper('default');
            } else {
                applyGroupWallpaper('default');
            }
        }
    }
    
    // 从DOM中移除壁纸选项
    wallpaperElement.remove();
    
    // 如果这是当前使用的壁纸，需要更新存储
    if (wallpaperElement.classList.contains('selected')) {
        if (!isGroup) {
            await AppStorage.setItem('chatWallpaper', 'default');
        } else if (currentChatContact && currentChatContact.isGroup) {
            const groupKey = `group_${currentChatContact.id}`;
            const savedGroup = await AppStorage.getItem(groupKey);
            let groupData = savedGroup ? JSON.parse(savedGroup) : {};
            groupData.wallpaper = 'default';
            await AppStorage.setItem(groupKey, JSON.stringify(groupData));
        }
    }
    
    alert('自定义壁纸已删除！');
}

// 群聊设置功能
let currentGroupMembers = [];
let selectedMembersToAdd = new Set();

function openGroupSettings() {
    playClickSound();
    const modal = document.getElementById('groupSettingsModal');
    modal.classList.add('show');
    
    // 加载群聊信息
    loadGroupSettings();
}

function closeGroupSettings() {
    playClickSound();
    const modal = document.getElementById('groupSettingsModal');
    modal.classList.remove('show');
}

async function loadGroupSettings() {
    if (!currentChatContact || !currentChatContact.isGroup) return;
    
    // 加载群聊基本信息
    document.getElementById('groupAvatarPreview').src = currentChatContact.avatar;
    document.getElementById('groupName').value = currentChatContact.name;
    
    // 加载群成员列表
    loadGroupMembers();
    
    // 从localStorage加载群聊设置
    const groupKey = `group_${currentChatContact.id}`;
    const savedGroup = await AppStorage.getItem(groupKey);
    if (savedGroup) {
        const groupData = JSON.parse(savedGroup);
        document.getElementById('groupName').value = groupData.name || currentChatContact.name;
        document.getElementById('groupAvatarPreview').src = groupData.avatar || currentChatContact.avatar;
        currentGroupMembers = groupData.members || [];
        } else {
        // 初始化群成员（包含群主）
        currentGroupMembers = [
            {
                id: 'owner',
                name: '我',
                avatar: 'https://placehold.co/40x40/E8E8E8/999?text=我',
                role: 'owner'
            }
        ];
    }
    
    renderGroupMembers();
}

async function loadGroupMembers() {
    // 从IndexedDB加载群成员数据
    if (currentChatContact && currentChatContact.isGroup) {
        const groupKey = `group_${currentChatContact.id}`;
        const savedGroup = await AppStorage.getItem(groupKey);
        if (savedGroup) {
            const groupData = JSON.parse(savedGroup);
            if (groupData.members && groupData.members.length > 0) {
                currentGroupMembers = groupData.members;
                return;
            }
        }
    }
    
    // 如果没有保存的数据，初始化群成员（包含群主）
    if (currentGroupMembers.length === 0) {
        const selfAvatar = await getSelfAvatar();
        currentGroupMembers = [
            {
                id: 'owner',
                name: '我',
                avatar: selfAvatar,
                role: 'owner'
            }
        ];
    }
}

function renderGroupMembers() {
    const membersList = document.getElementById('groupMembersList');
    membersList.innerHTML = '';
    
    if (currentGroupMembers.length === 0) {
        membersList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">暂无群成员</div>';
        return;
    }
    
    currentGroupMembers.forEach(member => {
        const memberItem = document.createElement('div');
        memberItem.className = 'group-member-item';
        
        let roleBadge = '';
        if (member.role === 'owner') {
            roleBadge = '<span class="group-owner-badge">群主</span>';
        } else if (member.role === 'admin') {
            roleBadge = '<span class="group-admin-badge">管理员</span>';
        }
        
        let actionButtons = '';
        if (member.role === 'owner') {
            // 群主可以转让群主
            actionButtons = '<button class="group-member-action-btn transfer" onclick="transferOwnership(\'' + member.id + '\')">转让</button>';
        } else if (member.role === 'admin') {
            // 管理员可以移除
            actionButtons = '<button class="group-member-action-btn remove" onclick="removeMember(\'' + member.id + '\')">移除</button>';
        } else if (member.role === 'member') {
            // 普通成员可以提升为管理员或移除
            actionButtons = `
                <button class="group-member-action-btn promote" onclick="promoteMember(\'' + member.id + '\')">提升</button>
                <button class="group-member-action-btn remove" onclick="removeMember(\'' + member.id + '\')">移除</button>
            `;
        }
        
        memberItem.innerHTML = `
            <img src="${member.avatar}" alt="${member.name}" class="group-member-avatar">
            <div class="group-member-info">
                <div class="group-member-name">${member.name} ${roleBadge}</div>
                <div class="group-member-role">${getRoleText(member.role)}</div>
            </div>
            <div class="group-member-actions">
                ${actionButtons}
            </div>
        `;
        
        membersList.appendChild(memberItem);
    });
}

function getRoleText(role) {
    switch (role) {
        case 'owner': return '群主';
        case 'admin': return '管理员';
        case 'member': return '群成员';
        default: return '未知';
    }
}

async function saveGroupSettings() {
    playClickSound();
    
    if (!currentChatContact || !currentChatContact.isGroup) return;
    
    const groupName = document.getElementById('groupName').value.trim();
    const groupAvatar = document.getElementById('groupAvatarPreview').src;
    
    if (!groupName) {
        alert('请输入群聊名称');
        return;
    }
    
    // 更新群聊信息
    currentChatContact.name = groupName;
    currentChatContact.avatar = groupAvatar;
    
    // 更新聊天界面显示
    document.getElementById('chatContactName').textContent = groupName;
    
    // 保存到localStorage
    const groupData = {
        name: groupName,
        avatar: groupAvatar,
        members: currentGroupMembers
    };
    const groupKey = `group_${currentChatContact.id}`;
    await AppStorage.setItem(groupKey, JSON.stringify(groupData));
    
    // 更新消息列表中的群聊信息
    const messageIndex = currentMessages.findIndex(msg => msg.id === currentChatContact.id);
    if (messageIndex !== -1) {
        currentMessages[messageIndex].name = groupName;
        currentMessages[messageIndex].avatar = groupAvatar;
        await renderMessagesList();
        // 保存更新后的消息列表
        await saveMessagesData();
    }
    
    // 如果当前在群聊界面，重新渲染聊天消息以更新头像
    if (currentChatContact && currentChatContact.isGroup) {
        renderChatMessages();
    }
    
    closeGroupSettings();
    alert('群聊设置已保存！');
}

// 群成员管理功能
function openAddMemberModal() {
    playClickSound();
    const modal = document.getElementById('addMemberModal');
    modal.classList.add('show');
    
    // 加载可用联系人列表
    loadAvailableContacts();
}

function closeAddMemberModal() {
    playClickSound();
    const modal = document.getElementById('addMemberModal');
    modal.classList.remove('show');
    selectedMembersToAdd.clear();
}

function loadAvailableContacts() {
    const contactsList = document.getElementById('availableContactsList');
    contactsList.innerHTML = '';
    
    // 从消息列表中获取所有联系人（排除群聊和自己）
    const allContacts = currentMessages.filter(msg => 
        !msg.isGroup && msg.id !== 'owner' && msg.id !== 'self'
    );
    
    // 过滤掉已经是群成员的联系人
    const availableContacts = allContacts.filter(contact => 
        !currentGroupMembers.some(member => member.id === contact.id)
    );
    
    if (availableContacts.length === 0) {
        contactsList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">没有可添加的联系人</div>';
        return;
    }
    
    availableContacts.forEach(contact => {
        const contactItem = document.createElement('div');
        contactItem.className = 'group-member-item';
        const isSelected = selectedMembersToAdd.has(contact.id);
        contactItem.innerHTML = `
            <img src="${contact.avatar}" alt="${contact.name}" class="group-member-avatar">
            <div class="group-member-info">
                <div class="group-member-name">${contact.name}</div>
                <div class="group-member-role">联系人</div>
            </div>
            <div class="group-member-actions">
                <button class="group-member-action-btn promote ${isSelected ? 'selected' : ''}" onclick="toggleMemberSelection('${contact.id}')">${isSelected ? '已选' : '选择'}</button>
            </div>
        `;
        
        contactItem.addEventListener('click', () => {
            toggleMemberSelection(contact.id);
        });
        
        contactsList.appendChild(contactItem);
    });
}

function toggleMemberSelection(contactId) {
    if (selectedMembersToAdd.has(contactId)) {
        selectedMembersToAdd.delete(contactId);
    } else {
        selectedMembersToAdd.add(contactId);
    }
    
    // 更新按钮状态
    const buttons = document.querySelectorAll(`[onclick="toggleMemberSelection('${contactId}')"]`);
    buttons.forEach(btn => {
        if (selectedMembersToAdd.has(contactId)) {
            btn.textContent = '已选';
            btn.classList.add('selected');
        } else {
            btn.textContent = '选择';
            btn.classList.remove('selected');
        }
    });
    
    // 重新渲染列表以更新选中状态
    loadAvailableContacts();
}

async function confirmAddMembers() {
    playClickSound();
    
    if (selectedMembersToAdd.size === 0) {
        alert('请选择要添加的成员');
        return;
    }
    
    // 从消息列表中获取选中的联系人
    const allContacts = currentMessages.filter(msg => 
        !msg.isGroup && msg.id !== 'owner' && msg.id !== 'self'
    );
    
    let addedCount = 0;
    selectedMembersToAdd.forEach(contactId => {
        const contact = allContacts.find(c => c.id === contactId);
        if (contact) {
            // 检查是否已经存在
            const exists = currentGroupMembers.some(member => member.id === contactId);
            if (!exists) {
                currentGroupMembers.push({
                    id: contact.id,
                    name: contact.name,
                    avatar: contact.avatar,
                    role: 'member'
                });
                addedCount++;
            }
        }
    });
    
    // 保存群成员信息到localStorage
    if (currentChatContact && currentChatContact.isGroup) {
        const groupKey = `group_${currentChatContact.id}`;
        const savedGroup = await AppStorage.getItem(groupKey);
        let groupData = savedGroup ? JSON.parse(savedGroup) : {};
        groupData.members = currentGroupMembers;
        await AppStorage.setItem(groupKey, JSON.stringify(groupData));
    }
    
    renderGroupMembers();
    closeAddMemberModal();
    alert(`已添加 ${addedCount} 位成员到群聊！`);
}

function promoteMember(memberId) {
    playClickSound();
    
    const member = currentGroupMembers.find(m => m.id === memberId);
    if (member && member.role === 'member') {
        member.role = 'admin';
        renderGroupMembers();
        alert(`${member.name} 已被提升为管理员！`);
    }
}

function removeMember(memberId) {
    playClickSound();
    
    const member = currentGroupMembers.find(m => m.id === memberId);
    if (member && member.role !== 'owner') {
        if (confirm(`确定要移除 ${member.name} 吗？`)) {
            currentGroupMembers = currentGroupMembers.filter(m => m.id !== memberId);
            renderGroupMembers();
            alert(`${member.name} 已被移除出群聊！`);
        }
    }
}

function transferOwnership(memberId) {
    playClickSound();
    
    const member = currentGroupMembers.find(m => m.id === memberId);
    if (member && member.role !== 'owner') {
        if (confirm(`确定要将群主转让给 ${member.name} 吗？`)) {
            // 将当前群主降为管理员
            const currentOwner = currentGroupMembers.find(m => m.role === 'owner');
            if (currentOwner) {
                currentOwner.role = 'admin';
            }
            
            // 将选中的成员提升为群主
            member.role = 'owner';
            
            renderGroupMembers();
            alert(`群主已转让给 ${member.name}！`);
        }
    }
}

// 群聊壁纸功能
async function openGroupWallpaperModal() {
    playClickSound();
    const modal = document.getElementById('groupWallpaperModal');
    modal.classList.add('show');
    
    // 加载当前群聊壁纸
    const groupKey = `group_${currentChatContact.id}`;
    const savedGroup = await AppStorage.getItem(groupKey);
    if (savedGroup) {
        const groupData = JSON.parse(savedGroup);
        if (groupData.wallpaper) {
            // 先移除所有选中状态
            document.querySelectorAll('#groupWallpaperModal .contact-wallpaper-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // 查找匹配的壁纸选项
            const matchingOption = document.querySelector(`#groupWallpaperModal .contact-wallpaper-option[data-wallpaper="${groupData.wallpaper}"]`);
            if (matchingOption) {
                matchingOption.classList.add('selected');
            } else if (groupData.wallpaper.startsWith('data:') || groupData.wallpaper.startsWith('blob:')) {
                // 如果是自定义壁纸，创建新的选项
                const wallpaperOptions = document.querySelector('#groupWallpaperModal .contact-wallpaper-options');
                const customOption = document.createElement('div');
                customOption.className = 'contact-wallpaper-option custom-wallpaper selected';
                customOption.dataset.wallpaper = groupData.wallpaper;
                customOption.style.backgroundImage = `url("${groupData.wallpaper}")`;
                
                // 创建删除按钮
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-wallpaper-btn';
                deleteBtn.innerHTML = '×';
                deleteBtn.title = '删除此壁纸';
                deleteBtn.onclick = function(e) {
                    e.stopPropagation();
                    deleteCustomWallpaper(customOption, true);
                };
                
                customOption.appendChild(deleteBtn);
                
                // 插入到第一个位置
                wallpaperOptions.insertBefore(customOption, wallpaperOptions.firstChild);
                
                // 添加点击事件
                customOption.addEventListener('click', function() {
                    wallpaperOptions.querySelectorAll('.contact-wallpaper-option').forEach(option => {
                        option.classList.remove('selected');
                    });
                    this.classList.add('selected');
                });
            }
        }
    }
}

function closeGroupWallpaperModal() {
    playClickSound();
    const modal = document.getElementById('groupWallpaperModal');
    modal.classList.remove('show');
}

async function saveGroupWallpaper() {
    playClickSound();
    
    const selectedWallpaper = document.querySelector('#groupWallpaperModal .contact-wallpaper-option.selected');
    if (selectedWallpaper) {
        const wallpaper = selectedWallpaper.dataset.wallpaper;
        
        // 保存群聊壁纸
        const groupKey = `group_${currentChatContact.id}`;
        const savedGroup = await AppStorage.getItem(groupKey);
        let groupData = savedGroup ? JSON.parse(savedGroup) : {};
        groupData.wallpaper = wallpaper;
        await AppStorage.setItem(groupKey, JSON.stringify(groupData));
        
        // 应用壁纸
        applyGroupWallpaper(wallpaper);
        
        closeGroupWallpaperModal();
        alert('群聊壁纸已更换！');
    }
}

function applyGroupWallpaper(wallpaper) {
    const chatMessages = document.getElementById('chatMessages');
    const wallpaperMap = {
        'default': 'url("https://files.catbox.moe/bihed7.jpg")',
        'wallpaper1': 'url("https://files.catbox.moe/bpqrv2.jpg")',
        'wallpaper2': 'url("https://files.catbox.moe/un7ruv.jpg")',
        'wallpaper3': 'url("https://files.catbox.moe/vet3g0.jpg")',
        'wallpaper4': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        'wallpaper5': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)'
    };
    
    if (wallpaperMap[wallpaper]) {
        chatMessages.style.backgroundImage = wallpaperMap[wallpaper];
    } else if (wallpaper.startsWith('data:') || wallpaper.startsWith('blob:')) {
        // 处理自定义上传的壁纸
        chatMessages.style.backgroundImage = `url("${wallpaper}")`;
    }
}

// 解散群聊功能
async function disbandGroup() {
    playClickSound();
    
    if (confirm('确定要解散这个群聊吗？此操作不可撤销！')) {
        if (confirm('再次确认：确定要解散群聊吗？')) {
            // 从消息列表中移除群聊
            currentMessages = currentMessages.filter(msg => msg.id !== currentChatContact.id);
            await renderMessagesList();
            // 保存更新后的消息列表
            await saveMessagesData();
            
            // 删除群聊数据
            const groupKey = `group_${currentChatContact.id}`;
            await AppStorage.removeItem(groupKey);
            
            // 关闭群聊界面
            closeChatApp();
            closeGroupSettings();
            
            alert('群聊已解散！');
        }
    }
}

// 设置界面功能
function openSettingsApp() {
    playClickSound();
    const settingsApp = document.getElementById('settingsApp');
    settingsApp.classList.add('show');
    loadAIConfig();
}

function closeSettingsApp() {
    playClickSound();
    const settingsApp = document.getElementById('settingsApp');
    settingsApp.classList.remove('show');
}

// 数据管理功能
async function exportAllData() {
    playClickSound();
    
    try {
        // 获取所有存储的数据
        const allData = {};
        
        // 获取所有localStorage中的数据
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key) {
                allData[key] = localStorage.getItem(key);
            }
        }
        
        // 创建导出数据对象
        const exportData = {
            version: '1.0',
            exportTime: new Date().toISOString(),
            data: allData
        };
        
        // 创建并下载JSON文件
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `多云熊数据备份_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        alert('数据导出成功！');
    } catch (error) {
        console.error('导出数据失败:', error);
        alert('导出数据失败，请重试');
    }
}

function importData() {
    playClickSound();
    
    // 创建文件输入元素
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = async function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        try {
            const text = await file.text();
            const importData = JSON.parse(text);
            
            // 确认导入
            if (confirm('导入数据将覆盖所有现有数据，确定要继续吗？')) {
                // 清空现有数据
                localStorage.clear();
                
                // 导入新数据
                for (const [key, value] of Object.entries(importData.data)) {
                    localStorage.setItem(key, value);
                }
                
                alert('数据导入成功！页面将刷新以应用更改。');
                location.reload();
            }
        } catch (error) {
            console.error('导入数据失败:', error);
            alert('导入数据失败，请检查文件格式');
        }
    };
    
    input.click();
}

async function cleanupRedundantData() {
    playClickSound();
    
    if (confirm('确定要清理冗余数据吗？这将删除所有历史聊天记录和临时数据，但保留联系人信息。')) {
        try {
            let cleanedCount = 0;
            
            // 清理历史聊天记录
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.startsWith('chat_') || key.startsWith('latestDiary_') || key.startsWith('group_'))) {
                    localStorage.removeItem(key);
                    cleanedCount++;
                }
            }
            
            // 清理消息列表中的历史数据
            const messagesKey = 'currentMessages';
            const messages = localStorage.getItem(messagesKey);
            if (messages) {
                const messagesData = JSON.parse(messages);
                const cleanedMessages = messagesData.filter(msg => {
                    // 保留置顶的消息和最近的消息
                    return msg.pinned || new Date(msg.time) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                });
                localStorage.setItem(messagesKey, JSON.stringify(cleanedMessages));
            }
            
            alert(`清理完成！删除了 ${cleanedCount} 个冗余数据项。`);
            
            // 刷新相关页面
            if (typeof renderMessagesList === 'function') {
                renderMessagesList();
            }
        } catch (error) {
            console.error('清理数据失败:', error);
            alert('清理数据失败，请重试');
        }
    }
}

// 桌面壁纸功能
function openDesktopWallpaperModal() {
    playClickSound();
    const modal = document.getElementById('desktopWallpaperModal');
    modal.classList.add('show');
    
    // 加载当前桌面壁纸
    loadDesktopWallpaper();
}

function closeDesktopWallpaperModal() {
    playClickSound();
    const modal = document.getElementById('desktopWallpaperModal');
    modal.classList.remove('show');
}

async function loadDesktopWallpaper() {
    const wallpaperOptions = document.querySelector('#desktopWallpaperModal .contact-wallpaper-options');
    
    // 清空现有选项
    wallpaperOptions.innerHTML = '';
    
    // 添加默认壁纸选项
    const defaultOption = document.createElement('div');
    defaultOption.className = 'contact-wallpaper-option';
    defaultOption.dataset.wallpaper = 'default';
    defaultOption.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    defaultOption.addEventListener('click', function() {
        wallpaperOptions.querySelectorAll('.contact-wallpaper-option').forEach(option => {
            option.classList.remove('selected');
        });
        this.classList.add('selected');
    });
    wallpaperOptions.appendChild(defaultOption);
    
    // 加载保存的壁纸
    const savedWallpaper = await AppStorage.getItem('desktopWallpaper');
    if (savedWallpaper && savedWallpaper !== 'default') {
        if (savedWallpaper.startsWith('data:') || savedWallpaper.startsWith('blob:')) {
            // 如果是自定义壁纸，创建新的选项
            const customOption = document.createElement('div');
            customOption.className = 'contact-wallpaper-option custom-wallpaper selected';
            customOption.dataset.wallpaper = savedWallpaper;
            customOption.style.backgroundImage = `url("${savedWallpaper}")`;
            
            // 创建删除按钮
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-wallpaper-btn';
            deleteBtn.innerHTML = '×';
            deleteBtn.title = '删除此壁纸';
            deleteBtn.onclick = function(e) {
                e.stopPropagation();
                deleteDesktopWallpaper(customOption);
            };
            
            customOption.appendChild(deleteBtn);
            
            // 插入到第一个位置
            wallpaperOptions.insertBefore(customOption, wallpaperOptions.firstChild);
            
            // 添加点击事件
            customOption.addEventListener('click', function() {
                wallpaperOptions.querySelectorAll('.contact-wallpaper-option').forEach(option => {
                    option.classList.remove('selected');
                });
                this.classList.add('selected');
            });
        }
    } else {
        // 如果没有保存的壁纸或为默认壁纸，选中默认选项
        defaultOption.classList.add('selected');
    }
}

async function saveDesktopWallpaper() {
    playClickSound();
    
    const selectedWallpaper = document.querySelector('#desktopWallpaperModal .contact-wallpaper-option.selected');
    if (selectedWallpaper) {
        const wallpaper = selectedWallpaper.dataset.wallpaper;
        
        // 保存桌面壁纸
        await AppStorage.setItem('desktopWallpaper', wallpaper);
        
        // 应用壁纸
        applyDesktopWallpaper(wallpaper);
        
        // 更新设置界面显示
        updateDesktopWallpaperDisplay(wallpaper);
        
        closeDesktopWallpaperModal();
        alert('桌面壁纸已更换！');
    }
}

function applyDesktopWallpaper(wallpaper) {
    const body = document.body;
    const phoneContainer = document.querySelector('.phone-container');
    
    // 默认壁纸
    if (wallpaper === 'default' || !wallpaper) {
        const defaultBg = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        body.style.backgroundImage = defaultBg;
        body.style.backgroundSize = 'cover';
        body.style.backgroundPosition = 'center';
        body.style.backgroundRepeat = 'no-repeat';
        body.style.backgroundAttachment = 'fixed';
        
        if (phoneContainer) {
            phoneContainer.style.backgroundImage = defaultBg;
            phoneContainer.style.backgroundSize = 'cover';
            phoneContainer.style.backgroundPosition = 'center';
            phoneContainer.style.backgroundRepeat = 'no-repeat';
        }
    } else if (wallpaper.startsWith('data:') || wallpaper.startsWith('blob:')) {
        // 处理自定义上传的壁纸
        const customBg = `url("${wallpaper}")`;
        body.style.backgroundImage = customBg;
        body.style.backgroundSize = 'cover';
        body.style.backgroundPosition = 'center';
        body.style.backgroundRepeat = 'no-repeat';
        body.style.backgroundAttachment = 'fixed';
        
        if (phoneContainer) {
            phoneContainer.style.backgroundImage = customBg;
            phoneContainer.style.backgroundSize = 'cover';
            phoneContainer.style.backgroundPosition = 'center';
            phoneContainer.style.backgroundRepeat = 'no-repeat';
        }
    } else {
        // 处理其他自定义壁纸
        const customBg = `url("${wallpaper}")`;
        body.style.backgroundImage = customBg;
        body.style.backgroundSize = 'cover';
        body.style.backgroundPosition = 'center';
        body.style.backgroundRepeat = 'no-repeat';
        body.style.backgroundAttachment = 'fixed';
        
        if (phoneContainer) {
            phoneContainer.style.backgroundImage = customBg;
            phoneContainer.style.backgroundSize = 'cover';
            phoneContainer.style.backgroundPosition = 'center';
            phoneContainer.style.backgroundRepeat = 'no-repeat';
        }
    }
}

function updateDesktopWallpaperDisplay(wallpaper) {
    const wallpaperValue = document.getElementById('desktopWallpaperValue');
    const wallpaperNames = {
        'default': '默认',
        'desktop1': '粉色渐变',
        'desktop2': '蓝色渐变',
        'desktop3': '绿色渐变',
        'desktop4': '橙粉渐变',
        'desktop5': '青粉渐变',
        'desktop6': '粉紫渐变',
        'desktop7': '橙黄渐变',
        'desktop8': '蓝青渐变'
    };
    
    if (wallpaperNames[wallpaper]) {
        wallpaperValue.textContent = wallpaperNames[wallpaper];
    } else if (wallpaper.startsWith('data:') || wallpaper.startsWith('blob:')) {
        wallpaperValue.textContent = '自定义';
    }
}

// 处理桌面壁纸文件上传
function handleDesktopWallpaperUpload(inputId) {
    const input = document.getElementById(inputId);
    const file = input.files[0];
    
    if (!file) return;
    
    // 检查文件类型
    if (!file.type.startsWith('image/')) {
        alert('请选择图片文件！');
        return;
    }
    
    // 检查文件大小（限制为5MB）
    if (file.size > 5 * 1024 * 1024) {
        alert('图片文件大小不能超过5MB！');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const imageUrl = e.target.result;
        
        // 创建新的壁纸选项
        const wallpaperOptions = document.querySelector('#desktopWallpaperModal .contact-wallpaper-options');
        
        // 移除之前的选中状态
        wallpaperOptions.querySelectorAll('.contact-wallpaper-option').forEach(option => {
            option.classList.remove('selected');
        });
        
        // 创建新的自定义壁纸选项
        const customOption = document.createElement('div');
        customOption.className = 'contact-wallpaper-option custom-wallpaper selected';
        customOption.dataset.wallpaper = imageUrl;
        customOption.style.backgroundImage = `url("${imageUrl}")`;
        
        // 创建删除按钮
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-wallpaper-btn';
        deleteBtn.innerHTML = '×';
        deleteBtn.title = '删除此壁纸';
        deleteBtn.onclick = function(e) {
            e.stopPropagation();
            deleteDesktopWallpaper(customOption);
        };
        
        customOption.appendChild(deleteBtn);
        
        // 插入到第一个位置
        wallpaperOptions.insertBefore(customOption, wallpaperOptions.firstChild);
        
        // 添加点击事件
        customOption.addEventListener('click', function() {
            wallpaperOptions.querySelectorAll('.contact-wallpaper-option').forEach(option => {
                option.classList.remove('selected');
            });
            this.classList.add('selected');
        });
        
        // 预览效果
        applyDesktopWallpaper(imageUrl);
    };
    
    reader.readAsDataURL(file);
}

// 日记全屏控制
function openDiaryModal() {
    playClickSound();
    const diaryApp = document.getElementById('diaryApp');
    const diaryHistoryApp = document.getElementById('diaryHistoryApp');
    const diarySettingsApp = document.getElementById('diarySettingsApp');
    
    // 确保所有日记相关页面都关闭
    if (diaryHistoryApp) {
        diaryHistoryApp.classList.remove('show');
    }
    if (diarySettingsApp) {
        diarySettingsApp.classList.remove('show');
    }
    
    // 打开主日记页面
    if (diaryApp) {
        diaryApp.classList.add('show');
        // 重置标题
        const diaryTitle = document.getElementById('diaryTitle');
        if (diaryTitle) {
            diaryTitle.textContent = '角色日记';
        }
        // 显示右上角的操作按钮
        const diaryHeaderActions = document.querySelector('.diary-header-actions');
        if (diaryHeaderActions) {
            diaryHeaderActions.style.display = 'flex';
        }
        renderDiaryContent();
    }
}

// 刷新日记界面
async function refreshDiaryInterface() {
    // 刷新主日记页面
    await renderDiaryContent();
    
    // 如果当前在日记历史页面，也刷新历史列表
    const diaryHistoryApp = document.getElementById('diaryHistoryApp');
    if (diaryHistoryApp && diaryHistoryApp.classList.contains('show')) {
        await renderDiaryHistory();
    }
}

function closeDiaryApp() {
    playClickSound();
    const diaryApp = document.getElementById('diaryApp');
    const diaryHistoryApp = document.getElementById('diaryHistoryApp');
    const diarySettingsApp = document.getElementById('diarySettingsApp');
    
    if (diaryApp) {
        diaryApp.classList.remove('show');
        // 重置标题
        const diaryTitle = document.getElementById('diaryTitle');
        if (diaryTitle) {
            diaryTitle.textContent = '角色日记';
        }
    }
    
    // 确保其他日记相关页面也关闭
    if (diaryHistoryApp) {
        diaryHistoryApp.classList.remove('show');
    }
    if (diarySettingsApp) {
        diarySettingsApp.classList.remove('show');
    }
}

// 渲染日记内容
async function renderDiaryContent() {
    const diaryContent = document.getElementById('diaryContent');
    if (!diaryContent) return;
    
    const currentContactId = getCurrentContactId();
    if (!currentContactId) return;
    
    // 尝试加载当前角色的最新日记
    const latestDiaryKey = `latestDiary_${currentContactId}`;
    const latestDiary = await AppStorage.getItem(latestDiaryKey);
    
    if (latestDiary) {
        const diaryData = JSON.parse(latestDiary);
        
        // 从AI生成的日记内容中提取日期和天气信息
        let extractedDate = diaryData.date || '2025年10月3日星期五';
        let extractedWeather = diaryData.weather || '☀️ 晴朗 / 18℃';
        
        // 尝试从日记内容中提取日期和天气
        const content = diaryData.content || '';
        
        // 匹配日期格式：2024年12月19日星期四 多云/15℃
        const dateWeatherMatch = content.match(/(\d{4}年\d{1,2}月\d{1,2}日[星期一二三四五六日]*)\s*([^，。\n]*)/);
        if (dateWeatherMatch) {
            extractedDate = dateWeatherMatch[1];
            const weatherText = dateWeatherMatch[2].trim();
            if (weatherText) {
                // 转换天气格式
                if (weatherText.includes('多云')) {
                    extractedWeather = '☁️ 多云 / 15℃';
                } else if (weatherText.includes('晴朗') || weatherText.includes('晴天')) {
                    extractedWeather = '☀️ 晴朗 / 18℃';
                } else if (weatherText.includes('雨')) {
                    extractedWeather = '🌧️ 雨天 / 12℃';
                } else if (weatherText.includes('雪')) {
                    extractedWeather = '❄️ 雪天 / 0℃';
                } else {
                    extractedWeather = `☀️ ${weatherText}`;
                }
            }
        }
        
        // 如果上面的匹配没有找到天气，尝试匹配开头的天气信息
        if (!dateWeatherMatch || !dateWeatherMatch[2]) {
            const weatherOnlyMatch = content.match(/^([^，。\n]*?[晴朗多云雨雪阴天][^，。\n]*?[℃°])/);
            if (weatherOnlyMatch) {
                const weatherText = weatherOnlyMatch[1].trim();
                if (weatherText.includes('多云')) {
                    extractedWeather = '☁️ 多云 / 15℃';
                } else if (weatherText.includes('晴朗') || weatherText.includes('晴天')) {
                    extractedWeather = '☀️ 晴朗 / 18℃';
                } else if (weatherText.includes('雨')) {
                    extractedWeather = '🌧️ 雨天 / 12℃';
                } else if (weatherText.includes('雪')) {
                    extractedWeather = '❄️ 雪天 / 0℃';
                } else {
                    extractedWeather = `☀️ ${weatherText}`;
                }
            }
        }
        
        // 清理日记内容，去掉开头的日期和天气信息
        let cleanedContent = content;
        
        // 如果有日期天气匹配，去掉这部分
        if (dateWeatherMatch) {
            cleanedContent = content.replace(dateWeatherMatch[0], '').trim();
        }
        
        // 如果还有单独的天气信息在开头，也去掉
        const weatherOnlyMatch = cleanedContent.match(/^([^，。\n]*?[晴朗多云雨雪阴天][^，。\n]*?[℃°])/);
        if (weatherOnlyMatch) {
            cleanedContent = cleanedContent.replace(weatherOnlyMatch[0], '').trim();
        }
        
        // 如果内容以句号或逗号开头，去掉
        cleanedContent = cleanedContent.replace(/^[，。\s]+/, '');
        
        const diaryHTML = `
            <div class="diary-entry">
                <div class="diary-entry-header">
                    <div class="diary-entry-date">${extractedDate}</div>
                    <div class="diary-entry-weather">${extractedWeather}</div>
                </div>
                <div class="diary-entry-content">
                    ${cleanedContent}
                </div>
                <div class="diary-entry-footer">
                  
                </div>
            </div>
        `;
        
        diaryContent.innerHTML = diaryHTML;
        
        // 为涂黑内容添加点击事件
        document.querySelectorAll('.censored').forEach(element => {
            element.addEventListener('click', function() {
                this.style.color = this.style.color === 'transparent' ? '#333' : 'transparent';
            });
        });
        return;
    }
    
    // 预设日记内容已清空，显示空状态
    diaryContent.innerHTML = `
        <div class="empty-state">
            <div class="empty-state-icon">📝</div>
            <div class="empty-state-text">还没有日记呢~</div>
            <div class="empty-state-subtext">AI会根据聊天内容自动生成日记，或者你可以手动创建</div>
        </div>
    `;
    
    // 为涂黑内容添加点击事件
    document.querySelectorAll('.censored').forEach(element => {
        element.addEventListener('click', function() {
            this.style.color = this.style.color === 'transparent' ? '#333' : 'transparent';
        });
    });
}

// 日记历史功能
function openDiaryHistory() {
    playClickSound();
    const diaryApp = document.getElementById('diaryApp');
    const diaryHistoryApp = document.getElementById('diaryHistoryApp');
    if (diaryApp && diaryHistoryApp) {
        diaryApp.classList.remove('show');
        diaryHistoryApp.classList.add('show');
        renderDiaryHistory();
    }
}

function closeDiaryHistory() {
    playClickSound();
    const diaryApp = document.getElementById('diaryApp');
    const diaryHistoryApp = document.getElementById('diaryHistoryApp');
    if (diaryApp && diaryHistoryApp) {
        diaryHistoryApp.classList.remove('show');
        diaryApp.classList.add('show');
        // 重置标题
        const diaryTitle = document.getElementById('diaryTitle');
        if (diaryTitle) {
            diaryTitle.textContent = '角色日记';
        }
        // 显示右上角的操作按钮
        const diaryHeaderActions = document.querySelector('.diary-header-actions');
        if (diaryHeaderActions) {
            diaryHeaderActions.style.display = 'flex';
        }
        // 重新渲染默认日记内容
        renderDiaryContent();
    }
}

// 关闭日记详情，返回到历史列表
function closeDiaryDetail() {
    playClickSound();
    const diaryApp = document.getElementById('diaryApp');
    const diaryHistoryApp = document.getElementById('diaryHistoryApp');
    
    // 检查当前是否在查看日记详情
    const diaryTitle = document.getElementById('diaryTitle');
    const isViewingDetail = diaryTitle && diaryTitle.textContent === '日记详情';
    
    if (isViewingDetail) {
        // 如果在查看详情，返回到历史列表
        if (diaryApp && diaryHistoryApp) {
            diaryApp.classList.remove('show');
            diaryHistoryApp.classList.add('show');
            renderDiaryHistory();
        }
    } else {
        // 如果不在查看详情，直接关闭日记应用
        closeDiaryApp();
    }
}

// 渲染日记历史列表
async function renderDiaryHistory() {
    const diaryHistoryContent = document.getElementById('diaryHistoryContent');
    if (!diaryHistoryContent) return;
    
    const currentContactId = getCurrentContactId();
    if (!currentContactId) return;
    
    // 从存储中获取当前角色的日记历史
    const diaryKey = `diaryHistory_${currentContactId}`;
    const existingDiaries = await AppStorage.getItem(diaryKey);
    let diaryHistory = existingDiaries ? JSON.parse(existingDiaries) : [];
    
    // 预设日记历史已清空，如果没有日记历史则显示空状态
    if (diaryHistory.length === 0) {
        diaryHistoryContent.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">📚</div>
                <div class="empty-state-text">还没有日记历史</div>
                <div class="empty-state-subtext">AI会根据聊天内容自动生成日记</div>
            </div>
        `;
        return;
    }
    
    // 清空容器
    diaryHistoryContent.innerHTML = '';
    
    // 为每个日记条目创建独立的DOM元素
    diaryHistory.forEach((diary, index) => {
        const diaryItem = document.createElement('div');
        diaryItem.className = 'diary-history-item';
        diaryItem.setAttribute('data-diary-id', diary.id);
        diaryItem.onclick = () => viewDiary(diary.id);
        diaryItem.oncontextmenu = (e) => {
            e.preventDefault();
            deleteDiary(diary.id);
        };
        
        diaryItem.innerHTML = `
            <div class="diary-history-date">${diary.date}</div>
            <div class="diary-history-preview">${diary.preview}</div>
        `;
        
        diaryHistoryContent.appendChild(diaryItem);
    });
}

// 删除日记
async function deleteDiary(diaryId) {
    if (!confirm('确定要删除这篇日记吗？')) {
        return;
    }
    
    try {
        const currentContactId = getCurrentContactId();
        if (!currentContactId) return;
        
        const diaryKey = `diaryHistory_${currentContactId}`;
        const existingDiaries = await AppStorage.getItem(diaryKey);
        let diaryHistory = existingDiaries ? JSON.parse(existingDiaries) : [];
        
        // 删除指定ID的日记
        diaryHistory = diaryHistory.filter(d => d.id != diaryId);
        
        // 保存更新后的历史记录
        await AppStorage.setItem(diaryKey, JSON.stringify(diaryHistory));
        
        // 重新渲染历史列表
        await renderDiaryHistory();
        
        console.log('日记已删除，ID:', diaryId);
    } catch (error) {
        console.error('删除日记失败:', error);
    }
}

// 查看日记详情
function viewDiary(diaryId) {
    playClickSound();
    console.log('点击查看日记ID:', diaryId);
    
    const diaryHistoryApp = document.getElementById('diaryHistoryApp');
    const diaryApp = document.getElementById('diaryApp');
    
    if (diaryHistoryApp && diaryApp) {
        // 隐藏历史列表，显示日记详情
        diaryHistoryApp.classList.remove('show');
        diaryApp.classList.add('show');
        
        // 修改标题显示当前查看的日记
        const diaryTitle = document.getElementById('diaryTitle');
        if (diaryTitle) {
            diaryTitle.textContent = '日记详情';
        }
        
        // 隐藏右上角的操作按钮
        const diaryHeaderActions = document.querySelector('.diary-header-actions');
        if (diaryHeaderActions) {
            diaryHeaderActions.style.display = 'none';
        }
        
        // 加载具体的日记内容
        loadDiaryDetail(diaryId);
    }
}

// 加载日记详情
async function loadDiaryDetail(diaryId) {
    console.log('加载日记详情，ID:', diaryId);
    const diaryContent = document.getElementById('diaryContent');
    if (!diaryContent) return;
    
    const currentContactId = getCurrentContactId();
    if (!currentContactId) return;
    
    // 从存储中获取当前角色的日记历史
    const diaryKey = `diaryHistory_${currentContactId}`;
    const existingDiaries = await AppStorage.getItem(diaryKey);
    let diaryHistory = existingDiaries ? JSON.parse(existingDiaries) : [];
    
    console.log('当前日记历史:', diaryHistory);
    
    // 查找对应的日记
    let diary = diaryHistory.find(d => d.id == diaryId);
    console.log('找到的日记:', diary);
    
    // 预设日记详情已清空，如果没有找到日记则显示空状态
    if (!diary) {
        diaryContent.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">📝</div>
                <div class="empty-state-text">日记不存在</div>
                <div class="empty-state-subtext">这篇日记可能已被删除或不存在</div>
            </div>
        `;
        return;
    }
    
    if (diary) {
        // 从AI生成的日记内容中提取日期和天气信息
        let extractedDate = diary.date || '2025年10月3日星期五';
        let extractedWeather = diary.weather || '☀️ 晴朗 / 18℃';
        
        // 尝试从日记内容中提取日期和天气
        const content = diary.content || '';
        
        // 匹配日期格式：2024年12月19日星期四 多云/15℃
        const dateWeatherMatch = content.match(/(\d{4}年\d{1,2}月\d{1,2}日[星期一二三四五六日]*)\s*([^，。\n]*)/);
        if (dateWeatherMatch) {
            extractedDate = dateWeatherMatch[1];
            const weatherText = dateWeatherMatch[2].trim();
            if (weatherText) {
                // 转换天气格式
                if (weatherText.includes('多云')) {
                    extractedWeather = '☁️ 多云 / 15℃';
                } else if (weatherText.includes('晴朗') || weatherText.includes('晴天')) {
                    extractedWeather = '☀️ 晴朗 / 18℃';
                } else if (weatherText.includes('雨')) {
                    extractedWeather = '🌧️ 雨天 / 12℃';
                } else if (weatherText.includes('雪')) {
                    extractedWeather = '❄️ 雪天 / 0℃';
                } else {
                    extractedWeather = `☀️ ${weatherText}`;
                }
            }
        }
        
        // 如果上面的匹配没有找到天气，尝试匹配开头的天气信息
        if (!dateWeatherMatch || !dateWeatherMatch[2]) {
            const weatherOnlyMatch = content.match(/^([^，。\n]*?[晴朗多云雨雪阴天][^，。\n]*?[℃°])/);
            if (weatherOnlyMatch) {
                const weatherText = weatherOnlyMatch[1].trim();
                if (weatherText.includes('多云')) {
                    extractedWeather = '☁️ 多云 / 15℃';
                } else if (weatherText.includes('晴朗') || weatherText.includes('晴天')) {
                    extractedWeather = '☀️ 晴朗 / 18℃';
                } else if (weatherText.includes('雨')) {
                    extractedWeather = '🌧️ 雨天 / 12℃';
                } else if (weatherText.includes('雪')) {
                    extractedWeather = '❄️ 雪天 / 0℃';
                } else {
                    extractedWeather = `☀️ ${weatherText}`;
                }
            }
        }
        
        // 清理日记内容，去掉开头的日期和天气信息
        let cleanedContent = content;
        
        // 如果有日期天气匹配，去掉这部分
        if (dateWeatherMatch) {
            cleanedContent = content.replace(dateWeatherMatch[0], '').trim();
        }
        
        // 如果还有单独的天气信息在开头，也去掉
        const weatherOnlyMatch = cleanedContent.match(/^([^，。\n]*?[晴朗多云雨雪阴天][^，。\n]*?[℃°])/);
        if (weatherOnlyMatch) {
            cleanedContent = cleanedContent.replace(weatherOnlyMatch[0], '').trim();
        }
        
        // 如果内容以句号或逗号开头，去掉
        cleanedContent = cleanedContent.replace(/^[，。\s]+/, '');
        
        const diaryHTML = `
            <div class="diary-entry">
                <div class="diary-entry-header">
                    <div class="diary-entry-date">${extractedDate}</div>
                    <div class="diary-entry-weather">${extractedWeather}</div>
                </div>
                <div class="diary-entry-content">
                    ${cleanedContent}
                </div>
                <div class="diary-entry-footer">
                
                </div>
            </div>
        `;
        
        diaryContent.innerHTML = diaryHTML;
        
        // 为涂黑内容添加点击事件
        document.querySelectorAll('.censored').forEach(element => {
            element.addEventListener('click', function() {
                this.style.color = this.style.color === 'transparent' ? '#333' : 'transparent';
            });
        });
    }
}

// 删除日记（长按触发）
async function deleteDiary(diaryId) {
    if (confirm('确定要删除这篇日记吗？')) {
        playClickSound();
        
        try {
            const currentContactId = getCurrentContactId();
            if (!currentContactId) return;
            
            // 从存储中获取当前角色的日记历史
            const diaryKey = `diaryHistory_${currentContactId}`;
            const existingDiaries = await AppStorage.getItem(diaryKey);
            let diaryHistory = existingDiaries ? JSON.parse(existingDiaries) : [];
            
            // 删除指定的日记
            diaryHistory = diaryHistory.filter(diary => diary.id != diaryId);
            
            // 保存更新后的日记历史
            await AppStorage.setItem(diaryKey, JSON.stringify(diaryHistory));
            
            // 重新渲染日记历史列表
            await renderDiaryHistory();
            
            alert('日记删除成功！');
        } catch (error) {
            console.error('删除日记失败:', error);
            alert('删除日记失败！');
        }
    }
}

// 日记设置功能
function openDiarySettings() {
    playClickSound();
    const diaryApp = document.getElementById('diaryApp');
    const diarySettingsApp = document.getElementById('diarySettingsApp');
    if (diaryApp && diarySettingsApp) {
        diaryApp.classList.remove('show');
        diarySettingsApp.classList.add('show');
        loadDiarySettings();
    }
}

function closeDiarySettings() {
    playClickSound();
    const diaryApp = document.getElementById('diaryApp');
    const diarySettingsApp = document.getElementById('diarySettingsApp');
    if (diaryApp && diarySettingsApp) {
        diarySettingsApp.classList.remove('show');
        diaryApp.classList.add('show');
        // 重置标题
        const diaryTitle = document.getElementById('diaryTitle');
        if (diaryTitle) {
            diaryTitle.textContent = '角色日记';
        }
        // 显示右上角的操作按钮
        const diaryHeaderActions = document.querySelector('.diary-header-actions');
        if (diaryHeaderActions) {
            diaryHeaderActions.style.display = 'flex';
        }
        // 重新渲染默认日记内容
        renderDiaryContent();
    }
}

// 加载日记设置
async function loadDiarySettings() {
    const currentContactId = getCurrentContactId();
    if (!currentContactId) return;
    
    const settingsKey = `diarySettings_${currentContactId}`;
    const savedSettings = await AppStorage.getItem(settingsKey);
    if (savedSettings) {
        const settings = JSON.parse(savedSettings);
        document.getElementById('diarySummaryCount').value = settings.summaryCount || 200;
    }
}

// 保存日记设置
async function saveDiarySettings() {
    playClickSound();
    const currentContactId = getCurrentContactId();
    if (!currentContactId) return;
    
    const summaryCount = parseInt(document.getElementById('diarySummaryCount').value) || 200;
    
    const settings = {
        summaryCount: Math.max(0, Math.min(500, summaryCount))
    };
    
    const settingsKey = `diarySettings_${currentContactId}`;
    await AppStorage.setItem(settingsKey, JSON.stringify(settings));
    alert('日记设置已保存！');
}

// 生成新日记
async function generateDiary() {
    playClickSound();
    const currentContactId = getCurrentContactId();
    if (!currentContactId) return;
    
    const summaryCount = parseInt(document.getElementById('diarySummaryCount').value) || 200;
    
    if (!aiConfig.provider || !aiConfig.apiKey || !aiConfig.model || aiConfig.status !== 'connected') {
        alert('请先配置AI服务！');
        return;
    }
    
    try {
        // 获取上次日记生成后的消息
        const lastDiaryTime = localStorage.getItem(`lastDiaryTime_${currentContactId}`);
        let startIndex = 0;
        
        if (lastDiaryTime) {
            // 找到上次日记生成时间之后的消息
            const lastTime = new Date(lastDiaryTime);
            for (let i = chatMessages.length - 1; i >= 0; i--) {
                // 消息对象可能使用time或timestamp字段
                const msgTime = chatMessages[i].timestamp || chatMessages[i].time;
                if (new Date(msgTime) <= lastTime) {
                    startIndex = i + 1;
                    break;
                }
            }
        } else {
            // 如果没有生成过日记，从最新的消息开始，取用户设置的条数
            startIndex = Math.max(0, chatMessages.length - summaryCount);
        }
        
        const recentMessages = chatMessages.slice(startIndex);
        const messageText = recentMessages.map(msg => 
            `${msg.sender === 'sent' ? '我' : '对方'}: ${msg.content}`
        ).join('\n');
        
        // 调用AI生成日记
        const diaryPrompt = `请根据以下聊天记录，以角色的身份写一篇日记。严格按照以下格式要求：

日记格式要求：
1. 日期格式：2024年12月19日 星期四
2. 天气格式：☀️ 晴朗 / 18℃ 或 ☁️ 多云 / 15℃ 或 🌧️ 小雨 / 12℃
3. 内容要求：
   - 使用 <span class="highlight">高亮文字</span> 标记重要内容
   - 使用 <span class="underline">下划线</span> 标记重点
   - 使用 <span class="emphasis">强调文字</span> 标记情感重点
   - 使用 <span class="handwritten">手写体</span> 标记个人感受
   - 使用 <span class="censored">涂黑内容</span> 标记隐私内容
   - 使用 <span class="messy">潦草文字</span> 标记随意想法
   - 使用 <span class="strikethrough">删除线</span> 标记否定内容


聊天记录：
${messageText}

请生成一篇完整的日记，包含日期、天气、内容，并使用各种特殊样式。`;

        const aiResponse = await callAIAPIForDiary(diaryPrompt);
        if (aiResponse) {
            // 保存生成的日记
            const diaryData = {
                id: Date.now(),
                date: new Date().toLocaleDateString('zh-CN', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    weekday: 'long'
                }),
                content: aiResponse,
                preview: aiResponse.substring(0, 100) + '...'
            };
            
            // 保存到日记历史
            await saveDiaryToHistory(diaryData);
            alert('日记生成成功！');
        }
    } catch (error) {
        console.error('生成日记失败:', error);
        alert('生成日记失败，请检查AI配置！');
    }
}

// 保存日记到历史记录
async function saveDiaryToHistory(diaryData) {
    try {
        const currentContactId = getCurrentContactId();
        if (!currentContactId) return;
        
        const diaryKey = `diaryHistory_${currentContactId}`;
        const existingDiaries = await AppStorage.getItem(diaryKey);
        let diaryHistory = existingDiaries ? JSON.parse(existingDiaries) : [];
        
        diaryHistory.unshift(diaryData); // 添加到开头
        
        // 限制历史记录数量（最多保存50篇）
        if (diaryHistory.length > 50) {
            diaryHistory = diaryHistory.slice(0, 50);
        }
        
        await AppStorage.setItem(diaryKey, JSON.stringify(diaryHistory));
        
        // 同时保存为当前角色的最新日记
        await AppStorage.setItem(`latestDiary_${currentContactId}`, JSON.stringify(diaryData));
        
        // 刷新日记界面
        refreshDiaryInterface();
    } catch (error) {
        console.error('保存日记失败:', error);
    }
}

// 自动生成日记的触发条件
async function checkAutoDiaryTrigger() {
    const currentContactId = getCurrentContactId();
    if (!currentContactId) return false;
    
    // 获取用户设置的总结条数
    const settingsKey = `diarySettings_${currentContactId}`;
    const savedSettings = await AppStorage.getItem(settingsKey);
    const userSummaryCount = savedSettings ? JSON.parse(savedSettings).summaryCount : 200;
    
    // 检查是否满足自动生成日记的条件
    const now = new Date();
    const lastDiaryTime = localStorage.getItem(`lastDiaryTime_${currentContactId}`);
    
    if (lastDiaryTime) {
        const lastTime = new Date(lastDiaryTime);
        const hoursDiff = (now - lastTime) / (1000 * 60 * 60);
        
        // 如果距离上次生成日记超过24小时，且聊天消息超过用户设置的条数
        if (hoursDiff >= 24 && chatMessages.length >= userSummaryCount) {
            return true;
        }
    } else {
        // 如果没有生成过日记，且聊天消息超过用户设置的条数
        if (chatMessages.length >= userSummaryCount) {
            return true;
        }
    }
    
    return false;
}

// 自动生成日记
async function autoGenerateDiary() {
    if (!(await checkAutoDiaryTrigger())) {
        return;
    }
    
    if (!aiConfig.provider || !aiConfig.apiKey || !aiConfig.model || aiConfig.status !== 'connected') {
        return;
    }
    
    try {
        // 获取用户设置的总结条数
        const currentContactId = getCurrentContactId();
        const settingsKey = `diarySettings_${currentContactId}`;
        const savedSettings = await AppStorage.getItem(settingsKey);
        const summaryCount = savedSettings ? JSON.parse(savedSettings).summaryCount : 200;
        
        // 获取上次日记生成后的消息
        const lastDiaryTime = localStorage.getItem(`lastDiaryTime_${currentContactId}`);
        let startIndex = 0;
        
        if (lastDiaryTime) {
            // 找到上次日记生成时间之后的消息
            const lastTime = new Date(lastDiaryTime);
            for (let i = chatMessages.length - 1; i >= 0; i--) {
                // 消息对象可能使用time或timestamp字段
                const msgTime = chatMessages[i].timestamp || chatMessages[i].time;
                if (new Date(msgTime) <= lastTime) {
                    startIndex = i + 1;
                    break;
                }
            }
        } else {
            // 如果没有生成过日记，从最新的消息开始，取用户设置的条数
            startIndex = Math.max(0, chatMessages.length - summaryCount);
        }
        
        const recentMessages = chatMessages.slice(startIndex);
        const messageText = recentMessages.map(msg => 
            `${msg.sender === 'sent' ? '我' : '对方'}: ${msg.content}`
        ).join('\n');
        
        const diaryPrompt = `请根据以下聊天记录，以角色的身份写一篇日记。严格按照以下格式要求：

日记格式要求：
1. 日期格式：2024年12月19日 星期四
2. 天气格式：☀️ 晴朗 / 18℃ 或 ☁️ 多云 / 15℃ 或 🌧️ 小雨 / 12℃
3. 内容要求：
   - 使用 <span class="highlight">高亮文字</span> 标记重要内容
   - 使用 <span class="underline">下划线</span> 标记重点
   - 使用 <span class="emphasis">强调文字</span> 标记情感重点
   - 使用 <span class="handwritten">手写体</span> 标记个人感受
   - 使用 <span class="censored">涂黑内容</span> 标记隐私内容
   - 使用 <span class="messy">潦草文字</span> 标记随意想法
   - 使用 <span class="strikethrough">删除线</span> 标记否定内容
4. 结尾使用：~つづく~

聊天记录：
${messageText}

请生成一篇完整的日记，包含日期、天气、内容，并使用各种特殊样式。`;

        const aiResponse = await callAIAPIForDiary(diaryPrompt);
        if (aiResponse) {
            const diaryData = {
                id: Date.now(),
                date: new Date().toLocaleDateString('zh-CN', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    weekday: 'long'
                }),
                content: aiResponse,
                preview: aiResponse.substring(0, 100) + '...'
            };
            
            await saveDiaryToHistory(diaryData);
            const currentContactId = getCurrentContactId();
            if (currentContactId) {
                localStorage.setItem(`lastDiaryTime_${currentContactId}`, new Date().toISOString());
            }
            
            // 显示通知
            showNotification('AI自动生成了一篇新日记！');
        }
    } catch (error) {
        console.error('自动生成日记失败:', error);
    }
}

// 显示通知
function showNotification(message) {
    // 创建通知元素
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #6C8CD5;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 10000;
        font-size: 14px;
        max-width: 300px;
        word-wrap: break-word;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // 3秒后自动移除
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

// 显示API提醒
function showAPIReminder(title, message) {
    // 创建提醒弹窗
    const reminder = document.createElement('div');
    reminder.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        z-index: 10001;
        max-width: 320px;
        width: 90%;
        overflow: hidden;
        animation: reminderSlideIn 0.3s ease-out;
    `;
    
    // 添加动画样式
    if (!document.getElementById('reminderAnimationStyle')) {
        const style = document.createElement('style');
        style.id = 'reminderAnimationStyle';
        style.textContent = `
            @keyframes reminderSlideIn {
                from {
                    opacity: 0;
                    transform: translate(-50%, -50%) scale(0.8);
                }
                to {
                    opacity: 1;
                    transform: translate(-50%, -50%) scale(1);
                }
            }
            .api-reminder-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 10000;
                animation: fadeIn 0.3s ease-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    }
    
    // 创建遮罩层
    const overlay = document.createElement('div');
    overlay.className = 'api-reminder-overlay';
    
    reminder.innerHTML = `
        <div style="padding: 24px 20px 20px 20px;">
            <div style="display: flex; align-items: center; margin-bottom: 16px;">
                <div style="width: 40px; height: 40px; background: #ff6b6b; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                    <span style="color: white; font-size: 20px;">⚠️</span>
                </div>
                <div>
                    <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 4px;">${title}</div>
                </div>
            </div>
            <div style="color: #666; line-height: 1.5; margin-bottom: 20px; font-size: 14px;">${message}</div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="closeAPIReminder()" style="
                    padding: 8px 16px;
                    border: 1px solid #ddd;
                    background: white;
                    color: #666;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    transition: all 0.2s;
                " onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                    知道了
                </button>
                <button onclick="openAIConfig(); closeAPIReminder();" style="
                    padding: 8px 16px;
                    border: none;
                    background: #6C8CD5;
                    color: white;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    transition: all 0.2s;
                " onmouseover="this.style.background='#4A6FBF'" onmouseout="this.style.background='#6C8CD5'">
                    去配置
                </button>
            </div>
        </div>
    `;
    
    // 添加到页面
    document.body.appendChild(overlay);
    document.body.appendChild(reminder);
    
    // 点击遮罩层关闭
    overlay.onclick = closeAPIReminder;
    
    // 5秒后自动关闭
    setTimeout(() => {
        closeAPIReminder();
    }, 5000);
}

// 关闭API提醒
function closeAPIReminder() {
    const reminder = document.querySelector('[style*="position: fixed"][style*="z-index: 10001"]');
    const overlay = document.querySelector('.api-reminder-overlay');
    
    if (reminder) {
        reminder.style.animation = 'reminderSlideIn 0.3s ease-out reverse';
        setTimeout(() => {
            if (reminder.parentNode) {
                reminder.parentNode.removeChild(reminder);
            }
        }, 300);
    }
    
    if (overlay) {
        overlay.style.animation = 'fadeIn 0.3s ease-out reverse';
        setTimeout(() => {
            if (overlay.parentNode) {
                overlay.parentNode.removeChild(overlay);
            }
        }, 300);
    }
}

// 删除桌面自定义壁纸
async function deleteDesktopWallpaper(wallpaperElement) {
    playClickSound();
    
    if (!confirm('确定要删除这个自定义桌面壁纸吗？')) {
        return;
    }
    
    const wallpaperUrl = wallpaperElement.dataset.wallpaper;
    
    // 如果当前选中的是要删除的壁纸，需要切换到默认壁纸
    if (wallpaperElement.classList.contains('selected')) {
        const wallpaperOptions = wallpaperElement.parentElement;
        const defaultOption = wallpaperOptions.querySelector('.contact-wallpaper-option[data-wallpaper="default"]');
        if (defaultOption) {
            defaultOption.classList.add('selected');
            // 应用默认壁纸
            applyDesktopWallpaper('default');
        }
    }
    
    // 从DOM中移除壁纸选项
    wallpaperElement.remove();
    
    // 如果这是当前使用的壁纸，需要更新存储
    if (wallpaperElement.classList.contains('selected')) {
        await AppStorage.setItem('desktopWallpaper', 'default');
        updateDesktopWallpaperDisplay('default');
    }
    
    alert('自定义桌面壁纸已删除！');
}

// AI配置功能
let currentAIProvider = null;
let aiConfig = {
    provider: null,
    apiKey: '',
    customUrl: '',
    model: '',
    status: 'disconnected'
};

function openAIConfig() {
    playClickSound();
    const modal = document.getElementById('aiConfigModal');
    modal.classList.add('show');
    
    // 加载已保存的配置
    loadAIConfig();
}

function closeAIConfig() {
    playClickSound();
    const modal = document.getElementById('aiConfigModal');
    modal.classList.remove('show');
}

async function loadAIConfig() {
    const savedConfig = await AppStorage.getItem('aiConfig');
    if (savedConfig) {
        aiConfig = JSON.parse(savedConfig);
        updateAIDisplay();
        
        if (aiConfig.provider) {
            selectAIProvider(aiConfig.provider);
            document.getElementById('aiApiKey').value = aiConfig.apiKey || '';
            document.getElementById('aiCustomUrl').value = aiConfig.customUrl || '';
            
            // 如果是下拉框，需要先加载模型列表再设置值
            const modelSelect = document.getElementById('aiModel');
            if (modelSelect.tagName === 'SELECT') {
                // 先加载模型列表
                await fetchModelsToSelect();
                // 然后设置选中的值
                if (aiConfig.model) {
                    modelSelect.value = aiConfig.model;
                }
            } else {
                // 兼容旧的输入框
                modelSelect.value = aiConfig.model || '';
            }
            
            // 自动测试连接（如果配置完整）
            if (aiConfig.apiKey && aiConfig.model) {
                await autoTestConnection();
            }
        }
    }
}

function updateAIDisplay() {
    const providerValue = document.getElementById('aiProviderValue');
    const modelValue = document.getElementById('aiModelValue');
    const statusValue = document.getElementById('aiStatusValue');
    
    if (aiConfig.provider) {
        const providerNames = {
            'deepseek': 'DeepSeek',
            'google': 'Google AI',
            'openai': 'OpenAI',
            'custom': '自定义反代'
        };
        providerValue.textContent = providerNames[aiConfig.provider] || '未知';
        modelValue.textContent = aiConfig.model || '未选择';
        if (aiConfig.status === 'connected') {
            statusValue.textContent = '已连接';
        } else if (aiConfig.status === 'connecting') {
            statusValue.textContent = '连接中...';
        } else {
            statusValue.textContent = '未连接';
        }
    } else {
        providerValue.textContent = '未配置';
        modelValue.textContent = '未选择';
        statusValue.textContent = '未连接';
    }
}

function selectAIProvider(provider) {
    // 清除之前的选择
    document.querySelectorAll('.ai-provider-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // 选择新的提供商
    const selectedOption = document.querySelector(`[data-provider="${provider}"]`);
    if (selectedOption) {
        selectedOption.classList.add('selected');
    }
    
    currentAIProvider = provider;
    
    // 显示/隐藏自定义URL输入框
    const customUrlGroup = document.getElementById('customUrlGroup');
    if (provider === 'custom') {
        customUrlGroup.style.display = 'block';
    } else {
        customUrlGroup.style.display = 'none';
    }
    
    // 显示配置表单
    document.getElementById('aiConfigForm').classList.add('show');
    
    // 不自动拉取，等待用户点击“拉取模型”按钮
}

async function fetchModels() {
    if (!currentAIProvider) return;
    const loading = document.getElementById('aiLoading');
    const modelInput = document.getElementById('aiModel');
    const listDiv = document.getElementById('aiModelFetchedList');
    loading.classList.add('show');
    listDiv.style.display = 'none';
    listDiv.innerHTML = '';

    try {
        const provider = currentAIProvider;
        // 优先读取表单未保存的值，其次回退到已保存配置
        const apiKeyInput = (document.getElementById('aiApiKey') || {}).value || '';
        const customUrlInput = (document.getElementById('aiCustomUrl') || {}).value || '';
        const { apiKey: savedKey, customUrl: savedUrl } = aiConfig;
        const apiKey = (apiKeyInput || savedKey || '').trim();
        const customUrl = (customUrlInput || savedUrl || '').trim();

        if (!apiKey) {
            throw new Error('请先填写 API 密钥');
        }
        let url = '';
        let headers = {};

        if (provider === 'openai') {
            url = 'https://api.openai.com/v1/models';
            headers = { 'Authorization': `Bearer ${apiKey}` };
        } else if (provider === 'deepseek') {
            url = 'https://api.deepseek.com/v1/models';
            headers = { 'Authorization': `Bearer ${apiKey}` };
        } else if (provider === 'google') {
            url = `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`;
        } else if (provider === 'custom') {
            if (!customUrl) throw new Error('请先填写自定义 API 地址');
            const baseRaw = String(customUrl).trim();
            // 允许用户填三种：
            // 1) http(s)://host:port            -> + /v1/models
            // 2) http(s)://host:port/v1         -> + /models
            // 3) http(s)://host:port/v1/models  -> 原样使用
            // 并消除重复斜杠
            let base = baseRaw.replace(/\s+/g, '');
            // 去掉末尾的斜杠，后续再拼
            base = base.replace(/\/$/, '');
            if (/\/models(\/)?$/i.test(base)) {
                url = base; // 已包含 /models
            } else if (/\/v1$/i.test(base)) {
                url = base + '/models';
            } else {
                url = base + '/v1/models';
            }
            headers = { 'Authorization': `Bearer ${apiKey}` };
        }

        if (!url) throw new Error('未配置拉取地址');

        // 某些 WebView 对带有用户名密码的 URL 不允许构造，这里防御
        try {
            const u = new URL(url);
            if (u.username || u.password) {
                throw new Error('URL 不允许包含用户名/密码');
            }
        } catch (e) {
            // 对于相对路径等异常，直接抛出友好提示
            if (e && e.message) throw e;
            throw new Error('自定义地址无效，请检查是否为 http/https 完整地址');
        }

        const resp = await fetch(url, { headers });
        if (!resp.ok) throw new Error(`获取模型失败: ${resp.status}`);
        const data = await resp.json();

        let models = [];
        if (currentAIProvider === 'google') {
            // Google 返回 { models: [ { name: 'models/gemini-pro' }, ... ] }
            const arr = data.models || [];
            models = arr.map(m => ({ id: (m.name || '').replace(/^models\//,''), name: (m.displayName || m.name || '').replace(/^models\//,'') }))
                        .filter(m => m.id);
        } else {
            // OpenAI/DeepSeek/Custom 类似：{ data: [ { id } ] } 或 { object, data }
            const arr = data.data || data.models || [];
            models = arr.map(m => ({ id: m.id || m.name, name: m.id || m.name }))
                        .filter(m => m.id);
        }

        if (models.length === 0) throw new Error('未获取到模型');

        // 渲染可点击列表，点击后填入输入框
        const fragment = document.createDocumentFragment();
        models.forEach(m => {
            const btn = document.createElement('button');
            btn.className = 'ai-form-btn';
            btn.style.marginRight = '6px';
            btn.textContent = m.name;
            btn.onclick = () => { modelInput.value = m.id; };
            fragment.appendChild(btn);
        });
        listDiv.appendChild(fragment);
        listDiv.style.display = 'block';
    } catch (e) {
        console.error(e);
        listDiv.style.display = 'block';
        listDiv.innerHTML = '<div style="color:#d33;">拉取失败，请检查地址与密钥</div>';
        alert('拉取模型失败：' + (e.message || e));
    } finally {
        loading.classList.remove('show');
    }
}

// 兼容旧按钮调用
function fetchModelsToInput(){ fetchModels(); }

// 新的下拉框拉取模型函数
async function fetchModelsToSelect() {
    const provider = currentAIProvider;
    if (!provider) {
        alert('请先选择AI服务商');
        return;
    }
    
    const selectElement = document.getElementById('aiModel');
    const loading = document.getElementById('aiLoading');
    
    try {
        loading.classList.add('show');
        
        // 获取API密钥和自定义URL
        const apiKeyInput = (document.getElementById('aiApiKey') || {}).value || '';
        const customUrlInput = (document.getElementById('aiCustomUrl') || {}).value || '';
        const { apiKey: savedKey, customUrl: savedUrl } = aiConfig;
        const apiKey = (apiKeyInput || savedKey || '').trim();
        const customUrl = (customUrlInput || savedUrl || '').trim();

        if (!apiKey) {
            throw new Error('请先填写 API 密钥');
        }

        let url = '';
        let headers = {};

        if (provider === 'openai') {
            url = 'https://api.openai.com/v1/models';
            headers = { 'Authorization': `Bearer ${apiKey}` };
        } else if (provider === 'deepseek') {
            url = 'https://api.deepseek.com/v1/models';
            headers = { 'Authorization': `Bearer ${apiKey}` };
        } else if (provider === 'google') {
            url = `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`;
        } else if (provider === 'custom') {
            if (!customUrl) throw new Error('请先填写自定义 API 地址');
            const baseRaw = String(customUrl).trim();
            let base = baseRaw.replace(/\s+/g, '');
            base = base.replace(/\/$/, '');
            if (/\/models(\/)?$/i.test(base)) {
                url = base;
            } else if (/\/v1$/i.test(base)) {
                url = base + '/models';
            } else {
                url = base + '/v1/models';
            }
            headers = { 'Authorization': `Bearer ${apiKey}` };
        }

        if (!url) throw new Error('未配置拉取地址');

        // 从API拉取模型列表
        const resp = await fetch(url, { headers });
        if (!resp.ok) throw new Error(`获取模型失败: ${resp.status}`);
        const data = await resp.json();

        let models = [];
        if (provider === 'google') {
            const arr = data.models || [];
            models = arr.map(m => ({ id: (m.name || '').replace(/^models\//,''), name: (m.displayName || m.name || '').replace(/^models\//,'') }))
                        .filter(m => m.id);
        } else {
            const arr = data.data || data.models || [];
            models = arr.map(m => ({ id: m.id || m.name, name: m.id || m.name }))
                        .filter(m => m.id);
        }

        if (models.length === 0) throw new Error('未获取到模型');
        
        // 清空现有选项（保留第一个默认选项）
        selectElement.innerHTML = '<option value="">请选择模型</option>';
        
        // 添加模型选项
        models.forEach(model => {
            const option = document.createElement('option');
            option.value = model.id;
            option.textContent = model.name;
            selectElement.appendChild(option);
        });
        
        // 如果有保存的模型，自动选择
        if (aiConfig.model) {
            selectElement.value = aiConfig.model;
        }
        
    } catch (error) {
        console.error('拉取模型失败:', error);
        alert('拉取模型失败: ' + error.message);
    } finally {
        loading.classList.remove('show');
    }
}

function getModelsForProvider(provider) {
    const modelMap = {
        'deepseek': [
            { id: 'deepseek-chat', name: 'DeepSeek Chat' },
            { id: 'deepseek-coder', name: 'DeepSeek Coder' }
        ],
        'google': [
            { id: 'gemini-pro', name: 'Gemini Pro' },
            { id: 'gemini-pro-vision', name: 'Gemini Pro Vision' }
        ],
        'openai': [
            { id: 'gpt-4', name: 'GPT-4' },
            { id: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo' },
            { id: 'gpt-4-turbo', name: 'GPT-4 Turbo' }
        ],
        'custom': [
            { id: 'custom-model', name: '自定义模型' }
        ]
    };
    
    return modelMap[provider] || [];
}

// 自动测试连接（静默模式，不显示弹窗）
async function autoTestConnection() {
    if (!aiConfig.provider || !aiConfig.apiKey || !aiConfig.model) {
        return;
    }
    
    // 设置连接中状态
    aiConfig.status = 'connecting';
    updateAIDisplay();
    
    try {
        // 静默测试连接
        const { provider, apiKey, customUrl, model } = aiConfig;
        let url, headers;
        
        if (provider === 'deepseek') {
            url = 'https://api.deepseek.com/v1/models';
            headers = { 'Authorization': `Bearer ${apiKey}` };
        } else if (provider === 'google') {
            url = `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`;
            headers = {};
        } else if (provider === 'openai') {
            url = 'https://api.openai.com/v1/models';
            headers = { 'Authorization': `Bearer ${apiKey}` };
        } else if (provider === 'custom') {
            if (!customUrl) return;
            const base = customUrl.replace(/\/$/, '');
            url = base.endsWith('/v1') ? base + '/models' : 
                  base.endsWith('/chat/completions') ? base.replace('/chat/completions', '/models') :
                  base + '/v1/models';
            headers = { 'Authorization': `Bearer ${apiKey}` };
        }
        
        const response = await fetch(url, {
            method: 'GET',
            headers: headers
        });
        
        if (response.ok) {
            aiConfig.status = 'connected';
            console.log('AI服务自动连接成功');
        } else {
            aiConfig.status = 'disconnected';
            console.log('AI服务自动连接失败');
        }
        
        // 更新显示状态
        updateAIDisplay();
        
    } catch (error) {
        aiConfig.status = 'disconnected';
        updateAIDisplay();
        console.log('AI服务自动连接失败:', error.message);
    }
}

function testAIConnection() {
    const apiKey = document.getElementById('aiApiKey').value.trim();
    const customUrl = document.getElementById('aiCustomUrl').value.trim();
    const model = document.getElementById('aiModel').value;
    
    if (!apiKey) {
        alert('请输入API密钥');
        return;
    }
    
    if (currentAIProvider === 'custom' && !customUrl) {
        alert('请输入自定义API地址');
        return;
    }
    
    if (!model) {
        alert('请选择模型');
        return;
    }
    
    playClickSound();
    
    // 模拟测试连接
    const testBtn = document.getElementById('aiTestBtn');
    const originalText = testBtn.textContent;
    testBtn.textContent = '测试中...';
    testBtn.disabled = true;
    
    setTimeout(() => {
        // 模拟测试结果
        const success = Math.random() > 0.3; // 70%成功率
        
        if (success) {
            alert('连接测试成功！');
            aiConfig.status = 'connected';
        } else {
            alert('连接测试失败，请检查API密钥和网络连接');
            aiConfig.status = 'disconnected';
        }
        
        testBtn.textContent = originalText;
        testBtn.disabled = false;
    }, 2000);
}

async function saveAIConfig() {
    const apiKey = document.getElementById('aiApiKey').value.trim();
    const customUrl = document.getElementById('aiCustomUrl').value.trim();
    const model = document.getElementById('aiModel').value;
    
    if (!apiKey || !model) {
        alert('请填写完整的配置信息');
        return;
    }
    
    playClickSound();
    
    // 保存配置
    aiConfig.provider = currentAIProvider;
    aiConfig.apiKey = apiKey;
    aiConfig.customUrl = customUrl;
    aiConfig.model = model;
    
    await AppStorage.setItem('aiConfig', JSON.stringify(aiConfig));
    
    // 更新显示
    updateAIDisplay();
    
    // 关闭弹窗
    closeAIConfig();
    
    // 自动测试连接
    await autoTestConnection();
    
    if (aiConfig.status === 'connected') {
        alert('AI配置已保存并连接成功！');
    } else {
        alert('AI配置已保存，但连接失败。请检查网络或API配置。');
    }
}

// AI聊天功能 - 支持后台处理
async function sendAIMessage(message) {
    if (!aiConfig.provider || !aiConfig.apiKey || !aiConfig.model || aiConfig.status !== 'connected') {
        return null;
    }
    
    try {
        // 检查是否有正在进行的AI生成任务
        const pendingTask = await getPendingAITask();
        if (pendingTask) {
            console.log('已有AI任务在进行中，将新任务加入队列');
            await addToAIQueue(message);
            return null; // 不立即返回结果，等待后台处理
        }
        
        // 标记AI生成开始
        await setAITaskStatus('generating', message);
        
        const response = await callAIAPI(message);
        
        // 标记AI生成完成
        await setAITaskStatus('completed', null);
        
        return response;
    } catch (error) {
        console.error('AI调用失败:', error);
        // 标记AI生成失败
        await setAITaskStatus('failed', null);
        return null;
    }
}

// 手动重置AI任务状态（解决卡住问题）
async function resetAITaskStatus() {
    try {
        await setAITaskStatus('reset', null);
        console.log('AI任务状态已重置');
        alert('AI任务状态已重置，现在可以正常发送消息了！');
    } catch (error) {
        console.error('重置AI任务状态失败:', error);
        alert('重置失败，请刷新页面重试');
    }
}

// 将重置函数暴露到全局，方便调试
window.resetAITaskStatus = resetAITaskStatus;

// 多选消息功能
let selectedMessages = [];
let isMultiSelectMode = false;

// 进入多选模式
function enterMultiSelectMode() {
    isMultiSelectMode = true;
    showMultiSelectToolbar();
    // 添加多选样式
    document.body.classList.add('multi-select-mode');
}

// 退出多选模式
function exitMultiSelectMode() {
    isMultiSelectMode = false;
    selectedMessages = [];
    hideMultiSelectToolbar();
    // 移除多选样式
    document.body.classList.remove('multi-select-mode');
    // 清除所有选中状态
    document.querySelectorAll('.message.selected').forEach(msg => {
        msg.classList.remove('selected');
    });
}

// 显示多选工具栏
function showMultiSelectToolbar() {
    let toolbar = document.getElementById('multiSelectToolbar');
    if (!toolbar) {
        toolbar = document.createElement('div');
        toolbar.id = 'multiSelectToolbar';
        toolbar.className = 'multi-select-toolbar';
        toolbar.innerHTML = `
            <div class="multiselect-action" onclick="forwardSelectedMessages()">转发</div>
            <div class="multiselect-action" onclick="deleteSelectedMessages()">删除</div>
            <div class="multiselect-action" onclick="collectSelectedMessages()">收藏</div>
            <div class="multiselect-action" onclick="exitMultiSelectMode()">取消</div>
        `;
        document.body.appendChild(toolbar);
    }
    toolbar.style.display = 'flex';
}

// 隐藏多选工具栏
function hideMultiSelectToolbar() {
    const toolbar = document.getElementById('multiSelectToolbar');
    if (toolbar) {
        toolbar.style.display = 'none';
    }
}

// 切换消息选中状态
function toggleMessageSelection(messageId) {
    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
    if (!messageElement) return;
    
    const index = selectedMessages.indexOf(messageId);
    if (index > -1) {
        // 取消选中
        selectedMessages.splice(index, 1);
        messageElement.classList.remove('selected');
    } else {
        // 选中
        selectedMessages.push(messageId);
        messageElement.classList.add('selected');
    }
    
    // 更新工具栏状态
    updateMultiSelectToolbar();
}

// 更新多选工具栏状态
function updateMultiSelectToolbar() {
    const toolbar = document.getElementById('multiSelectToolbar');
    if (!toolbar) return;
    
    const deleteBtn = toolbar.querySelector('[onclick="deleteSelectedMessages()"]');
    const forwardBtn = toolbar.querySelector('[onclick="forwardSelectedMessages()"]');
    const collectBtn = toolbar.querySelector('[onclick="collectSelectedMessages()"]');
    
    const hasSelection = selectedMessages.length > 0;
    
    if (deleteBtn) deleteBtn.style.opacity = hasSelection ? '1' : '0.5';
    if (forwardBtn) forwardBtn.style.opacity = hasSelection ? '1' : '0.5';
    if (collectBtn) collectBtn.style.opacity = hasSelection ? '1' : '0.5';
}

// 删除选中的消息
async function deleteSelectedMessages() {
    if (selectedMessages.length === 0) {
        alert('请先选择要删除的消息');
        return;
    }
    
    if (!confirm(`确定要删除选中的 ${selectedMessages.length} 条消息吗？`)) {
        return;
    }
    
    try {
        // 从chatMessages数组中删除选中的消息
        selectedMessages.forEach(messageId => {
            const index = chatMessages.findIndex(msg => msg.id == messageId);
            if (index > -1) {
                chatMessages.splice(index, 1);
            }
        });
        
        // 从DOM中删除选中的消息元素
        selectedMessages.forEach(messageId => {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                messageElement.remove();
            }
        });
        
        // 保存更新后的消息
        if (currentChatContact) {
            await saveChatMessages(currentChatContact.id, chatMessages);
        }
        
        // 退出多选模式
        exitMultiSelectMode();
        
        // 显示成功提示
        showNotification(`已删除 ${selectedMessages.length} 条消息`);
        
    } catch (error) {
        console.error('删除消息失败:', error);
        alert('删除消息失败，请重试');
    }
}

// 转发选中的消息
function forwardSelectedMessages() {
    if (selectedMessages.length === 0) {
        alert('请先选择要转发的消息');
        return;
    }
    
    // 这里可以实现转发逻辑
    alert(`转发 ${selectedMessages.length} 条消息功能待实现`);
}

// 收藏选中的消息
function collectSelectedMessages() {
    if (selectedMessages.length === 0) {
        alert('请先选择要收藏的消息');
        return;
    }
    
    // 这里可以实现收藏逻辑
    alert(`收藏 ${selectedMessages.length} 条消息功能待实现`);
}

// 绑定长按事件
function bindLongPress(element, message) {
    let pressTimer = null;
    let isLongPress = false;
    
    const startPress = (e) => {
        isLongPress = false;
        pressTimer = setTimeout(() => {
            isLongPress = true;
            // 长按触发多选模式
            if (!isMultiSelectMode) {
                enterMultiSelectMode();
                // 自动选中当前消息
                toggleMessageSelection(message.id);
            }
        }, 500); // 500ms后触发长按
    };
    
    const endPress = (e) => {
        if (pressTimer) {
            clearTimeout(pressTimer);
            pressTimer = null;
        }
        
        // 如果不是长按，且不在多选模式，则正常处理点击
        if (!isLongPress && !isMultiSelectMode) {
            // 这里可以添加正常的点击处理逻辑
        }
    };
    
    // 鼠标事件（PC端）
    element.addEventListener('mousedown', startPress);
    element.addEventListener('mouseup', endPress);
    element.addEventListener('mouseleave', endPress);
    
    // 触摸事件（移动端）
    element.addEventListener('touchstart', (e) => {
        e.preventDefault();
        startPress(e);
    });
    
    element.addEventListener('touchend', (e) => {
        e.preventDefault();
        endPress(e);
    });
    
    element.addEventListener('touchcancel', (e) => {
        e.preventDefault();
        endPress(e);
    });
}

// AI任务管理函数
async function setAITaskStatus(status, message) {
    const taskData = {
        status: status,
        message: message,
        timestamp: Date.now(),
        contactId: currentChatContact ? currentChatContact.id : null
    };
    await AppStorage.setItem('ai_task_status', JSON.stringify(taskData));
}

async function getPendingAITask() {
    try {
        const taskData = await AppStorage.getItem('ai_task_status');
        if (!taskData) return null;
        
        const task = JSON.parse(taskData);
        if (task.status === 'generating') {
            // 检查任务是否超时（超过30秒认为卡住了）
            const now = Date.now();
            const taskAge = now - (task.timestamp || 0);
            const TIMEOUT = 30000; // 30秒超时
            
            if (taskAge > TIMEOUT) {
                console.log('AI任务超时，自动重置状态');
                await setAITaskStatus('timeout', null);
                return null;
            }
            
            return task;
        }
        return null;
    } catch (error) {
        console.error('获取AI任务状态失败:', error);
        return null;
    }
}

async function addToAIQueue(message) {
    try {
        const queueData = await AppStorage.getItem('ai_queue');
        const queue = queueData ? JSON.parse(queueData) : [];
        
        queue.push({
            message: message,
            timestamp: Date.now(),
            contactId: currentChatContact ? currentChatContact.id : null
        });
        
        await AppStorage.setItem('ai_queue', JSON.stringify(queue));
        console.log('AI任务已加入队列');
    } catch (error) {
        console.error('添加AI任务到队列失败:', error);
    }
}

async function processAIQueue() {
    try {
        const queueData = await AppStorage.getItem('ai_queue');
        if (!queueData) return;
        
        const queue = JSON.parse(queueData);
        if (queue.length === 0) return;
        
        // 取出队列中的第一个任务
        const task = queue.shift();
        await AppStorage.setItem('ai_queue', JSON.stringify(queue));
        
        // 处理任务
        await setAITaskStatus('generating', task.message);
        
        try {
            const response = await callAIAPI(task.message);
            await setAITaskStatus('completed', null);
            
            // 如果当前在聊天界面，直接显示回复
            if (currentChatContact && currentChatContact.id === task.contactId) {
                await renderAndSaveAIReplies(response);
            } else {
                // 如果不在聊天界面，保存待处理回复
                await savePendingAIResponse(task.contactId, response);
            }
        } catch (error) {
            console.error('处理AI队列任务失败:', error);
            await setAITaskStatus('failed', null);
            // 显示错误提示
            showAPIReminder('AI服务错误', 'AI服务暂时不可用，请检查网络连接或API配置');
        }
    } catch (error) {
        console.error('处理AI队列失败:', error);
    }
}

async function savePendingAIResponse(contactId, response) {
    try {
        const pendingKey = `pending_ai_response_${contactId}`;
        const pendingData = {
            response: response,
            timestamp: Date.now()
        };
        await AppStorage.setItem(pendingKey, JSON.stringify(pendingData));
    } catch (error) {
        console.error('保存待处理AI回复失败:', error);
    }
}

async function checkPendingAIResponse(contactId) {
    try {
        const pendingKey = `pending_ai_response_${contactId}`;
        const pendingData = await AppStorage.getItem(pendingKey);
        
        if (pendingData) {
            const data = JSON.parse(pendingData);
            await AppStorage.removeItem(pendingKey);
            return data.response;
        }
        return null;
    } catch (error) {
        console.error('检查待处理AI回复失败:', error);
        return null;
    }
}

// 后台AI处理服务
function startAIBackgroundService() {
    // 每5秒检查一次AI队列
    setInterval(async () => {
        const pendingTask = await getPendingAITask();
        if (!pendingTask) {
            await processAIQueue();
        }
    }, 5000);
    
    // 页面可见性变化时处理待处理回复
    document.addEventListener('visibilitychange', async () => {
        if (!document.hidden && currentChatContact) {
            const pendingResponse = await checkPendingAIResponse(currentChatContact.id);
            if (pendingResponse) {
                await renderAndSaveAIReplies(pendingResponse);
            }
        }
    });
}

// 构造统一的系统提示词（避免重复分支）
function buildSystemPrompt(contactPersona, selfPersona) {
  const baseRules = `你正在扮演一个角色（与我线上聊天），严格遵守：
1) 禁止任何"动作/舞台指令/表演性描述"，不要输出括号或星号中的动作（如[摸头]、(拥抱)、*轻抚*等）。
2) 语言风格亲密但尊重、口语自然、先共情后建议，避免居高临下的说教。
3) 每次对同一话题的回复允许1-20条短消息（每条1-3句），由调用方分发；请输出自然分段的文本，避免长篇讲义式段落。
4) 优先回应我的情绪与具体处境，再给1-2条可立即执行的小建议；如涉及风险，建议求助专业人士。
5) 避免模板化与重复用词，贴近日常表达，不暴露自己是AI。
6) 严禁在聊天中写日记！不要输出任何以日期开头的日记格式内容（如"2024年12月20日"、"今天"等），不要写内心独白或回忆录式的内容。
7) 若在合适场景下希望发送特殊消息，请使用以下格式：
   - 语音消息：[语音：文本内容]
   - 外卖消息：[外卖：食物|金额|备注]
   - 定位消息：[定位：地址]
   - 转账消息：[转账：金额|备注]
   - 图片消息：[图片：描述内容]
   - 视频消息：[视频：描述内容]
   - 文件消息：[文件：标题|大小|内容]
   - 天气消息：[天气：城市|温度|天气状况]
   - 表情包消息：[表情：表情名称]

8) 表情包使用规则：
   - 你可以在合适的时机发送表情包来增强表达效果
   - 表情包会根据你的回复内容自动选择，无需手动指定
   - 表情包会以特殊格式显示，包含表情图片和名称
   - 在表达情绪、回应情感或想要更生动地交流时，系统会自动为你选择合适的表情包

示例：
[语音：今天天气真好呢，我们去公园散步吧]
[外卖：宫保鸡丁|25.8|不要辣]
[定位：北京市朝阳区三里屯]
[转账：100|请吃饭]
[图片：左手拿着水杯，右手拿着牙刷]
[视频：我在公园里跑步的视频]
[文件：会议记录.docx|2.5MB|今天的会议讨论了新项目计划]
[天气：北京|22°C|晴朗]
`;

  const personaParts = [];
  if (contactPersona) personaParts.push(`角色人设：${contactPersona}`);
  if (selfPersona) personaParts.push(`我的人设：${selfPersona}`);

  if (personaParts.length === 0) return baseRules;
  return `${baseRules}\n\n${personaParts.join('\n\n')}\n\n请以该角色的性格与口吻自然回复。`;
}

// 将当前会话构造成多轮对话（解锁上下文）
function buildAIChatMessages(systemPrompt, latestUserText, maxTurns = 20, maxChars = 5000) {
  // 如果为该联系人设置了专属上下文条数，则优先采用
  try {
    if (currentChatContact) {
      const key = `contact_${currentChatContact.id}`;
      // 注意：此函数在同步上下文内使用不到 await，这里仅做保护性读取（若未命中则忽略）
      // 若需要严格同步读取，可在调用处提前获取；当前简单容错：异步读取不可用时使用缓存字段
      // 读取缓存字段
      // 在 openChatApp 加载时 currentChatContact 可能没有 contextTurns，因此更稳妥的方案是用 savedContact
    }
  } catch (e) {}

  const messages = [];
  if (systemPrompt) messages.push({ role: 'system', content: systemPrompt });

  // 从最近到最早遍历，收集有限条数与字符数
  let totalChars = 0;
  const history = [];
  if (Array.isArray(chatMessages)) {
    for (let i = chatMessages.length - 1; i >= 0; i--) {
      const m = chatMessages[i];
      if (!m || typeof m.content !== 'string') continue;
      // 仅纳入普通文本与可读内容，系统提示/菜单等可忽略
      const text = m.content.trim();
      if (!text) continue;
      const role = (m.sender === 'sent') ? 'user' : 'assistant';
      history.push({ role, content: text });
      totalChars += text.length;
      if (history.length >= maxTurns || totalChars >= maxChars) break;
    }
  }
  history.reverse();
  messages.push(...history);
  if (latestUserText && latestUserText.trim()) {
    messages.push({ role: 'user', content: latestUserText.trim() });
  }
  return messages;
}

// 异步读取当前联系人上下文条数
async function getCurrentContactContextTurns(defaultTurns = 20) {
  try {
    if (!currentChatContact) return defaultTurns;
    const contactKey = `contact_${currentChatContact.id}`;
    const savedContact = await AppStorage.getItem(contactKey);
    if (savedContact) {
      const contactData = JSON.parse(savedContact);
      if (Number.isFinite(contactData.contextTurns)) return Math.max(0, Math.min(200, contactData.contextTurns));
    }
  } catch (e) {}
  return defaultTurns;
}

// 为不支持多消息结构的提供商（如部分Google接口）拼接历史文本
async function buildAIHistoryPlainText(systemPrompt, latestUserText, maxTurns = 20, maxChars = 5000) {
  maxTurns = await getCurrentContactContextTurns(maxTurns);
  const parts = [];
  if (systemPrompt) parts.push(systemPrompt);
  const lines = [];
  let totalChars = 0;
  if (Array.isArray(chatMessages)) {
    for (let i = chatMessages.length - 1; i >= 0; i--) {
      const m = chatMessages[i];
      if (!m || typeof m.content !== 'string') continue;
      const who = (m.sender === 'sent') ? '用户' : '助手';
      const text = m.content.trim();
      if (!text) continue;
      lines.push(`${who}：${text}`);
      totalChars += text.length;
      if (lines.length >= maxTurns || totalChars >= maxChars) break;
    }
  }
  lines.reverse();
  if (lines.length) parts.push('对话历史：\n' + lines.join('\n'));
  if (latestUserText && latestUserText.trim()) parts.push('用户消息：' + latestUserText.trim());
  return parts.join('\n\n');
}

// 专门用于日记生成的AI调用函数
async function callAIAPIForDiary(message) {
    const { provider, apiKey, customUrl, model } = aiConfig;
    
    // 检查AI配置是否完整
    if (!provider || !apiKey || !model) {
        throw new Error('AI配置不完整');
    }
    
    // 获取人设信息
    const contactPersona = await getContactPersona();
    
    // 构建专门的日记系统提示词
    const diarySystemPrompt = `你是一个专业的日记生成助手。请根据提供的聊天记录，以角色的身份写一篇日记。

角色人设：${contactPersona || '普通角色'}

重要规则：
1. 这是日记生成，不是聊天回复
2. 严格按照要求的格式生成日记内容
3. 不要输出任何聊天消息格式的内容
4. 专注于日记的创作，不要偏离主题
5. 使用第一人称视角，以角色的身份写作

请完全按照用户的要求生成日记内容。`;

    let apiUrl, headers, body;
    
    switch (provider) {
        case 'deepseek':
            apiUrl = 'https://api.deepseek.com/v1/chat/completions';
            headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            };
            body = {
                model: model,
                messages: [
                    { role: 'system', content: diarySystemPrompt },
                    { role: 'user', content: message }
                ],
                stream: false
            };
            break;
            
        case 'google':
            apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`;
            headers = {
                'Content-Type': 'application/json'
            };
            const fullMessage = `${diarySystemPrompt}\n\n用户要求：${message}`;
            body = {
                contents: [{
                    parts: [{ text: fullMessage }]
                }]
            };
            apiUrl += `?key=${apiKey}`;
            break;
            
        case 'openai':
            apiUrl = 'https://api.openai.com/v1/chat/completions';
            headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            };
            body = {
                model: model,
                messages: [
                    { role: 'system', content: diarySystemPrompt },
                    { role: 'user', content: message }
                ],
                stream: false
            };
            break;
            
        case 'custom':
            let base = String(customUrl || '').trim();
            base = base.replace(/\/$/, '');
            if (/\/chat\/completions(\/)?$/i.test(base)) {
                apiUrl = base;
            } else if (/\/v1$/i.test(base)) {
                apiUrl = base + '/chat/completions';
            } else {
                apiUrl = base + '/v1/chat/completions';
            }
            headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            };
            body = {
                model: model,
                messages: [
                    { role: 'system', content: diarySystemPrompt },
                    { role: 'user', content: message }
                ],
                stream: false
            };
            break;
            
        default:
            throw new Error('不支持的AI提供商');
    }
    
    const response = await fetch(apiUrl, {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(body)
    });
    
    if (!response.ok) {
        throw new Error(`API调用失败: ${response.status}`);
    }
    
    const data = await response.json();
    
    // 根据不同提供商解析响应
    switch (provider) {
        case 'google':
            return data.candidates?.[0]?.content?.parts?.[0]?.text || '抱歉，无法生成日记内容。';
        default:
            return data.choices?.[0]?.message?.content || '抱歉，无法生成日记内容。';
    }
}

async function callAIAPI(message) {
    const { provider, apiKey, customUrl, model } = aiConfig;
    
    // 检查AI配置是否完整
    if (!provider || !apiKey || !model) {
        throw new Error('AI配置不完整');
    }
    
    // 获取人设信息
    const contactPersona = await getContactPersona();
    const selfPersona = await getSelfPersona();
    
    // 构建系统提示词（陪伴式、无动作、多条短消息，读人设）
    const systemPrompt = buildSystemPrompt(contactPersona, selfPersona);
    
    let apiUrl, headers, body;
    
    switch (provider) {
        case 'deepseek':
            apiUrl = 'https://api.deepseek.com/v1/chat/completions';
            headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            };
            body = {
                model: model,
                messages: buildAIChatMessages(systemPrompt, message, await getCurrentContactContextTurns(20)),
                stream: false
            };
            break;
            
        case 'google':
            apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`;
            headers = {
                'Content-Type': 'application/json'
            };
            const fullMessage = await buildAIHistoryPlainText(systemPrompt, message, await getCurrentContactContextTurns(20));
            body = {
                contents: [{
                    parts: [{ text: fullMessage }]
                }]
            };
            // Google API使用查询参数传递API密钥
            apiUrl += `?key=${apiKey}`;
            break;
            
        case 'openai':
            apiUrl = 'https://api.openai.com/v1/chat/completions';
            headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            };
            body = {
                model: model,
                messages: buildAIChatMessages(systemPrompt, message, await getCurrentContactContextTurns(20)),
                stream: false
            };
            break;
            
        case 'custom':
            // 自定义反代：规范化 URL 并拼接 /chat/completions
            let base = String(customUrl || '').trim();
            base = base.replace(/\/$/, '');
            if (/\/chat\/completions(\/)?$/i.test(base)) {
                apiUrl = base;
            } else if (/\/v1$/i.test(base)) {
                apiUrl = base + '/chat/completions';
            } else {
                apiUrl = base + '/v1/chat/completions';
            }
            headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            };
            body = {
                model: model,
                messages: buildAIChatMessages(systemPrompt, message, await getCurrentContactContextTurns(20)),
                stream: false
            };
            break;
            
        default:
            throw new Error('不支持的AI提供商');
    }
    
    const response = await fetch(apiUrl, {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(body)
    });
    
    if (!response.ok) {
        throw new Error(`API调用失败: ${response.status}`);
    }
    
    const data = await response.json();
    
    // 根据不同提供商解析响应
    switch (provider) {
        case 'google':
            return data.candidates?.[0]?.content?.parts?.[0]?.text || '抱歉，我无法理解您的问题。';
        default:
            return data.choices?.[0]?.message?.content || '抱歉，我无法理解您的问题。';
    }
}

async function getContactPersona() {
    if (!currentChatContact) return '';
    
    const contactKey = `contact_${currentChatContact.id}`;
    const savedContact = await AppStorage.getItem(contactKey);
    if (savedContact) {
        const contactData = JSON.parse(savedContact);
        return contactData.persona || '';
    }
    return '';
}

async function getSelfPersona() {
    const savedSelf = await AppStorage.getItem('selfSettings');
    if (savedSelf) {
        const selfData = JSON.parse(savedSelf);
        return selfData.persona || '';
    }
    return '';
}

async function getSelfAvatar() {
    const savedSelf = await AppStorage.getItem('selfSettings');
    if (savedSelf) {
        const selfData = JSON.parse(savedSelf);
        return selfData.avatar || 'https://placehold.co/36x36/E8E8E8/999?text=我';
    }
    return 'https://placehold.co/36x36/E8E8E8/999?text=我';
}

// 页面初始化函数
async function initializeApp() {
    try {
        // 等待IndexedDB迁移完成
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // 加载消息列表数据
        await loadMessagesData();
        
        // 加载AI配置
        await loadAIConfig();
        
        // 加载论坛数据
        await loadForumData();
        
        // 加载个人主页数据
        loadProfileData();
        
        // 初始化发布动态图片上传
        initPostMomentImageUpload();
        
        console.log('应用初始化完成');
    } catch (error) {
        console.error('应用初始化失败:', error);
    }
}

// 加载消息列表数据
async function loadMessagesData() {
    try {
        // 从IndexedDB加载消息列表
        const savedMessages = await AppStorage.getItem('currentMessages');
        if (savedMessages) {
            currentMessages = JSON.parse(savedMessages);
        }
        // 清理历史上的示例联系人（小雨/阿明/苏凛泽/苍介 等）
        await cleanupDefaultSeedContacts();
        
        // 重新渲染消息列表以显示正确的头像
        await await renderMessagesList();
    } catch (error) {
        console.error('加载消息数据失败:', error);
    }
}

// 保存消息列表数据
async function saveMessagesData() {
    try {
        await AppStorage.setItem('currentMessages', JSON.stringify(currentMessages));
    } catch (error) {
        console.error('保存消息数据失败:', error);
    }
}

// 聊天功能条
function openChatMenu() {
    console.log('openChatMenu called'); // 调试信息
    playClickSound();
    const chatToolbar = document.getElementById('chatToolbar');
    if (chatToolbar) {
        chatToolbar.style.display = 'block';
        console.log('Chat toolbar opened'); // 调试信息
    } else {
        console.error('Chat toolbar element not found'); // 调试信息
    }
}

function closeChatMenu() {
    playClickSound();
    const chatToolbar = document.getElementById('chatToolbar');
    if (chatToolbar) {
        chatToolbar.style.display = 'none';
    }
}

// 聊天功能函数
function openMusicTogether() {
    playClickSound();
    closeChatMenu();
    openMusicTogetherModal();
}

function sendImage() {
    playClickSound();
    closeChatMenu();
    openImageUploadModal();
}

function sendTransfer() {
    playClickSound();
    closeChatMenu();
    openTransferModal();
}

function sendLocation() {
    playClickSound();
    closeChatMenu();
    openLocationModal();
}

function orderFood() {
    playClickSound();
    closeChatMenu();
    openFoodOrderModal();
}

function sendEmoji() {
    playClickSound();
    closeChatMenu();
    openEmojiModal();
}

// 打开表情包弹窗
function openEmojiModal() {
    const emojiModal = document.getElementById('emojiModal');
    if (emojiModal) {
        emojiModal.classList.add('show');
        renderEmojiGrid();
    }
}

// 关闭表情包弹窗
function closeEmojiModal() {
    playClickSound();
    const emojiModal = document.getElementById('emojiModal');
    if (emojiModal) {
        emojiModal.classList.remove('show');
    }
}

// 渲染表情包网格
async function renderEmojiGrid() {
    const emojiContainer = document.getElementById('emojiContainer');
    if (!emojiContainer) return;
    
    const currentContactId = getCurrentContactId();
    if (!currentContactId) return;
    
    // 获取当前角色的表情包
    const emojiKey = `emojis_${currentContactId}`;
    const savedEmojis = await AppStorage.getItem(emojiKey);
    let emojis = savedEmojis ? JSON.parse(savedEmojis) : [];
    
    if (emojis.length === 0) {
        emojiContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">暂无表情包，点击左上角上传</div>';
        return;
    }
    
    let emojiHTML = '<div class="emoji-grid">';
    emojis.forEach(emoji => {
        emojiHTML += `
            <div class="emoji-item" onclick="sendEmojiMessage('${emoji.url}')">
                <img src="${emoji.url}" alt="${emoji.name}" title="${emoji.name}">
            </div>
        `;
    });
    emojiHTML += '</div>';
    
    emojiContainer.innerHTML = emojiHTML;
}

// 上传表情包
function uploadEmoji() {
    const result = prompt('请输入图床链接，格式：名字：链接\n例如：开心：http://example.com/happy.jpg', '');
    
    if (result && result.includes('：')) {
        const [name, url] = result.split('：');
        if (name.trim() && url.trim()) {
            saveEmoji(name.trim(), url.trim());
        } else {
            alert('格式错误！请使用：名字：链接 的格式');
        }
    }
}

// 保存表情包
async function saveEmoji(name, url) {
    try {
        const currentContactId = getCurrentContactId();
        if (!currentContactId) return;
        
        const emojiKey = `emojis_${currentContactId}`;
        const savedEmojis = await AppStorage.getItem(emojiKey);
        let emojis = savedEmojis ? JSON.parse(savedEmojis) : [];
        
        // 检查是否已存在
        const exists = emojis.some(emoji => emoji.name === name || emoji.url === url);
        if (exists) {
            alert('该表情包已存在！');
            return;
        }
        
        emojis.push({ name, url, id: Date.now() });
        await AppStorage.setItem(emojiKey, JSON.stringify(emojis));
        
        // 重新渲染表情包网格
        renderEmojiGrid();
        alert('表情包添加成功！');
    } catch (error) {
        console.error('保存表情包失败:', error);
        alert('保存表情包失败！');
    }
}

// 发送表情包消息
function sendEmojiMessage(emojiUrl) {
    playClickSound();
    closeEmojiModal();
    
    // 添加表情包消息到聊天
    addMessage(emojiUrl, 'sent', 'emoji');
    scrollToBottom();
}

function sendVoice() {
    playClickSound();
    closeChatMenu();
    openVoiceTextModal();
}

function videoCall() {
    playClickSound();
    closeChatMenu();
    openCallModal();
}

// 打开通话选择弹窗
function openCallModal() {
    const callModal = document.getElementById('callModal');
    if (callModal) {
        callModal.classList.add('show');
    }
}

// 关闭通话选择弹窗
function closeCallModal() {
    playClickSound();
    const callModal = document.getElementById('callModal');
    if (callModal) {
        callModal.classList.remove('show');
    }
}

// 发起语音通话
function initiateVoiceCall() {
    playClickSound();
    closeCallModal();
    showVoiceInviteModal();
}

// 发起视频通话
function initiateVideoCall() {
    playClickSound();
    closeCallModal();
    showVideoInviteModal();
}

// 显示语音通话来电弹窗
function showVoiceInviteModal() {
    const voiceModal = document.getElementById('voiceInviteModal');
    const voiceName = document.getElementById('voiceInviteName');
    const voiceAvatar = document.getElementById('voiceInviteAvatar');
    
    if (voiceModal && currentChatContact) {
        voiceName.textContent = currentChatContact.name;
        voiceAvatar.src = currentChatContact.avatar || 'https://placehold.co/120x120/E8E8E8/999?text=头像';
        voiceModal.classList.add('show');
    }
}

// 显示视频通话来电弹窗
function showVideoInviteModal() {
    const videoModal = document.getElementById('videoInviteModal');
    const videoName = document.getElementById('videoInviteName');
    const videoAvatar = document.getElementById('videoInviteAvatar');
    
    if (videoModal && currentChatContact) {
        videoName.textContent = currentChatContact.name;
        videoAvatar.src = currentChatContact.avatar || 'https://placehold.co/120x120/E8E8E8/999?text=头像';
        videoModal.classList.add('show');
    }
}

// 接听语音通话
function acceptVoiceCall() {
    playClickSound();
    closeVoiceInviteModal();
    showVoiceCallInterface();
}

// 挂断语音通话
function declineVoiceCall() {
    playClickSound();
    closeVoiceInviteModal();
}

// 接听视频通话
function acceptVideoCall() {
    playClickSound();
    closeVideoInviteModal();
    showVideoCallInterface();
}

// 挂断视频通话
function declineVideoCall() {
    playClickSound();
    closeVideoInviteModal();
}

// ========== 语音通话界面功能 ==========

// 显示语音通话界面
function showVoiceCallInterface() {
    const voiceInterface = document.getElementById('voiceCallInterface');
    const voiceAvatar = document.getElementById('voiceCallAvatar');
    const voiceName = document.getElementById('voiceCallName');
    const voiceStatus = document.getElementById('voiceCallStatus');
    
    if (voiceInterface && currentChatContact) {
        voiceAvatar.src = currentChatContact.avatar || 'https://placehold.co/120x120/E8E8E8/999?text=头像';
        voiceName.textContent = currentChatContact.name;
        voiceStatus.textContent = '正在通话中...';
        
        // 开始计时
        window.voiceCallStartTime = Date.now();
        startVoiceCallTimer();
        
        voiceInterface.classList.add('show');
    }
}

// 挂断语音通话
function hangupVoiceCall() {
    playClickSound();
    const voiceInterface = document.getElementById('voiceCallInterface');
    if (voiceInterface) {
        // 停止计时
        if (window.voiceCallTimer) {
            clearInterval(window.voiceCallTimer);
        }
        // 关闭语音通话界面
        voiceInterface.classList.remove('show');
    }
}

// 开始语音通话计时
function startVoiceCallTimer() {
    const statusElement = document.getElementById('voiceCallStatus');
    if (!statusElement) return;
    
    window.voiceCallTimer = setInterval(() => {
        if (window.voiceCallStartTime) {
            const elapsed = Math.floor((Date.now() - window.voiceCallStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            statusElement.textContent = `语音通话中 ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
    }, 1000);
}

// 切换语音通话输入
function toggleVoiceCallInput() {
    const inputSection = document.getElementById('voiceCallInputSection');
    if (inputSection) {
        inputSection.style.display = inputSection.style.display === 'none' ? 'block' : 'none';
        if (inputSection.style.display === 'block') {
            document.getElementById('voiceCallTextInput').focus();
        }
    }
}

// 发送语音通话消息
function sendVoiceCallMessage() {
    const input = document.getElementById('voiceCallTextInput');
    const message = input.value.trim();
    if (message) {
        addVoiceCallMessage(message, 'sent');
        input.value = '';
        // 隐藏输入框
        document.getElementById('voiceCallInputSection').style.display = 'none';
        
        // 模拟AI回复
        setTimeout(() => {
            addVoiceCallMessage('收到你的消息了！', 'received');
        }, 1000);
    }
}

// 添加语音通话消息
function addVoiceCallMessage(message, type) {
    const messagesContainer = document.getElementById('voiceCallChatMessages');
    if (!messagesContainer) return;
    
    const messageElement = document.createElement('div');
    messageElement.className = `call-message ${type}`;
    messageElement.textContent = message;
    
    messagesContainer.appendChild(messageElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// ========== 视频通话界面功能 ==========

// 显示视频通话界面
async function showVideoCallInterface() {
    const videoInterface = document.getElementById('videoCallInterface');
    const characterImage = document.getElementById('videoCallCharacterImage');
    const dialogContent = document.getElementById('videoCallDialogContent');
    
    if (videoInterface) {
        // 如果没有当前联系人，创建一个默认的
        if (!currentChatContact) {
            currentChatContact = {
                id: 'default',
                name: '多云熊',
                avatar: 'https://placehold.co/120x120/E8E8E8/999?text=多云熊'
            };
        }
        
        // 加载角色通话立绘
        try {
            const callImage = await AppStorage.getItem('characterCallImage');
            if (callImage) {
                characterImage.src = callImage;
            } else {
                // 如果没有设置立绘，使用默认头像
                characterImage.src = currentChatContact.avatar || 'https://placehold.co/120x120/E8E8E8/999?text=头像';
            }
        } catch (error) {
            console.error('加载角色通话立绘失败:', error);
            characterImage.src = currentChatContact.avatar || 'https://placehold.co/120x120/E8E8E8/999?text=头像';
        }
        
        // 清空对话框内容
        dialogContent.innerHTML = '';
        
        // 开始计时
        window.videoCallStartTime = Date.now();
        startVideoCallTimer();
        
        videoInterface.classList.add('show');
    }
}

// 挂断视频通话
function hangupVideoCall() {
    playClickSound();
    const videoInterface = document.getElementById('videoCallInterface');
    if (videoInterface) {
        // 停止计时
        if (window.videoCallTimer) {
            clearInterval(window.videoCallTimer);
        }
        // 关闭视频通话界面
        videoInterface.classList.remove('show');
    }
}

// 开始视频通话计时
function startVideoCallTimer() {
    // 视频通话的计时可以在这里实现，比如显示通话时长
    // 目前先保持简单
}

// 视频通话输入框始终显示，不需要切换函数

// 发送视频通话消息
function sendVideoCallMessage() {
    const input = document.getElementById('videoCallTextInput');
    const message = input.value.trim();
    if (message) {
        addVideoCallMessage(message, 'user');
        input.value = '';
        
        // 模拟AI回复
        setTimeout(() => {
            addVideoCallMessage('我明白了！', 'ai');
        }, 1000);
    }
}

// 添加视频通话消息
function addVideoCallMessage(message, type) {
    const dialogContent = document.getElementById('videoCallDialogContent');
    if (!dialogContent) return;
    
    // 创建消息元素
    const messageElement = document.createElement('div');
    messageElement.className = `video-call-message ${type}`;
    
    if (type === 'user') {
        messageElement.textContent = message; // 去掉"你:"前缀
    } else {
        messageElement.textContent = message; // 去掉"AI:"前缀
    }
    
    dialogContent.appendChild(messageElement);
    
    // 滚动到底部
    const dialogBox = dialogContent.parentElement;
    dialogBox.scrollTop = dialogBox.scrollHeight;
}

// 关闭语音通话弹窗
function closeVoiceInviteModal() {
    const voiceModal = document.getElementById('voiceInviteModal');
    if (voiceModal) {
        voiceModal.classList.remove('show');
    }
}

// 关闭视频通话弹窗
function closeVideoInviteModal() {
    const videoModal = document.getElementById('videoInviteModal');
    if (videoModal) {
        videoModal.classList.remove('show');
    }
}

// 显示通话界面
function showCallInterface(callType) {
    const callInterface = document.getElementById('callInterface');
    const callName = document.getElementById('callName');
    const callStatus = document.getElementById('callStatus');
    const callAvatar = document.getElementById('callAvatar');
    
    if (callInterface && currentChatContact) {
        callName.textContent = currentChatContact.name;
        callStatus.textContent = callType === 'voice' ? '语音通话中...' : '视频通话中...';
        callAvatar.src = currentChatContact.avatar || 'https://placehold.co/120x120/E8E8E8/999?text=头像';
        
        // 记录通话开始时间
        window.callStartTime = Date.now();
        
        // 清空之前的聊天记录
        const chatMessages = document.getElementById('callChatMessages');
        if (chatMessages) {
            chatMessages.innerHTML = '';
        }
        
        // 开始计时
        startCallTimer();
        
        callInterface.classList.add('show');
    }
}

// 挂断通话
function hangupCall() {
    playClickSound();
    const callInterface = document.getElementById('callInterface');
    if (callInterface) {
        // 停止计时
        if (window.callTimer) {
            clearInterval(window.callTimer);
        }
        
        // 关闭通话界面
        callInterface.classList.remove('show');
    }
}

// 切换通话输入框显示/隐藏
function toggleCallInput() {
    playClickSound();
    const inputSection = document.getElementById('callInputSection');
    if (inputSection) {
        if (inputSection.style.display === 'none') {
            inputSection.style.display = 'block';
            document.getElementById('callTextInput').focus();
        } else {
            inputSection.style.display = 'none';
        }
    }
}

// 发送通话消息
function sendCallMessage() {
    const textInput = document.getElementById('callTextInput');
    const message = textInput.value.trim();
    
    if (message) {
        // 添加用户消息到聊天区域
        addCallMessage(message, 'sent');
        
        // 清空输入框并隐藏
        textInput.value = '';
        document.getElementById('callInputSection').style.display = 'none';
        
        // 模拟对方回复（延迟1-3秒）
        setTimeout(() => {
            const responses = [
                '好的，我明白了',
                '嗯嗯，收到',
                '没问题',
                '知道了',
                '好的'
            ];
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            addCallMessage(randomResponse, 'received');
        }, Math.random() * 2000 + 1000);
    }
}

// 添加通话消息到聊天区域
function addCallMessage(message, type) {
    const chatMessages = document.getElementById('callChatMessages');
    if (chatMessages) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `call-message ${type}`;
        messageDiv.textContent = message;
        
        chatMessages.appendChild(messageDiv);
        
        // 滚动到底部
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
}

// 开始通话计时
function startCallTimer() {
    const callStatus = document.getElementById('callStatus');
    if (!callStatus) return;
    
    window.callTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - window.callStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        const timeText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        callStatus.textContent = `语音通话中 ${timeText}`;
    }, 1000);
}

// 监听回车键发送消息
document.addEventListener('DOMContentLoaded', function() {
    const callTextInput = document.getElementById('callTextInput');
    if (callTextInput) {
        callTextInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendCallMessage();
            }
        });
    }
});

// 接听通话
function answerCall() {
    playClickSound();
    const callInterface = document.getElementById('callInterface');
    if (callInterface) {
        callInterface.classList.remove('show');
    }
}

// 打开收藏功能
function openFavorites() {
    playClickSound();
    closeChatMenu();
    openFavoritesListModal();
}

// 屏幕共享功能
function openScreenShare() {
    playClickSound();
    closeChatMenu();
    const modal = document.getElementById('screenShareModal');
    modal.classList.add('show');
}

function closeScreenShare() {
    playClickSound();
    const modal = document.getElementById('screenShareModal');
    modal.classList.remove('show');
}

function regenerateScreenShare() {
    playClickSound();
    // 重新生成功能，暂时显示提示
    alert('重新生成功能开发中...');
}

// 屏幕共享子功能
function openSMS() {
    playClickSound();
    closeScreenShare();
    alert('短信功能开发中...');
}

function openShopping() {
    playClickSound();
    closeScreenShare();
    alert('购物功能开发中...');
}

function openBrowser() {
    playClickSound();
    closeScreenShare();
    alert('浏览器功能开发中...');
}

function openMemo() {
    playClickSound();
    closeScreenShare();
    alert('备忘录功能开发中...');
}

function openFootprint() {
    playClickSound();
    closeScreenShare();
    alert('足迹功能开发中...');
}

// 收藏选中的消息
function favoriteSelectedMessages() {
    playClickSound();
    const selectedMessages = document.querySelectorAll('.message.selected');
    
    if (selectedMessages.length === 0) {
        alert('请先选择要收藏的消息！');
        return;
    }
    
    // 收集选中的消息数据
    const messagesToFavorite = [];
    selectedMessages.forEach(msg => {
        const messageData = {
            id: msg.dataset.messageId,
            content: msg.querySelector('.message-content')?.textContent || '',
            type: msg.dataset.messageType || 'text',
            timestamp: msg.dataset.timestamp || Date.now(),
            contactId: getCurrentContactId()
        };
        messagesToFavorite.push(messageData);
    });
    
    // 保存到收藏
    saveFavorites(messagesToFavorite);
    
    // 清除选择状态
    clearMessageSelection();
    
    alert(`已收藏 ${messagesToFavorite.length} 条消息！`);
}

// 保存收藏消息
async function saveFavorites(messages) {
    try {
        const currentContactId = getCurrentContactId();
        if (!currentContactId) return;
        
        const favoritesKey = `favorites_${currentContactId}`;
        const existingFavorites = await AppStorage.getItem(favoritesKey);
        let favorites = existingFavorites ? JSON.parse(existingFavorites) : [];
        
        // 添加新收藏的消息
        favorites.push(...messages);
        
        // 限制收藏数量（最多100条）
        if (favorites.length > 100) {
            favorites = favorites.slice(-100);
        }
        
        await AppStorage.setItem(favoritesKey, JSON.stringify(favorites));
        console.log('收藏保存成功');
    } catch (error) {
        console.error('保存收藏失败:', error);
        alert('保存收藏失败！');
    }
}

// 图片上传功能
function openImageUploadModal() {
    // 改为直接调起系统文件选择
    const picker = document.getElementById('imageFileInput');
    if (picker) picker.click();
}

function closeImageUploadModal() {
    // 弹窗已不再使用，仅做清理
    clearImagePreview();
}

function clearImagePreview() {
    document.getElementById('imagePreview').style.display = 'none';
    document.getElementById('imageFileInput').value = '';
}

// 一起听音乐功能
let currentMusic = null;
let isPlaying = false;
let currentMusicIndex = 0;
let musicPlaylist = [
    { title: '安静', artist: '周杰伦', url: 'https://files.catbox.moe/quiet.mp3', cover: '🎵' },
    { title: '稻香', artist: '周杰伦', url: 'https://files.catbox.moe/daoxiang.mp3', cover: '🌾' },
    { title: '青花瓷', artist: '周杰伦', url: 'https://files.catbox.moe/qinghuaci.mp3', cover: '🏺' }
];

function openMusicTogetherModal() {
    const modal = document.getElementById('musicTogetherModal');
    if (modal) {
        modal.style.display = 'flex';
        // 更新角色名称
        const title = modal.querySelector('h3');
        if (title && currentChatContact) {
            title.textContent = `🎵 和${currentChatContact.name}一起听音乐`;
        }
        const artist = modal.querySelector('#musicArtist');
        if (artist && currentChatContact) {
            artist.textContent = `和${currentChatContact.name}一起听`;
        }
    }
}

function closeMusicTogetherModal() {
    const modal = document.getElementById('musicTogetherModal');
    if (modal) {
        modal.style.display = 'none';
    }
    // 停止音乐
    if (currentMusic) {
        currentMusic.pause();
        currentMusic = null;
        isPlaying = false;
    }
}

function selectMusic(title, artist, url) {
    const musicTitle = document.getElementById('musicTitle');
    const musicArtist = document.getElementById('musicArtist');
    const musicCover = document.getElementById('musicCoverImage');
    
    if (musicTitle) musicTitle.textContent = title;
    if (musicArtist) musicArtist.textContent = artist;
    if (musicCover) musicCover.textContent = '🎵';
    
    // 创建新的音频对象
    if (currentMusic) {
        currentMusic.pause();
    }
    
    currentMusic = new Audio(url);
    currentMusic.addEventListener('loadedmetadata', () => {
        const totalTime = document.getElementById('totalTime');
        if (totalTime) {
            totalTime.textContent = formatTime(currentMusic.duration);
        }
    });
    
    currentMusic.addEventListener('timeupdate', () => {
        updateProgress();
    });
    
    currentMusic.addEventListener('ended', () => {
        nextMusic();
    });
    
    // 发送角色互动消息
    sendCharacterMusicReaction(title, artist);
}

function togglePlayPause() {
    if (!currentMusic) return;
    
    const playBtn = document.getElementById('playPauseBtn');
    
    if (isPlaying) {
        currentMusic.pause();
        playBtn.textContent = '▶';
        isPlaying = false;
    } else {
        currentMusic.play();
        playBtn.textContent = '⏸';
        isPlaying = true;
    }
}

function previousMusic() {
    currentMusicIndex = (currentMusicIndex - 1 + musicPlaylist.length) % musicPlaylist.length;
    const music = musicPlaylist[currentMusicIndex];
    selectMusic(music.title, music.artist, music.url);
}

function nextMusic() {
    currentMusicIndex = (currentMusicIndex + 1) % musicPlaylist.length;
    const music = musicPlaylist[currentMusicIndex];
    selectMusic(music.title, music.artist, music.url);
}

function updateProgress() {
    if (!currentMusic) return;
    
    const progressFill = document.getElementById('progressFill');
    const currentTime = document.getElementById('currentTime');
    
    if (progressFill) {
        const progress = (currentMusic.currentTime / currentMusic.duration) * 100;
        progressFill.style.width = progress + '%';
    }
    
    if (currentTime) {
        currentTime.textContent = formatTime(currentMusic.currentTime);
    }
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// 角色音乐互动
async function sendCharacterMusicReaction(title, artist) {
    if (!currentChatContact) return;
    
    const reactions = [
        `🎵 正在和${currentChatContact.name}一起听《${title}》`,
        `${currentChatContact.name}说：这首歌真好听！`,
        `${currentChatContact.name}跟着音乐轻轻摇摆~`,
        `${currentChatContact.name}：这首歌让我想起了很多回忆...`,
        `${currentChatContact.name}：我们一起听音乐的感觉真好~`
    ];
    
    const randomReaction = reactions[Math.floor(Math.random() * reactions.length)];
    
    const newMessage = {
        id: Date.now(),
        sender: 'received',
        content: randomReaction,
        time: `${new Date().getHours()}:${String(new Date().getMinutes()).padStart(2, '0')}`,
        avatar: currentChatContact.avatar
    };
    
    chatMessages.push(newMessage);
    await saveChatMessages(currentChatContact.id, chatMessages);
    await renderChatMessages();
}

// 图片文件选择：选择后立即发送
document.addEventListener('DOMContentLoaded', () => {
    const imageFileInput = document.getElementById('imageFileInput');
    if (imageFileInput) {
        imageFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) { alert('请选择图片文件！'); e.target.value = ''; return; }
            if (file.size > 5 * 1024 * 1024) { alert('图片文件大小不能超过5MB！'); e.target.value = ''; return; }

            const reader = new FileReader();
            reader.onload = async (ev) => {
                const imageData = ev.target.result;
                const newMessage = {
                    id: Date.now(),
                    sender: 'sent',
                    content: '',
                    image: imageData,
                    time: `${new Date().getHours()}:${String(new Date().getMinutes()).padStart(2, '0')}`,
                    avatar: await getSelfAvatar()
                };
                chatMessages.push(newMessage);
                await saveChatMessages(currentChatContact.id, chatMessages);
                await renderChatMessages();
                e.target.value = '';
            };
            reader.readAsDataURL(file);
        });
    }
});

async function sendImageMessage() {
    const fileInput = document.getElementById('imageFileInput');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('请先选择图片！');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = async (e) => {
        const imageData = e.target.result;
        
        // 创建图片消息
        const newMessage = {
            id: Date.now(),
            sender: 'sent',
            content: '',
            image: imageData,
            time: `${new Date().getHours()}:${String(new Date().getMinutes()).padStart(2, '0')}`,
            avatar: await getSelfAvatar()
        };
        
        // 添加到聊天消息
        chatMessages.push(newMessage);
        await saveChatMessages(currentChatContact.id, chatMessages);
        await renderChatMessages();
        
        closeImageUploadModal();
    };
    reader.readAsDataURL(file);
}


// 转账功能
function openTransferModal() {
    const modal = document.getElementById('transferModal');
    modal.style.display = 'flex';
}

function closeTransferModal() {
    const modal = document.getElementById('transferModal');
    modal.style.display = 'none';
    // 重置表单
    document.getElementById('transferAmount').value = '';
    document.getElementById('transferNote').value = '';
}

async function sendTransferMessage() {
    const amount = document.getElementById('transferAmount').value;
    const note = document.getElementById('transferNote').value;
    
    if (!amount || parseFloat(amount) <= 0) {
        alert('请输入有效的转账金额！');
        return;
    }
    
    // 创建转账消息
    const newMessage = {
        id: Date.now(),
        sender: 'sent',
        content: `转账 ¥${amount}${note ? '\n备注：' + note : ''}\n已转账给${currentChatContact.name}`,
        time: `${new Date().getHours()}:${String(new Date().getMinutes()).padStart(2, '0')}`,
        avatar: await getSelfAvatar(),
        type: 'transfer'
    };
    
    // 添加到聊天消息
    chatMessages.push(newMessage);
    await saveChatMessages(currentChatContact.id, chatMessages);
    await renderChatMessages();
    
    closeTransferModal();
}

// 定位功能
function openLocationModal() {
    const modal = document.getElementById('locationModal');
    modal.style.display = 'flex';
}

function closeLocationModal() {
    const modal = document.getElementById('locationModal');
    modal.style.display = 'none';
    // 重置表单
    document.getElementById('locationAddress').value = '';
}

async function sendLocationMessage() {
    const address = document.getElementById('locationAddress').value;
    
    if (!address.trim()) {
        alert('请输入地址！');
        return;
    }
    
    await sendLocationMessageWithImage(address, null);
}

async function sendLocationMessageWithImage(address, imageData) {
    // 创建定位消息
    const newMessage = {
        id: Date.now(),
        sender: 'sent',
        content: `📍 ${address}`,
        time: `${new Date().getHours()}:${String(new Date().getMinutes()).padStart(2, '0')}`,
        avatar: await getSelfAvatar(),
        type: 'location',
        image: imageData
    };
    
    // 添加到聊天消息
    chatMessages.push(newMessage);
    await saveChatMessages(currentChatContact.id, chatMessages);
    await renderChatMessages();
    
    closeLocationModal();
}

// 点外卖功能
function openFoodOrderModal() {
    const modal = document.getElementById('foodOrderModal');
    modal.style.display = 'flex';
}

function closeFoodOrderModal() {
    const modal = document.getElementById('foodOrderModal');
    modal.style.display = 'none';
    // 重置表单
    document.getElementById('foodOrderName').value = '';
    document.getElementById('foodOrderAmount').value = '';
    document.getElementById('foodOrderNote').value = '';
}

async function sendFoodOrderMessage() {
    const name = document.getElementById('foodOrderName').value;
    const amount = document.getElementById('foodOrderAmount').value;
    const note = document.getElementById('foodOrderNote').value;
    
    if (!name.trim()) {
        alert('请输入餐厅或菜品名称！');
        return;
    }
    
    if (!amount || parseFloat(amount) <= 0) {
        alert('请输入有效的金额！');
        return;
    }
    
    // 创建点外卖消息
    const newMessage = {
        id: Date.now(),
        sender: 'sent',
        content: `🍔 ${name}\n💰 ¥${amount}${note ? '\n备注：' + note : ''}\n已发送外卖订单`,
        time: `${new Date().getHours()}:${String(new Date().getMinutes()).padStart(2, '0')}`,
        avatar: await getSelfAvatar(),
        type: 'food_order'
    };
    
    // 添加到聊天消息
    chatMessages.push(newMessage);
    await saveChatMessages(currentChatContact.id, chatMessages);
    await renderChatMessages();
    
    closeFoodOrderModal();
}

// 语音文字功能
function openVoiceTextModal() {
    const modal = document.getElementById('voiceTextModal');
    modal.style.display = 'flex';
}

function closeVoiceTextModal() {
    const modal = document.getElementById('voiceTextModal');
    modal.style.display = 'none';
    // 重置表单
    document.getElementById('voiceTextContent').value = '';
}

async function sendVoiceTextMessage() {
    const content = document.getElementById('voiceTextContent').value.trim();
    
    if (!content) {
        alert('请输入语音内容！');
        return;
    }
    
    // 创建语音消息
    const newMessage = {
        id: Date.now(),
        sender: 'sent',
        content: content,
        time: `${new Date().getHours()}:${String(new Date().getMinutes()).padStart(2, '0')}`,
        avatar: await getSelfAvatar(),
        type: 'voice'
    };
    
    // 添加到聊天消息
    chatMessages.push(newMessage);
    await saveChatMessages(currentChatContact.id, chatMessages);
    await renderChatMessages();
    
    closeVoiceTextModal();
}

// 视频通话功能
function openVideoCallModal() {
    const modal = document.getElementById('videoCallModal');
    modal.style.display = 'flex';
    
    // 设置联系人信息
    document.getElementById('videoCallAvatar').src = currentChatContact.avatar;
    document.getElementById('videoCallName').textContent = currentChatContact.name;
    document.getElementById('videoCallStatus').textContent = '正在呼叫...';
    
    // 模拟呼叫过程
    setTimeout(() => {
        document.getElementById('videoCallStatus').textContent = '对方未接听';
    }, 3000);
}

function closeVideoCallModal() {
    const modal = document.getElementById('videoCallModal');
    modal.style.display = 'none';
}

function endVideoCall() {
    playClickSound();
    closeVideoCallModal();
}

// 论坛页面功能
async function openForumApp() {
    playClickSound();
    
    // 加载论坛数据
    await loadForumData();
    await loadForumProfile();
    
    const forumApp = document.getElementById('forumApp');
    if (forumApp) {
        forumApp.classList.add('show');
    }
    
    // 渲染论坛首页
    renderForumHome();
}

function closeForumApp() {
    playClickSound();
    const forumApp = document.getElementById('forumApp');
    if (forumApp) {
        forumApp.classList.remove('show');
    }
}

// 论坛贴文数据
let forumPosts = [];

// 论坛数据保存和加载功能（使用AppStorage）
async function saveForumData() {
    try {
        await AppStorage.setItem('forumPosts', JSON.stringify(forumPosts));
        
        // 保存AI生成的帖子
        const aiPosts = JSON.parse(localStorage.getItem('aiForumPosts') || '[]');
        await AppStorage.setItem('aiForumPosts', JSON.stringify(aiPosts));
        
        console.log('论坛数据已保存到IndexedDB');
    } catch (error) {
        console.error('保存论坛数据失败:', error);
    }
}

async function loadForumData() {
    try {
        const savedForumPosts = await AppStorage.getItem('forumPosts');
        const savedAIPosts = await AppStorage.getItem('aiForumPosts');
        
        if (savedForumPosts) {
            const parsedPosts = JSON.parse(savedForumPosts);
            forumPosts.length = 0; // 清空数组
            forumPosts.push(...parsedPosts);
            console.log('论坛帖子已从IndexedDB加载:', forumPosts.length, '条帖子');
        }
        
        if (savedAIPosts) {
            localStorage.setItem('aiForumPosts', savedAIPosts);
            console.log('AI论坛帖子已从IndexedDB加载');
        }
    } catch (error) {
        console.error('加载论坛数据失败:', error);
    }
}


// 论坛个人资料数据
let forumProfile = {
    name: '用户',
    avatar: 'https://files.catbox.moe/r5s188.jpg',
    card: '' // 名片图片
};

// 论坛个人资料保存和加载功能（使用localStorage）
function saveForumProfile() {
    try {
        localStorage.setItem('forum_profile_name', forumProfile.name);
        localStorage.setItem('forum_profile_avatar', forumProfile.avatar);
        localStorage.setItem('forum_profile_card', forumProfile.card || '');
        console.log('论坛个人资料已保存到localStorage');
    } catch (error) {
        console.error('保存论坛个人资料失败:', error);
    }
}

async function loadForumProfile() {
    try {
        const name = localStorage.getItem('forum_profile_name');
        const avatar = localStorage.getItem('forum_profile_avatar');
        const card = localStorage.getItem('forum_profile_card');
        
        if (name) forumProfile.name = name;
        if (avatar) forumProfile.avatar = avatar;
        if (card) forumProfile.card = card;
        
        // 更新页面显示
        updateForumProfile();
        
        console.log('论坛个人资料已从localStorage加载');
    } catch (error) {
        console.error('加载论坛个人资料失败:', error);
    }
}


// 论坛页面切换功能
function showForumHome() {
    playClickSound();
    // 隐藏所有页面
    document.getElementById('forumHomePage').style.display = 'block';
    document.getElementById('forumProfilePage').classList.remove('show');
    
    // 更新导航栏状态
    document.querySelectorAll('.forum-bottom-nav-item').forEach(item => {
        item.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
}

function showForumMessages() {
    playClickSound();
    // 暂时显示首页，消息功能可以后续添加
    showForumHome();
    
    // 更新导航栏状态
    document.querySelectorAll('.forum-bottom-nav-item').forEach(item => {
        item.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
}

function showForumProfile() {
    playClickSound();
    // 显示我的页面
    document.getElementById('forumHomePage').style.display = 'none';
    document.getElementById('forumProfilePage').classList.add('show');
    
    // 更新用户信息
    updateForumProfile();
    
    // 更新导航栏状态
    document.querySelectorAll('.forum-bottom-nav-item').forEach(item => {
        item.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
}

function showForumSettings() {
    playClickSound();
    document.getElementById('forumSettingsModal').style.display = 'flex';
    
    // 加载当前设置
    loadForumSettings();
    
    // 初始化取色器
    initColorPicker();
    
    // 初始化世界观选择
    initWorldviewSelect();
    
    // 初始化联系人集成
    initContactIntegration();
}

function closeForumSettings() {
    playClickSound();
    document.getElementById('forumSettingsModal').style.display = 'none';
}

// 论坛设置数据
let forumSettings = {
    themeColor: '#ff6b35',
    worldview: '',
    contactIntegration: false,
    selectedContacts: []
};

// 加载论坛设置
function loadForumSettings() {
    const savedSettings = localStorage.getItem('forumSettings');
    if (savedSettings) {
        forumSettings = JSON.parse(savedSettings);
    }
    
    // 应用主题色
    applyThemeColor(forumSettings.themeColor);
    
    // 更新UI
    document.getElementById('themeColorPicker').value = forumSettings.themeColor;
    document.getElementById('colorPreview').style.background = forumSettings.themeColor;
    document.getElementById('colorValue').textContent = forumSettings.themeColor;
    document.getElementById('worldviewInput').value = forumSettings.worldview || '';
    document.getElementById('contactIntegrationToggle').checked = forumSettings.contactIntegration;
}

// 初始化取色器
function initColorPicker() {
    const colorPicker = document.getElementById('themeColorPicker');
    const colorPreview = document.getElementById('colorPreview');
    const colorValue = document.getElementById('colorValue');
    const presetColors = document.querySelectorAll('.preset-color');
    
    colorPicker.addEventListener('input', function() {
        const color = this.value;
        colorPreview.style.background = color;
        colorValue.textContent = color;
        applyThemeColor(color);
    });
    
    // 预设颜色点击
    presetColors.forEach(preset => {
        preset.addEventListener('click', function() {
            const color = this.dataset.color;
            colorPicker.value = color;
            colorPreview.style.background = color;
            colorValue.textContent = color;
            applyThemeColor(color);
            
            // 更新选中状态
            presetColors.forEach(p => p.classList.remove('selected'));
            this.classList.add('selected');
        });
    });
}

// 应用主题色
function applyThemeColor(color) {
    document.documentElement.style.setProperty('--forum-theme-color', color);
    
    // 更新所有使用主题色的元素
    const elements = document.querySelectorAll('.forum-post-card.pinned-post-card .forum-post-title, .forum-post-card.pinned-post-card .forum-post-author, .forum-post-tag, .forum-bottom-nav-item.active .forum-bottom-nav-icon, .forum-bottom-nav-item.active .forum-bottom-nav-text');
    elements.forEach(el => {
        el.style.color = color;
    });
    
    // 更新边框色
    const borderElements = document.querySelectorAll('.forum-post-card.pinned-post-card');
    borderElements.forEach(el => {
        el.style.borderLeftColor = color;
    });
}

// 初始化世界观输入
function initWorldviewSelect() {
    // 世界观现在是自定义输入，不需要特殊初始化
}

// 初始化联系人集成
function initContactIntegration() {
    const toggle = document.getElementById('contactIntegrationToggle');
    const contactList = document.getElementById('contactList');
    
    toggle.addEventListener('change', function() {
        if (this.checked) {
            contactList.style.display = 'block';
            // 强制刷新联系人数据
            refreshContactData();
            loadContactList();
        } else {
            contactList.style.display = 'none';
        }
    });
}

// 刷新联系人数据
function refreshContactData() {
    console.log('Refreshing contact data...');
    
    // 尝试从多个来源获取数据
    try {
        // 方法1：从localStorage获取
        const savedMessages = localStorage.getItem('currentMessages');
        if (savedMessages) {
            const messagesData = JSON.parse(savedMessages);
            window.currentMessages = messagesData;
            console.log('Loaded from localStorage:', messagesData.length, 'messages');
            return;
        }
    } catch (error) {
        console.error('Error loading from localStorage:', error);
    }
    
    // 方法2：从全局变量获取
    if (typeof currentMessages !== 'undefined' && currentMessages) {
        window.currentMessages = currentMessages;
        console.log('Using global currentMessages:', currentMessages.length, 'messages');
        return;
    }
    
    // 方法3：从IndexedDB获取（如果可用）
    if (typeof AppStorage !== 'undefined') {
        AppStorage.getItem('currentMessages').then(savedMessages => {
            if (savedMessages) {
                const messagesData = JSON.parse(savedMessages);
                window.currentMessages = messagesData;
                console.log('Loaded from IndexedDB:', messagesData.length, 'messages');
                // 重新加载联系人列表
                loadContactList();
            }
        }).catch(error => {
            console.error('Error loading from IndexedDB:', error);
        });
    }
    
    console.log('Contact data refresh completed');
}

// 加载联系人列表
function loadContactList() {
    const contactItems = document.getElementById('contactItems');
    contactItems.innerHTML = '';
    
    // 确保能访问到currentMessages
    console.log('loadContactList called');
    console.log('window.currentMessages:', window.currentMessages);
    console.log('currentMessages (global):', typeof currentMessages !== 'undefined' ? currentMessages : 'undefined');
    
    // 尝试从不同来源获取联系人数据
    let contacts = [];
    
    // 方法1：从window.currentMessages获取
    if (window.currentMessages && window.currentMessages.length > 0) {
        console.log('Using window.currentMessages');
        contacts = window.currentMessages.filter(msg => !msg.isGroup).map(msg => ({
            name: msg.name,
            avatar: msg.avatar,
            id: msg.id
        }));
    }
    // 方法2：从全局currentMessages获取
    else if (typeof currentMessages !== 'undefined' && currentMessages && currentMessages.length > 0) {
        console.log('Using global currentMessages');
        contacts = currentMessages.filter(msg => !msg.isGroup).map(msg => ({
            name: msg.name,
            avatar: msg.avatar,
            id: msg.id
        }));
    }
    // 方法3：从localStorage直接获取
    else {
        console.log('Trying to load from localStorage');
        try {
            const savedMessages = localStorage.getItem('currentMessages');
            if (savedMessages) {
                const messagesData = JSON.parse(savedMessages);
                contacts = messagesData.filter(msg => !msg.isGroup).map(msg => ({
                    name: msg.name,
                    avatar: msg.avatar,
                    id: msg.id
                }));
                console.log('Loaded from localStorage:', contacts.length, 'contacts');
            }
        } catch (error) {
            console.error('Error loading from localStorage:', error);
        }
    }
    
    console.log('Final contacts:', contacts);
    
    if (contacts.length > 0) {
        contacts.forEach(contact => {
            const contactItem = document.createElement('div');
            contactItem.className = 'contact-item';
            contactItem.innerHTML = `
                <input type="checkbox" id="contact_${contact.id}" value="${contact.id}">
                <img src="${contact.avatar}" alt="${contact.name}" class="contact-avatar">
                <span class="contact-name">${contact.name}</span>
            `;
            contactItems.appendChild(contactItem);
        });
    } else {
        contactItems.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">暂无联系人<br><small>请先在消息应用中添加一些联系人</small></div>';
    }
}

// 保存论坛设置
function saveForumSettings() {
    playClickSound();
    
    // 收集设置数据
    forumSettings.themeColor = document.getElementById('themeColorPicker').value;
    forumSettings.worldview = document.getElementById('worldviewInput').value.trim();
    forumSettings.contactIntegration = document.getElementById('contactIntegrationToggle').checked;
    
    // 收集选中的联系人
    const selectedContacts = [];
    const contactCheckboxes = document.querySelectorAll('#contactItems input[type="checkbox"]:checked');
    contactCheckboxes.forEach(checkbox => {
        selectedContacts.push(checkbox.value);
    });
    forumSettings.selectedContacts = selectedContacts;
    
    // 保存到本地存储
    localStorage.setItem('forumSettings', JSON.stringify(forumSettings));
    
    // 应用设置
    applyThemeColor(forumSettings.themeColor);
    
    // 如果启用了联系人参与，添加联系人到论坛
    if (forumSettings.contactIntegration && selectedContacts.length > 0) {
        addContactsToForum(selectedContacts);
        
        // 立即生成一些AI帖子作为演示
        setTimeout(() => {
            generateContactPosts(forumSettings);
            renderForumHome();
        }, 1000);
    }
    
    // 显示成功提示
    let message = '设置已保存！\n\n主题色：' + forumSettings.themeColor + '\n世界观：' + (forumSettings.worldview || '未设置') + '\n联系人参与：' + (forumSettings.contactIntegration ? '已开启' : '已关闭');
    
    if (forumSettings.contactIntegration && selectedContacts.length > 0) {
        message += '\n\n已添加 ' + selectedContacts.length + ' 个联系人到论坛！';
    }
    
    alert(message);
    
    // 关闭设置弹窗
    closeForumSettings();
}

// 添加联系人到论坛
function addContactsToForum(contactIds) {
    if (!window.currentMessages) return;
    
    const contacts = window.currentMessages.filter(msg => contactIds.includes(msg.id));
    
    contacts.forEach(contact => {
        // 为联系人创建论坛用户数据
        const forumUser = {
            id: 'forum_' + contact.id,
            name: contact.name,
            avatar: contact.avatar,
            isContact: true,
            joinTime: new Date().toISOString()
        };
        
        // 保存到论坛用户列表（如果不存在的话）
        let forumUsers = JSON.parse(localStorage.getItem('forumUsers') || '[]');
        if (!forumUsers.find(user => user.id === forumUser.id)) {
            forumUsers.push(forumUser);
            localStorage.setItem('forumUsers', JSON.stringify(forumUsers));
        }
    });
    
    // 刷新论坛首页以显示新用户
    if (document.getElementById('forumHomePage').style.display !== 'none') {
        renderForumHome();
    }
}

// AI生成帖子功能
function generateAIPosts() {
    const settings = JSON.parse(localStorage.getItem('forumSettings') || '{}');
    
    // 如果启用了联系人参与
    if (settings.contactIntegration && settings.selectedContacts && settings.selectedContacts.length > 0) {
        // 检查是否需要生成新帖子（每5分钟生成一次）
        const lastGeneration = localStorage.getItem('lastAIPostGeneration');
        const now = Date.now();
        const fiveMinutes = 5 * 60 * 1000;
        
        if (!lastGeneration || (now - parseInt(lastGeneration)) > fiveMinutes) {
            generateContactPosts(settings);
            localStorage.setItem('lastAIPostGeneration', now.toString());
        }
    }
}

// 生成联系人帖子
function generateContactPosts(settings) {
    if (!window.currentMessages) return;
    
    const selectedContacts = window.currentMessages.filter(msg => 
        settings.selectedContacts.includes(msg.id)
    );
    
    selectedContacts.forEach(contact => {
        // 随机决定是否生成帖子（30%概率）
        if (Math.random() < 0.3) {
            const post = generateContactPost(contact, settings.worldview);
            if (post) {
                addAIPostToForum(post);
            }
        }
    });
}

// 生成单个联系人帖子
function generateContactPost(contact, worldview) {
    const postTemplates = getPostTemplates(worldview);
    const template = postTemplates[Math.floor(Math.random() * postTemplates.length)];
    
    return {
        id: 'ai_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        title: template.title,
        content: template.content,
        author: contact.name,
        avatar: contact.avatar,
        timestamp: new Date().toISOString(),
        isAI: true,
        contactId: contact.id,
        likes: Math.floor(Math.random() * 100),
        comments: Math.floor(Math.random() * 50),
        views: Math.floor(Math.random() * 1000) + 100
    };
}

// 获取帖子模板（根据世界观）
function getPostTemplates(worldview) {
    const baseTemplates = [
        {
            title: "今天遇到了一件有趣的事",
            content: "刚刚在街上看到一只小猫，它看起来迷路了，我给了它一些食物，现在它一直跟着我。不知道该怎么办..."
        },
        {
            title: "求助，这个问题怎么解决？",
            content: "最近工作压力很大，总是失眠，大家有什么好的建议吗？在线等，挺急的！"
        },
        {
            title: "分享一个好消息",
            content: "今天终于完成了这个项目，虽然很累但是很有成就感！感谢大家的支持！"
        }
    ];
    
    // 根据世界观调整内容
    if (worldview && worldview.trim()) {
        return [
            {
                title: `在${worldview}中的新发现`,
                content: `今天在${worldview}中遇到了一个很有趣的现象，想和大家分享一下我的观察和思考。`
            },
            {
                title: `${worldview}中的困惑`,
                content: `最近在${worldview}中遇到了一些问题，不知道大家有没有类似的经历？`
            },
            {
                title: `${worldview}的日常`,
                content: `在${worldview}中的一天又开始了，今天有什么新鲜事发生吗？`
            }
        ];
    }
    
    return baseTemplates;
}

// 添加AI帖子到论坛
async function addAIPostToForum(post) {
    let aiPosts = JSON.parse(localStorage.getItem('aiForumPosts') || '[]');
    
    // 限制AI帖子数量（最多保留20条）
    if (aiPosts.length >= 20) {
        aiPosts = aiPosts.slice(-19); // 保留最新的19条
    }
    
    aiPosts.push(post);
    localStorage.setItem('aiForumPosts', JSON.stringify(aiPosts));
    
    // 保存到IndexedDB
    await saveForumData();
}

// 格式化时间
function formatTime(timestamp) {
    const now = new Date();
    const postTime = new Date(timestamp);
    const diff = now - postTime;
    
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return '刚刚';
    if (minutes < 60) return `${minutes}分钟前`;
    if (hours < 24) return `${hours}小时前`;
    if (days < 7) return `${days}天前`;
    
    return postTime.toLocaleDateString();
}

// 调试功能：手动生成AI帖子
async function generateAIPostsDebug() {
    playClickSound();
    
    // 先加载论坛设置
    loadForumSettings();
    
    // 检查世界观设置
    const worldview = forumSettings && forumSettings.worldview ? forumSettings.worldview.trim() : '';
    
    console.log('🔍 调试模式 - 检查世界观设置:');
    console.log('forumSettings:', forumSettings);
    console.log('worldview:', worldview);
    
    let message = '🤖 AI正在生成原创帖子内容，请稍候...';
    if (worldview) {
        message += `\n\n📖 当前世界观：${worldview}`;
    } else {
        message += '\n\n📝 使用默认主题生成';
    }
    
    // 显示生成中提示
    alert(message);
    
    try {
        // 生成AI帖子
        const generatedCount = await generateAIPosts();
        
        // 刷新论坛首页
        renderForumHome();
        
        // 显示结果
        if (generatedCount > 0) {
            let resultMessage = `✨ 成功生成 ${generatedCount} 条AI原创帖子！\n\n包含AI生成的标题、内容和评论！`;
            if (worldview) {
                resultMessage += `\n\n📖 已根据世界观生成内容`;
            }
            alert(resultMessage);
        } else {
            alert('生成失败，请重试！');
        }
    } catch (error) {
        console.error('生成AI帖子失败:', error);
        alert('生成失败，请检查AI配置！');
    }
}

// 清除AI帖子（调试功能）
async function clearAIPostsDebug() {
    playClickSound();
    
    if (confirm('确定要清除所有AI生成的帖子吗？此操作不可恢复！')) {
        // 清除localStorage中的AI帖子
        localStorage.removeItem('aiForumPosts');
        
        // 同时清除IndexedDB中的数据
        await saveForumData();
        
        alert('✅ 已清除所有AI帖子！');
        
        // 刷新论坛首页
        renderForumHome();
    }
}

// AI生成帖子系统
async function generateAIPosts() {
    let generatedCount = 0;
    const usedThemes = new Set(); // 记录已使用的主题
    const maxAttempts = 10; // 最大尝试次数
    let attempts = 0;
    
    // 生成5条帖子，确保主题不重复
    while (generatedCount < 5 && attempts < maxAttempts) {
        try {
            const post = await generateAIPost();
            if (post && !usedThemes.has(post.theme)) {
                await addAIPostToForum(post);
                usedThemes.add(post.theme);
                generatedCount++;
                console.log(`✅ 成功生成第${generatedCount}条帖子，主题：${post.theme}`);
            } else if (post) {
                console.log(`⚠️ 跳过重复主题：${post.theme}`);
            }
        } catch (error) {
            console.error('生成AI帖子失败:', error);
        }
        attempts++;
    }
    
    console.log(`🎯 总共生成${generatedCount}条帖子，尝试${attempts}次`);
    return generatedCount;
}

// 生成单条AI帖子 - 平台风格化
async function generateAIPost() {
    // 先加载论坛设置
    loadForumSettings();
    
    // 随机选择平台
    const platforms = ['知乎', '小红书', '贴吧', 'B站', '推特'];
    const selectedPlatform = platforms[Math.floor(Math.random() * platforms.length)];
    
    // 检查是否有世界观设置
    const worldview = forumSettings && forumSettings.worldview ? forumSettings.worldview.trim() : '';
    
    console.log('🔍 generateAIPost - 检查世界观设置:');
    console.log('forumSettings:', forumSettings);
    console.log('worldview:', worldview);
    
    let selectedTheme;
    let username;
    
    if (worldview) {
        // 有世界观：使用世界观生成，主题可以是任意相关主题
        const themes = ['生活', '职场', '情感', '学习', '娱乐', '冒险', '日常', '经历'];
        selectedTheme = themes[Math.floor(Math.random() * themes.length)];
        username = generateUsername(selectedTheme);
        console.log(`🎯 根据世界观生成${selectedPlatform}风格的帖子`);
    } else {
        // 没有世界观：使用默认主题
        const themes = ['生活', '职场', '情感', '学习', '娱乐'];
        selectedTheme = themes[Math.floor(Math.random() * themes.length)];
        username = generateUsername(selectedTheme);
        console.log(`🎯 生成${selectedPlatform}风格的${selectedTheme}主题帖子`);
    }
    
    const postContent = await generatePostContent(selectedPlatform, selectedTheme);
    
    // 如果AI生成失败，返回null
    if (!postContent) {
        console.log(`${selectedPlatform}风格"${selectedTheme}"主题的帖子生成失败，跳过`);
        return null;
    }
    
    // 使用AI生成的评论，如果没有则生成备用评论
    let comments = [];
    if (postContent.comments && postContent.comments.length > 0) {
        comments = postContent.comments.map((comment, index) => ({
            id: 'comment_' + Date.now() + '_' + index,
            author: generateUsername(selectedTheme),
            content: comment,
            timestamp: new Date().toISOString(),
            replies: []
        }));
    } else {
        // 备用评论生成
        comments = generateComments(selectedTheme);
    }
    
    // 随机添加一些样式元素
    const hasImage = Math.random() < 0.3; // 30%概率有图片
    const hasEmoji = Math.random() < 0.5; // 50%概率有表情
    
    return {
        id: 'ai_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        title: postContent.title,
        content: postContent.content,
        author: username,
        avatar: generateAvatar(),
        timestamp: new Date().toISOString(),
        isAI: true,
        platform: selectedPlatform, // 添加平台标识
        theme: selectedTheme,
        tag: getTagByTheme(selectedTheme),
        likes: Math.floor(Math.random() * 100) + 10,
        comments: comments.length,
        views: Math.floor(Math.random() * 1000) + 100,
        commentsData: comments,
        // 添加样式多样性
        image: hasImage ? generateRandomImage() : null,
        emoji: hasEmoji ? generateRandomEmoji() : null,
        style: generateRandomStyle()
    };
}

// 生成用户名 - 增加更多样化的用户名
function generateUsername(theme) {
    const usernames = {
        '生活': [
            '性感母蟑螂', '小雨下不停', '甜甜糖果', '超甜冷', '冷面杀手', '热辣小辣椒', '甜心宝贝', '冷酷无情', '温柔一刀', '小甜心', '大甜心', '超甜心', '吃货小王', '旅行者小李', '居家小张', '生活达人', '日常分享者', '生活观察者',
            '小清新', '阳光少年', '温柔少女', '酷炫青年', '文艺青年', '生活家', '美食家', '旅行家', '居家达人', '生活小能手', '日常记录者', '生活感悟者', '生活探索者', '生活体验者', '生活分享者',
            '小可爱', '大可爱', '超可爱', '萌萌哒', '甜甜圈', '小天使', '大天使', '超天使', '小仙女', '大仙女', '超仙女', '小公主', '大公主', '超公主', '小王子', '大王子', '超王子'
        ],
        '职场': [
            '打工人小王', '职场新人', '工作狂人', '职场老司机', '经验分享者', '工作达人', '职场观察者', '职场导师', '职场小白', '工作狂人', '职场达人', '职场分享者',
            '职场精英', '工作狂', '职场小白', '职场达人', '工作狂人', '职场导师', '职场观察者', '职场分享者', '职场新人', '职场老司机', '经验分享者', '工作达人',
            '职场小能手', '职场高手', '职场达人', '职场精英', '职场导师', '职场观察者', '职场分享者', '职场新人', '职场老司机', '经验分享者', '工作达人', '职场小能手'
        ],
        '情感': [
            '恋爱小白', '情感导师', '情感观察者', '暖心小天使', '情感分享者', '恋爱达人', '情感咨询师', '爱情观察者', '情感小白', '恋爱狂人', '情感达人', '情感分享者',
            '情感专家', '恋爱达人', '情感导师', '情感观察者', '暖心小天使', '情感分享者', '恋爱达人', '情感咨询师', '爱情观察者', '情感小白', '恋爱狂人', '情感达人',
            '情感小能手', '情感高手', '情感达人', '情感专家', '情感导师', '情感观察者', '情感分享者', '恋爱达人', '情感咨询师', '爱情观察者', '情感小白', '恋爱狂人'
        ],
        '学习': [
            '学霸小王', '知识分享者', '学习小白', '学习达人', '知识观察者', '学习导师', '学习狂人', '知识达人', '学习分享者', '知识小白', '学习观察者', '知识导师',
            '学习专家', '知识达人', '学习导师', '知识观察者', '学习分享者', '学习达人', '知识导师', '学习观察者', '学习小白', '学习狂人', '知识达人', '学习分享者',
            '学习小能手', '学习高手', '学习达人', '学习专家', '学习导师', '知识观察者', '学习分享者', '学习达人', '知识导师', '学习观察者', '学习小白', '学习狂人'
        ],
        '娱乐': [
            '吃瓜群众', '娱乐达人', '八卦小能手', '追星族', '娱乐观察者', '八卦分享者', '娱乐小白', '八卦达人', '娱乐狂人', '八卦小白', '娱乐观察者', '八卦导师',
            '娱乐专家', '八卦达人', '娱乐导师', '娱乐观察者', '八卦分享者', '娱乐达人', '八卦导师', '娱乐观察者', '娱乐小白', '娱乐狂人', '八卦达人', '娱乐分享者',
            '娱乐小能手', '娱乐高手', '娱乐达人', '娱乐专家', '娱乐导师', '娱乐观察者', '娱乐分享者', '娱乐达人', '八卦导师', '娱乐观察者', '娱乐小白', '娱乐狂人'
        ]
    };
    
    const themeUsernames = usernames[theme] || usernames['生活'];
    return themeUsernames[Math.floor(Math.random() * themeUsernames.length)];
}

// 生成随机图片
function generateRandomImage() {
    const images = [
        'https://picsum.photos/400/300?random=1',
        'https://picsum.photos/400/300?random=2',
        'https://picsum.photos/400/300?random=3',
        'https://picsum.photos/400/300?random=4',
        'https://picsum.photos/400/300?random=5'
    ];
    return images[Math.floor(Math.random() * images.length)];
}

// 生成随机表情
function generateRandomEmoji() {
    const emojis = ['😊', '😄', '😍', '🤔', '😮', '😯', '😲', '😱', '😭', '😤', '😡', '😠', '😢', '😥', '😰', '😨', '😧', '😦', '😵', '😴', '😪', '😑', '😐', '😶', '😏', '😒', '😓', '😔', '😕', '😖', '😗', '😘', '😙', '😚', '😛', '😜', '😝', '😞', '😟', '😠', '😡', '😢', '😣', '😤', '😥', '😦', '😧', '😨', '😩', '😪', '😫', '😬', '😭', '😮', '😯', '😰', '😱', '😲', '😳', '😴', '😵', '😶', '😷', '😸', '😹', '😺', '😻', '😼', '😽', '😾', '😿', '🙀', '🙁', '🙂', '🙃', '🙄', '🤐', '🤑', '🤒', '🤓', '🤔', '🤕', '🤖', '🤗', '🤘', '🤙', '🤚', '🤛', '🤜', '🤝', '🤞', '🤟', '🤠', '🤡', '🤢', '🤣', '🤤', '🤥', '🤦', '🤧', '🤨', '🤩', '🤪', '🤫', '🤬', '🤭', '🤮', '🤯', '🤰', '🤱', '🤲', '🤳', '🤴', '🤵', '🤶', '🤷', '🤸', '🤹', '🤺', '🤻', '🤼', '🤽', '🤾', '🤿', '🥀', '🥁', '🥂', '🥃', '🥄', '🥅', '🥆', '🥇', '🥈', '🥉', '🥊', '🥋', '🥌', '🥍', '🥎', '🥏', '🥐', '🥑', '🥒', '🥓', '🥔', '🥕', '🥖', '🥗', '🥘', '🥙', '🥚', '🥛', '🥜', '🥝', '🥞', '🥟', '🥠', '🥡', '🥢', '🥣', '🥤', '🥥', '🥦', '🥧', '🥨', '🥩', '🥪', '🥫', '🥬', '🥭', '🥮', '🥯', '🥰', '🥱', '🥲', '🥳', '🥴', '🥵', '🥶', '🥷', '🥸', '🥹', '🥺', '🥻', '🥼', '🥽', '🥾', '🥿', '🦀', '🦁', '🦂', '🦃', '🦄', '🦅', '🦆', '🦇', '🦈', '🦉', '🦊', '🦋', '🦌', '🦍', '🦎', '🦏', '🦐', '🦑', '🦒', '🦓', '🦔', '🦕', '🦖', '🦗', '🦘', '🦙', '🦚', '🦛', '🦜', '🦝', '🦞', '🦟', '🦠', '🦡', '🦢', '🦣', '🦤', '🦥', '🦦', '🦧', '🦨', '🦩', '🦪', '🦫', '🦬', '🦭', '🦮', '🦯', '🦰', '🦱', '🦲', '🦳', '🦴', '🦵', '🦶', '🦷', '🦸', '🦹', '🦺', '🦻', '🦼', '🦽', '🦾', '🦿', '🧀', '🧁', '🧂', '🧃', '🧄', '🧅', '🧆', '🧇', '🧈', '🧉', '🧊', '🧋', '🧌', '🧍', '🧎', '🧏', '🧐', '🧑', '🧒', '🧓', '🧔', '🧕', '🧖', '🧗', '🧘', '🧙', '🧚', '🧛', '🧜', '🧝', '🧞', '🧟', '🧠', '🧡', '🧢', '🧣', '🧤', '🧥', '🧦', '🧧', '🧨', '🧩', '🧪', '🧫', '🧬', '🧭', '🧮', '🧯', '🧰', '🧱', '🧲', '🧳', '🧴', '🧵', '🧶', '🧷', '🧸', '🧹', '🧺', '🧻', '🧼', '🧽', '🧾', '🧿', '🩀', '🩁', '🩂', '🩃', '🩄', '🩅', '🩆', '🩇', '🩈', '🩉', '🩊', '🩋', '🩌', '🩍', '🩎', '🩏', '🩐', '🩑', '🩒', '🩓', '🩔', '🩕', '🩖', '🩗', '🩘', '🩙', '🩚', '🩛', '🩜', '🩝', '🩞', '🩟', '🩠', '🩡', '🩢', '🩣', '🩤', '🩥', '🩦', '🩧', '🩨', '🩩', '🩪', '🩫', '🩬', '🩭', '🩮', '🩯', '🩰', '🩱', '🩲', '🩳', '🩴', '🩵', '🩶', '🩷', '🩸', '🩹', '🩺', '🩻', '🩼', '🪀', '🪁', '🪂', '🪃', '🪄', '🪅', '🪆', '🪇', '🪈', '🪉', '🪊', '🪋', '🪌', '🪍', '🪎', '🪏', '🪐', '🪑', '🪒', '🪓', '🪔', '🪕', '🪖', '🪗', '🪘', '🪙', '🪚', '🪛', '🪜', '🪝', '🪞', '🪟', '🪠', '🪡', '🪢', '🪣', '🪤', '🪥', '🪦', '🪧', '🪨', '🪩', '🪪', '🪫', '🪬', '🪭', '🪮', '🪯', '🪰', '🪱', '🪲', '🪳', '🪴', '🪵', '🪶', '🪷', '🪸', '🪹', '🪺', '🪻', '🪼', '🪽', '🪾', '🪿', '🫀', '🫁', '🫂', '🫃', '🫄', '🫅', '🫆', '🫇', '🫈', '🫉', '🫊', '🫋', '🫌', '🫍', '🫎', '🫏', '🫐', '🫑', '🫒', '🫓', '🫔', '🫕', '🫖', '🫗', '🫘', '🫙', '🫚', '🫛', '🫜', '🫝', '🫞', '🫟', '🫠', '🫡', '🫢', '🫣', '🫤', '🫥', '🫦', '🫧', '🫨', '🫩', '🫪', '🫫', '🫬', '🫭', '🫮', '🫯', '🫰', '🫱', '🫲', '🫳', '🫴', '🫵', '🫶', '🫷', '🫸', '🫹', '🫺', '🫻', '🫼', '🫽', '🫾', '🫿', '🬀', '🬁', '🬂', '🬃', '🬄', '🬅', '🬆', '🬇', '🬈', '🬉', '🬊', '🬋', '🬌', '🬍', '🬎', '🬏', '🬐', '🬑', '🬒', '🬓', '🬔', '🬕', '🬖', '🬗', '🬘', '🬙', '🬚', '🬛', '🬜', '🬝', '🬞', '🬟', '🬠', '🬡', '🬢', '🬣', '🬤', '🬥', '🬦', '🬧', '🬨', '🬩', '🬪', '🬫', '🬬', '🬭', '🬮', '🬯', '🬰', '🬱', '🬲', '🬳', '🬴', '🬵', '🬶', '🬷', '🬸', '🬹', '🬺', '🬻', '🬼', '🬽', '🬾', '🬿', '🭀', '🭁', '🭂', '🭃', '🭄', '🭅', '🭆', '🭇', '🭈', '🭉', '🭊', '🭋', '🭌', '🭍', '🭎', '🭏', '🭐', '🭑', '🭒', '🭓', '🭔', '🭕', '🭖', '🭗', '🭘', '🭙', '🭚', '🭛', '🭜', '🭝', '🭞', '🭟', '🭠', '🭡', '🭢', '🭣', '🭤', '🭥', '🭦', '🭧', '🭨', '🭩', '🭪', '🭫', '🭬', '🭭', '🭮', '🭯', '🭰', '🭱', '🭲', '🭳', '🭴', '🭵', '🭶', '🭷', '🭸', '🭹', '🭺', '🭻', '🭼', '🭽', '🭾', '🭿', '🮀', '🮁', '🮂', '🮃', '🮄', '🮅', '🮆', '🮇', '🮈', '🮉', '🮊', '🮋', '🮌', '🮍', '🮎', '🮏', '🮐', '🮑', '🮒', '🮓', '🮔', '🮕', '🮖', '🮗', '🮘', '🮙', '🮚', '🮛', '🮜', '🮝', '🮞', '🮟', '🮠', '🮡', '🮢', '🮣', '🮤', '🮥', '🮦', '🮧', '🮨', '🮩', '🮪', '🮫', '🮬', '🮭', '🮮', '🮯', '🮰', '🮱', '🮲', '🮳', '🮴', '🮵', '🮶', '🮷', '🮸', '🮹', '🮺', '🮻', '🮼', '🮽', '🮾', '🮿', '🯀', '🯁', '🯂', '🯃', '🯄', '🯅', '🯆', '🯇', '🯈', '🯉', '🯊', '🯋', '🯌', '🯍', '🯎', '🯏', '🯐', '🯑', '🯒', '🯓', '🯔', '🯕', '🯖', '🯗', '🯘', '🯙', '🯚', '🯛', '🯜', '🯝', '🯞', '🯟', '🯠', '🯡', '🯢', '🯣', '🯤', '🯥', '🯦', '🯧', '🯨', '🯩', '🯪', '🯫', '🯬', '🯭', '🯮', '🯯', '🯰', '🯱', '🯲', '🯳', '🯴', '🯵', '🯶', '🯷', '🯸', '🯹', '🯺', '🯻', '🯼', '🯽', '🯾', '🯿', '🰀', '🰁', '🰂', '🰃', '🰄', '🰅', '🰆', '🰇', '🰈', '🰉', '🰊', '🰋', '🰌', '🰍', '🰎', '🰏', '🰐', '🰑', '🰒', '🰓', '🰔', '🰕', '🰖', '🰗', '🰘', '🰙', '🰚', '🰛', '🰜', '🰝', '🰞', '🰟', '🰠', '🰡', '🰢', '🰣', '🰤', '🰥', '🰦', '🰧', '🰨', '🰩', '🰪', '🰫', '🰬', '🰭', '🰮', '🰯', '🰰', '🰱', '🰲', '🰳', '🰴', '🰵', '🰶', '🰷', '🰸', '🰹', '🰺', '🰻', '🰼', '🰽', '🰾', '🰿', '🱀', '🱁', '🱂', '🱃', '🱄', '🱅', '🱆', '🱇', '🱈', '🱉', '🱊', '🱋', '🱌', '🱍', '🱎', '🱏', '🱐', '🱑', '🱒', '🱓', '🱔', '🱕', '🱖', '🱗', '🱘', '🱙', '🱚', '🱛', '🱜', '🱝', '🱞', '🱟', '🱠', '🱡', '🱢', '🱣', '🱤', '🱥', '🱦', '🱧', '🱨', '🱩', '🱪', '🱫', '🱬', '🱭', '🱮', '🱯', '🱰', '🱱', '🱲', '🱳', '🱴', '🱵', '🱶', '🱷', '🱸', '🱹', '🱺', '🱻', '🱼', '🱽', '🱾', '🱿', '🲀', '🲁', '🲂', '🲃', '🲄', '🲅', '🲆', '🲇', '🲈', '🲉', '🲊', '🲋', '🲌', '🲍', '🲎', '🲏', '🲐', '🲑', '🲒', '🲓', '🲔', '🲕', '🲖', '🲗', '🲘', '🲙', '🲚', '🲛', '🲜', '🲝', '🲞', '🲟', '🲠', '🲡', '🲢', '🲣', '🲤', '🲥', '🲦', '🲧', '🲨', '🲩', '🲪', '🲫', '🲬', '🲭', '🲮', '🲯', '🲰', '🲱', '🲲', '🲳', '🲴', '🲵', '🲶', '🲷', '🲸', '🲹', '🲺', '🲻', '🲼', '🲽', '🲾', '🲿', '🳀', '🳁', '🳂', '🳃', '🳄', '🳅', '🳆', '🳇', '🳈', '🳉', '🳊', '🳋', '🳌', '🳍', '🳎', '🳏', '🳐', '🳑', '🳒', '🳓', '🳔', '🳕', '🳖', '🳗', '🳘', '🳙', '🳚', '🳛', '🳜', '🳝', '🳞', '🳟', '🳠', '🳡', '🳢', '🳣', '🳤', '🳥', '🳦', '🳧', '🳨', '🳩', '🳪', '🳫', '🳬', '🳭', '🳮', '🳯', '🳰', '🳱', '🳲', '🳳', '🳴', '🳵', '🳶', '🳷', '🳸', '🳹', '🳺', '🳻', '🳼', '🳽', '🳾', '🳿', '🴀', '🴁', '🴂', '🴃', '🴄', '🴅', '🴆', '🴇', '🴈', '🴉', '🴊', '🴋', '🴌', '🴍', '🴎', '🴏', '🴐', '🴑', '🴒', '🴓', '🴔', '🴕', '🴖', '🴗', '🴘', '🴙', '🴚', '🴛', '🴜', '🴝', '🴞', '🴟', '🴠', '🴡', '🴢', '🴣', '🴤', '🴥', '🴦', '🴧', '🴨', '🴩', '🴪', '🴫', '🴬', '🴭', '🴮', '🴯', '🴰', '🴱', '🴲', '🴳', '🴴', '🴵', '🴶', '🴷', '🴸', '🴹', '🴺', '🴻', '🴼', '🴽', '🴾', '🴿', '🵀', '🵁', '🵂', '🵃', '🵄', '🵅', '🵆', '🵇', '🵈', '🵉', '🵊', '🵋', '🵌', '🵍', '🵎', '🵏', '🵐', '🵑', '🵒', '🵓', '🵔', '🵕', '🵖', '🵗', '🵘', '🵙', '🵚', '🵛', '🵜', '🵝', '🵞', '🵟', '🵠', '🵡', '🵢', '🵣', '🵤', '🵥', '🵦', '🵧', '🵨', '🵩', '🵪', '🵫', '🵬', '🵭', '🵮', '🵯', '🵰', '🵱', '🵲', '🵳', '🵴', '🵵', '🵶', '🵷', '🵸', '🵹', '🵺', '🵻', '🵼', '🵽', '🵾', '🵿', '🶀', '🶁', '🶂', '🶃', '🶄', '🶅', '🶆', '🶇', '🶈', '🶉', '🶊', '🶋', '🶌', '🶍', '🶎', '🶏', '🶐', '🶑', '🶒', '🶓', '🶔', '🶕', '🶖', '🶗', '🶘', '🶙', '🶚', '🶛', '🶜', '🶝', '🶞', '🶟', '🶠', '🶡', '🶢', '🶣', '🶤', '🶥', '🶦', '🶧', '🶨', '🶩', '🶪', '🶫', '🶬', '🶭', '🶮', '🶯', '🶰', '🶱', '🶲', '🶳', '🶴', '🶵', '🶶', '🶷', '🶸', '🶹', '🶺', '🶻', '🶼', '🶽', '🶾', '🶿', '🷀', '🷁', '🷂', '🷃', '🷄', '🷅', '🷆', '🷇', '🷈', '🷉', '🷊', '🷋', '🷌', '🷍', '🷎', '🷏', '🷐', '🷑', '🷒', '🷓', '🷔', '🷕', '🷖', '🷗', '🷘', '🷙', '🷚', '🷛', '🷜', '🷝', '🷞', '🷟', '🷠', '🷡', '🷢', '🷣', '🷤', '🷥', '🷦', '🷧', '🷨', '🷩', '🷪', '🷫', '🷬', '🷭', '🷮', '🷯', '🷰', '🷱', '🷲', '🷳', '🷴', '🷵', '🷶', '🷷', '🷸', '🷹', '🷺', '🷻', '🷼', '🷽', '🷾', '🷿', '🸀', '🸁', '🸂', '🸃', '🸄', '🸅', '🸆', '🸇', '🸈', '🸉', '🸊', '🸋', '🸌', '🸍', '🸎', '🸏', '🸐', '🸑', '🸒', '🸓', '🸔', '🸕', '🸖', '🸗', '🸘', '🸙', '🸚', '🸛', '🸜', '🸝', '🸞', '🸟', '🸠', '🸡', '🸢', '🸣', '🸤', '🸥', '🸦', '🸧', '🸨', '🸩', '🸪', '🸫', '🸬', '🸭', '🸮', '🸯', '🸰', '🸱', '🸲', '🸳', '🸴', '🸵', '🸶', '🸷', '🸸', '🸹', '🸺', '🸻', '🸼', '🸽', '🸾', '🸿', '🹀', '🹁', '🹂', '🹃', '🹄', '🹅', '🹆', '🹇', '🹈', '🹉', '🹊', '🹋', '🹌', '🹍', '🹎', '🹏', '🹐', '🹑', '🹒', '🹓', '🹔', '🹕', '🹖', '🹗', '🹘', '🹙', '🹚', '🹛', '🹜', '🹝', '🹞', '🹟', '🹠', '🹡', '🹢', '🹣', '🹤', '🹥', '🹦', '🹧', '🹨', '🹩', '🹪', '🹫', '🹬', '🹭', '🹮', '🹯', '🹰', '🹱', '🹲', '🹳', '🹴', '🹵', '🹶', '🹷', '🹸', '🹹', '🹺', '🹻', '🹼', '🹽', '🹾', '🹿', '🺀', '🺁', '🺂', '🺃', '🺄', '🺅', '🺆', '🺇', '🺈', '🺉', '🺊', '🺋', '🺌', '🺍', '🺎', '🺏', '🺐', '🺑', '🺒', '🺓', '🺔', '🺕', '🺖', '🺗', '🺘', '🺙', '🺚', '🺛', '🺜', '🺝', '🺞', '🺟', '🺠', '🺡', '🺢', '🺣', '🺤', '🺥', '🺦', '🺧', '🺨', '🺩', '🺪', '🺫', '🺬', '🺭', '🺮', '🺯', '🺰', '🺱', '🺲', '🺳', '🺴', '🺵', '🺶', '🺷', '🺸', '🺹', '🺺', '🺻', '🺼', '🺽', '🺾', '🺿', '🻀', '🻁', '🻂', '🻃', '🻄', '🻅', '🻆', '🻇', '🻈', '🻉', '🻊', '🻋', '🻌', '🻍', '🻎', '🻏', '🻐', '🻑', '🻒', '🻓', '🻔', '🻕', '🻖', '🻗', '🻘', '🻙', '🻚', '🻛', '🻜', '🻝', '🻞', '🻟', '🻠', '🻡', '🻢', '🻣', '🻤', '🻥', '🻦', '🻧', '🻨', '🻩', '🻪', '🻫', '🻬', '🻭', '🻮', '🻯', '🻰', '🻱', '🻲', '🻳', '🻴', '🻵', '🻶', '🻷', '🻸', '🻹', '🻺', '🻻', '🻼', '🻽', '🻾', '🻿', '🼀', '🼁', '🼂', '🼃', '🼄', '🼅', '🼆', '🼇', '🼈', '🼉', '🼊', '🼋', '🼌', '🼍', '🼎', '🼏', '🼐', '🼑', '🼒', '🼓', '🼔', '🼕', '🼖', '🼗', '🼘', '🼙', '🼚', '🼛', '🼜', '🼝', '🼞', '🼟', '🼠', '🼡', '🼢', '🼣', '🼤', '🼥', '🼦', '🼧', '🼨', '🼩', '🼪', '🼫', '🼬', '🼭', '🼮', '🼯', '🼰', '🼱', '🼲', '🼳', '🼴', '🼵', '🼶', '🼷', '🼸', '🼹', '🼺', '🼻', '🼼', '🼽', '🼾', '🼿', '🽀', '🽁', '🽂', '🽃', '🽄', '🽅', '🽆', '🽇', '🽈', '🽉', '🽊', '🽋', '🽌', '🽍', '🽎', '🽏', '🽐', '🽑', '🽒', '🽓', '🽔', '🽕', '🽖', '🽗', '🽘', '🽙', '🽚', '🽛', '🽜', '🽝', '🽞', '🽟', '🽠', '🽡', '🽢', '🽣', '🽤', '🽥', '🽦', '🽧', '🽨', '🽩', '🽪', '🽫', '🽬', '🽭', '🽮', '🽯', '🽰', '🽱', '🽲', '🽳', '🽴', '🽵', '🽶', '🽷', '🽸', '🽹', '🽺', '🽻', '🽼', '🽽', '🽾', '🽿', '🾀', '🾁', '🾂', '🾃', '🾄', '🾅', '🾆', '🾇', '🾈', '🾉', '🾊', '🾋', '🾌', '🾍', '🾎', '🾏', '🾐', '🾑', '🾒', '🾓', '🾔', '🾕', '🾖', '🾗', '🾘', '🾙', '🾚', '🾛', '🾜', '🾝', '🾞', '🾟', '🾠', '🾡', '🾢', '🾣', '🾤', '🾥', '🾦', '🾧', '🾨', '🾩', '🾪', '🾫', '🾬', '🾭', '🾮', '🾯', '🾰', '🾱', '🾲', '🾳', '🾴', '🾵', '🾶', '🾷', '🾸', '🾹', '🾺', '🾻', '🾼', '🾽', '🾾', '🾿', '🿀', '🿁', '🿂', '🿃', '🿄', '🿅', '🿆', '🿇', '🿈', '🿉', '🿊', '🿋', '🿌', '🿍', '🿎', '🿏', '🿐', '🿑', '🿒', '🿓', '🿔', '🿕', '🿖', '🿗', '🿘', '🿙', '🿚', '🿛', '🿜', '🿝', '🿞', '🿟', '🿠', '🿡', '🿢', '🿣', '🿤', '🿥', '🿦', '🿧', '🿨', '🿩', '🿪', '🿫', '🿬', '🿭', '🿮', '🿯', '🿰', '🿱', '🿲', '🿳', '🿴', '🿵', '🿶', '🿷', '🿸', '🿹', '🿺', '🿻', '🿼', '🿽', '🿾', '🿿', '💀', '💁', '💂', '💃', '💄', '💅', '💆', '💇', '💈', '💉', '💊', '💋', '💌', '💍', '💎', '💏', '💐', '💑', '💒', '💓', '💔', '💕', '💖', '💗', '💘', '💙', '💚', '💛', '💜', '💝', '💞', '💟', '💠', '💡', '💢', '💣', '💤', '💥', '💦', '💧', '💨', '💩', '💪', '💫', '💬', '💭', '💮', '💯', '💰', '💱', '💲', '💳', '💴', '💵', '💶', '💷', '💸', '💹', '💺', '💻', '💼', '💽', '💾', '💿', '📀', '📁', '📂', '📃', '📄', '📅', '📆', '📇', '📈', '📉', '📊', '📋', '📌', '📍', '📎', '📏', '📐', '📑', '📒', '📓', '📔', '📕', '📖', '📗', '📘', '📙', '📚', '📛', '📜', '📝', '📞', '📟', '📠', '📡', '📢', '📣', '📤', '📥', '📦', '📧', '📨', '📩', '📪', '📫', '📬', '📭', '📮', '📯', '📰', '📱', '📲', '📳', '📴', '📵', '📶', '📷', '📸', '📹', '📺', '📻', '📼', '📽', '📾', '📿', '🔀', '🔁', '🔂', '🔃', '🔄', '🔅', '🔆', '🔇', '🔈', '🔉', '🔊', '🔋', '🔌', '🔍', '🔎', '🔏', '🔐', '🔑', '🔒', '🔓', '🔔', '🔕', '🔖', '🔗', '🔘', '🔙', '🔚', '🔛', '🔜', '🔝', '🔞', '🔟', '🔠', '🔡', '🔢', '🔣', '🔤', '🔥', '🔦', '🔧', '🔨', '🔩', '🔪', '🔫', '🔬', '🔭', '🔮', '🔯', '🔰', '🔱', '🔲', '🔳', '🔴', '🔵', '🔶', '🔷', '🔸', '🔹', '🔺', '🔻', '🔼', '🔽', '🕐', '🕑', '🕒', '🕓', '🕔', '🕕', '🕖', '🕗', '🕘', '🕙', '🕚', '🕛', '🕜', '🕝', '🕞', '🕟', '🕠', '🕡', '🕢', '🕣', '🕤', '🕥', '🕦', '🕧', '🕰', '🕱', '🕲', '🕳', '🕴', '🕵', '🕶', '🕷', '🕸', '🕹', '🕺', '🕻', '🕼', '🕽', '🕾', '🕿', '🖀', '🖁', '🖂', '🖃', '🖄', '🖅', '🖆', '🖇', '🖈', '🖉', '🖊', '🖋', '🖌', '🖍', '🖎', '🖏', '🖐', '🖑', '🖒', '🖓', '🖔', '🖕', '🖖', '🖗', '🖘', '🖙', '🖚', '🖛', '🖜', '🖝', '🖞', '🖟', '🖠', '🖡', '🖢', '🖣', '🖤', '🖥', '🖦', '🖧', '🖨', '🖩', '🖪', '🖫', '🖬', '🖭', '🖮', '🖯', '🖰', '🖱', '🖲', '🖳', '🖴', '🖵', '🖶', '🖷', '🖸', '🖹', '🖺', '🖻', '🖼', '🖽', '🖾', '🖿', '🗀', '🗁', '🗂', '🗃', '🗄', '🗅', '🗆', '🗇', '🗈', '🗉', '🗊', '🗋', '🗌', '🗍', '🗎', '🗏', '🗐', '🗑', '🗒', '🗓', '🗔', '🗕', '🗖', '🗗', '🗘', '🗙', '🗚', '🗛', '🗜', '🗝', '🗞', '🗟', '🗠', '🗡', '🗢', '🗣', '🗤', '🗥', '🗦', '🗧', '🗨', '🗩', '🗪', '🗫', '🗬', '🗭', '🗮', '🗯', '🗰', '🗱', '🗲', '🗳', '🗴', '🗵', '🗶', '🗷', '🗸', '🗹', '🗺', '🗻', '🗼', '🗽', '🗾', '🗿', '😀', '😁', '😂', '😃', '😄', '😅', '😆', '😇', '😈', '😉', '😊', '😋', '😌', '😍', '😎', '😏', '😐', '😑', '😒', '😓', '😔', '😕', '😖', '😗', '😘', '😙', '😚', '😛', '😜', '😝', '😞', '😟', '😠', '😡', '😢', '😣', '😤', '😥', '😦', '😧', '😨', '😩', '😪', '😫', '😬', '😭', '😮', '😯', '😰', '😱', '😲', '😳', '😴', '😵', '😶', '😷', '😸', '😹', '😺', '😻', '😼', '😽', '😾', '😿', '🙀', '🙁', '🙂', '🙃', '🙄', '🤐', '🤑', '🤒', '🤓', '🤔', '🤕', '🤖', '🤗', '🤘', '🤙', '🤚', '🤛', '🤜', '🤝', '🤞', '🤟', '🤠', '🤡', '🤢', '🤣', '🤤', '🤥', '🤦', '🤧', '🤨', '🤩', '🤪', '🤫', '🤬', '🤭', '🤮', '🤯', '🤰', '🤱', '🤲', '🤳', '🤴', '🤵', '🤶', '🤷', '🤸', '🤹', '🤺', '🤻', '🤼', '🤽', '🤾', '🤿', '🥀', '🥁', '🥂', '🥃', '🥄', '🥅', '🥆', '🥇', '🥈', '🥉', '🥊', '🥋', '🥌', '🥍', '🥎', '🥏', '🥐', '🥑', '🥒', '🥓', '🥔', '🥕', '🥖', '🥗', '🥘', '🥙', '🥚', '🥛', '🥜', '🥝', '🥞', '🥟', '🥠', '🥡', '🥢', '🥣', '🥤', '🥥', '🥦', '🥧', '🥨', '🥩', '🥪', '🥫', '🥬', '🥭', '🥮', '🥯', '🥰', '🥱', '🥲', '🥳', '🥴', '🥵', '🥶', '🥷', '🥸', '🥹', '🥺', '🥻', '🥼', '🥽', '🥾', '🥿', '🦀', '🦁', '🦂', '🦃', '🦄', '🦅', '🦆', '🦇', '🦈', '🦉', '🦊', '🦋', '🦌', '🦍', '🦎', '🦏', '🦐', '🦑', '🦒', '🦓', '🦔', '🦕', '🦖', '🦗', '🦘', '🦙', '🦚', '🦛', '🦜', '🦝', '🦞', '🦟', '🦠', '🦡', '🦢', '🦣', '🦤', '🦥', '🦦', '🦧', '🦨', '🦩', '🦪', '🦫', '🦬', '🦭', '🦮', '🦯', '🦰', '🦱', '🦲', '🦳', '🦴', '🦵', '🦶', '🦷', '🦸', '🦹', '🦺', '🦻', '🦼', '🦽', '🦾', '🦿', '🧀', '🧁', '🧂', '🧃', '🧄', '🧅', '🧆', '🧇', '🧈', '🧉', '🧊', '🧋', '🧌', '🧍', '🧎', '🧏', '🧐', '🧑', '🧒', '🧓', '🧔', '🧕', '🧖', '🧗', '🧘', '🧙', '🧚', '🧛', '🧜', '🧝', '🧞', '🧟', '🧠', '🧡', '🧢', '🧣', '🧤', '🧥', '🧦', '🧧', '🧨', '🧩', '🧪', '🧫', '🧬', '🧭', '🧮', '🧯', '🧰', '🧱', '🧲', '🧳', '🧴', '🧵', '🧶', '🧷', '🧸', '🧹', '🧺', '🧻', '🧼', '🧽', '🧾', '🧿', '🩀', '🩁', '🩂', '🩃', '🩄', '🩅', '🩆', '🩇', '🩈', '🩉', '🩊', '🩋', '🩌', '🩍', '🩎', '🩏', '🩐', '🩑', '🩒', '🩓', '🩔', '🩕', '🩖', '🩗', '🩘', '🩙', '🩚', '🩛', '🩜', '🩝', '🩞', '🩟', '🩠', '🩡', '🩢', '🩣', '🩤', '🩥', '🩦', '🩧', '🩨', '🩩', '🩪', '🩫', '🩬', '🩭', '🩮', '🩯', '🩰', '🩱', '🩲', '🩳', '🩴', '🩵', '🩶', '🩷', '🩸', '🩹', '🩺', '🩻', '🩼', '🪀', '🪁', '🪂', '🪃', '🪄', '🪅', '🪆', '🪇', '🪈', '🪉', '🪊', '🪋', '🪌', '🪍', '🪎', '🪏', '🪐', '🪑', '🪒', '🪓', '🪔', '🪕', '🪖', '🪗', '🪘', '🪙', '🪚', '🪛', '🪜', '🪝', '🪞', '🪟', '🪠', '🪡', '🪢', '🪣', '🪤', '🪥', '🪦', '🪧', '🪨', '🪩', '🪪', '🪫', '🪬', '🪭', '🪮', '🪯', '🪰', '🪱', '🪲', '🪳', '🪴', '🪵', '🪶', '🪷', '🪸', '🪹', '🪺', '🪻', '🪼', '🪽', '🪾', '🪿', '🫀', '🫁', '🫂', '🫃', '🫄', '🫅', '🫆', '🫇', '🫈', '🫉', '🫊', '🫋', '🫌', '🫍', '🫎', '🫏', '🫐', '🫑', '🫒', '🫓', '🫔', '🫕', '🫖', '🫗', '🫘', '🫙', '🫚', '🫛', '🫜', '🫝', '🫞', '🫟', '🫠', '🫡', '🫢', '🫣', '🫤', '🫥', '🫦', '🫧', '🫨', '🫩', '🫪', '🫫', '🫬', '🫭', '🫮', '🫯', '🫰', '🫱', '🫲', '🫳', '🫴', '🫵', '🫶', '🫷', '🫸', '🫹', '🫺', '🫻', '🫼', '🫽', '🫾', '🫿', '🬀', '🬁', '🬂', '🬃', '🬄', '🬅', '🬆', '🬇', '🬈', '🬉', '🬊', '🬋', '🬌', '🬍', '🬎', '🬏', '🬐', '🬑', '🬒', '🬓', '🬔', '🬕', '🬖', '🬗', '🬘', '🬙', '🬚', '🬛', '🬜', '🬝', '🬞', '🬟', '🬠', '🬡', '🬢', '🬣', '🬤', '🬥', '🬦', '🬧', '🬨', '🬩', '🬪', '🬫', '🬬', '🬭', '🬮', '🬯', '🬰', '🬱', '🬲', '🬳', '🬴', '🬵', '🬶', '🬷', '🬸', '🬹', '🬺', '🬻', '🬼', '🬽', '🬾', '🬿', '🭀', '🭁', '🭂', '🭃', '🭄', '🭅', '🭆', '🭇', '🭈', '🭉', '🭊', '🭋', '🭌', '🭍', '🭎', '🭏', '🭐', '🭑', '🭒', '🭓', '🭔', '🭕', '🭖', '🭗', '🭘', '🭙', '🭚', '🭛', '🭜', '🭝', '🭞', '🭟', '🭠', '🭡', '🭢', '🭣', '🭤', '🭥', '🭦', '🭧', '🭨', '🭩', '🭪', '🭫', '🭬', '🭭', '🭮', '🭯', '🭰', '🭱', '🭲', '🭳', '🭴', '🭵', '🭶', '🭷', '🭸', '🭹', '🭺', '🭻', '🭼', '🭽', '🭾', '🭿', '🮀', '🮁', '🮂', '🮃', '🮄', '🮅', '🮆', '🮇', '🮈', '🮉', '🮊', '🮋', '🮌', '🮍', '🮎', '🮏', '🮐', '🮑', '🮒', '🮓', '🮔', '🮕', '🮖', '🮗', '🮘', '🮙', '🮚', '🮛', '🮜', '🮝', '🮞', '🮟', '🮠', '🮡', '🮢', '🮣', '🮤', '🮥', '🮦', '🮧', '🮨', '🮩', '🮪', '🮫', '🮬', '🮭', '🮮', '🮯', '🮰', '🮱', '🮲', '🮳', '🮴', '🮵', '🮶', '🮷', '🮸', '🮹', '🮺', '🮻', '🮼', '🮽', '🮾', '🮿', '🯀', '🯁', '🯂', '🯃', '🯄', '🯅', '🯆', '🯇', '🯈', '🯉', '🯊', '🯋', '🯌', '🯍', '🯎', '🯏', '🯐', '🯑', '🯒', '🯓', '🯔', '🯕', '🯖', '🯗', '🯘', '🯙', '🯚', '🯛', '🯜', '🯝', '🯞', '🯟', '🯠', '🯡', '🯢', '🯣', '🯤', '🯥', '🯦', '🯧', '🯨', '🯩', '🯪', '🯫', '🯬', '🯭', '🯮', '🯯', '🯰', '🯱', '🯲', '🯳', '🯴', '🯵', '🯶', '🯷', '🯸', '🯹', '🯺', '🯻', '🯼', '🯽', '🯾', '🯿', '🰀', '🰁', '🰂', '🰃', '🰄', '🰅', '🰆', '🰇', '🰈', '🰉', '🰊', '🰋', '🰌', '🰍', '🰎', '🰏', '🰐', '🰑', '🰒', '🰓', '🰔', '🰕', '🰖', '🰗', '🰘', '🰙', '🰚', '🰛', '🰜', '🰝', '🰞', '🰟', '🰠', '🰡', '🰢', '🰣', '🰤', '🰥', '🰦', '🰧', '🰨', '🰩', '🰪', '🰫', '🰬', '🰭', '🰮', '🰯', '🰰', '🰱', '🰲', '🰳', '🰴', '🰵', '🰶', '🰷', '🰸', '🰹', '🰺', '🰻', '🰼', '🰽', '🰾', '🰿', '🱀', '🱁', '🱂', '🱃', '🱄', '🱅', '🱆', '🱇', '🱈', '🱉', '🱊', '🱋', '🱌', '🱍', '🱎', '🱏', '🱐', '🱑', '🱒', '🱓', '🱔', '🱕', '🱖', '🱗', '🱘', '🱙', '🱚', '🱛', '🱜', '🱝', '🱞', '🱟', '🱠', '🱡', '🱢', '🱣', '🱤', '🱥', '🱦', '🱧', '🱨', '🱩', '🱪', '🱫', '🱬', '🱭', '🱮', '🱯', '🱰', '🱱', '🱲', '🱳', '🱴', '🱵', '🱶', '🱷', '🱸', '🱹', '🱺', '🱻', '🱼', '🱽', '🱾', '🱿', '🲀', '🲁', '🲂', '🲃', '🲄', '🲅', '🲆', '🲇', '🲈', '🲉', '🲊', '🲋', '🲌', '🲍', '🲎', '🲏', '🲐', '🲑', '🲒', '🲓', '🲔', '🲕', '🲖', '🲗', '🲘', '🲙', '🲚', '🲛', '🲜', '🲝', '🲞', '🲟', '🲠', '🲡', '🲢', '🲣', '🲤', '🲥', '🲦', '🲧', '🲨', '🲩', '🲪', '🲫', '🲬', '🲭', '🲮', '🲯', '🲰', '🲱', '🲲', '🲳', '🲴', '🲵', '🲶', '🲷', '🲸', '🲹', '🲺', '🲻', '🲼', '🲽', '🲾', '🲿', '🳀', '🳁', '🳂', '🳃', '🳄', '🳅', '🳆', '🳇', '🳈', '🳉', '🳊', '🳋', '🳌', '🳍', '🳎', '🳏', '🳐', '🳑', '🳒', '🳓', '🳔', '🳕', '🳖', '🳗', '🳘', '🳙', '🳚', '🳛', '🳜', '🳝', '🳞', '🳟', '🳠', '🳡', '🳢', '🳣', '🳤', '🳥', '🳦', '🳧', '🳨', '🳩', '🳪', '🳫', '🳬', '🳭', '🳮', '🳯', '🳰', '🳱', '🳲', '🳳', '🳴', '🳵', '🳶', '🳷', '🳸', '🳹', '🳺', '🳻', '🳼', '🳽', '🳾', '🳿', '🴀', '🴁', '🴂', '🴃', '🴄', '🴅', '🴆', '🴇', '🴈', '🴉', '🴊', '🴋', '🴌', '🴍', '🴎', '🴏', '🴐', '🴑', '🴒', '🴓', '🴔', '🴕', '🴖', '🴗', '🴘', '🴙', '🴚', '🴛', '🴜', '🴝', '🴞', '🴟', '🴠', '🴡', '🴢', '🴣', '🴤', '🴥', '🴦', '🴧', '🴨', '🴩', '🴪', '🴫', '🴬', '🴭', '🴮', '🴯', '🴰', '🴱', '🴲', '🴳', '🴴', '🴵', '🴶', '🴷', '🴸', '🴹', '🴺', '🴻', '🴼', '🴽', '🴾', '🴿', '🵀', '🵁', '🵂', '🵃', '🵄', '🵅', '🵆', '🵇', '🵈', '🵉', '🵊', '🵋', '🵌', '🵍', '🵎', '🵏', '🵐', '🵑', '🵒', '🵓', '🵔', '🵕', '🵖', '🵗', '🵘', '🵙', '🵚', '🵛', '🵜', '🵝', '🵞', '🵟', '🵠', '🵡', '🵢', '🵣', '🵤', '🵥', '🵦', '🵧', '🵨', '🵩', '🵪', '🵫', '🵬', '🵭', '🵮', '🵯', '🵰', '🵱', '🵲', '🵳', '🵴', '🵵', '🵶', '🵷', '🵸', '🵹', '🵺', '🵻', '🵼', '🵽', '🵾', '🵿', '🶀', '🶁', '🶂', '🶃', '🶄', '🶅', '🶆', '🶇', '🶈', '🶉', '🶊', '🶋', '🶌', '🶍', '🶎', '🶏', '🶐', '🶑', '🶒', '🶓', '🶔', '🶕', '🶖', '🶗', '🶘', '🶙', '🶚', '🶛', '🶜', '🶝', '🶞', '🶟', '🶠', '🶡', '🶢', '🶣', '🶤', '🶥', '🶦', '🶧', '🶨', '🶩', '🶪', '🶫', '🶬', '🶭', '🶮', '🶯', '🶰', '🶱', '🶲', '🶳', '🶴', '🶵', '🶶', '🶷', '🶸', '🶹', '🶺', '🶻', '🶼', '🶽', '🶾', '🶿', '🷀', '🷁', '🷂', '🷃', '🷄', '🷅', '🷆', '🷇', '🷈', '🷉', '🷊', '🷋', '🷌', '🷍', '🷎', '🷏', '🷐', '🷑', '🷒', '🷓', '🷔', '🷕', '🷖', '🷗', '🷘', '🷙', '🷚', '🷛', '🷜', '🷝', '🷞', '🷟', '🷠', '🷡', '🷢', '🷣', '🷤', '🷥', '🷦', '🷧', '🷨', '🷩', '🷪', '🷫', '🷬', '🷭', '🷮', '🷯', '🷰', '🷱', '🷲', '🷳', '🷴', '🷵', '🷶', '🷷', '🷸', '🷹', '🷺', '🷻', '🷼', '🷽', '🷾', '🷿', '🸀', '🸁', '🸂', '🸃', '🸄', '🸅', '🸆', '🸇', '🸈', '🸉', '🸊', '🸋', '🸌', '🸍', '🸎', '🸏', '🸐', '🸑', '🸒', '🸓', '🸔', '🸕', '🸖', '🸗', '🸘', '🸙', '🸚', '🸛', '🸜', '🸝', '🸞', '🸟', '🸠', '🸡', '🸢', '🸣', '🸤', '🸥', '🸦', '🸧', '🸨', '🸩', '🸪', '🸫', '🸬', '🸭', '🸮', '🸯', '🸰', '🸱', '🸲', '🸳', '🸴', '🸵', '🸶', '🸷', '🸸', '🸹', '🸺', '🸻', '🸼', '🸽', '🸾', '🸿', '🹀', '🹁', '🹂', '🹃', '🹄', '🹅', '🹆', '🹇', '🹈', '🹉', '🹊', '🹋', '🹌', '🹍', '🹎', '🹏', '🹐', '🹑', '🹒', '🹓', '🹔', '🹕', '🹖', '🹗', '🹘', '🹙', '🹚', '🹛', '🹜', '🹝', '🹞', '🹟', '🹠', '🹡', '🹢', '🹣', '🹤', '🹥', '🹦', '🹧', '🹨', '🹩', '🹪', '🹫', '🹬', '🹭', '🹮', '🹯', '🹰', '🹱', '🹲', '🹳', '🹴', '🹵', '🹶', '🹷', '🹸', '🹹', '🹺', '🹻', '🹼', '🹽', '🹾', '🹿', '🺀', '🺁', '🺂', '🺃', '🺄', '🺅', '🺆', '🺇', '🺈', '🺉', '🺊', '🺋', '🺌', '🺍', '🺎', '🺏', '🺐', '🺑', '🺒', '🺓', '🺔', '🺕', '🺖', '🺗', '🺘', '🺙', '🺚', '🺛', '🺜', '🺝', '🺞', '🺟', '🺠', '🺡', '🺢', '🺣', '🺤', '🺥', '🺦', '🺧', '🺨', '🺩', '🺪', '🺫', '🺬', '🺭', '🺮', '🺯', '🺰', '🺱', '🺲', '🺳', '🺴', '🺵', '🺶', '🺷', '🺸', '🺹', '🺺', '🺻', '🺼', '🺽', '🺾', '🺿', '🻀', '🻁', '🻂', '🻃', '🻄', '🻅', '🻆', '🻇', '🻈', '🻉', '🻊', '🻋', '🻌', '🻍', '🻎', '🻏', '🻐', '🻑', '🻒', '🻓', '🻔', '🻕', '🻖', '🻗', '🻘', '🻙', '🻚', '🻛', '🻜', '🻝', '🻞', '🻟', '🻠', '🻡', '🻢', '🻣', '🻤', '🻥', '🻦', '🻧', '🻨', '🻩', '🻪', '🻫', '🻬', '🻭', '🻮', '🻯', '🻰', '🻱', '🻲', '🻳', '🻴', '🻵', '🻶', '🻷', '🻸', '🻹', '🻺', '🻻', '🻼', '🻽', '🻾', '🻿', '🼀', '🼁', '🼂', '🼃', '🼄', '🼅', '🼆', '🼇', '🼈', '🼉', '🼊', '🼋', '🼌', '🼍', '🼎', '🼏', '🼐', '🼑', '🼒', '🼓', '🼔', '🼕', '🼖', '🼗', '🼘', '🼙', '🼚', '🼛', '🼜', '🼝', '🼞', '🼟', '🼠', '🼡', '🼢', '🼣', '🼤', '🼥', '🼦', '🼧', '🼨', '🼩', '🼪', '🼫', '🼬', '🼭', '🼮', '🼯', '🼰', '🼱', '🼲', '🼳', '🼴', '🼵', '🼶', '🼷', '🼸', '🼹', '🼺', '🼻', '🼼', '🼽', '🼾', '🼿', '🽀', '🽁', '🽂', '🽃', '🽄', '🽅', '🽆', '🽇', '🽈', '🽉', '🽊', '🽋', '🽌', '🽍', '🽎', '🽏', '🽐', '🽑', '🽒', '🽓', '🽔', '🽕', '🽖', '🽗', '🽘', '🽙', '🽚', '🽛', '🽜', '🽝', '🽞', '🽟', '🽠', '🽡', '🽢', '🽣', '🽤', '🽥', '🽦', '🽧', '🽨', '🽩', '🽪', '🽫', '🽬', '🽭', '🽮', '🽯', '🽰', '🽱', '🽲', '🽳', '🽴', '🽵', '🽶', '🽷', '🽸', '🽹', '🽺', '🽻', '🽼', '🽽', '🽾', '🽿', '🾀', '🾁', '🾂', '🾃', '🾄', '🾅', '🾆', '🾇', '🾈', '🾉', '🾊', '🾋', '🾌', '🾍', '🾎', '🾏', '🾐', '🾑', '🾒', '🾓', '🾔', '🾕', '🾖', '🾗', '🾘', '🾙', '🾚', '🾛', '🾜', '🾝', '🾞', '🾟', '🾠', '🾡', '🾢', '🾣', '🾤', '🾥', '🾦', '🾧', '🾨', '🾩', '🾪', '🾫', '🾬', '🾭', '🾮', '🾯', '🾰', '🾱', '🾲', '🾳', '🾴', '🾵', '🾶', '🾷', '🾸', '🾹', '🾺', '🾻', '🾼', '🾽', '🾾', '🾿', '🿀', '🿁', '🿂', '🿃', '🿄', '🿅', '🿆', '🿇', '🿈', '🿉', '🿊', '🿋', '🿌', '🿍', '🿎', '🿏', '🿐', '🿑', '🿒', '🿓', '🿔', '🿕', '🿖', '🿗', '🿘', '🿙', '🿚', '🿛', '🿜', '🿝', '🿞', '🿟', '🿠', '🿡', '🿢', '🿣', '🿤', '🿥', '🿦', '🿧', '🿨', '🿩', '🿪', '🿫', '🿬', '🿭', '🿮', '🿯', '🿰', '🿱', '🿲', '🿳', '🿴', '🿵', '🿶', '🿷', '🿸', '🿹', '🿺', '🿻', '🿼', '🿽', '🿾', '🿿'];
    return emojis[Math.floor(Math.random() * emojis.length)];
}

// 生成随机样式
function generateRandomStyle() {
    const styles = ['normal', 'highlight', 'quote', 'story'];
    return styles[Math.floor(Math.random() * styles.length)];
}

// 生成帖子内容（使用AI生成）- 平台风格化
async function generatePostContent(platform, theme) {
    try {
        // 获取论坛设置中的世界观
        const worldview = forumSettings && forumSettings.worldview ? forumSettings.worldview.trim() : '';
        
        console.log('🔍 检查世界观设置:');
        console.log('forumSettings:', forumSettings);
        console.log('worldview:', worldview);
        
        // 平台风格定义
        const platformStyles = {
            '知乎': {
                name: '知乎',
                style: '知识分享型，理性分析，逻辑清晰，专业回答，数据支撑',
                titleStyle: '如何...？为什么...？有什么...？',
                contentStyle: '专业术语，逻辑连接词，引用数据，举例说明，分点论述',
                commentStyle: '专业讨论，补充信息，质疑提问，深入探讨，感谢分享'
            },
            '小红书': {
                name: '小红书',
                style: '生活分享型，图文并茂，种草推荐，个人体验',
                titleStyle: '姐妹们！绝绝子！yyds！',
                contentStyle: '网络流行语，emoji表情，第一人称分享，详细步骤',
                commentStyle: '求链接，种草分享，分享经验，夸赞支持'
            },
            '贴吧': {
                name: '百度贴吧',
                style: '闲聊讨论型，接地气，网络用语，轻松随意',
                titleStyle: '老铁们、兄弟们、求助！',
                contentStyle: '方言特色，网络梗，真实吐槽，情感表达',
                commentStyle: '调侃安慰，经验分享，同感共鸣，搞笑回复'
            },
            'B站': {
                name: '哔哩哔哩',
                style: '二次元文化型，年轻化，梗文化，创意表达',
                titleStyle: 'awsl、爷青回、太真实了！',
                contentStyle: '二次元用语，网络梗，创意表达，年轻化表达',
                commentStyle: '玩梗回复，弹幕式，二次元用语，互动玩梗'
            },
            '推特': {
                name: '推特',
                style: '短快精悍型，简洁有力，观点鲜明，话题性强',
                titleStyle: '直接观点，热点话题',
                contentStyle: '短句表达，金句输出，观点鲜明，话题性强',
                commentStyle: '赞同反对，观点碰撞，转发讨论，争议讨论'
            }
        };
        
        const platformInfo = platformStyles[platform] || platformStyles['知乎'];
        
        // 构建prompt，根据是否有世界观来决定生成方式
        let prompt;
        
        if (worldview) {
            // 有世界观：根据世界观生成内容
            prompt = `请根据以下世界观背景，以${platformInfo.name}的风格生成一个论坛帖子。

世界观背景：${worldview}

平台特色：${platformInfo.style}
标题风格：${platformInfo.titleStyle}
内容风格：${platformInfo.contentStyle}
评论风格：${platformInfo.commentStyle}

要求：
1. 内容必须符合设定的世界观背景
2. 标题要符合${platformInfo.name}用户的表达习惯
3. 内容要体现${platformInfo.name}的特色和语言风格
4. 内容长度适中，符合该平台用户习惯
5. 然后生成3-5条符合该平台风格和世界观的评论
6. 返回格式：标题：xxx\n内容：xxx\n评论：\n1. xxx\n2. xxx\n3. xxx

请完全按照世界观背景和${platformInfo.name}的风格自由创作，不要使用固定模板。`;
        } else {
            // 没有世界观：使用默认主题生成
            prompt = `请以${platformInfo.name}的风格，生成一个关于"${theme}"主题的论坛帖子。

平台特色：${platformInfo.style}
标题风格：${platformInfo.titleStyle}
内容风格：${platformInfo.contentStyle}
评论风格：${platformInfo.commentStyle}

要求：
1. 标题要符合${platformInfo.name}用户的表达习惯
2. 内容要体现${platformInfo.name}的特色和语言风格
3. 内容长度适中，符合该平台用户习惯
4. 然后生成3-5条符合该平台风格的评论
5. 返回格式：标题：xxx\n内容：xxx\n评论：\n1. xxx\n2. xxx\n3. xxx

请完全按照${platformInfo.name}的风格自由创作，不要使用固定模板。`;
        }

        // 调用AI API
        const response = await callAIAPI(prompt);
        
        if (response && response.trim()) {
            // 解析AI返回的内容
            const lines = response.split('\n');
            let title = '';
            let content = '';
            let comments = [];
            let currentSection = '';
            
            for (const line of lines) {
                const trimmedLine = line.trim();
                
                if (trimmedLine.includes('标题：') || trimmedLine.includes('标题:')) {
                    title = trimmedLine.replace(/标题[：:]\s*/, '').trim();
                    currentSection = 'title';
                } else if (trimmedLine.includes('内容：') || trimmedLine.includes('内容:')) {
                    content = trimmedLine.replace(/内容[：:]\s*/, '').trim();
                    currentSection = 'content';
                } else if (trimmedLine.includes('评论：') || trimmedLine.includes('评论:')) {
                    currentSection = 'comments';
                } else if (trimmedLine.match(/^\d+\.\s/) || trimmedLine.match(/^-\s/) || trimmedLine.match(/^•\s/)) {
                    // 匹配评论格式：1. xxx 或 - xxx 或 • xxx
                    const comment = trimmedLine.replace(/^\d+\.\s|^-\s|^•\s/, '').trim();
                    if (comment && currentSection === 'comments') {
                        comments.push(comment);
                    }
                } else if (trimmedLine && currentSection === 'content') {
                    // 如果当前在内容部分，继续添加到内容
                    content += (content ? '\n' : '') + trimmedLine;
                } else if (trimmedLine && currentSection === 'comments') {
                    // 如果当前在评论部分，继续添加到评论
                    if (trimmedLine && !trimmedLine.includes('评论')) {
                        comments.push(trimmedLine);
                    }
                }
            }
            
            // 清理内容，移除重复的标题
            if (content && title && content.includes(title)) {
                content = content.replace(title, '').trim();
            }
            
            // 如果没有找到标题和内容，使用整个响应作为内容
            if (!title && !content) {
                content = response.trim();
                title = content.length > 20 ? content.substring(0, 20) + '...' : content;
            } else if (!title) {
                title = content.length > 20 ? content.substring(0, 20) + '...' : content;
            } else if (!content) {
                content = response.trim();
            }
            
            return { title, content, comments };
        }
    } catch (error) {
        console.error('AI生成帖子内容失败:', error);
    }
    
    // 如果AI生成失败，返回null
    return null;
}

// 生成评论
function generateComments(theme) {
    const comments = [];
    const commentCount = Math.floor(Math.random() * 3) + 3; // 3-5条评论
    
    for (let i = 0; i < commentCount; i++) {
        const comment = generateComment(theme);
        comments.push(comment);
    }
    
    return comments;
}

// 生成单条评论
function generateComment(theme) {
    // 根据主题生成更相关的评论
    const commentTemplates = {
        '生活': [
            '真的吗？我也试试！', '太有用了，谢谢分享！', '我也遇到过这种情况！', '学到了，谢谢！',
            '这个真的有用吗？', '我也试试看！', '谢谢分享！', '学到了！', '真的吗？', '我也试试！',
            '太棒了！', '我也遇到过！', '学到了新知识！', '谢谢分享经验！', '我也试试这个方法！',
            '太实用了！', '我也遇到过同样的问题！', '学到了！', '谢谢分享！', '我也试试！',
            '太有用了！', '我也遇到过！', '学到了！', '谢谢分享！', '我也试试！',
            '太棒了！我也试试！', '学到了新知识！', '谢谢分享经验！', '我也遇到过！', '太实用了！'
        ],
        '职场': [
            '学到了！', '谢谢分享！', '我也遇到过！', '太有用了！', '我也试试！',
            '学到了新知识！', '谢谢分享经验！', '我也遇到过！', '太实用了！', '我也试试！',
            '学到了！', '谢谢分享！', '我也遇到过！', '太有用了！', '我也试试！',
            '学到了新知识！', '谢谢分享经验！', '我也遇到过！', '太实用了！', '我也试试！',
            '学到了！', '谢谢分享！', '我也遇到过！', '太有用了！', '我也试试！'
        ],
        '情感': [
            '太有用了！', '我也遇到过！', '学到了！', '谢谢分享！', '我也试试！',
            '学到了新知识！', '谢谢分享经验！', '我也遇到过！', '太实用了！', '我也试试！',
            '太有用了！', '我也遇到过！', '学到了！', '谢谢分享！', '我也试试！',
            '学到了新知识！', '谢谢分享经验！', '我也遇到过！', '太实用了！', '我也试试！',
            '太有用了！', '我也遇到过！', '学到了！', '谢谢分享！', '我也试试！'
        ],
        '学习': [
            '学到了！', '谢谢分享！', '我也遇到过！', '太有用了！', '我也试试！',
            '学到了新知识！', '谢谢分享经验！', '我也遇到过！', '太实用了！', '我也试试！',
            '学到了！', '谢谢分享！', '我也遇到过！', '太有用了！', '我也试试！',
            '学到了新知识！', '谢谢分享经验！', '我也遇到过！', '太实用了！', '我也试试！',
            '学到了！', '谢谢分享！', '我也遇到过！', '太有用了！', '我也试试！'
        ],
        '娱乐': [
            '太有用了！', '我也遇到过！', '学到了！', '谢谢分享！', '我也试试！',
            '学到了新知识！', '谢谢分享经验！', '我也遇到过！', '太实用了！', '我也试试！',
            '太有用了！', '我也遇到过！', '学到了！', '谢谢分享！', '我也试试！',
            '学到了新知识！', '谢谢分享经验！', '我也遇到过！', '太实用了！', '我也试试！',
            '太有用了！', '我也遇到过！', '学到了！', '谢谢分享！', '我也试试！'
        ]
    };
    
    const templates = commentTemplates[theme] || commentTemplates['生活'];
    const commentText = templates[Math.floor(Math.random() * templates.length)];
    const commentAuthor = generateUsername(theme);
    
    // 生成回复
    const replies = [];
    const replyCount = Math.floor(Math.random() * 2) + 1; // 1-2条回复
    
    for (let i = 0; i < replyCount; i++) {
        const reply = generateReply(theme);
        replies.push(reply);
    }
    
    return {
        id: 'comment_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        author: commentAuthor,
        content: commentText,
        timestamp: new Date().toISOString(),
        replies: replies
    };
}

// 生成回复
function generateReply(theme) {
    const replyTemplates = [
        '我也觉得！',
        '确实是这样！',
        '我也遇到过！',
        '谢谢分享！',
        '学到了！',
        '我也试试！',
        '真的吗？',
        '我也觉得！',
        '确实！',
        '我也试试！'
    ];
    
    const replyText = replyTemplates[Math.floor(Math.random() * replyTemplates.length)];
    const replyAuthor = generateUsername(theme);
    
    return {
        id: 'reply_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        author: replyAuthor,
        content: replyText,
        timestamp: new Date().toISOString()
    };
}

// 生成头像
function generateAvatar() {
    const avatars = [
        'https://files.catbox.moe/sim1.jpg',
        'https://files.catbox.moe/sim2.jpg',
        'https://files.catbox.moe/sim3.jpg',
        'https://files.catbox.moe/sim4.jpg',
        'https://files.catbox.moe/sim5.jpg'
    ];
    return avatars[Math.floor(Math.random() * avatars.length)];
}

// 根据主题获取标签
function getTagByTheme(theme) {
    const themeTags = {
        '生活': '生活',
        '职场': '职场',
        '情感': '情感',
        '学习': '学习',
        '娱乐': '娱乐'
    };
    return themeTags[theme] || '生活';
}

// 更新论坛个人资料
function updateForumProfile() {
    const avatar = document.getElementById('forumProfileAvatar');
    const name = document.getElementById('forumProfileName');
    const postCount = document.getElementById('forumPostCount');
    const likeCount = document.getElementById('forumLikeCount');
    const commentCount = document.getElementById('forumCommentCount');
    const header = document.querySelector('.forum-profile-header');
    
    // 设置头像和名字（使用论坛个人资料）
    avatar.style.backgroundImage = `url('${forumProfile.avatar}')`;
    name.textContent = forumProfile.name;
    
    // 设置名片背景
    if (forumProfile.card) {
        header.style.backgroundImage = `url('${forumProfile.card}')`;
        header.style.backgroundSize = 'cover';
        header.style.backgroundPosition = 'center';
        header.style.backgroundRepeat = 'no-repeat';
    } else {
        header.style.backgroundImage = 'linear-gradient(135deg, #ff6b35, #ff9a9e)';
        header.style.backgroundSize = '';
        header.style.backgroundPosition = '';
        header.style.backgroundRepeat = '';
    }
    
    // 计算统计数据
    const userPosts = forumPosts.filter(post => post.author === forumProfile.name);
    const totalLikes = userPosts.reduce((sum, post) => sum + (post.likes || 0), 0);
    const totalComments = userPosts.reduce((sum, post) => sum + (post.comments || 0), 0);
    
    postCount.textContent = userPosts.length;
    likeCount.textContent = totalLikes;
    commentCount.textContent = totalComments;
    
    // 渲染用户的贴文
    renderForumProfilePosts(userPosts);
}

// 渲染论坛个人贴文
function renderForumProfilePosts(posts) {
    const container = document.getElementById('forumProfilePosts');
    
    if (posts.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: #999;">
                <div style="font-size: 48px; margin-bottom: 20px;">📝</div>
                <div>还没有发布过贴文</div>
                <div style="font-size: 12px; margin-top: 8px;">点击右下角的 + 号开始发帖吧</div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = posts.map(post => `
        <div class="forum-profile-post-card">
            <div class="forum-profile-post">
                ${post.title ? `<div class="forum-profile-post-title">${post.title}</div>` : ''}
                <div class="forum-profile-post-content">${post.content}</div>
                <div class="forum-profile-post-meta">
                    <span class="forum-profile-post-time">${post.time || '刚刚'}</span>
                    <div class="forum-profile-post-stats">
                        <div class="forum-profile-post-stat">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                            <span>${post.views || 0}</span>
                        </div>
                        <div class="forum-profile-post-stat">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            <span>${post.comments || 0}</span>
                        </div>
                        <div class="forum-profile-post-stat">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                            </svg>
                            <span>${post.likes || 0}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// 发帖功能
function openPostModal() {
    playClickSound();
    const modal = document.getElementById('forumPostModal');
    if (modal) {
        modal.style.display = 'flex';
        document.getElementById('forumPostTitle').focus();
    }
}

function closePostModal() {
    const modal = document.getElementById('forumPostModal');
    if (modal) {
        modal.style.display = 'none';
        // 清空表单
        document.getElementById('forumPostTitle').value = '';
        document.getElementById('forumPostContent').value = '';
    }
}

async function submitForumPost() {
    const title = document.getElementById('forumPostTitle').value.trim();
    const content = document.getElementById('forumPostContent').value.trim();
    
    if (!content) {
        alert('请输入贴文内容');
        return;
    }
    
    playClickSound();
    
    // 创建新贴文
    const newPost = {
        id: Date.now(),
        title: title,
        content: content,
        author: forumProfile.name,
        avatar: forumProfile.avatar,
        time: '刚刚',
        views: 0,
        likes: 0,
        comments: 0,
        tags: [],
        commentList: []
    };
    
    // 添加到贴文列表
    forumPosts.unshift(newPost);
    
    // 重新渲染首页
    renderForumHome();
    
    // 关闭弹窗
    closePostModal();
    
    // 保存数据
    await saveForumData();
    
    // 延迟2秒后生成模拟回复
    setTimeout(async () => {
        await generateSimulatedReplies(newPost.id);
        renderForumHome(); // 重新渲染以显示模拟回复
        await saveForumData(); // 保存回复数据
    }, 2000);
    
    console.log('贴文发布成功');
}

// 论坛分页相关变量
let forumCurrentPage = 1;
const forumPostsPerPage = 5;

// 内容截断函数
function truncateContent(content, maxLength = 150) {
    if (!content) return '';
    if (content.length <= maxLength) return content;
    return content.substring(0, maxLength) + '...';
}

// 渲染论坛首页
function renderForumHome(page = 1) {
    const container = document.getElementById('forumPostsList');
    forumCurrentPage = page;
    
    // 生成AI帖子（如果启用了联系人参与）
    generateAIPosts();
    
    // 置顶帖子
    const pinnedPost = `
        <div class="forum-post-card pinned-post-card">
            <div class="forum-post pinned">
                <div style="text-align: center; margin-bottom: 15px;">
                    <h1 style="color: #ff6b35; font-size: 2.5em; margin: 0; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M2 12h20"></path>
                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                        </svg>
                        地球Online
                    </h1>
                    <p style="color: #666; font-size: 14px; margin: 8px 0 0 0;">这里是最新动态和八卦消息的聚集地!</p>
                </div>
                <p class="forum-post-content">
                    欢迎来到"地球online"！这里是分享生活点滴的地方，希望大家能够保持良好的社区氛围。请仔细阅读版规，禁止人身攻击、恶意挑拨、发布违规内容。祝大家冲浪愉快！
                </p>
                <div class="forum-post-footer">
                    <span class="forum-post-author">Admin</span>
                    <div class="forum-post-stats">
                        <span class="forum-stat-item">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                            999k
                        </span>
                        <span class="forum-stat-item">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            1.2k
                        </span>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // 获取AI生成的帖子
    const aiPosts = JSON.parse(localStorage.getItem('aiForumPosts') || '[]');
    
    // 合并所有帖子并按时间排序
    const allPosts = [...aiPosts, ...forumPosts].sort((a, b) => {
        const timeA = new Date(a.timestamp || a.time || 0);
        const timeB = new Date(b.timestamp || b.time || 0);
        return timeB - timeA;
    });
    
    // 计算分页
    const startIndex = (page - 1) * forumPostsPerPage;
    const endIndex = startIndex + forumPostsPerPage;
    const currentPagePosts = allPosts.slice(startIndex, endIndex);
    const totalPages = Math.ceil(allPosts.length / forumPostsPerPage);
    
    // 渲染当前页的帖子
    const postsHtml = currentPagePosts.map(post => {
        const isAIPost = post.isAI;
        const postId = isAIPost ? `'${post.id}'` : post.id;
        
        return `
            <div class="forum-post-card ${isAIPost ? 'ai-post' : ''}" onclick="openForumPostDetail(${postId})">
            <div class="forum-post">
                ${post.title ? `<h4 class="forum-post-title">${post.title}</h4>` : ''}
                    <p class="forum-post-content">${truncateContent(post.content, 150)}</p>
                <div class="forum-post-footer">
                    <div class="forum-post-author-info">
                        <span class="forum-post-author">${post.author}</span>
                            <span class="forum-post-time">${formatTime(post.timestamp || post.time)}</span>
                    </div>
                    <div class="forum-post-stats">
                            ${post.tag ? `<span class="forum-tag ${post.tag}">${post.tag}</span>` : ''}
                        ${post.tags && post.tags.length > 0 ? post.tags.map(tag => `<span class="forum-tag ${tag}">${tag}</span>`).join('') : ''}
                        <span class="forum-stat-item">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                                ${post.views || 0}
                        </span>
                            ${isAIPost ? `
                                <span class="forum-stat-item" onclick="event.stopPropagation(); shareForumPost('${post.id}')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                                <polyline points="16,6 12,2 8,6"></polyline>
                                <line x1="12" y1="2" x2="12" y2="15"></line>
                            </svg>
                        </span>
                                <span class="forum-stat-item" onclick="event.stopPropagation(); showCommentInput('${post.id}')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                                    ${post.comments || 0}
                        </span>
                            ` : `
                        <span class="forum-stat-item">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                                <polyline points="16,6 12,2 8,6"></polyline>
                                <line x1="12" y1="2" x2="12" y2="15"></line>
                            </svg>
                        </span>
                                <span class="forum-stat-item">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                                    ${post.comments || 0}
                        </span>
                            `}
                        <span class="forum-stat-item">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                            </svg>
                                ${post.likes || 0}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        `;
    }).join('');
    
    // 生成加载更多按钮
    let loadMoreButton = '';
    if (page < totalPages) {
        loadMoreButton = `
            <div class="forum-load-more-container">
                <button class="forum-load-more-btn" onclick="loadMoreForumPosts()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14"></path>
                        <path d="M5 12h14"></path>
                    </svg>
                    加载更多帖子
                </button>
            </div>
        `;
    }
    
    container.innerHTML = pinnedPost + postsHtml + loadMoreButton;
}

// 加载更多论坛帖子
function loadMoreForumPosts() {
    playClickSound();
    
    // 获取当前所有帖子
    const aiPosts = JSON.parse(localStorage.getItem('aiForumPosts') || '[]');
    const allPosts = [...aiPosts, ...forumPosts].sort((a, b) => {
        const timeA = new Date(a.timestamp || a.time || 0);
        const timeB = new Date(b.timestamp || b.time || 0);
        return timeB - timeA;
    });
    
    // 计算当前已显示的帖子数量
    const currentDisplayedCount = forumCurrentPage * forumPostsPerPage;
    const nextPagePosts = allPosts.slice(currentDisplayedCount, currentDisplayedCount + forumPostsPerPage);
    
    if (nextPagePosts.length === 0) {
        console.log('没有更多帖子了');
        return;
    }
    
    // 渲染新帖子并追加到现有内容
    const container = document.getElementById('forumPostsList');
    const newPostsHtml = nextPagePosts.map(post => {
        const isAIPost = post.isAI;
        const postId = isAIPost ? `'${post.id}'` : post.id;
        
        return `
            <div class="forum-post-card ${isAIPost ? 'ai-post' : ''}" onclick="openForumPostDetail(${postId})">
            <div class="forum-post">
                ${post.title ? `<h4 class="forum-post-title">${post.title}</h4>` : ''}
                    <p class="forum-post-content">${truncateContent(post.content, 150)}</p>
                <div class="forum-post-footer">
                    <div class="forum-post-author-info">
                        <span class="forum-post-author">${post.author}</span>
                            <span class="forum-post-time">${formatTime(post.timestamp || post.time)}</span>
                    </div>
                    <div class="forum-post-stats">
                            ${post.tag ? `<span class="forum-tag ${post.tag}">${post.tag}</span>` : ''}
                            ${post.tags && post.tags.length > 0 ? post.tags.map(tag => `<span class="forum-tag ${tag}">${tag}</span>`).join('') : ''}
                        <span class="forum-stat-item">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                                ${post.views || 0}
                        </span>
                            ${isAIPost ? `
                                <span class="forum-stat-item" onclick="event.stopPropagation(); shareForumPost('${post.id}')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                                <polyline points="16,6 12,2 8,6"></polyline>
                                <line x1="12" y1="2" x2="12" y2="15"></line>
                            </svg>
                        </span>
                                <span class="forum-stat-item" onclick="event.stopPropagation(); showCommentInput('${post.id}')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                                    ${post.comments || 0}
                        </span>
                            ` : `
                                <span class="forum-stat-item">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                                        <polyline points="16,6 12,2 8,6"></polyline>
                                        <line x1="12" y1="2" x2="12" y2="15"></line>
                                    </svg>
                                </span>
                                <span class="forum-stat-item">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                    </svg>
                                    ${post.comments || 0}
                                </span>
                            `}
                        <span class="forum-stat-item">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                            </svg>
                                ${post.likes || 0}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        `;
    }).join('');
    
    // 移除旧的加载更多按钮
    const oldLoadMoreBtn = container.querySelector('.forum-load-more-container');
    if (oldLoadMoreBtn) {
        oldLoadMoreBtn.remove();
    }
    
    // 追加新帖子
    container.insertAdjacentHTML('beforeend', newPostsHtml);
    
    // 更新当前页码
    forumCurrentPage++;
    
    // 检查是否还有更多帖子
    const totalPosts = allPosts.length;
    const displayedCount = forumCurrentPage * forumPostsPerPage;
    
    if (displayedCount < totalPosts) {
        // 还有更多帖子，添加新的加载更多按钮
        const loadMoreButton = `
            <div class="forum-load-more-container">
                <button class="forum-load-more-btn" onclick="loadMoreForumPosts()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14"></path>
                        <path d="M5 12h14"></path>
                    </svg>
                    加载更多帖子
                </button>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', loadMoreButton);
    }
}

// 论坛个人资料编辑功能
function openForumProfileEdit() {
    playClickSound();
    const modal = document.getElementById('forumProfileEditModal');
    if (modal) {
        // 设置当前值
        document.getElementById('forumProfileEditName').value = forumProfile.name;
        document.getElementById('forumProfileEditAvatar').style.backgroundImage = `url('${forumProfile.avatar}')`;
        
        // 设置名片
        const cardElement = document.getElementById('forumProfileEditCard');
        const placeholder = document.getElementById('forumProfileEditCardPlaceholder');
        if (forumProfile.card) {
            cardElement.style.backgroundImage = `url('${forumProfile.card}')`;
            cardElement.style.backgroundColor = 'transparent';
            placeholder.style.display = 'none';
        } else {
            cardElement.style.backgroundImage = '';
            cardElement.style.backgroundColor = 'transparent';
            placeholder.style.display = 'flex';
        }
        
        modal.style.display = 'flex';
    }
}

function closeForumProfileEdit() {
    const modal = document.getElementById('forumProfileEditModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

function selectForumAvatar() {
    playClickSound();
    // 创建文件选择器
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                forumProfile.avatar = e.target.result;
                document.getElementById('forumProfileEditAvatar').style.backgroundImage = `url('${e.target.result}')`;
                // 保存到localStorage
                saveForumProfile();
            };
            reader.readAsDataURL(file);
        }
    };
    input.click();
}

function selectForumCard() {
    playClickSound();
    // 创建文件选择器
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                forumProfile.card = e.target.result;
                const cardElement = document.getElementById('forumProfileEditCard');
                const placeholder = document.getElementById('forumProfileEditCardPlaceholder');
                
                // 设置背景图片
                cardElement.style.backgroundImage = `url('${e.target.result}')`;
                cardElement.style.backgroundColor = 'transparent';
                // 隐藏占位符文字
                placeholder.style.display = 'none';
                
                // 保存到localStorage
                saveForumProfile();
            };
            reader.readAsDataURL(file);
        }
    };
    input.click();
}

async function confirmSaveForumProfile() {
    const newName = document.getElementById('forumProfileEditName').value.trim();
    
    if (!newName) {
        alert('请输入论坛昵称');
        return;
    }
    
    playClickSound();
    
    // 更新资料
    forumProfile.name = newName;
    
    // 保存到localStorage
    saveForumProfile();
    
    // 更新显示
    updateForumProfile();
    
    // 关闭弹窗
    closeForumProfileEdit();
    
    console.log('论坛资料已保存');
}

// 贴文详情页面功能
function openForumPostDetail(postId) {
    playClickSound();
    
    // 先尝试从普通帖子中查找
    let post = forumPosts.find(p => p.id === postId);
    
    // 如果没找到，尝试从AI帖子中查找
    if (!post) {
        const aiPosts = JSON.parse(localStorage.getItem('aiForumPosts') || '[]');
        post = aiPosts.find(p => p.id === postId);
    }
    
    if (!post) {
        console.error('贴文不存在');
        return;
    }
    
    // 增加浏览量
    post.views = (post.views || 0) + 1;
    
    // 隐藏其他页面和底部导航栏
    document.getElementById('forumHomePage').style.display = 'none';
    document.getElementById('forumProfilePage').classList.remove('show');
    document.querySelector('.forum-bottom-nav').style.display = 'none';
    document.querySelector('.forum-fab-btn').style.display = 'none';
    
    // 显示详情页面
    document.getElementById('forumDetailPage').classList.add('show');
    
    // 渲染详情内容
    renderForumPostDetail(post);
    
    // 保存数据
    saveForumData();
}

function closeForumPostDetail() {
    playClickSound();
    
    // 隐藏详情页面
    document.getElementById('forumDetailPage').classList.remove('show');
    
    // 显示首页
    document.getElementById('forumHomePage').style.display = 'block';
    
    // 恢复底部导航栏和+按钮
    document.querySelector('.forum-bottom-nav').style.display = 'flex';
    document.querySelector('.forum-fab-btn').style.display = 'flex';
}

function renderForumPostDetail(post) {
    const container = document.getElementById('forumDetailContent');
    
    // 处理评论数据 - 统一处理AI帖子和普通帖子
    let commentsToRender = [];
    
    // 如果是AI帖子，先添加AI生成的评论
    if (post.isAI && post.commentsData && post.commentsData.length > 0) {
        commentsToRender = [...post.commentsData];
    }
    
    // 然后添加commentList中的评论（用户添加的评论）到最前面
    if (post.commentList && post.commentList.length > 0) {
        commentsToRender = [...post.commentList, ...commentsToRender];
    }
    
    // 渲染评论列表（按时间倒序，最新的在上面）
    const commentsHtml = commentsToRender.length > 0 ? 
        commentsToRender.slice().reverse().map(comment => `
            <div class="forum-comment-item" onclick="event.stopPropagation(); showReplyInput('${post.id}', '${comment.id}', '${comment.author}')">
                <div class="forum-comment-header">
                    <div class="forum-comment-avatar" style="background-image: url('${comment.avatar || ''}');">${comment.avatar ? '' : comment.author.charAt(0)}</div>
                    <div class="forum-comment-info">
                        <div class="forum-comment-author">${comment.author}</div>
                        <div class="forum-comment-time">${comment.time || comment.timestamp || '刚刚'}</div>
                    </div>
                </div>
                <div class="forum-comment-content">
                    <div class="forum-comment-text">${comment.content}</div>
                    ${comment.replies && comment.replies.length > 0 ? `
                        <div class="forum-comment-replies">
                            <div class="forum-reply-toggle" onclick="event.stopPropagation(); toggleReplies('${post.id}', '${comment.id}')">
                                <span class="forum-reply-toggle-text">展开 ${comment.replies.length} 条回复</span>
                                <span class="forum-reply-toggle-icon">▼</span>
                            </div>
                            <div class="forum-reply-list" style="display: none;">
                                ${comment.replies.slice().reverse().map(reply => `
                                    <div class="forum-comment-reply" onclick="event.stopPropagation(); showReplyInput('${post.id}', '${comment.id}', '${reply.author}')">
                                        <div class="forum-comment-header">
                                            <div class="forum-comment-avatar" style="background-image: url('${reply.avatar || ''}');">${reply.avatar ? '' : reply.author.charAt(0)}</div>
                                            <div class="forum-comment-info">
                                                <div class="forum-comment-author">${reply.author}</div>
                                                <div class="forum-comment-time">${reply.time}</div>
                                            </div>
                                        </div>
                                        <div class="forum-comment-content">
                                            <div class="forum-comment-text">${reply.content}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `).join('') : '<div class="forum-no-comments">暂无评论，快来抢沙发吧！</div>';
    
    container.innerHTML = `
        <div class="forum-detail-post-card">
            <div class="forum-detail-post">
                ${post.title ? `<div class="forum-detail-post-title">${post.title}</div>` : ''}
                <div class="forum-detail-post-header">
                    <div class="forum-detail-post-avatar" style="background-image: url('${post.avatar}');"></div>
                    <div class="forum-detail-post-info">
                        <div class="forum-detail-post-author">${post.author}</div>
                        <div class="forum-detail-post-time">${formatTime(post.timestamp || post.time)}</div>
                    </div>
                </div>
                <div class="forum-detail-post-content">${post.content}</div>
                <div class="forum-detail-post-stats">
                    <div class="forum-detail-stat-item" onclick="toggleForumPostLike(${post.id})">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                        <span>${post.likes || 0}</span>
                    </div>
                    <div class="forum-detail-stat-item">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        <span>${post.views || 0}</span>
                    </div>
                    <div class="forum-detail-stat-item" onclick="event.stopPropagation(); shareForumPost('${post.id}')">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                            <polyline points="16,6 12,2 8,6"></polyline>
                            <line x1="12" y1="2" x2="12" y2="15"></line>
                        </svg>
                    </div>
                    <div class="forum-detail-stat-item" onclick="event.stopPropagation(); showCommentInput('${post.id}')">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <span>${post.comments || 0}</span>
                    </div>
                    ${post.author === forumProfile.name ? `
                        <div class="forum-detail-stat-item delete-post-btn" onclick="event.stopPropagation(); deleteForumPost('${post.id}')">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 6h18"></path>
                                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                <line x1="14" y1="11" x2="14" y2="17"></line>
                            </svg>
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
        
        ${commentsHtml}
    `;
    
    // 设置用户头像
    const avatar = document.getElementById('forumCommentInputAvatar');
    if (avatar) {
        avatar.style.backgroundImage = `url('${forumProfile.avatar || 'https://files.catbox.moe/default-avatar.jpg'}')`;
    }
}

function toggleForumPostLike(postId) {
    playClickSound();
    
    const post = forumPosts.find(p => p.id === postId);
    if (post) {
        post.likes = (post.likes || 0) + 1;
        renderForumPostDetail(post);
        saveForumData();
    }
}

// 转发论坛帖子（占位符功能）
// 转发论坛帖子
function shareForumPost(postId) {
    playClickSound();
    showForumForwardModal(postId);
}

// 显示转发弹窗
function showForumForwardModal(postId) {
    const modal = document.getElementById('forumForwardModal');
    const contactsContainer = document.getElementById('forumForwardContacts');
    
    if (!modal || !contactsContainer) {
        console.error('转发弹窗元素未找到');
        return;
    }
    
    // 渲染联系人列表
    renderForwardContacts(postId);
    
    // 显示弹窗
    modal.classList.add('show');
}

// 关闭转发弹窗
function closeForumForwardModal() {
    const modal = document.getElementById('forumForwardModal');
    if (modal) {
        modal.classList.remove('show');
    }
    playClickSound();
}

// 渲染转发联系人列表
function renderForwardContacts(postId) {
    const contactsContainer = document.getElementById('forumForwardContacts');
    if (!contactsContainer) return;
    
    // 获取联系人列表
    const contacts = getContactsList();
    
    if (contacts.length === 0) {
        contactsContainer.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: #999;">
                <p>暂无联系人</p>
                <p style="font-size: 12px; margin-top: 8px;">请先添加联系人</p>
            </div>
        `;
        return;
    }
    
    // 生成联系人HTML
    const contactsHtml = contacts.map(contact => `
        <div class="forum-forward-contact" onclick="forwardToContact('${postId}', '${contact.id}')">
            <div class="forum-forward-contact-avatar" style="background-image: url('${contact.avatar || ''}'); background-color: ${contact.avatar ? 'transparent' : '#007AFF'};">
                ${contact.avatar ? '' : contact.name.charAt(0)}
            </div>
            <div class="forum-forward-contact-info">
                <div class="forum-forward-contact-name">${contact.name}</div>
                <div class="forum-forward-contact-status">${contact.isGroup ? '群聊' : '在线'}</div>
            </div>
        </div>
    `).join('');
    
    contactsContainer.innerHTML = contactsHtml;
}

// 获取联系人列表
function getContactsList() {
    console.log('🔍 开始获取联系人列表...');
    
    // 从currentMessages中获取真实的联系人数据
    if (typeof currentMessages !== 'undefined' && currentMessages && currentMessages.length > 0) {
        console.log('📱 从currentMessages获取联系人，总数:', currentMessages.length);
        
        // 去重并格式化联系人数据
        const uniqueContacts = new Map();
        
        currentMessages.forEach((message, index) => {
            const contactId = message.id || message.name; // 使用id或name作为唯一标识
            console.log(`联系人${index + 1}:`, {
                id: contactId,
                name: message.name,
                avatar: message.avatar,
                isGroup: message.isGroup
            });
            
            if (!uniqueContacts.has(contactId)) {
                uniqueContacts.set(contactId, {
                    id: String(contactId), // 确保ID是字符串类型
                    name: message.name,
                    avatar: message.avatar || '',
                    isGroup: message.isGroup || false
                });
            }
        });
        
        const contacts = Array.from(uniqueContacts.values());
        console.log('✅ 成功获取联系人:', contacts);
        return contacts;
    }
    
    // 如果没有联系人数据，返回示例数据
    console.log('⚠️ 没有找到currentMessages，使用示例联系人数据');
    const exampleContacts = [
        { id: 'contact1', name: '张三', avatar: '', isGroup: false },
        { id: 'contact2', name: '李四', avatar: '', isGroup: false },
        { id: 'contact3', name: '王五', avatar: '', isGroup: false },
        { id: 'group1', name: '工作群', avatar: '', isGroup: true },
        { id: 'group2', name: '朋友群', avatar: '', isGroup: true }
    ];
    console.log('📋 示例联系人:', exampleContacts);
    return exampleContacts;
}

// 转发到指定联系人
async function forwardToContact(postId, contactId) {
    // 先尝试从普通帖子中查找
    let post = forumPosts.find(p => p.id === postId);
    
    // 如果没找到，尝试从AI帖子中查找
    if (!post) {
        const aiPosts = JSON.parse(localStorage.getItem('aiForumPosts') || '[]');
        post = aiPosts.find(p => p.id === postId);
    }
    
    if (!post) {
        alert('帖子不存在！');
        return;
    }
    
    // 获取联系人信息
    console.log('🔍 开始查找联系人，contactId:', contactId);
    const contacts = getContactsList();
    console.log('📋 可用联系人列表:', contacts.map(c => ({ id: c.id, name: c.name })));
    
    // 尝试多种匹配方式，解决类型不匹配问题
    const contact = contacts.find(c => 
        c.id === contactId || 
        c.id == contactId || 
        String(c.id) === String(contactId) ||
        Number(c.id) === Number(contactId)
    );
    console.log('🎯 查找结果:', contact);
    
    if (!contact) {
        console.error('❌ 联系人查找失败:', { 
            contactId, 
            contactIdType: typeof contactId,
            availableContacts: contacts.map(c => ({ id: c.id, name: c.name, idType: typeof c.id }))
        });
        alert(`联系人不存在！\n\n查找的ID: ${contactId}\n可用联系人: ${contacts.map(c => c.name).join(', ')}`);
        return;
    }
    
    // 创建转发消息
    const forwardMessage = {
        id: Date.now(),
        type: 'forum_forward',
        content: `📢 转发论坛帖子：${post.title || post.content.substring(0, 30)}...`,
        timestamp: new Date().toISOString(),
        sender: 'sent', // 设置为'sent'表示用户发送的消息
        isForward: true,
        isFromUser: true, // 标记这是用户发送的消息
        originalPost: {
            id: post.id,
            title: post.title,
            content: post.content,
            author: post.author,
            time: post.time || post.timestamp,
            likes: post.likes,
            comments: post.comments,
            image: post.image,
            avatar: post.avatar
        }
    };
    
    try {
        // 将消息添加到指定联系人的聊天记录中
        await addMessageToChat(contactId, forwardMessage);
        
        // 显示成功提示
        alert(`✅ 已转发到 ${contact.name} 的聊天中！`);
        
        // 关闭转发弹窗
        closeForumForwardModal();
        
        // 播放点击音效
        playClickSound();
        
    } catch (error) {
        console.error('转发失败:', error);
        alert('转发失败，请重试！');
    }
}

// 添加消息到聊天记录
async function addMessageToChat(contactId, message) {
    // 获取该联系人的聊天记录
    let chatMessages = await loadChatMessages(contactId);
    if (!chatMessages) {
        chatMessages = [];
    }
    
    // 添加新消息
    chatMessages.push(message);
    
    // 保存聊天记录
    await saveChatMessages(contactId, chatMessages);
    
    // 同时更新currentMessages中的最后消息时间
    if (typeof currentMessages !== 'undefined' && currentMessages && contactId) {
        const contactIndex = currentMessages.findIndex(m => 
            m.id == contactId || m.name === contactId || 
            String(m.id) === contactId || String(m.name) === contactId
        );
        if (contactIndex !== -1) {
            currentMessages[contactIndex].time = message.timestamp;
            currentMessages[contactIndex].lastMessage = message.content;
            // 保存更新后的消息列表
            await saveMessagesToStorage();
        } else {
            console.warn('未找到联系人:', contactId, '在消息列表中');
        }
    }
}

// 提交论坛评论
async function submitForumComment(postId, commentId = null) {
    const input = document.getElementById('forumInputModalInput');
    const content = input.value.trim();
    
    if (!content) {
        alert('请输入评论内容！');
        return;
    }
    
    console.log('submitForumComment called with:', { postId, commentId, content });
    
    // 先尝试从普通帖子中查找
    let post = forumPosts.find(p => p.id === postId);
    let isAIPost = false;
    
    // 如果没找到，尝试从AI帖子中查找
    if (!post) {
        const aiPosts = JSON.parse(localStorage.getItem('aiForumPosts') || '[]');
        post = aiPosts.find(p => p.id === postId);
        if (post) isAIPost = true;
    }
    
    if (!post) {
        alert('帖子不存在！');
        return;
    }
    
    // 确保commentList存在
    if (!post.commentList) {
        post.commentList = [];
    }
    
    // 创建新评论
    const newComment = {
        id: Date.now(),
        author: forumProfile.name || '用户',
        avatar: forumProfile.avatar || 'https://files.catbox.moe/default-avatar.jpg',
        content: content,
        time: '刚刚',
        likes: 0,
        replies: []
    };
    
    // 添加到评论列表
    post.commentList.push(newComment);
    post.comments = (post.comments || 0) + 1;
    
    // 如果是AI帖子，需要更新localStorage
    if (isAIPost) {
        const aiPosts = JSON.parse(localStorage.getItem('aiForumPosts') || '[]');
        const index = aiPosts.findIndex(p => p.id === postId);
        if (index !== -1) {
            aiPosts[index] = post;
            localStorage.setItem('aiForumPosts', JSON.stringify(aiPosts));
        }
    }
    
    // 关闭输入框
    closeForumInputModal();
    
    // 重新渲染详情页面
    renderForumPostDetail(post);
    
    // 保存数据
    await saveForumData();
    
    // 触发AI自动回复（如果启用）
    if (forumSettings && forumSettings.enableAIReplies !== false) {
        setTimeout(() => {
            generateAIReplies(postId, commentId, content, post);
        }, 2000); // 2秒后生成AI回复
    }
    
    // 播放点击音效
    playClickSound();
}

// 显示评论输入框
function showCommentInput(postId) {
    console.log('showCommentInput called with postId:', postId);
    playClickSound();
    
    // 设置全局变量
    window.currentForumPostId = postId;
    
    // 检查必要元素是否存在
    const modal = document.getElementById('forumInputModal');
    const avatar = document.getElementById('forumInputModalAvatar');
    const input = document.getElementById('forumInputModalInput');
    const sendBtn = document.getElementById('forumInputModalSendBtn');
    
    if (!modal) {
        console.error('forumInputModal not found!');
        return;
    }
    if (!avatar) {
        console.error('forumInputModalAvatar not found!');
        return;
    }
    if (!input) {
        console.error('forumInputModalInput not found!');
        return;
    }
    if (!sendBtn) {
        console.error('forumInputModalSendBtn not found!');
        return;
    }
    
    // 设置用户头像
    if (avatar) {
        if (forumProfile.avatar) {
            avatar.style.backgroundImage = `url('${forumProfile.avatar}')`;
            avatar.textContent = '';
        } else {
            avatar.style.backgroundImage = '';
            avatar.textContent = (forumProfile.name || '用户').charAt(0);
        }
    }
    
    // 清空输入框
    input.value = '';
    
    // 设置发送按钮点击事件
    sendBtn.onclick = function() {
        submitForumComment(postId, null); // 评论帖子，commentId为null
    };
    
    // 显示弹窗
    console.log('Modal element:', modal);
    modal.classList.add('show');
    console.log('Modal classes after adding show:', modal.className);
    
    // 聚焦输入框
    setTimeout(() => {
        input.focus();
    }, 100);
}

// 显示回复输入框
function showReplyInput(postId, commentId, replyToUser) {
    console.log('showReplyInput called with postId:', postId, 'commentId:', commentId, 'replyToUser:', replyToUser);
    playClickSound();
    
    // 检查必要元素是否存在
    const modal = document.getElementById('forumInputModal');
    const avatar = document.getElementById('forumInputModalAvatar');
    const input = document.getElementById('forumInputModalInput');
    const sendBtn = document.getElementById('forumInputModalSendBtn');
    
    if (!modal) {
        console.error('forumInputModal not found!');
        return;
    }
    if (!avatar) {
        console.error('forumInputModalAvatar not found!');
        return;
    }
    if (!input) {
        console.error('forumInputModalInput not found!');
        return;
    }
    if (!sendBtn) {
        console.error('forumInputModalSendBtn not found!');
        return;
    }
    
    // 设置用户头像
    if (avatar) {
        if (forumProfile.avatar) {
            avatar.style.backgroundImage = `url('${forumProfile.avatar}')`;
            avatar.textContent = '';
        } else {
            avatar.style.backgroundImage = '';
            avatar.textContent = (forumProfile.name || '用户').charAt(0);
        }
    }
    
    // 设置输入框内容，自动@用户
    input.value = `@${replyToUser} `;
    
    // 设置发送按钮点击事件
    sendBtn.onclick = function() {
        submitReply(postId, commentId, input.value.trim());
    };
    
    // 显示弹窗
    console.log('Modal element:', modal);
    modal.classList.add('show');
    console.log('Modal classes after adding show:', modal.className);
    
    // 聚焦输入框并移动光标到末尾
    setTimeout(() => {
        input.focus();
        input.setSelectionRange(input.value.length, input.value.length);
    }, 100);
}

// 关闭输入框弹窗
function closeForumInputModal() {
    playClickSound();
    document.getElementById('forumInputModal').classList.remove('show');
}

// 点击空白处关闭输入框和转发弹窗
document.addEventListener('click', function(event) {
    // 关闭输入框弹窗
    const inputModal = document.getElementById('forumInputModal');
    const inputModalContent = inputModal.querySelector('.forum-input-modal-content');
    
    if (inputModal.classList.contains('show') && !inputModalContent.contains(event.target)) {
        // 检查是否点击的是评论相关的元素，如果是则不关闭
        const isCommentClick = event.target.closest('.forum-comment-item') || 
                              event.target.closest('.forum-comment-reply') ||
                              event.target.closest('.forum-detail-stat-item');
        
        if (!isCommentClick) {
            closeForumInputModal();
        }
    }
    
    // 关闭转发弹窗
    const forwardModal = document.getElementById('forumForwardModal');
    const forwardModalContent = forwardModal.querySelector('.forum-forward-content');
    
    if (forwardModal.classList.contains('show') && !forwardModalContent.contains(event.target)) {
        closeForumForwardModal();
    }
    
});

// 提交评论
async function submitComment(postId) {
    const input = document.getElementById('forumInputModalInput');
    const content = input.value.trim();
    
    if (!content) {
        alert('请输入评论内容！');
        return;
    }
    
    // 先尝试从普通帖子中查找
    let post = forumPosts.find(p => p.id === postId);
    let isAIPost = false;
    
    // 如果没找到，尝试从AI帖子中查找
    if (!post) {
        const aiPosts = JSON.parse(localStorage.getItem('aiForumPosts') || '[]');
        post = aiPosts.find(p => p.id === postId);
        if (post) isAIPost = true;
    }
    
    if (!post) return;
    
    // 确保commentList存在
    if (!post.commentList) {
        post.commentList = [];
    }
    
    // 创建新评论
    const newComment = {
        id: Date.now(),
        author: forumProfile.name || '用户',
        avatar: forumProfile.avatar || 'https://files.catbox.moe/default-avatar.jpg',
        content: content,
        time: '刚刚',
        likes: 0,
        replies: []
    };
    
    // 添加到评论列表
    post.commentList.push(newComment);
    post.comments = (post.comments || 0) + 1;
    
    // 如果是AI帖子，需要更新localStorage
    if (isAIPost) {
        const aiPosts = JSON.parse(localStorage.getItem('aiForumPosts') || '[]');
        const index = aiPosts.findIndex(p => p.id === postId);
        if (index !== -1) {
            aiPosts[index] = post;
            localStorage.setItem('aiForumPosts', JSON.stringify(aiPosts));
        }
    }
    
    // 关闭弹窗
    closeForumInputModal();
    
    // 重新渲染详情页面
    renderForumPostDetail(post);
    
    // 保存数据
    await saveForumData();
    
    // 播放点击音效
    playClickSound();
}

// 提交回复
async function submitReply(postId, commentId, content) {
    console.log('submitReply called with:', { postId, commentId, content });
    
    if (!content) {
        alert('请输入回复内容！');
        return;
    }
    
    // 先尝试从普通帖子中查找
    let post = forumPosts.find(p => p.id === postId);
    let isAIPost = false;
    
    // 如果没找到，尝试从AI帖子中查找
    if (!post) {
        const aiPosts = JSON.parse(localStorage.getItem('aiForumPosts') || '[]');
        post = aiPosts.find(p => p.id === postId);
        if (post) isAIPost = true;
    }
    
    if (!post) return;
    
    // 查找评论 - 先尝试commentList，再尝试commentsData
    let comment = null;
    if (post.commentList) {
        comment = post.commentList.find(c => c.id == commentId || c.id === commentId);
    }
    if (!comment && post.commentsData) {
        comment = post.commentsData.find(c => c.id == commentId || c.id === commentId);
    }
    
    if (!comment) {
        console.error('未找到评论:', commentId);
        return;
    }
    
    // 确保replies存在
    if (!comment.replies) {
        comment.replies = [];
    }
    
    // 创建新回复
    const newReply = {
        id: Date.now(),
        author: forumProfile.name || '用户',
        avatar: forumProfile.avatar || 'https://files.catbox.moe/default-avatar.jpg',
        content: content,
        time: '刚刚',
        likes: 0
    };
    
    // 添加到回复列表
    comment.replies.push(newReply);
    
    // 如果是AI帖子，需要更新localStorage
    if (isAIPost) {
        const aiPosts = JSON.parse(localStorage.getItem('aiForumPosts') || '[]');
        const index = aiPosts.findIndex(p => p.id === postId);
        if (index !== -1) {
            aiPosts[index] = post;
            localStorage.setItem('aiForumPosts', JSON.stringify(aiPosts));
        }
    }
    
    // 保存数据到IndexedDB
    await saveForumData();
    
    // 关闭弹窗
    closeForumInputModal();
    
    // 重新渲染详情页面
    renderForumPostDetail(post);
    
    // 展开当前评论的楼中楼
    setTimeout(() => {
        const toggle = document.querySelector(`[onclick*="toggleReplies('${postId}', '${commentId}')"]`);
        if (toggle) {
            const replyList = toggle.nextElementSibling;
            const toggleText = toggle.querySelector('.forum-reply-toggle-text');
            const toggleIcon = toggle.querySelector('.forum-reply-toggle-icon');
            
            replyList.style.display = 'block';
            toggleText.textContent = '收起回复';
            toggleIcon.textContent = '▲';
        }
    }, 100);
    
    // 触发AI自动回复（如果启用）
    if (forumSettings && forumSettings.enableAIReplies !== false) {
        setTimeout(() => {
            generateAIReplies(postId, commentId, content, post);
        }, 2000); // 2秒后生成AI回复
    }
    
    // 播放点击音效
    playClickSound();
}

// 通用提交函数
async function submitForumInput() {
    console.log('submitForumInput called');
    const input = document.getElementById('forumInputModalInput');
    const content = input.value.trim();
    
    if (!content) {
        alert('请输入内容！');
        return;
    }
    
    console.log('Content to submit:', content);
    
    // 获取当前发送按钮的点击事件
    const sendBtn = document.getElementById('forumInputModalSendBtn');
    console.log('Send button:', sendBtn);
    console.log('Send button onclick:', sendBtn ? sendBtn.onclick : 'null');
    
    if (sendBtn && sendBtn.onclick) {
        console.log('Calling sendBtn.onclick()');
        sendBtn.onclick();
    } else {
        console.log('No onclick event found, trying fallback');
        // 如果没有设置onclick事件，尝试从全局变量获取当前postId
        if (typeof currentForumPostId !== 'undefined' && currentForumPostId) {
            console.log('Using currentForumPostId:', currentForumPostId);
            await submitForumComment(currentForumPostId);
        } else {
            console.error('无法确定要评论的帖子ID');
            alert('评论失败，请重试！');
        }
    }
}






// 删除论坛帖子
async function deleteForumPost(postId) {
    if (!confirm('确定要删除这个帖子吗？删除后无法恢复！')) {
        return;
    }
    
    playClickSound();
    
    // 先尝试从普通帖子中删除
    let postIndex = forumPosts.findIndex(p => p.id === postId);
    let isAIPost = false;
    
    if (postIndex !== -1) {
        // 从普通帖子中删除
        forumPosts.splice(postIndex, 1);
        console.log('✅ 已从普通帖子中删除');
    } else {
        // 尝试从AI帖子中删除
        const aiPosts = JSON.parse(localStorage.getItem('aiForumPosts') || '[]');
        const aiPostIndex = aiPosts.findIndex(p => p.id === postId);
        
        if (aiPostIndex !== -1) {
            aiPosts.splice(aiPostIndex, 1);
            localStorage.setItem('aiForumPosts', JSON.stringify(aiPosts));
            isAIPost = true;
            console.log('✅ 已从AI帖子中删除');
        } else {
            console.log('❌ 未找到要删除的帖子');
            alert('帖子不存在！');
            return;
        }
    }
    
    // 保存数据
    await saveForumData();
    
    // 重新渲染论坛首页
    renderForumHome();
    
    // 如果当前在详情页，返回首页
    const detailPage = document.getElementById('forumDetailPage');
    if (detailPage && detailPage.style.display !== 'none') {
        showForumHome();
    }
    
    console.log('✅ 帖子删除成功');
}

// 切换回复显示/隐藏
function toggleReplies(postId, commentId) {
    const toggle = event.target.closest('.forum-reply-toggle');
    const replyList = toggle.nextElementSibling;
    const toggleText = toggle.querySelector('.forum-reply-toggle-text');
    const toggleIcon = toggle.querySelector('.forum-reply-toggle-icon');
    
    if (replyList.style.display === 'none' || replyList.style.display === '') {
        // 展开回复
        replyList.style.display = 'block';
        toggleText.textContent = '收起回复';
        toggleIcon.textContent = '▲';
    } else {
        // 收起回复
        replyList.style.display = 'none';
        const replyCount = replyList.querySelectorAll('.forum-comment-reply').length;
        toggleText.textContent = `展开 ${replyCount} 条回复`;
        toggleIcon.textContent = '▼';
    }
    
    playClickSound();
}

// AI自动回复功能
async function generateAIReplies(postId, commentId, userContent, post) {
    console.log('generateAIReplies called:', { postId, commentId, userContent });
    
    try {
        // 判断是评论帖子还是回复评论
        const isReplyToComment = commentId !== null;
        
        if (isReplyToComment) {
            // 回复评论：只有楼主回复
            console.log('用户回复了评论，只有楼主会回复');
            await generateAuthorReply(postId, commentId, userContent, post);
        } else {
            // 评论帖子：只有楼主回复
            console.log('用户评论了帖子，只有楼主会回复');
            await generateAuthorReply(postId, null, userContent, post);
        }
    } catch (error) {
        console.error('AI回复生成失败:', error);
    }
}

// 生成楼主回复
async function generateAuthorReply(postId, commentId, userContent, post) {
    const authorName = post.author;
    const authorAvatar = post.avatar;
    const userForumName = forumProfile.name || '用户';
    
    // 使用AI生成智能回复
    const replyContent = await generateAICommentReply(userContent, authorName, post.content, userForumName);
    
    // 如果commentId为null，说明是直接评论帖子，需要找到用户的最新评论
    if (commentId === null) {
        // 直接评论帖子：找到用户的最新评论
        const userComment = post.commentList ? post.commentList[post.commentList.length - 1] : null;
        
        if (userComment) {
            if (!userComment.replies) {
                userComment.replies = [];
            }
            
            const aiReply = {
                id: Date.now() + Math.random(),
                author: authorName,
                avatar: authorAvatar,
                content: replyContent,
                time: '刚刚',
                likes: 0
            };
            
            userComment.replies.push(aiReply);
            
            // 更新数据
            await updatePostData(postId, post);
            
            // 重新渲染
            renderForumPostDetail(post);
            
            console.log('✅ 楼主回复已生成（直接评论帖子）');
        }
    } else {
        // 回复评论：找到对应的评论并添加回复
        let targetComment = null;
        if (post.commentList) {
            targetComment = post.commentList.find(c => c.id == commentId || c.id === commentId);
        }
        if (!targetComment && post.commentsData) {
            targetComment = post.commentsData.find(c => c.id == commentId || c.id === commentId);
        }
        
        if (targetComment) {
            if (!targetComment.replies) {
                targetComment.replies = [];
            }
            
            const aiReply = {
                id: Date.now() + Math.random(),
                author: authorName,
                avatar: authorAvatar,
                content: replyContent,
                time: '刚刚',
                likes: 0
            };
            
            targetComment.replies.push(aiReply);
            
            // 更新数据
            await updatePostData(postId, post);
            
            // 重新渲染
            renderForumPostDetail(post);
            
            console.log('✅ 楼主回复已生成（回复评论）');
        }
    }
}

// 生成随机陌生人回复
async function generateRandomReplies(postId, userContent, post) {
    const replyCount = Math.floor(Math.random() * 2) + 1; // 1-2个回复，减少数量
    
    for (let i = 0; i < replyCount; i++) {
        setTimeout(async () => {
            const userForumName = forumProfile.name || '用户';
            
            // 使用AI生成智能回复，回复者使用楼主名字
            const replyContent = await generateAICommentReply(userContent, post.author, post.content, userForumName);
            
            // 找到用户的最新评论
            const userComment = post.commentList ? post.commentList[post.commentList.length - 1] : null;
            
            if (userComment) {
                if (!userComment.replies) {
                    userComment.replies = [];
                }
                
                const aiReply = {
                    id: Date.now() + Math.random() + i,
                    author: post.author, // 使用楼主名字
                    avatar: post.avatar, // 使用楼主头像
                    content: replyContent,
                    time: '刚刚',
                    likes: 0
                };
                
                userComment.replies.push(aiReply);
                
                // 更新数据
                await updatePostData(postId, post);
                
                // 重新渲染
                renderForumPostDetail(post);
                
                console.log(`✅ 陌生人回复已生成: ${randomUser.name}`);
            }
        }, (i + 1) * 1000); // 每个回复间隔1秒
    }
}

// 生成随机用户
function generateRandomUser() {
    const names = ['路人甲', '吃瓜群众', '热心网友', '匿名用户', '围观群众', '路人乙', '网友A', '吃瓜路人'];
    const avatars = [
        'https://files.catbox.moe/avatar1.jpg',
        'https://files.catbox.moe/avatar2.jpg',
        'https://files.catbox.moe/avatar3.jpg'
    ];
    
    return {
        name: names[Math.floor(Math.random() * names.length)],
        avatar: avatars[Math.floor(Math.random() * avatars.length)]
    };
}

// 生成简单回复（不调用AI API）
function generateSimpleReply(userContent, replierName, targetUserName) {
    const targetName = targetUserName || '用户';
    
    // 根据评论内容生成更相关的回复
    if (userContent.includes('好') || userContent.includes('棒') || userContent.includes('赞') || userContent.includes('不错')) {
        const positiveReplies = [
            `@${targetName} 我也觉得很好！`,
            `@${targetName} 确实很棒`,
            `@${targetName} 我也很喜欢`,
            `@${targetName} 太赞了`,
            `@${targetName} 完全同意`
        ];
        return positiveReplies[Math.floor(Math.random() * positiveReplies.length)];
    }
    
    if (userContent.includes('不') || userContent.includes('难') || userContent.includes('累') || userContent.includes('不行')) {
        const supportiveReplies = [
            `@${targetName} 我理解你的感受`,
            `@${targetName} 确实不容易`,
            `@${targetName} 我也遇到过这种情况`,
            `@${targetName} 加油！`,
            `@${targetName} 慢慢来，会好的`
        ];
        return supportiveReplies[Math.floor(Math.random() * supportiveReplies.length)];
    }
    
    if (userContent.includes('搞笑') || userContent.includes('笑') || userContent.includes('幽默')) {
        const funnyReplies = [
            `@${targetName} 哈哈确实很搞笑`,
            `@${targetName} 我也觉得很好笑`,
            `@${targetName} 太幽默了`,
            `@${targetName} 笑死我了`
        ];
        return funnyReplies[Math.floor(Math.random() * funnyReplies.length)];
    }
    
    if (userContent.includes('公司') || userContent.includes('工作') || userContent.includes('职场')) {
        const workReplies = [
            `@${targetName} 职场确实不容易`,
            `@${targetName} 我也深有体会`,
            `@${targetName} 工作压力确实大`,
            `@${targetName} 加油，会好的`
        ];
        return workReplies[Math.floor(Math.random() * workReplies.length)];
    }
    
    if (userContent.includes('什么') || userContent.includes('啥') || userContent.includes('？') || userContent.includes('?')) {
        const questionReplies = [
            `@${targetName} 我来解释一下`,
            `@${targetName} 就是那个意思`,
            `@${targetName} 我理解你的疑问`,
            `@${targetName} 让我想想怎么解释`
        ];
        return questionReplies[Math.floor(Math.random() * questionReplies.length)];
    }
    
    // 默认通用回复
    const generalReplies = [
        `@${targetName} 我也这么觉得`,
        `@${targetName} 说得很有道理`,
        `@${targetName} 确实如此`,
        `@${targetName} 很有同感`,
        `@${targetName} 我也这么想`
    ];
    return generalReplies[Math.floor(Math.random() * generalReplies.length)];
}

// 更新帖子数据
async function updatePostData(postId, post) {
    // 先尝试从普通帖子中更新
    let postIndex = forumPosts.findIndex(p => p.id === postId);
    let isAIPost = false;
    
    if (postIndex !== -1) {
        forumPosts[postIndex] = post;
    } else {
        // 尝试从AI帖子中更新
        const aiPosts = JSON.parse(localStorage.getItem('aiForumPosts') || '[]');
        const aiIndex = aiPosts.findIndex(p => p.id === postId);
        if (aiIndex !== -1) {
            aiPosts[aiIndex] = post;
            localStorage.setItem('aiForumPosts', JSON.stringify(aiPosts));
            isAIPost = true;
        }
    }
    
    // 保存到IndexedDB
    await saveForumData();
}

// 模拟回复功能 - 当用户发布新帖子时自动生成模拟回复
async function generateSimulatedReplies(postId) {
    const post = forumPosts.find(p => p.id === postId);
    if (!post) return;
    
    // 模拟用户数据
    const simulatedUsers = [
        { name: "热心网友", avatar: "https://files.catbox.moe/sim1.jpg" },
        { name: "论坛老用户", avatar: "https://files.catbox.moe/sim2.jpg" },
        { name: "路过群众", avatar: "https://files.catbox.moe/sim3.jpg" },
        { name: "资深潜水员", avatar: "https://files.catbox.moe/sim4.jpg" },
        { name: "新手上路", avatar: "https://files.catbox.moe/sim5.jpg" }
    ];
    
    // 模拟回复内容
    const replyTemplates = [
        "说得很有道理！",
        "我也遇到过类似的情况",
        "感谢分享，学到了",
        "这个观点不错",
        "深有同感",
        "支持楼主",
        "学到了新知识",
        "很有用的信息",
        "谢谢分享经验",
        "期待更多内容"
    ];
    
    // 确保commentList存在
    if (!post.commentList) {
        post.commentList = [];
    }
    
    // 随机生成2-4条回复
    const replyCount = Math.floor(Math.random() * 3) + 2;
    
    for (let i = 0; i < replyCount; i++) {
        const user = simulatedUsers[Math.floor(Math.random() * simulatedUsers.length)];
        const content = replyTemplates[Math.floor(Math.random() * replyTemplates.length)];
        
        const simulatedComment = {
            id: Date.now() + i,
            author: user.name,
            avatar: user.avatar,
            content: content,
            time: `${i + 1}分钟前`,
            likes: Math.floor(Math.random() * 5),
            replies: []
        };
        
        post.commentList.push(simulatedComment);
    }
    
    // 更新评论数量
    post.comments = (post.comments || 0) + replyCount;
    
    // 保存数据
}


// 动态页面功能
function openMomentApp() {
    playClickSound();
    const momentApp = document.getElementById('momentApp');
    momentApp.style.display = 'flex';
    switchMomentPage('home'); // 默认显示动态页面
}

function closeMomentApp() {
    playClickSound();
    const momentApp = document.getElementById('momentApp');
    momentApp.style.display = 'none';
}

// 切换动态页面内容
function switchMomentPage(page) {
    playClickSound();
    
    const momentPage = document.getElementById('momentPage');
    const profilePage = document.getElementById('profilePage');
    const momentPageTitle = document.getElementById('momentPageTitle');
    const homeBtn = document.getElementById('moment-nav-home-btn');
    const profileBtn = document.getElementById('moment-nav-profile-btn');
    
    if (page === 'home') {
        // 显示动态页面
        momentPage.style.display = 'block';
        profilePage.style.display = 'none';
        momentPageTitle.textContent = '动态';
        
        // 更新导航按钮状态
        homeBtn.classList.add('active');
        profileBtn.classList.remove('active');
        
        // 渲染动态内容
        renderMomentTimeline();
    } else if (page === 'profile') {
        // 显示个人主页
        momentPage.style.display = 'none';
        profilePage.style.display = 'block';
        momentPageTitle.textContent = '个人主页';
        
        // 更新导航按钮状态
        homeBtn.classList.remove('active');
        profileBtn.classList.add('active');
        
        // 渲染个人主页内容
        renderProfileTimeline();
    }
}

// 背景图片池
const backgroundImages = [
    'https://img.wjwj.top/2025/09/20/c79dad0096c2a31251bb902937bc43a0.md.jpeg',
    'https://img.wjwj.top/2025/09/20/b1044b1c2e905c330221bbbeacc01957.md.jpeg',
    'https://img.wjwj.top/2025/09/20/98a5930ce3f395d114a7f85e6c024cf6.md.jpeg',
    'https://img.wjwj.top/2025/09/20/af4941e4c72905dcb2cba3aa82fac095.md.jpeg',
    'https://img.wjwj.top/2025/09/20/ea7d55a780d9fbdba22daa74748a5a60.md.jpeg',
    'https://img.wjwj.top/2025/09/20/eca46641ccd93b8dd7c4d51b84dbfe2b.md.jpeg',
    'https://img.wjwj.top/2025/09/20/172e684ef05b86970a5296fcd0c52af5.md.jpeg',
    'https://img.wjwj.top/2025/09/20/f7bd58cedc93acbd6aa494f0d52dfd78.md.jpeg',
    'https://img.wjwj.top/2025/09/20/95d7aad7ac39673f623db41cfa778362.md.jpeg',
    'https://img.wjwj.top/2025/09/20/5161b97a59edae631ef3357fb712dcdc.md.jpeg',
    'https://img.wjwj.top/2025/09/20/912a2b17970ac6f8c50b3320cef8a305.md.jpeg',
    'https://img.wjwj.top/2025/09/20/de3daed188f680c0409842c5d41245cf.md.jpeg',
    'https://img.wjwj.top/2025/09/20/46ba0d49665e543804251cd0c80f3bf2.md.jpeg',
    'https://img.wjwj.top/2025/09/20/b23bd89f24f84e1abb1aa5548dd1c70f.md.jpeg',
    'https://img.wjwj.top/2025/09/20/17565c98c9693c56b25bd7461e98bf63.md.png',
    'https://img.wjwj.top/2025/09/20/f3d6d56ce9560a8aa7517d3a301d707d.md.jpg',
    'https://img.wjwj.top/2025/09/20/95aebff98bff0ceaf9f6ee30c6b81b68.md.jpg',
    'https://img.wjwj.top/2025/09/20/840470043e498b2c2e4847f377318341.md.jpg',
    'https://img.wjwj.top/2025/09/20/61f07c146262ab82dad6a1d46fbba435.md.png',
    'https://img.wjwj.top/2025/09/20/ef653a1f9ac2a3e7689c68f06649ef26.md.jpg',
    'https://img.wjwj.top/2025/09/20/0504d1f18b923eedebf3f43c8e13d1a6.md.jpg',
    'https://img.wjwj.top/2025/09/20/9f0e3713a5243f93ec25920bdb105393.md.jpeg',
    'https://img.wjwj.top/2025/09/20/dab3b3bd421aa4f9c70a16a88a16113d.md.jpeg',
    'https://img.wjwj.top/2025/09/20/de50636930b9ab33fbd085df44816f7d.md.jpeg',
    'https://img.wjwj.top/2025/09/20/b6771b6b291069550b2a8974021380e6.md.jpeg',
    'https://img.wjwj.top/2025/09/20/b896a58e41590c942a8a564dca615b3d.md.jpeg',
    'https://img.wjwj.top/2025/09/20/7c5cf7497e1f7716425b670238e8b564.md.jpeg',
    'https://img.wjwj.top/2025/09/20/5a820c723cca1413c28a6fd2b402e475.md.jpeg',
    'https://img.wjwj.top/2025/09/20/938ee29f9eca8818253b44801fe8473c.md.jpeg',
    'https://img.wjwj.top/2025/09/20/c923c0602d5893948b5dcab392e2e195.md.jpeg',
    'https://img.wjwj.top/2025/09/20/2e88422d8eac2fe69f72b8d06dc0cf9d.md.jpeg',
    'https://img.wjwj.top/2025/09/20/eece3302d2c86512f096ffcd61b7618d.md.jpeg',
    'https://img.wjwj.top/2025/09/20/5d86b06a04fe296405369b189fd58e69.md.jpeg',
    'https://img.wjwj.top/2025/09/20/10eeecfda9479e298df8e24b6cee21bc.md.jpeg',
    'https://img.wjwj.top/2025/09/20/676b47dd6983100aeb0df67d8957b296.md.jpeg',
    'https://img.wjwj.top/2025/09/20/33d809942ee846a9da8128242e843d86.md.jpeg',
    'https://img.wjwj.top/2025/09/20/2ba5a1fe00579149bca88a3eb151e8f8.md.jpeg',
    'https://img.wjwj.top/2025/09/20/4dcce95b587e06905c43ddae611b610a.md.jpeg',
    'https://img.wjwj.top/2025/09/20/ab838c8200f3db03d541388969d87d0c.md.jpeg',
    'https://img.wjwj.top/2025/09/20/e8da41f958b12b0402214797cf3f4d7f.md.jpeg',
    'https://img.wjwj.top/2025/09/20/66f1e6beeed44d938d6cfe5fc58d2789.md.jpg',
    'https://img.wjwj.top/2025/09/20/06b549f5fd8f95275e91cd1b2abf03c2.md.jpg',
    'https://img.wjwj.top/2025/09/20/031bd78025b4b803ce48ef32f2f415a6.md.jpg',
    'https://img.wjwj.top/2025/09/20/5685254b3c2ae1f88e711a1f54daf98b.md.jpeg',
    'https://img.wjwj.top/2025/09/20/1138a612f59468680dae991b03d08b55.md.jpeg',
    'https://img.wjwj.top/2025/09/20/9e02e72edb5a218d6fcc146e10125a98.md.gif',
    'https://img.wjwj.top/2025/09/20/412db762d5a53288e11d7ddc15a75fea.md.jpg',
    'https://img.wjwj.top/2025/09/20/f3d1e84a036a64d8854f7d59dcdb4380.md.jpg',
    'https://img.wjwj.top/2025/09/20/191389d77cc33b82ffde129e09661cfa.md.jpg',
    'https://img.wjwj.top/2025/09/20/77483cb06fbd839d5575c694a84e0c42.md.jpg',
    'https://img.wjwj.top/2025/09/20/52b153768120cc3cca048714a89f3810.md.jpeg',
    'https://img.wjwj.top/2025/09/20/08647ccd11c0e35c02647f9741e72021.md.jpg',
    'https://img.wjwj.top/2025/09/20/7376ef34d2044810cc4904cdfb6e343c.md.jpg',
    'https://img.wjwj.top/2025/09/20/2a4443aac2e3762566e668331e20c7f6.md.jpg',
    'https://img.wjwj.top/2025/09/20/7a217da940ba79d1e2764076111d91dd.md.jpg',
    'https://img.wjwj.top/2025/09/20/26b5eec32e35a495b8ec44a5bc87e77b.md.jpg',
    'https://img.wjwj.top/2025/09/20/cb493060306e253811f79ebeb5d23790.md.jpg',
    'https://img.wjwj.top/2025/09/20/bc5b814d2e35dc6e56e016a9e8107448.md.png',
    'https://img.wjwj.top/2025/09/20/ad8b3eb78534bf55da025c5c28e51889.md.jpg',
    'https://img.wjwj.top/2025/09/20/7a913fb7f09cf6760b46c2dd3b547fe6.md.png',
    'https://img.wjwj.top/2025/09/20/917479be6301660b739eb00b851b43f8.md.png'
];

// 动态数据（已清空预设内容）
const momentPosts = [];

// 定时更换背景图片（每10分钟）
setInterval(() => {
    momentPosts.forEach(post => {
        // 随机选择一个新的背景图片
        const randomIndex = Math.floor(Math.random() * backgroundImages.length);
        post.background = backgroundImages[randomIndex];
    });
    console.log('背景图片已随机更换');
}, 10 * 60 * 1000); // 10分钟

// 根据联系人的人设分析发动态频率
function getContactFrequency(contactName, persona) {
    if (!persona) {
        return 0.1; // 默认10%概率
    }
    
    const personaText = persona.toLowerCase();
    
    // 根据人设关键词判断活跃度
    if (personaText.includes('活泼') || personaText.includes('开朗') || personaText.includes('活跃') || 
        personaText.includes('喜欢分享') || personaText.includes('话多') || personaText.includes('外向')) {
        return 0.3; // 30%概率，比较活跃
    } else if (personaText.includes('内向') || personaText.includes('安静') || personaText.includes('沉默') || 
               personaText.includes('不爱说话') || personaText.includes('害羞')) {
        return 0.1; // 10%概率，比较内向
    } else if (personaText.includes('冷淡') || personaText.includes('高冷') || personaText.includes('不爱分享') || 
               personaText.includes('孤僻') || personaText.includes('冷漠')) {
        return 0.05; // 5%概率，很冷淡
    } else {
        return 0.2; // 20%概率，中等活跃
    }
}

// 根据聊天内容计算触发加成
function calculateChatTrigger(chatContent) {
    if (!chatContent) return 0;
    
    const content = chatContent.toLowerCase();
    let trigger = 0;
    
    // 高触发概率的关键词
    const highTriggerWords = [
        '想你了', '想念', '好久不见', '开心', '高兴', '太棒了', '难过', '伤心', '委屈',
        '累了', '压力大', '好烦', '加油', '努力', '坚持', '美食', '吃饭', '好吃',
        '工作', '学习', '考试', '天气', '下雨', '晴天', '朋友', '聚会', '一起',
        '电影', '音乐', '书', '旅行', '回忆', '时光'
    ];
    
    // 低触发概率的关键词
    const lowTriggerWords = [
        '你好', '在吗', '拜拜', '嗯', '好的', '知道了', '谢谢', '不客气'
    ];
    
    // 检查高触发词
    for (const word of highTriggerWords) {
        if (content.includes(word)) {
            trigger += 0.3; // 每个高触发词增加30%概率
            break; // 只取第一个匹配的词
        }
    }
    
    // 检查低触发词
    for (const word of lowTriggerWords) {
        if (content.includes(word)) {
            trigger -= 0.1; // 每个低触发词减少10%概率
            break;
        }
    }
    
    return Math.max(0, Math.min(trigger, 0.5)); // 限制在0-50%之间
}

// AI发动态功能（聊天触发版）
async function aiPublishMomentFromChat(friendName, chatContent, friendPersona = '') {
    // 根据联系人的人设决定基础发动态频率
    const baseFrequency = getContactFrequency(friendName, friendPersona);
    
    // 根据聊天内容计算触发加成
    const chatTrigger = calculateChatTrigger(chatContent);
    
    // 最终概率 = 基础频率 + 聊天触发加成（最高不超过0.8）
    const finalFrequency = Math.min(baseFrequency + chatTrigger, 0.8);
    const shouldPublish = Math.random() < finalFrequency;
    
    if (!shouldPublish) {
        console.log(`${friendName}这次不发动态（概率：${(finalFrequency * 100).toFixed(1)}%）`);
        return null;
    }
    
    // 根据聊天内容生成相关动态
    const momentContent = generateMomentFromChat(chatContent, friendPersona);
    
    // 只有当有动态内容时才创建动态
    if (!momentContent) {
        console.log(`${friendName}这次不发动态（没有生成内容）`);
        return null;
    }
    
    try {
        // 创建新动态
        const newMoment = {
            id: momentPosts.length + 1,
            name: friendName,
            username: '@' + friendName.replace(/\s+/g, '_'),
            avatar: getCharacterAvatar(friendName),
            background: backgroundImages[Math.floor(Math.random() * backgroundImages.length)],
            bio: generateBioFromChat(chatContent, friendPersona),
            content: momentContent,
            image: null,
            time: '刚刚',
            likes: 0,
            shares: 0,
            comments: 0,
            liked: false,
            commentList: [],
            world: '现代' // 默认世界观
        };
        
        // 添加到动态列表
        momentPosts.unshift(newMoment);
        
        // 重置分页到第一页
        resetMomentPagination();
        
        // 保存动态数据
        await saveMomentData();
        
        // 重新渲染动态时间线
        renderMomentTimeline();
        
        console.log(`AI为${friendName}发布了新动态：${momentContent}`);
        return newMoment;
    } catch (error) {
        console.error('AI发布动态失败:', error);
        return null;
    }
}

// 根据聊天内容生成动态内容 - 让AI用自己的话表达心情
function generateMomentFromChat(chatContent, persona) {
    if (!chatContent) return null;
    
    const content = chatContent.toLowerCase();
    
    // 根据聊天内容和人设，生成AI想表达的心情和想说的话（一次只分享一件事情）
    const moodTemplates = {
        // 思念和想念
        missing: [
            "突然有点想你了...",
            "刚才和你聊天，想起了美好的回忆",
            "看到[话题]就想到你了",
            "想起你刚才说的话，心里暖暖的",
            "和你聊天后，突然很想你"
        ],
        
        // 开心和快乐
        happy: [
            "刚才和你聊天，心情特别好！",
            "因为你的话，今天心情很好",
            "和你聊到[话题]，突然觉得生活很美好",
            "刚才的对话让我很开心",
            "因为你的陪伴，今天过得很开心"
        ],
        
        // 关心和担心
        caring: [
            "刚才你提到[话题]，有点担心你",
            "希望你能看到这条动态，一切都会好的",
            "看到你这么努力，我也要加油",
            "想给你发点正能量",
            "刚才的对话让我想关心你一下"
        ],
        
        // 感悟和思考
        thoughtful: [
            "和你聊到[话题]，突然想到了一些事情",
            "因为你的话，突然想分享一些想法",
            "刚才的对话让我想到了一些感悟",
            "和你讨论[话题]后，突然想记录一下",
            "因为你的话，突然想分享一些感受"
        ],
        
        // 日常和生活
        daily: [
            "刚才和你聊天，突然想分享今天的感受",
            "和你聊到[话题]，觉得很有意思",
            "刚才的对话让我想到了一些事情",
            "和你聊天后，突然想记录一下今天",
            "因为你的话，突然想分享一些日常"
        ],
        
        // 感谢和珍惜
        grateful: [
            "谢谢你刚才和我聊天，心情好多了",
            "因为你的陪伴，今天过得很充实",
            "和你聊天总是很开心，谢谢你",
            "刚才的对话让我很感动，想谢谢你",
            "因为你的话，突然觉得很幸福"
        ]
    };
    
    // 根据聊天内容的情感色彩选择心情类型
    let moodType = 'daily'; // 默认
    
    if (content.includes('想你了') || content.includes('想念') || content.includes('好久不见')) {
        moodType = 'missing';
    } else if (content.includes('开心') || content.includes('高兴') || content.includes('太棒了') || 
               content.includes('谢谢') || content.includes('感谢')) {
        moodType = content.includes('谢谢') || content.includes('感谢') ? 'grateful' : 'happy';
    } else if (content.includes('难过') || content.includes('伤心') || content.includes('委屈') || 
               content.includes('累了') || content.includes('压力大') || content.includes('好烦')) {
        moodType = 'caring';
    } else if (content.includes('觉得') || content.includes('想到') || content.includes('感悟') || 
               content.includes('思考') || content.includes('想法')) {
        moodType = 'thoughtful';
    }
    
    // 随机选择一个心情表达
    const templates = moodTemplates[moodType];
    const selectedTemplate = templates[Math.floor(Math.random() * templates.length)];
    
    // 替换[话题]占位符
    let finalContent = selectedTemplate;
    if (finalContent.includes('[话题]')) {
        // 从聊天内容中提取关键词作为话题
        const topicKeywords = ['美食', '工作', '学习', '天气', '朋友', '电影', '音乐', '书', '旅行', '生活', '心情'];
        const foundTopic = topicKeywords.find(keyword => content.includes(keyword));
        finalContent = finalContent.replace('[话题]', foundTopic || '刚才聊到的事情');
    }
    
    // 添加@好友功能
    finalContent = addMentionsToMoment(finalContent, persona, chatContent);
    
    return finalContent;
}

// 为动态添加@好友功能
function addMentionsToMoment(content, persona, chatContent) {
    if (!persona) return content;
    
    const mentions = [];
    
    // 从人设中提取朋友名字
    const personaText = persona.toLowerCase();
    const friendKeywords = ['朋友', '好友', '同学', '同事', '室友', '闺蜜', '兄弟', '伙伴'];
    
    // 检查人设中是否提到朋友
    for (const keyword of friendKeywords) {
        if (personaText.includes(keyword)) {
            // 从人设中提取可能的朋友名字（简单提取）
            const friendNames = extractFriendNamesFromPersona(persona);
            if (friendNames.length > 0) {
                mentions.push(...friendNames);
            }
            break;
        }
    }
    
    // 从聊天内容中提取提到的朋友
    const chatMentions = extractMentionsFromChat(chatContent);
    mentions.push(...chatMentions);
    
    // 添加@主摄（用户）的概率
    if (Math.random() < 0.3) { // 30%概率@主摄
        const mainCharacterName = getMainCharacterName();
        if (mainCharacterName) {
            mentions.push(mainCharacterName);
        }
    }
    
    // 去重并添加到内容中
    const uniqueMentions = [...new Set(mentions)];
    if (uniqueMentions.length > 0) {
        const mentionText = uniqueMentions.map(name => `@${name}`).join(' ');
        content += ` ${mentionText}`;
    }
    
    return content;
}

// 从人设中提取朋友名字（简单实现）
function extractFriendNamesFromPersona(persona) {
    const names = [];
    // 这里可以根据实际情况扩展，提取人设中提到的朋友名字
    // 暂时返回一些常见的名字作为示例
    const commonNames = ['小明', '小红', '小李', '小王', '小张', '小陈', '小刘', '小周'];
    
    // 随机选择1-2个名字
    const count = Math.floor(Math.random() * 2) + 1;
    for (let i = 0; i < count && i < commonNames.length; i++) {
        names.push(commonNames[Math.floor(Math.random() * commonNames.length)]);
    }
    
    return names;
}

// 从聊天内容中提取@的人
function extractMentionsFromChat(chatContent) {
    const mentions = [];
    // 简单的@提取，可以扩展
    const mentionRegex = /@(\w+)/g;
    let match;
    while ((match = mentionRegex.exec(chatContent)) !== null) {
        mentions.push(match[1]);
    }
    return mentions;
}

// 获取主摄名字
function getMainCharacterName() {
    // 优先从个人主页获取名字
    const profileName = document.getElementById('profileName')?.textContent?.trim();
    if (profileName && profileName !== '桜酱') {
        return profileName;
    }
    
    // 从localStorage获取保存的名字
    const savedName = localStorage.getItem('profileName');
    if (savedName && savedName !== '桜酱') {
        return savedName;
    }
    
    // 默认返回用户名
    return getCurrentUserName();
}

// 根据聊天内容生成个性签名
function generateBioFromChat(chatContent, persona) {
    // 预设个性签名已清空，当AI不可用时不会生成签名
    return null;
}

// 获取角色头像
function getCharacterAvatar(characterName) {
    // 首先尝试从联系人列表中获取头像
    const contact = currentMessages.find(msg => 
        !msg.isGroup && msg.name === characterName
    );
    
    if (contact && contact.avatar) {
        return contact.avatar;
    }
    
    // 如果没有找到，使用预设头像
    const avatars = {
        '小樱': 'https://files.catbox.moe/r5s188.jpg',
        '明光': 'https://files.catbox.moe/q91f3g.jpg',
        '小希': 'https://files.catbox.moe/tw2ygf.jpg',
        '靳柯璟': 'https://files.catbox.moe/r5s188.jpg',
        '杨晶晶': 'https://files.catbox.moe/q91f3g.jpg',
        '艾利欧特': 'https://files.catbox.moe/tw2ygf.jpg',
        '艾利': 'https://files.catbox.moe/tw2ygf.jpg'
    };
    
    return avatars[characterName] || 'https://files.catbox.moe/r5s188.jpg';
}

// 已删除自动评论功能 - 现在只保留用户主动互动时的AI回复

// AI点赞动态
function aiLikePost(postIndex, friends) {
    const post = momentPosts[postIndex];
    if (!post || post.liked) return; // 已经点赞过的不再点赞
    
    // 从好友列表中随机选择一个来点赞
    const randomFriend = friends[Math.floor(Math.random() * friends.length)];
    const randomCharacter = randomFriend.name;
    
    post.liked = true;
    post.likes++;
    
    // 添加到点赞列表
    if (!post.likeList) {
        post.likeList = [];
    }
    if (!post.likeList.includes(randomCharacter)) {
        post.likeList.push(randomCharacter);
    }
    
    // 更新显示
    updateLikeDisplay(postIndex);
    
    // 保存动态数据（包括新点赞）
    saveMomentData();
    
    console.log(`${randomCharacter}点赞了${post.name}的动态`);
}

// AI评论动态（使用指定好友）
async function aiCommentPostWithFriend(postIndex, friend) {
    const post = momentPosts[postIndex];
    if (!post) return;
    
    const randomCharacter = friend.name;
    
    // 获取AI角色的人设
    const contact = currentMessages.find(msg => msg.name === randomCharacter && !msg.isGroup);
    let persona = '';
    if (contact) {
        const contactKey = `contact_${contact.id}`;
        const savedContact = await AppStorage.getItem(contactKey);
        if (savedContact) {
            const contactData = JSON.parse(savedContact);
            persona = contactData.persona || '';
        }
    }
    
    // 调用AI生成评论内容
    const commentText = await generateAIComment(post.content, randomCharacter, persona);
    
    // 只有当有评论内容时才添加评论
    if (commentText) {
    // 添加评论
    if (!post.commentList) {
        post.commentList = [];
    }
    
    post.commentList.push({
        author: randomCharacter,
        avatar: getCharacterAvatar(randomCharacter),
        text: commentText,
        time: '刚刚'
    });
    
    post.comments++;
    }
    
    // 更新显示
    const commentCount = document.querySelector(`[data-post-id="${postIndex}"] .comment-count`);
    if (commentCount) {
        commentCount.textContent = post.comments;
    }
    
    // 重新渲染动态时间线以显示新评论
    renderMomentTimeline();
    
    // 保存动态数据（包括新评论）
    await saveMomentData();
    
    console.log(`${randomCharacter}评论了${post.name}的动态：${commentText}`);
}

// AI评论动态（随机选择好友）
async function aiCommentPost(postIndex, friends) {
    const post = momentPosts[postIndex];
    if (!post) return;
    
    // 从好友列表中随机选择一个来评论
    const randomFriend = friends[Math.floor(Math.random() * friends.length)];
    const randomCharacter = randomFriend.name;
    
    // 获取AI角色的人设
    const contact = currentMessages.find(msg => msg.name === randomCharacter && !msg.isGroup);
    let persona = '';
    if (contact) {
        const contactKey = `contact_${contact.id}`;
        const savedContact = await AppStorage.getItem(contactKey);
        if (savedContact) {
            const contactData = JSON.parse(savedContact);
            persona = contactData.persona || '';
        }
    }
    
    // 调用AI生成评论内容
    const commentText = await generateAIComment(post.content, randomCharacter, persona);
    
    // 只有当有评论内容时才添加评论
    if (commentText) {
    // 添加评论
    if (!post.commentList) {
        post.commentList = [];
    }
    
    post.commentList.push({
        author: randomCharacter,
        avatar: getCharacterAvatar(randomCharacter),
        text: commentText,
        time: '刚刚'
    });
    
    post.comments++;
    }
    
    // 更新显示
    const commentCount = document.querySelector(`[data-post-id="${postIndex}"] .comment-count`);
    if (commentCount) {
        commentCount.textContent = post.comments;
    }
    
    // 重新渲染动态时间线以显示新评论
    renderMomentTimeline();
    
    // 保存动态数据（包括新评论）
    await saveMomentData();
    
    console.log(`${randomCharacter}评论了${post.name}的动态：${commentText}`);
}

// 生成AI评论内容
async function generateAIComment(postContent, characterName, persona) {
    try {
        const systemPrompt = `你是${characterName}，请对以下朋友圈动态进行评论。要求：
1. 符合${characterName}的性格特点
2. 评论要自然、真实，像朋友间的互动
3. 长度控制在20字以内
4. 不要使用emoji表情，保持文字表达
5. 语言风格要符合人设

人设：${persona || '普通朋友'}
动态内容：${postContent}

请直接输出评论内容，不要其他解释：`;

        const aiResponse = await callAIAPI(systemPrompt);
        return aiResponse.trim();
    } catch (error) {
        console.error('AI生成评论失败:', error);
        // 如果AI调用失败，使用备用评论
        return generateFallbackComment(postContent, characterName);
    }
}

// 备用评论生成（当AI调用失败时使用）
function generateFallbackComment(postContent, characterName) {
    const fallbackComments = [
        '好棒呀！✨',
        '我也这么觉得~',
        '太可爱了！',
        '好有趣呢',
        '我也想要！',
        '不错不错！',
        '我也这么想',
        '很有道理',
        '确实如此',
        '我也喜欢',
        '太厉害了！',
        '好羡慕呀',
        '我也想要',
        '太棒了！',
        '好有趣',
        '我也这么觉得',
        '太可爱了',
        '好厉害',
        '我也喜欢这个',
        '太棒了'
    ];
    
    // 根据角色名称选择不同的评论风格
    if (characterName.includes('小樱') || characterName.includes('樱')) {
        return fallbackComments[Math.floor(Math.random() * 5)]; // 可爱风格
    } else if (characterName.includes('明光') || characterName.includes('光')) {
        return fallbackComments[Math.floor(Math.random() * 5) + 5]; // 阳光风格
    } else {
        return fallbackComments[Math.floor(Math.random() * fallbackComments.length)];
    }
}

// 已删除自动评论功能，现在只保留用户主动互动时的AI回复

// 测试AI发动态功能（读取好友列表和人设）
async function testAIPublishAll() {
    playClickSound();
    
    if (!confirm('是否让所有联系人发布动态？')) {
        return;
    }
    
    // 获取所有非群组联系人
    const contacts = currentMessages.filter(msg => !msg.isGroup);
    
    if (contacts.length === 0) {
        alert('没有找到任何联系人！');
        return;
    }
    
    alert(`开始让${contacts.length}个联系人发布动态...`);
    
    let successCount = 0;
    
    for (const contact of contacts) {
        // 生成测试内容
        const testContent = generateTestContent();
        
        // 强制发布动态（忽略概率）
        const result = await forceAIPublishMoment(contact.name, testContent);
        if (result) {
            successCount++;
        }
        
        // 每个联系人之间间隔1秒
        await new Promise(resolve => setTimeout(resolve, 1000));
    }
    
    alert(`完成！${successCount}/${contacts.length} 个联系人发布了动态`);
}

// 强制AI发布动态（忽略概率）
async function forceAIPublishMoment(friendName, chatContent) {
    // 获取角色信息
    const contact = currentMessages.find(msg => msg.name === friendName && !msg.isGroup);
    if (!contact) return null;
    
    try {
        // 获取联系人的人设
        const contactKey = `contact_${contact.id}`;
        const savedContact = await AppStorage.getItem(contactKey);
        let persona = '';
        if (savedContact) {
            const contactData = JSON.parse(savedContact);
            persona = contactData.persona || '';
        }
        
        // 调用AI生成动态内容
        const momentContent = await generateAIMomentContent(friendName, chatContent, persona);
        
        // 如果AI生成失败，不发布动态
        if (!momentContent) {
            console.log(`${friendName}的AI动态生成失败，跳过发布`);
            return null;
        }
        
        // 调用AI生成个性签名
        const bio = await generateAIBio(friendName, chatContent, persona);
        
        // 创建新动态
        const newMoment = {
            id: momentPosts.length + 1,
            name: friendName,
            username: '@' + friendName.toLowerCase().replace(/\s/g, '_'),
            avatar: contact.avatar,
            content: momentContent,
            image: null,
            time: '刚刚',
            likes: 0,
            shares: 0,
            comments: 0,
            liked: false,
            commentList: [],
            background: backgroundImages[Math.floor(Math.random() * backgroundImages.length)],
            bio: bio,
            world: '现代' // 默认世界观
        };
        
        // 添加到动态列表
        if (momentPosts) {
            momentPosts.unshift(newMoment);
        }
        
        // 保存动态数据
        await saveMomentData();
        
        // 重新渲染动态列表
        renderMomentTimeline();
        
        console.log(`${friendName}发布了动态：${momentContent}`);
        
        return newMoment;
    } catch (error) {
        console.error(`${friendName}发布动态失败:`, error);
        // 如果AI调用失败，不发布动态
        return null;
    }
}

// 生成测试内容
function generateTestContent() {
    const contents = [
        '今天天气真好',
        '心情不错呢',
        '分享一些日常',
        '最近的生活很充实',
        '和朋友们聊得很开心'
    ];
    return contents[Math.floor(Math.random() * contents.length)];
}

// 动态规则设置功能
function openMomentRulesModal() {
    playClickSound();
    const modal = document.getElementById('momentRulesModal');
    modal.style.display = 'flex';
    
    // 加载当前规则
    const currentRules = localStorage.getItem('momentRules') || '让AI根据角色人设，发布一些日常生活动态，如：心情感悟、美食分享、天气感受、读书心得、朋友聚会等内容。要求真实自然，不要太刻意。';
    document.getElementById('momentRulesText').value = currentRules;
}

function closeMomentRulesModal() {
    playClickSound();
    const modal = document.getElementById('momentRulesModal');
    modal.style.display = 'none';
}

function saveMomentRules() {
    playClickSound();
    const rules = document.getElementById('momentRulesText').value.trim();
    
    if (!rules) {
        alert('请输入动态规则！');
        return;
    }
    
    localStorage.setItem('momentRules', rules);
    alert('动态规则保存成功！');
    closeMomentRulesModal();
}

// 调用AI生成动态内容
async function generateAIMomentContent(friendName, chatContent, persona) {
    try {
        // 检查AI配置
        if (!aiConfig || !aiConfig.apiKey || !aiConfig.model) {
            console.warn('AI配置不完整，使用备用内容');
            return generateMomentFromChat(chatContent, persona);
        }
        
        // 获取动态规则
        const momentRules = localStorage.getItem('momentRules') || '让AI根据角色人设，发布一些日常生活动态，如：心情感悟、美食分享、天气感受、读书心得、朋友聚会等内容。要求真实自然，不要太刻意。';
        
        const mainCharacterName = getMainCharacterName();
        const systemPrompt = `你是${friendName}，请根据以下人设和聊天内容，表达你此刻的心情和想对用户说的话。

人设：${persona || '普通朋友'}
聊天内容：${chatContent}
动态规则：${momentRules}

要求：
1. 用你自己的话表达此刻的心情和感受
2. 可以是对用户想说的话，或者因为聊天产生的想法
3. 要自然、真实，像真实的内心表达
4. 长度控制在50字以内
5. 不要使用emoji表情，保持文字表达
6. 语言风格要符合你的性格特点
7. 不要总是用"今天"开头，可以用"刚才"、"突然"、"想起"等
8. 可以@朋友或@用户，格式如：@朋友名字 或 @${mainCharacterName}
9. 重要：一次只分享一件事情或一个想法，不要一次性分享多件事情

请直接输出动态内容，不要其他解释：`;

        console.log('正在调用AI生成动态内容...');
        const aiResponse = await callAIAPI(systemPrompt);
        console.log('AI生成动态内容成功:', aiResponse);
        return aiResponse.trim();
    } catch (error) {
        console.error('AI生成动态内容失败:', error);
        // 不再使用预设模板，直接返回null，让调用者决定如何处理
        return null;
    }
}

// 调用AI生成个性签名
async function generateAIBio(friendName, chatContent, persona) {
    try {
        const systemPrompt = `你是${friendName}，请根据以下人设和聊天内容，生成一个个性签名。要求：
1. 符合${friendName}的性格特点
2. 简洁有趣，10-20字
3. 不要使用emoji表情，保持文字表达
4. 体现个人特色

人设：${persona || '普通朋友'}
聊天内容：${chatContent}

请直接输出个性签名，不要其他解释：`;

        const aiResponse = await callAIAPI(systemPrompt);
        return aiResponse.trim();
    } catch (error) {
        console.error('AI生成个性签名失败:', error);
        return generateBioFromChat(chatContent, persona);
    }
}

// 处理图片识别的统一函数
async function handleImageRecognition(imageData) {
    try {
        console.log('开始处理图片识别...');
        
        // 检查AI配置
        if (!aiConfig.provider || !aiConfig.apiKey || !aiConfig.model || aiConfig.status !== 'connected') {
            console.log('AI服务未连接，跳过识图');
            return;
        }
        
        // 显示"正在思考"状态
        setChatTyping(true);
        
        // 获取聊天上下文（最近几条消息）
        const recentMessages = chatMessages.slice(-3);
        const chatContext = recentMessages.map(msg => `${msg.sender === 'sent' ? '你' : currentChatContact.name}: ${msg.content}`).join('\n');
        
        // 调用AI识图
        const aiResponse = await recognizeImageWithAI(imageData, chatContext);
        
        if (aiResponse) {
            // 创建AI回复消息
            const now = new Date();
            const timeStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            
            const aiMessage = {
                id: Date.now() + Math.random(),
                sender: 'received',
                content: aiResponse,
                time: timeStr,
                avatar: currentChatContact ? currentChatContact.avatar : 'https://placehold.co/40x40/E8E8E8/999?text=AI'
            };
            
            // 添加到消息数组
            chatMessages.push(aiMessage);
            
            // 渲染AI回复
            await renderNewAIMessage(aiMessage);
            
            // 异步保存
            setTimeout(async () => {
                if (currentChatContact) {
                    await saveChatMessages(currentChatContact.id, chatMessages);
                }
            }, 0);
            
            console.log('AI识图回复已发送');
        } else {
            console.log('AI识图失败，无回复');
        }
        
    } catch (error) {
        console.error('处理图片识别失败:', error);
    } finally {
        // 恢复在线状态
        setChatTyping(false);
    }
}

// AI识图功能
async function recognizeImageWithAI(imageData, chatContext = '') {
    try {
        console.log('开始AI识图...');
        
        // 检查AI配置
        if (!aiConfig.provider || !aiConfig.apiKey || !aiConfig.model || aiConfig.status !== 'connected') {
            console.log('AI服务未连接，跳过识图');
            return null;
        }
        
        // 获取当前联系人的人设
        const contactPersona = await getContactPersona();
        const selfPersona = await getSelfPersona();
        
        // 构建识图提示词
        const systemPrompt = `你是${currentChatContact ? currentChatContact.name : 'AI助手'}，请分析用户发送的图片内容。

要求：
1. 仔细观察图片中的主要元素、场景、人物、物品等
2. 描述图片的整体氛围和情感色彩
3. 根据你的性格特点给出自然的反应
4. 可以适当表达对图片内容的看法或感受
5. 保持对话的自然和流畅

你的性格特点：${contactPersona || '友善、好奇'}
聊天上下文：${chatContext}

请直接输出对图片的分析和反应，不要其他解释：`;

        // 根据不同AI提供商调用识图API
        let apiUrl, headers, body;
        
        switch (aiConfig.provider) {
            case 'openai':
                apiUrl = 'https://api.openai.com/v1/chat/completions';
                headers = {
                    'Authorization': `Bearer ${aiConfig.apiKey}`,
                    'Content-Type': 'application/json'
                };
                body = {
                    model: aiConfig.model,
                    messages: [
                        {
                            role: 'user',
                            content: [
                                {
                                    type: 'text',
                                    text: systemPrompt
                                },
                                {
                                    type: 'image_url',
                                    image_url: {
                                        url: imageData
                                    }
                                }
                            ]
                        }
                    ],
                    max_tokens: 500
                };
                break;
                
            case 'deepseek':
                apiUrl = 'https://api.deepseek.com/v1/chat/completions';
                headers = {
                    'Authorization': `Bearer ${aiConfig.apiKey}`,
                    'Content-Type': 'application/json'
                };
                body = {
                    model: aiConfig.model,
                    messages: [
                        {
                            role: 'user',
                            content: [
                                {
                                    type: 'text',
                                    text: systemPrompt
                                },
                                {
                                    type: 'image_url',
                                    image_url: {
                                        url: imageData
                                    }
                                }
                            ]
                        }
                    ],
                    max_tokens: 500
                };
                break;
                
            case 'google':
                apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${aiConfig.model}:generateContent?key=${aiConfig.apiKey}`;
                headers = {
                    'Content-Type': 'application/json'
                };
                body = {
                    contents: [{
                        parts: [
                            {
                                text: systemPrompt
                            },
                            {
                                inline_data: {
                                    mime_type: 'image/jpeg',
                                    data: imageData.split(',')[1] // 移除data:image/jpeg;base64,前缀
                                }
                            }
                        ]
                    }],
                    generationConfig: {
                        maxOutputTokens: 500
                    }
                };
                break;
                
            default:
                throw new Error('不支持的AI提供商');
        }
        
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(body)
        });
        
        if (!response.ok) {
            throw new Error(`AI识图API调用失败: ${response.status}`);
        }
        
        const data = await response.json();
        
        // 解析不同提供商的响应
        let aiResponse;
        switch (aiConfig.provider) {
            case 'openai':
            case 'deepseek':
                aiResponse = data.choices?.[0]?.message?.content || '抱歉，我无法识别这张图片。';
                break;
            case 'google':
                aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || '抱歉，我无法识别这张图片。';
                break;
            default:
                aiResponse = '抱歉，我无法识别这张图片。';
        }
        
        console.log('AI识图成功:', aiResponse);
        return aiResponse.trim();
        
    } catch (error) {
        console.error('AI识图失败:', error);
        return null;
    }
}


// 聊天触发AI发动态（使用AI生成内容）
async function aiPublishMomentFromChat(friendName, chatContent) {
    console.log(`检查是否触发${friendName}发动态...`);
    
    // 获取角色信息
    const contact = currentMessages.find(msg => msg.name === friendName && !msg.isGroup);
    if (!contact) {
        console.log('未找到联系人，跳过发动态');
        return;
    }
    
    // 获取联系人的人设
    const contactKey = `contact_${contact.id}`;
    const savedContact = await AppStorage.getItem(contactKey);
    let persona = '';
    if (savedContact) {
        const contactData = JSON.parse(savedContact);
        persona = contactData.persona || '';
    }
    
    // 根据人设和聊天内容计算发动态概率
    const baseFrequency = getContactFrequency(friendName, persona);
    const chatTrigger = calculateChatTrigger(chatContent);
    const finalProbability = Math.min(baseFrequency + chatTrigger, 0.8); // 最高80%概率
    
    console.log(`${friendName}发动态概率: 基础${baseFrequency} + 聊天触发${chatTrigger} = ${finalProbability}`);
    
    // 随机判断是否发动态
    if (Math.random() > finalProbability) {
        console.log(`${friendName}未触发发动态（概率${finalProbability}）`);
        return;
    }
    
    console.log(`${friendName}触发发动态！正在使用AI生成内容...`);
    
    try {
        // 使用AI生成动态内容
        const momentContent = await generateAIMomentContent(friendName, chatContent, persona);
        
        // 如果AI生成失败，不发布动态
        if (!momentContent) {
            console.log(`${friendName}的AI动态生成失败，跳过发布`);
            return;
        }
        
        // 使用AI生成个性签名
        const bio = await generateAIBio(friendName, chatContent, persona);
        
        // 创建新动态
        const newMoment = {
            id: momentPosts.length + 1,
            name: friendName,
            username: '@' + friendName.toLowerCase().replace(/\s/g, '_'),
            avatar: contact.avatar,
            content: momentContent,
            image: null,
            time: '刚刚',
            likes: 0,
            shares: 0,
            comments: 0,
            liked: false,
            commentList: [],
            background: backgroundImages[Math.floor(Math.random() * backgroundImages.length)],
            bio: bio || '分享生活点滴',
            world: '现代'
        };
        
        // 添加到动态列表
        if (momentPosts) {
            momentPosts.unshift(newMoment);
        }
        
        // 保存动态数据
        await saveMomentData();
        
        // 重新渲染动态列表
        renderMomentTimeline();
        
        console.log(`✅ ${friendName}发布了AI生成的动态：${momentContent}`);
        
        return newMoment;
    } catch (error) {
        console.error(`${friendName}发布动态失败:`, error);
        return null;
    }
}

// 批量让AI为多个好友发动态
async function aiPublishMomentsForFriends(friendsList) {
    // friendsList: 好友列表，每个元素包含 { name, persona }
    for (const friend of friendsList) {
        await aiPublishMoment(friend.name, friend.persona);
        // 每个好友之间间隔一段时间，避免过快
        await new Promise(resolve => setTimeout(resolve, 2000));
    }
}

// 定时让AI发动态（可选功能，默认关闭）
let aiAutoPublishInterval = null;

function enableAIAutoPublish(intervalMinutes = 30) {
    // 启用AI自动发动态功能
    if (aiAutoPublishInterval) {
        clearInterval(aiAutoPublishInterval);
    }
    
    aiAutoPublishInterval = setInterval(async () => {
        // 从currentMessages中获取好友列表
        const friends = currentMessages
            .filter(msg => !msg.isGroup)
            .map(msg => ({
                name: msg.name,
                persona: '默认人设' // 这里将来从存储中获取
            }));
        
        // 随机选择一个好友发动态
        if (friends.length > 0) {
            const randomFriend = friends[Math.floor(Math.random() * friends.length)];
            await aiPublishMoment(randomFriend.name, randomFriend.persona);
        }
    }, intervalMinutes * 60 * 1000);
    
    console.log(`AI自动发动态已启用，间隔${intervalMinutes}分钟`);
}

function disableAIAutoPublish() {
    // 禁用AI自动发动态功能
    if (aiAutoPublishInterval) {
        clearInterval(aiAutoPublishInterval);
        aiAutoPublishInterval = null;
        console.log('AI自动发动态已禁用');
    }
}

// 个人动态数据（已清空预设内容）
const profilePosts = [];

// 动态分页相关变量
let currentPage = 1;
const postsPerPage = 5;

function renderMomentTimeline() {
    const timeline = document.getElementById('momentTimeline');
    timeline.innerHTML = '';
    
    // 如果没有动态，显示空状态提示
    if (momentPosts.length === 0) {
        timeline.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">📱</div>
                <div class="empty-state-text">还没有动态呢~</div>
                <div class="empty-state-subtext">点击右下角的"+"按钮发布第一条动态吧！</div>
            </div>
        `;
        return;
    }
    
    // 计算当前页显示的动态
    const startIndex = 0;
    const endIndex = Math.min(currentPage * postsPerPage, momentPosts.length);
    const postsToShow = momentPosts.slice(startIndex, endIndex);
    
    // 渲染动态
    postsToShow.forEach((post, index) => {
        const postElement = document.createElement('div');
        postElement.className = 'moment-post';
        postElement.setAttribute('data-post-id', index);
        
        let imageHtml = '';
        if (post.image) {
            imageHtml = `<div class="moment-post-image" style="background-image: url('${post.image}');"></div>`;
        }
        
        // 检查是否已点赞
        const isLiked = post.liked || false;
        const likeClass = isLiked ? 'liked' : '';
        
        // 生成预设评论HTML
        let commentsHtml = '';
        if (post.commentList && post.commentList.length > 0) {
            commentsHtml = post.commentList.map(comment => `
                <div class="comment-item">
                    <div class="comment-avatar" style="background-image: url('${comment.avatar}');"></div>
                    <div class="comment-bubble">
                        <span class="comment-author">${comment.author}</span>
                        <span class="comment-text"> ${comment.text}</span>
                    </div>
                </div>
            `).join('');
        }

        postElement.innerHTML = `
            <div class="moment-post-header">
                <div class="moment-post-avatar" style="background-image: url('${post.avatar}');" onclick="openOthersProfile(${index})"></div>
                <div class="moment-post-info">
                    <div class="moment-post-name">${post.name}</div>
                    <div class="moment-post-time">${post.time}</div>
                </div>
            </div>
            <div class="moment-post-content" oncontextmenu="event.preventDefault(); showDeleteConfirm(${index})" onmousedown="startLongPress(${index})" onmouseup="endLongPress()" onmouseleave="endLongPress()">${post.content}</div>
            ${imageHtml}
            <div class="moment-post-actions">
                <div class="moment-post-action like-action ${likeClass}" onclick="toggleLike(${index})">
                    <span>♥</span>
                    <span class="like-count">${post.likes}</span>
                </div>
                <div class="moment-post-action">
                    <span>↺</span>
                    <span>${post.shares}</span>
                </div>
                <div class="moment-post-action comment-action" onclick="toggleCommentInput(${index})">
                    <span>✧</span>
                    <span class="comment-count">${post.comments}</span>
                </div>
            </div>
            <div class="comments-section" id="comments-${index}" style="display: ${post.commentList && post.commentList.length > 0 ? 'block' : 'none'};">
                ${commentsHtml}
            </div>
            <div class="comment-input-section" id="comment-input-${index}" style="display: none;">
                <div class="comment-input-avatar" style="background-image: url('${getCurrentUserAvatar()}');"></div>
                <div class="comment-input-bubble">
                    <textarea class="comment-input" placeholder="写下你的评论..." rows="1" onkeydown="handleCommentKeydown(event, ${index})"></textarea>
                </div>
                <button class="comment-send-btn" onclick="submitInlineComment(${index})">
                    <svg viewBox="0 0 24 24">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        `;
        
        timeline.appendChild(postElement);
        
        // 更新点赞显示
        updateLikeDisplay(index);
    });
    
    // 如果还有更多动态，显示加载更多按钮
    if (endIndex < momentPosts.length) {
        const loadMoreBtn = document.createElement('div');
        loadMoreBtn.className = 'load-more-btn';
        loadMoreBtn.innerHTML = `
            <div class="load-more-content">
                <div class="load-more-text">加载更多动态</div>
            </div>
        `;
        loadMoreBtn.onclick = loadMoreMoments;
        timeline.appendChild(loadMoreBtn);
    }
}

// 加载更多动态
function loadMoreMoments() {
    playClickSound();
    currentPage++;
    renderMomentTimeline();
}

// 重置分页（当发布新动态时）
function resetMomentPagination() {
    currentPage = 1;
}

function renderProfileTimeline() {
    const timeline = document.getElementById('profileTimeline');
    timeline.innerHTML = '';
    
    // 如果没有个人动态，显示空状态提示
    if (profilePosts.length === 0) {
        timeline.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">👤</div>
                <div class="empty-state-text">还没有发布过动态</div>
                <div class="empty-state-subtext">去动态页面发布第一条动态吧！</div>
            </div>
        `;
        return;
    }
    
    profilePosts.forEach(post => {
        const postElement = document.createElement('div');
        postElement.className = 'profile-tweet';
        
        let imageHtml = '';
        if (post.image) {
            imageHtml = `<div class="profile-tweet-image" style="background-image: url('${post.image}');"></div>`;
        }
        
        postElement.innerHTML = `
            <div class="profile-tweet-header">
                <div class="profile-tweet-avatar" style="background-image: url('${getCurrentUserAvatar()}');"></div>
                <div class="profile-tweet-info">
                    <div class="profile-tweet-name">${getCurrentUserName()}</div>
                    <div class="profile-tweet-username">@${(localStorage.getItem('profile_username') || 'sakura_kawaii').replace('@', '')}</div>
                </div>
            </div>
            <div class="profile-tweet-content">${post.content}</div>
            ${imageHtml}
            <div class="profile-tweet-actions">
                <div class="profile-tweet-action">♥ ${post.likes}</div>
                <div class="profile-tweet-action">↺ ${post.shares}</div>
                <div class="profile-tweet-action">✧ ${post.comments}</div>
            </div>
        `;
        
        timeline.appendChild(postElement);
    });
}

// 个人主页编辑功能
let currentEditType = '';
let currentEditElement = null;

function editProfileAvatar(event) {
    event.stopPropagation();
    playClickSound();
    document.getElementById('avatarFileInput').click();
}

function editProfileBackground() {
    playClickSound();
    document.getElementById('backgroundFileInput').click();
}

function editProfileName() {
    playClickSound();
    currentEditType = 'name';
    currentEditElement = document.getElementById('profileName');
    openEditModal('编辑姓名', currentEditElement.textContent);
}

function editProfileUsername() {
    playClickSound();
    currentEditType = 'username';
    currentEditElement = document.getElementById('profileUsername');
    openEditModal('编辑用户名', currentEditElement.textContent);
}

function editProfileBio() {
    playClickSound();
    currentEditType = 'bio';
    currentEditElement = document.getElementById('profileBio');
    openEditModal('编辑个人简介', currentEditElement.textContent);
}


function editProfileStat(type) {
    playClickSound();
    currentEditType = type;
    const statElement = document.getElementById(`stat${type.charAt(0).toUpperCase() + type.slice(1)}`);
    currentEditElement = statElement;
    openEditModal('编辑数据', statElement.textContent);
}

function openEditModal(title, currentValue) {
    const modal = document.getElementById('editModal');
    const titleElement = document.getElementById('editModalTitle');
    const inputElement = document.getElementById('editModalInput');
    
    titleElement.textContent = title;
    inputElement.value = currentValue;
    modal.style.display = 'flex';
}

function closeEditModal() {
    const modal = document.getElementById('editModal');
    modal.style.display = 'none';
    currentEditType = '';
    currentEditElement = null;
}

function saveEdit() {
    const inputElement = document.getElementById('editModalInput');
    const newValue = inputElement.value.trim();
    
    if (newValue && currentEditElement) {
        currentEditElement.textContent = newValue;
        
        // 如果是背景图片，需要特殊处理
        if (currentEditType === 'background') {
            const profileSection = document.getElementById('profileSection');
            profileSection.style.backgroundImage = `url('${newValue}')`;
        }
        
        // 保存到本地存储
        localStorage.setItem(`profile_${currentEditType}`, newValue);
        
        // 如果是名字更改，立即更新所有相关名字
        if (currentEditType === 'name') {
            updateAllCommentNames();
        }
    }
    
    closeEditModal();
}

function handleAvatarChange(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const avatar = document.getElementById('profileAvatar');
            avatar.style.backgroundImage = `url('${e.target.result}')`;
            localStorage.setItem('profile_avatar', e.target.result);
            
            // 立即更新所有相关头像
            updateAllCommentAvatars();
        };
        reader.readAsDataURL(file);
    }
}

function handleBackgroundChange(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const profileSection = document.getElementById('profileSection');
            profileSection.style.backgroundImage = `url('${e.target.result}')`;
            localStorage.setItem('profile_background', e.target.result);
        };
        reader.readAsDataURL(file);
    }
}

// 动态设置功能
function openMomentSettings() {
    playClickSound();
    
    const settingsModal = document.createElement('div');
    settingsModal.className = 'modal-overlay';
    settingsModal.innerHTML = `
        <div class="modal-content" style="max-width: 300px;">
            <div class="modal-header">
                <h3>动态设置</h3>
                <button class="close-btn" onclick="closeMomentSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="setting-item" onclick="clearOldMoments()">
                    <div class="setting-icon">🗑️</div>
                    <div class="setting-text">
                        <div class="setting-title">清除旧动态</div>
                        <div class="setting-desc">删除折叠的旧动态，保留最新5条</div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(settingsModal);
    settingsModal.style.display = 'flex';
}

function closeMomentSettings() {
    const modal = document.querySelector('.modal-overlay');
    if (modal) {
        modal.remove();
    }
}

// 清除旧动态（保留最新5条）
async function clearOldMoments() {
    if (momentPosts.length <= 5) {
        alert('当前动态数量不超过5条，无需清除！');
        closeMomentSettings();
        return;
    }
    
    const oldCount = momentPosts.length - 5;
    if (confirm(`确定要清除${oldCount}条旧动态吗？将保留最新5条动态。此操作不可恢复！`)) {
        try {
            // 只保留最新5条动态
            momentPosts.splice(5);
            
            // 保存到存储
            await saveMomentData();
            
            // 重置分页
            resetMomentPagination();
            
            // 重新渲染
            renderMomentTimeline();
            
            // 关闭设置
            closeMomentSettings();
            
            alert(`已清除${oldCount}条旧动态，保留最新5条！`);
        } catch (error) {
            console.error('清除旧动态失败:', error);
            alert('清除失败，请重试');
        }
    }
}


// 发动态功能
function openCreateMomentModal() {
    playClickSound();
    const modal = document.getElementById('postMomentModal');
    modal.style.display = 'flex';
    
    // 聚焦到输入框
    const textarea = document.getElementById('postMomentText');
    textarea.focus();
}

function closePostMomentModal() {
    const modal = document.getElementById('postMomentModal');
    modal.style.display = 'none';
    
    // 清空内容
    document.getElementById('postMomentText').value = '';
    document.getElementById('postImagePreview').innerHTML = '';
    document.getElementById('postImageUpload').value = '';
}

async function submitMoment() {
    const textarea = document.getElementById('postMomentText');
    const imagePreview = document.getElementById('postImagePreview');
    const postBtn = document.querySelector('.post-moment-btn');
    
    if (!textarea.value.trim() && imagePreview.children.length === 0) {
        postBtn.classList.add('shake');
        setTimeout(() => postBtn.classList.remove('shake'), 820);
        return;
    }
    
    postBtn.innerHTML = '发布中...';
    postBtn.disabled = true;
    
    // 创建新的动态
    const newMoment = {
        id: momentPosts.length + 1,
        name: getCurrentUserName(),
        username: '@' + (localStorage.getItem('profile_username') || 'sakura_kawaii').replace('@', ''),
        avatar: getCurrentUserAvatar(),
        content: textarea.value.trim(),
        image: imagePreview.children.length > 0 ? imagePreview.children[0].querySelector('img').src : null,
        time: '刚刚',
        likes: 0,
        shares: 0,
        comments: 0,
        liked: false,
        commentList: []
    };
    
    // 添加到动态列表开头
    momentPosts.unshift(newMoment);
    
    // 同时添加到个人主页动态列表
    const newProfilePost = {
        id: profilePosts.length + 1,
        content: textarea.value.trim(),
        image: imagePreview.children.length > 0 ? imagePreview.children[0].querySelector('img').src : null,
        time: '刚刚',
        likes: 0,
        shares: 0,
        comments: 0
    };
    profilePosts.unshift(newProfilePost);
    
    // 保存动态数据
    await saveMomentData();
    
    // 重新渲染动态时间线
    renderMomentTimeline();
    
    // 如果当前在个人主页，也更新个人主页
    if (document.getElementById('profilePage').style.display !== 'none') {
        renderProfileTimeline();
    }
    
    // 根据可见性设置让相应的联系人评论动态
    setTimeout(async () => {
        // 获取可见的联系人列表
        const visibleFriends = getVisibleFriends();
        
        if (visibleFriends.length > 0) {
            // 让可见的联系人对新发布的动态进行评论
            const newPostIndex = 0; // 新发布的动态在数组开头
            const commentCount = Math.min(visibleFriends.length, Math.floor(Math.random() * 3) + 2); // 2-4个评论
            const usedFriends = new Set(); // 记录已经评论过的好友
            
            for (let i = 0; i < commentCount && usedFriends.size < visibleFriends.length; i++) {
                // 随机选择一个未评论过的好友
                let randomFriend;
                do {
                    randomFriend = visibleFriends[Math.floor(Math.random() * visibleFriends.length)];
                } while (usedFriends.has(randomFriend.id) && usedFriends.size < visibleFriends.length);
                
                if (randomFriend) {
                    usedFriends.add(randomFriend.id);
                    // 延迟评论，让评论看起来更自然
                    setTimeout(() => {
                        aiCommentPostWithFriend(newPostIndex, randomFriend);
                    }, i * 2000 + Math.random() * 3000); // 每个评论间隔2-5秒
                }
            }
        }
    }, 3000); // 3秒后开始评论
    
    setTimeout(() => {
        postBtn.innerHTML = '发布';
        postBtn.disabled = false;
        closePostMomentModal();
    }, 1500);
}

// 图片上传功能
function initPostMomentImageUpload() {
    const imageUpload = document.getElementById('postImageUpload');
    const imagePreview = document.getElementById('postImagePreview');
    
    if (imageUpload) {
        imageUpload.addEventListener('change', function(e) {
            const files = e.target.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (!file.type.match('image.*')) continue;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'post-moment-preview-item';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    
                    const removeBtn = document.createElement('div');
                    removeBtn.className = 'post-moment-remove-btn';
                    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    removeBtn.addEventListener('click', function() {
                        previewItem.remove();
                    });
                    
                    previewItem.appendChild(img);
                    previewItem.appendChild(removeBtn);
                    imagePreview.appendChild(previewItem);
                }
                reader.readAsDataURL(file);
            }
        });
    }
}

// 点赞功能
async function toggleLike(postIndex) {
    playClickSound();
    const post = momentPosts[postIndex];
    const likeAction = document.querySelector(`[data-post-id="${postIndex}"] .like-action`);
    const likeCount = likeAction.querySelector('.like-count');
    
    if (post.liked) {
        post.liked = false;
        post.likes--;
        likeAction.classList.remove('liked');
        
        // 移除点赞人名字
        if (post.likeList) {
            const currentUserName = getCurrentUserName();
            post.likeList = post.likeList.filter(name => name !== currentUserName);
        }
    } else {
        post.liked = true;
        post.likes++;
        likeAction.classList.add('liked');
        
        // 添加点赞人名字
        if (!post.likeList) {
            post.likeList = [];
        }
        const currentUserName = getCurrentUserName();
        if (!post.likeList.includes(currentUserName)) {
            post.likeList.push(currentUserName);
        }
    }
    
    // 更新点赞显示
    updateLikeDisplay(postIndex);
    
    // 保存动态数据
    await saveMomentData();
}

function updateLikeDisplay(postIndex) {
    const post = momentPosts[postIndex];
    const likeAction = document.querySelector(`[data-post-id="${postIndex}"] .like-action`);
    const likeCount = likeAction.querySelector('.like-count');
    
    if (post.likes > 0) {
        if (post.likeList && post.likeList.length > 0) {
            // 显示点赞人名字
            let likeText = '';
            if (post.likeList.length === 1) {
                likeText = post.likeList[0];
            } else if (post.likeList.length === 2) {
                likeText = `${post.likeList[0]}、${post.likeList[1]}`;
            } else {
                likeText = `${post.likeList[0]}等${post.likes}人`;
            }
            likeCount.textContent = likeText;
        } else {
            likeCount.textContent = post.likes;
        }
    } else {
        likeCount.textContent = '0';
    }
}

// 评论功能
let currentCommentPostId = null;

// 删除动态功能
let currentDeletePostId = null;
let longPressTimer = null;

// 长按检测
function startLongPress(postIndex) {
    longPressTimer = setTimeout(() => {
        showDeleteConfirm(postIndex);
    }, 800); // 800ms长按触发
}

function endLongPress() {
    if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
    }
}

// 显示删除确认弹窗
function showDeleteConfirm(postIndex) {
    playClickSound();
    currentDeletePostId = postIndex;
    const overlay = document.getElementById('deleteConfirmOverlay');
    overlay.style.display = 'flex';
}

// 关闭删除确认弹窗
function closeDeleteConfirm() {
    const overlay = document.getElementById('deleteConfirmOverlay');
    overlay.style.display = 'none';
    currentDeletePostId = null;
}

// 确认删除动态
async function confirmDeleteMoment() {
    if (currentDeletePostId === null) return;
    
    playClickSound();
    
    // 从数组中删除动态
    momentPosts.splice(currentDeletePostId, 1);
    
    // 重新渲染动态时间线
    renderMomentTimeline();
    
    // 如果当前在个人主页，也更新个人主页
    if (document.getElementById('profilePage').style.display !== 'none') {
        renderProfileTimeline();
    }
    
    // 关闭弹窗
    closeDeleteConfirm();
    
    console.log('动态已删除');
}

function toggleCommentInput(postIndex) {
    playClickSound();
    const commentsSection = document.getElementById(`comments-${postIndex}`);
    const inputSection = document.getElementById(`comment-input-${postIndex}`);
    
    if (inputSection.style.display === 'none') {
        // 显示评论输入框
        inputSection.style.display = 'flex';
        commentsSection.style.display = 'block';
        
        // 聚焦到输入框
        const textarea = inputSection.querySelector('.comment-input');
        textarea.focus();
        
        // 自动调整高度
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 60) + 'px';
        });
    } else {
        // 隐藏评论输入框
        inputSection.style.display = 'none';
        if (commentsSection.children.length === 0) {
            commentsSection.style.display = 'none';
        }
    }
}

function handleCommentKeydown(event, postIndex) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        submitInlineComment(postIndex);
    }
}

async function submitInlineComment(postIndex) {
    const inputSection = document.getElementById(`comment-input-${postIndex}`);
    const textarea = inputSection.querySelector('.comment-input');
    const commentText = textarea.value.trim();
    
    if (commentText) {
        const post = momentPosts[postIndex];
        post.comments++;
        
        // 确保commentList存在
        if (!post.commentList) {
            post.commentList = [];
        }
        
        // 添加评论到数据中
        const newComment = {
            author: getCurrentUserName(),
            avatar: getCurrentUserAvatar(),
            text: commentText,
            time: '刚刚'
        };
        post.commentList.push(newComment);
        
        // 更新评论数显示
        const commentCount = document.querySelector(`[data-post-id="${postIndex}"] .comment-count`);
        commentCount.textContent = post.comments;
        
        // 添加评论到评论区域
        addCommentToPost(postIndex, commentText);
        
        // 清空输入框
        textarea.value = '';
        textarea.style.height = 'auto';
        
        // 保存动态数据
        await saveMomentData();
        
        // 检测是否@了角色，如果@了就让被@的角色回复
        const mentionedCharacters = detectMentionedCharacters(commentText);
        if (mentionedCharacters.length > 0) {
            // 如果@了角色，让被@的角色回复
            setTimeout(() => {
                mentionedCharacters.forEach(characterName => {
                    aiReplyToMentionedCharacter(postIndex, characterName, commentText);
                });
            }, 2000); // 2秒后被@的角色回复
        } else {
            // 如果没有@角色，使用原来的AI回复逻辑
            setTimeout(() => {
                aiReplyToComment(postIndex, commentText);
            }, 2000); // 2秒后AI回复
            
            // 延迟让其他角色也参与讨论（30%概率）
            setTimeout(() => {
                if (Math.random() < 0.3) {
                    aiReplyToComment(postIndex, commentText);
                }
            }, 5000); // 5秒后其他角色可能回复
        }
        
        // 重新渲染评论区域，让用户可以继续回复
        renderComments(postIndex);
    }
}

function addCommentToPost(postIndex, commentText) {
    const commentsSection = document.getElementById(`comments-${postIndex}`);
    const commentElement = document.createElement('div');
    commentElement.className = 'comment-item';
    commentElement.innerHTML = `
        <div class="comment-avatar" style="background-image: url('${getCurrentUserAvatar()}');"></div>
        <div class="comment-bubble">
            <span class="comment-author">${getCurrentUserName()}</span>
            <span class="comment-text"> ${commentText}</span>
        </div>
    `;
    
    commentsSection.appendChild(commentElement);
    commentsSection.style.display = 'block';
}

// 渲染评论区域
function renderComments(postIndex) {
    const post = momentPosts[postIndex];
    if (!post) return;
    
    const commentsSection = document.getElementById(`comments-${postIndex}`);
    if (!commentsSection) return;
    
    // 清空现有评论
    while (commentsSection.firstChild) {
        commentsSection.removeChild(commentsSection.firstChild);
    }
    
    // 渲染所有评论
    if (post.commentList && post.commentList.length > 0) {
        post.commentList.forEach(comment => {
            const commentElement = document.createElement('div');
            commentElement.className = 'comment-item';
            
            // 确保使用正确的头像和名字
            const avatar = comment.avatar || getCurrentUserAvatar();
            const author = comment.author || getCurrentUserName();
            
            commentElement.innerHTML = `
                <div class="comment-avatar" style="background-image: url('${avatar}');"></div>
                <div class="comment-bubble">
                    <span class="comment-author">${author}</span>
                    <span class="comment-text"> ${comment.text}</span>
                </div>
            `;
            
            // 已删除点击评论功能
            
            commentsSection.appendChild(commentElement);
        });
    }
}

// 已删除点击评论回复功能

// 已删除提交回复评论功能

// 已删除旧的回复函数，现在使用submitReplyComment

// 检测评论中@的角色
function detectMentionedCharacters(commentText) {
    const mentionedCharacters = [];
    
    // 获取所有角色名字
    const characterNames = currentMessages
        .filter(msg => !msg.isGroup)
        .map(msg => msg.name);
    
    // 检测@符号后的角色名字
    characterNames.forEach(characterName => {
        const mentionPattern = new RegExp(`@${characterName}\\b`, 'g');
        if (mentionPattern.test(commentText)) {
            mentionedCharacters.push(characterName);
        }
    });
    
    return mentionedCharacters;
}

// AI回复被@的角色
async function aiReplyToMentionedCharacter(postIndex, characterName, userComment) {
    const post = momentPosts[postIndex];
    if (!post) return;
    
    // 检查是否已经回复过这个用户的评论
    const userCommentIndex = post.commentList.findIndex(comment => 
        comment.author === getCurrentUserName() && comment.text === userComment
    );
    
    if (userCommentIndex !== -1) {
        // 检查在这个用户评论之后是否已经回复过
        const hasRepliedAfterUserComment = post.commentList
            .slice(userCommentIndex + 1)
            .some(comment => comment.author === characterName);
        
        if (hasRepliedAfterUserComment) {
            console.log(`${characterName}已经回复过这个用户评论了，跳过`);
            return;
        }
    }
    
    // 获取角色人设
    const character = currentMessages.find(msg => 
        !msg.isGroup && msg.name === characterName
    );
    
    if (!character) {
        console.log(`找不到角色 ${characterName}`);
        return;
    }
    
    let persona = '';
    const contactKey = `contact_${character.id}`;
    const savedContact = await AppStorage.getItem(contactKey);
    if (savedContact) {
        const contactData = JSON.parse(savedContact);
        persona = contactData.persona || '';
    }
    
    try {
        // 生成AI回复
        const replyText = await generateAICommentReply(userComment, characterName, persona, post.content);
        
        // 添加AI回复到数据中
        if (!post.commentList) {
            post.commentList = [];
        }
        
        const aiReply = {
            author: characterName,
            avatar: getCharacterAvatar(characterName),
            text: replyText,
            time: '刚刚'
        };
        post.commentList.push(aiReply);
        post.comments++;
        
        // 重新渲染评论区域
        renderComments(postIndex);
        
        // 更新评论数显示
        const commentCount = document.querySelector(`[data-post-id="${postIndex}"] .comment-count`);
        if (commentCount) {
            commentCount.textContent = post.comments;
        }
        
        // 保存动态数据
        await saveMomentData();
        
        console.log(`${characterName}回复了被@的评论：${replyText}`);
    } catch (error) {
        console.error('AI回复被@角色失败:', error);
    }
}

// 保留原有的模态框评论功能（备用）
function openCommentModal(postIndex) {
    playClickSound();
    currentCommentPostId = postIndex;
    const modal = document.getElementById('commentModal');
    const input = document.getElementById('commentInput');
    input.value = '';
    modal.style.display = 'flex';
    input.focus();
}

function closeCommentModal() {
    const modal = document.getElementById('commentModal');
    modal.style.display = 'none';
    currentCommentPostId = null;
}

async function submitComment() {
    const input = document.getElementById('commentInput');
    const commentText = input.value.trim();
    
    if (commentText && currentCommentPostId !== null) {
        const post = momentPosts[currentCommentPostId];
        post.comments++;
        
        // 确保commentList存在
        if (!post.commentList) {
            post.commentList = [];
        }
        
        // 添加评论到数据中
        const newComment = {
            author: getCurrentUserName(),
            avatar: getCurrentUserAvatar(),
            text: commentText,
            time: '刚刚'
        };
        post.commentList.push(newComment);
        
        // 更新评论数显示
        const commentCount = document.querySelector(`[data-post-id="${currentCommentPostId}"] .comment-count`);
        commentCount.textContent = post.comments;
        
        // 添加评论到评论区域
        addCommentToPost(currentCommentPostId, commentText);
        
        // 保存动态数据
        await saveMomentData();
        
        // 延迟让AI回复评论
        setTimeout(() => {
            aiReplyToComment(currentCommentPostId, commentText);
        }, 2000); // 2秒后AI回复
        
        // 延迟让其他角色也参与讨论（30%概率）
        setTimeout(() => {
            if (Math.random() < 0.3) {
                aiReplyToComment(currentCommentPostId, commentText);
            }
        }, 5000); // 5秒后其他角色可能回复
        
        closeCommentModal();
    }
}

function getCurrentUserName() {
    return localStorage.getItem('profile_name') || '桜酱';
}

function getCurrentUserAvatar() {
    return localStorage.getItem('profile_avatar') || 'https://files.catbox.moe/r5s188.jpg';
}

// 更新所有评论区域的头像和名字
function updateAllCommentAvatars() {
    const currentAvatar = getCurrentUserAvatar();
    
    // 更新所有评论输入框的头像
    document.querySelectorAll('.comment-input-avatar').forEach(avatar => {
        avatar.style.backgroundImage = `url('${currentAvatar}')`;
    });
    
    // 更新所有评论中的用户头像
    document.querySelectorAll('.comment-avatar').forEach(avatar => {
        avatar.style.backgroundImage = `url('${currentAvatar}')`;
    });
    
    // 更新所有动态中的帖主头像
    document.querySelectorAll('.moment-post-avatar').forEach(avatar => {
        avatar.style.backgroundImage = `url('${currentAvatar}')`;
    });
    
    // 更新个人主页动态中的头像
    document.querySelectorAll('.profile-tweet-avatar').forEach(avatar => {
        avatar.style.backgroundImage = `url('${currentAvatar}')`;
    });
}

// 更新所有评论区域的名字
function updateAllCommentNames() {
    const currentName = getCurrentUserName();
    
    // 更新所有动态中的帖主名字
    document.querySelectorAll('.moment-post-name').forEach(nameElement => {
        nameElement.textContent = currentName;
    });
    
    // 更新个人主页动态中的名字
    document.querySelectorAll('.profile-tweet-name').forEach(nameElement => {
        nameElement.textContent = currentName;
    });
    
    // 更新所有评论中的用户名字
    document.querySelectorAll('.comment-author').forEach(authorElement => {
        authorElement.textContent = currentName;
    });
}


// AI回复评论功能 - 让其他角色回复评论
async function aiReplyToComment(postIndex, userComment) {
    const post = momentPosts[postIndex];
    if (!post) return;
    
    const postAuthor = post.name;
    const currentUser = getCurrentUserName();
    
    // 让动态发布者来回复评论
    const replyCharacter = currentMessages.find(msg => 
        !msg.isGroup && 
        msg.name === postAuthor
    );
    
    if (!replyCharacter) {
        console.log('找不到动态发布者，跳过回复');
        return;
    }
    
    // 检查动态发布者是否已经回复过这个用户的评论
    const userCommentIndex = post.commentList.findIndex(comment => 
        comment.author === currentUser && comment.text === userComment
    );
    
    if (userCommentIndex !== -1) {
        // 检查在这个用户评论之后是否已经回复过
        const hasRepliedAfterUserComment = post.commentList
            .slice(userCommentIndex + 1)
            .some(comment => comment.author === postAuthor);
        
        if (hasRepliedAfterUserComment) {
            console.log(`${postAuthor}已经回复过这个用户评论了，跳过`);
            return;
        }
    }
    
    console.log(`${postAuthor}开始回复评论`);
    
    // 获取回复角色的人设
    const contact = replyCharacter;
    let persona = '';
    if (contact) {
        const contactKey = `contact_${contact.id}`;
        const savedContact = await AppStorage.getItem(contactKey);
        if (savedContact) {
            const contactData = JSON.parse(savedContact);
            persona = contactData.persona || '';
        }
    }
    
    try {
        console.log('开始生成AI回复，用户评论:', userComment);
        console.log('贴主:', postAuthor);
        console.log('AI配置:', aiConfig);
        
        // 调用AI生成回复
        const replyText = await generateAICommentReply(userComment, postAuthor, persona, post.content);
        
        console.log('生成的回复:', replyText);
        
        // 添加AI回复到数据中
        if (!post.commentList) {
            post.commentList = [];
        }
        
        // 使用动态发布者的头像
        const replyAvatar = getCharacterAvatar(postAuthor);
        
        console.log('回复角色:', postAuthor);
        console.log('角色头像:', replyAvatar);
        
        const aiReply = {
            author: postAuthor,
            avatar: replyAvatar,
            text: replyText,
            time: '刚刚'
        };
        post.commentList.push(aiReply);
        
        // 更新评论数
        post.comments++;
        
        // 重新渲染评论区域
        renderComments(postIndex);
        
        // 更新显示
        const commentCount = document.querySelector(`[data-post-id="${postIndex}"] .comment-count`);
        if (commentCount) {
            commentCount.textContent = post.comments;
        }
        
        // 保存动态数据
        await saveMomentData();
        
        // 重新渲染动态时间线以显示AI回复
        renderMomentTimeline();
        
        console.log(`${postAuthor}回复了评论：${replyText}`);
    } catch (error) {
        console.error('AI回复评论失败:', error);
    }
}

// 生成AI评论回复
async function generateAICommentReply(userComment, characterName, persona, postContent, targetUserName = null) {
    try {
        // 检查AI配置
        if (!aiConfig || !aiConfig.apiKey || !aiConfig.model) {
            console.warn('AI配置不完整，使用备用回复');
            return generateFallbackCommentReply(userComment, characterName, targetUserName);
        }
        
        const targetName = targetUserName || (forumProfile && forumProfile.name) || '用户';
        const systemPrompt = `你是${characterName}，请回复以下评论。要求：
1. 回复要自然、真实，像朋友间的互动
2. 长度控制在20字以内
3. 不要使用emoji表情，保持文字表达
4. 要@评论者，格式如：@${targetName} 回复内容
5. 回复要体现对评论的回应和互动
6. 根据评论内容生成相关回复
7. 语言要生动有趣，符合网络用语习惯
8. 可以适当引用评论中的关键词进行回应

原帖子内容：${postContent}
用户评论：${userComment}

请直接输出回复内容，不要其他解释：`;

        console.log('正在调用AI生成评论回复...');
        const aiResponse = await callAIAPI(systemPrompt);
        console.log('AI生成评论回复成功:', aiResponse);
        return aiResponse.trim();
    } catch (error) {
        console.error('AI生成评论回复失败:', error);
        return generateFallbackCommentReply(userComment, characterName);
    }
}

// 备用评论回复生成（当AI调用失败时使用）
function generateFallbackCommentReply(userComment, characterName, targetUserName = null) {
    const targetName = targetUserName || (forumProfile && forumProfile.name) || '用户';
    const replies = [
        `@${targetName} 好棒呀！`,
        `@${targetName} 我也这么觉得~`,
        `@${targetName} 太可爱了！`,
        `@${targetName} 好有趣呢`,
        `@${targetName} 我也想要！`,
        `@${targetName} 不错不错！`,
        `@${targetName} 我也这么想`,
        `@${targetName} 很有道理`,
        `@${targetName} 确实如此`,
        `@${targetName} 我也喜欢`,
        `@${targetName} 太厉害了！`,
        `@${targetName} 好羡慕呀`,
        `@${targetName} 我也想要`,
        `@${targetName} 太棒了！`,
        `@${targetName} 好有趣`,
        `@${targetName} 我也这么觉得`,
        `@${targetName} 太可爱了`,
        `@${targetName} 好厉害`,
        `@${targetName} 我也喜欢这个`,
        `@${targetName} 太棒了`,
        `@${targetName} 很温暖呢`,
        '说得很好',
        '很有感触',
        '确实如此',
        '哈哈，说得对',
        '我也这么认为',
        '太有才了！',
        '好厉害！',
        '我也想要',
        '太棒了！'
    ];
    
    const randomReply = replies[Math.floor(Math.random() * replies.length)];
    const mainCharacterName = getMainCharacterName();
    return `@${mainCharacterName} ${randomReply}`;
}

// 清除预设数据
async function clearPresetData() {
    try {
        await AppStorage.setItem('clearPresetData', 'true');
        console.log('预设数据清除标记已设置');
    } catch (error) {
        console.error('设置清除标记失败:', error);
    }
}

// 数据保存和加载功能（使用AppStorage）
async function saveMomentData() {
    try {
        await AppStorage.setItem('momentPosts', JSON.stringify(momentPosts));
        await AppStorage.setItem('profilePosts', JSON.stringify(profilePosts));
        console.log('动态数据已保存到IndexedDB');
    } catch (error) {
        console.error('保存动态数据失败:', error);
    }
}

async function loadMomentData() {
    try {
        const savedMomentPosts = await AppStorage.getItem('momentPosts');
        const savedProfilePosts = await AppStorage.getItem('profilePosts');
        
        if (savedMomentPosts) {
            const parsedPosts = JSON.parse(savedMomentPosts);
            momentPosts.length = 0; // 清空数组
            momentPosts.push(...parsedPosts);
            console.log('动态数据已从IndexedDB加载:', momentPosts.length, '条动态');
        }
        
        if (savedProfilePosts) {
            profilePosts.length = 0; // 清空数组
            profilePosts.push(...JSON.parse(savedProfilePosts));
            console.log('个人动态数据已从IndexedDB加载:', profilePosts.length, '条动态');
        }
    } catch (error) {
        console.error('加载动态数据失败:', error);
    }
}

// 调试函数：测试数据持久化
async function testDataPersistence() {
    console.log('=== 数据持久化测试 ===');
    
    // 测试保存数据
    const testMoment = {
        id: Date.now(),
        name: '测试用户',
        avatar: 'https://files.catbox.moe/r5s188.jpg',
        content: '这是一条测试动态 - ' + new Date().toLocaleString(),
        timestamp: Date.now(),
        likes: 0,
        comments: []
    };
    
    momentPosts.unshift(testMoment);
    await saveMomentData();
    console.log('✅ 测试动态已保存');
    
    // 测试加载数据
    const savedData = await AppStorage.getItem('momentPosts');
    if (savedData) {
        const parsedData = JSON.parse(savedData);
        console.log('✅ 数据加载成功，共', parsedData.length, '条动态');
        console.log('最新动态:', parsedData[0]?.content);
    } else {
        console.log('❌ 数据加载失败');
    }
    
    // 重新渲染
    renderMomentTimeline();
    console.log('=== 测试完成 ===');
}

// 暴露到全局，方便调试
window.testDataPersistence = testDataPersistence;

// 加载保存的个人信息
function loadProfileData() {
    const name = localStorage.getItem('profile_name');
    const username = localStorage.getItem('profile_username');
    const bio = localStorage.getItem('profile_bio');
    const avatar = localStorage.getItem('profile_avatar');
    const background = localStorage.getItem('profile_background');
    const following = localStorage.getItem('profile_following');
    const followers = localStorage.getItem('profile_followers');
    const likes = localStorage.getItem('profile_likes');
    
    if (name) document.getElementById('profileName').textContent = name;
    if (username) document.getElementById('profileUsername').textContent = username;
    if (bio) document.getElementById('profileBio').textContent = bio;
    if (avatar) document.getElementById('profileAvatar').style.backgroundImage = `url('${avatar}')`;
    if (background) document.getElementById('profileSection').style.backgroundImage = `url('${background}')`;
    if (following) document.getElementById('statFollowing').textContent = following;
    if (followers) document.getElementById('statFollowers').textContent = followers;
    if (likes) document.getElementById('statLikes').textContent = likes;
}

// 打开他人主页
function openOthersProfile(postIndex) {
    playClickSound();
    const post = momentPosts[postIndex];
    
    // 创建他人主页的弹窗
    const modal = document.createElement('div');
    modal.id = 'othersProfileModal';
    modal.className = 'moment-app';
    modal.style.display = 'flex';
    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = '0';
    modal.style.right = '0';
    modal.style.bottom = '0';
    modal.style.zIndex = '10000';
    modal.style.background = '#fff';
    
    modal.innerHTML = `
        <div class="moment-nav">
            <div class="moment-back-btn" onclick="closeOthersProfile()">‹</div>
            <div class="moment-title">个人主页</div>
            <div style="width: 32px;"></div>
        </div>
        
        <div class="moment-page-content" style="display: block;">
            <div class="profile-section" style="background-image: url('${post.background || 'https://files.catbox.moe/fym5yn.png'}');">
                <div class="profile-header-overlay"></div>
                <div class="profile-avatar" style="background-image: url('${post.avatar}');"></div>
            </div>
            <div class="profile-info">
                <div class="profile-name">${post.name}</div>
                <div class="profile-username">${post.username}</div>
                <div class="profile-bio">${post.bio || '这个人很懒，什么都没有写...'}</div>
                <div class="profile-stats">
                    <div class="stat-item">
                        <div class="stat-number">${post.following || Math.floor(Math.random() * 500) + 100}</div>
                        <div>关注中</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${post.followers || Math.floor(Math.random() * 10000) + 1000}</div>
                        <div>追随者</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${post.totalLikes || Math.floor(Math.random() * 100000) + 10000}</div>
                        <div>获得💖</div>
                    </div>
                </div>
            </div>
            <div class="profile-timeline" id="othersProfileTimeline">
                <!-- 他人动态内容将由JavaScript动态生成 -->
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // 渲染他人的动态
    renderOthersProfileTimeline(post.name);
}

// 关闭他人主页
function closeOthersProfile() {
    playClickSound();
    const modal = document.getElementById('othersProfileModal');
    if (modal) {
        modal.remove();
    }
}

// 渲染他人主页动态
function renderOthersProfileTimeline(userName) {
    const timeline = document.getElementById('othersProfileTimeline');
    if (!timeline) return;
    
    timeline.innerHTML = '';
    
    // 筛选出该用户的所有动态
    const userPosts = momentPosts.filter(post => post.name === userName);
    
    userPosts.forEach(post => {
        const postElement = document.createElement('div');
        postElement.className = 'profile-tweet';
        
        let imageHtml = '';
        if (post.image) {
            imageHtml = `<div class="profile-tweet-image" style="background-image: url('${post.image}');"></div>`;
        }
        
        postElement.innerHTML = `
            <div class="profile-tweet-header">
                <div class="profile-tweet-avatar" style="background-image: url('${post.avatar}');"></div>
                <div class="profile-tweet-info">
                    <div class="profile-tweet-name">${post.name}</div>
                    <div class="profile-tweet-username">${post.username}</div>
                </div>
            </div>
            <div class="profile-tweet-content">${post.content}</div>
            ${imageHtml}
            <div class="profile-tweet-actions">
                <div class="profile-tweet-action">♥ ${post.likes}</div>
                <div class="profile-tweet-action">↺ ${post.shares}</div>
                <div class="profile-tweet-action">✧ ${post.comments}</div>
            </div>
        `;
        
        timeline.appendChild(postElement);
    });
    
    // 如果没有动态，显示提示
    if (userPosts.length === 0) {
        timeline.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">还没有发布过动态</div>';
    }
}

// 事件监听器
document.addEventListener('DOMContentLoaded', async () => {
    // 初始化应用
    await initializeApp();
    
    // AI提供商选择
    document.querySelectorAll('.ai-provider-option').forEach(option => {
        option.addEventListener('click', () => {
            const provider = option.dataset.provider;
            selectAIProvider(provider);
        });
    });
    
    // 点击弹窗外部关闭
    document.getElementById('aiConfigModal').addEventListener('click', (e) => {
        if (e.target.id === 'aiConfigModal') {
            closeAIConfig();
        }
    });
    
    // 联系人设置标签切换
    document.querySelectorAll('.contact-settings-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const tabType = tab.dataset.tab;
            
            // 切换标签状态
            document.querySelectorAll('.contact-settings-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            // 切换表单显示
            document.querySelectorAll('.contact-settings-form').forEach(form => form.classList.remove('show'));
            document.getElementById(tabType + 'Form').classList.add('show');
        });
    });
    
    // 壁纸选择
    document.querySelectorAll('.contact-wallpaper-option').forEach(option => {
        option.addEventListener('click', () => {
            document.querySelectorAll('.contact-wallpaper-option').forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
        });
    });
    
    // 头像上传
    document.getElementById('contactAvatarInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('contactAvatarPreview').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });
    
    // 加好友头像上传
    document.getElementById('friend-avatar').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            // 检查文件类型
            if (!file.type.startsWith('image/')) {
                alert('请选择图片文件！');
                return;
            }
            
            // 检查文件大小（限制为5MB）
            if (file.size > 5 * 1024 * 1024) {
                alert('图片文件大小不能超过5MB！');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('friend-avatar-preview').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });
    
    document.getElementById('selfAvatarInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('selfAvatarPreview').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });
    
    // 点击联系人设置弹窗外部关闭
    document.getElementById('contactSettingsModal').addEventListener('click', (e) => {
        if (e.target.id === 'contactSettingsModal') {
            closeContactSettings();
        }
    });
    
    // 群聊头像上传
    document.getElementById('groupAvatarInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('groupAvatarPreview').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });
    
    // 点击群聊设置弹窗外部关闭
    document.getElementById('groupSettingsModal').addEventListener('click', (e) => {
        if (e.target.id === 'groupSettingsModal') {
            closeGroupSettings();
        }
    });
    
    // 点击添加成员弹窗外部关闭
    document.getElementById('addMemberModal').addEventListener('click', (e) => {
        if (e.target.id === 'addMemberModal') {
            closeAddMemberModal();
        }
    });
    
    // 点击群聊壁纸弹窗外部关闭
    document.getElementById('groupWallpaperModal').addEventListener('click', (e) => {
        if (e.target.id === 'groupWallpaperModal') {
            closeGroupWallpaperModal();
        }
    });
    
    // 初始化聊天输入框
    initChatInput();
});

// 私聊界面功能
let currentChatContact = null;
let chatMessages = [];

// 加载更多消息功能相关变量
const MESSAGE_RENDER_WINDOW = 20; // 每次渲染的消息数量
let currentRenderedCount = 0; // 当前已渲染的消息数量

// 获取当前联系人ID
function getCurrentContactId() {
    return currentChatContact ? currentChatContact.id : null;
}

// 保存聊天消息到IndexedDB
async function saveChatMessages(contactId, messages) {
    try {
        const chatKey = `chat_${contactId}`;
        await AppStorage.setItem(chatKey, JSON.stringify(messages));
    } catch (error) {
        console.error('保存聊天消息失败:', error);
    }
}

// 从IndexedDB加载聊天消息
async function loadChatMessages(contactId) {
    try {
        const chatKey = `chat_${contactId}`;
        const savedChat = await AppStorage.getItem(chatKey);
        if (savedChat) {
            return JSON.parse(savedChat);
        }
        return [];
    } catch (error) {
        console.error('加载聊天消息失败:', error);
        return [];
    }
}

async function openChatApp(contact) {
    // 如果是非群聊联系人，从IndexedDB加载保存的数据
    if (!contact.isGroup) {
        const contactKey = `contact_${contact.id}`;
        const savedContact = await AppStorage.getItem(contactKey);
        if (savedContact) {
            const contactData = JSON.parse(savedContact);
            contact.avatar = contactData.avatar || contact.avatar;
            contact.name = contactData.name || contact.name;
        }
    } else {
        // 如果是群聊，从IndexedDB加载群聊数据
        const groupKey = `group_${contact.id}`;
        const savedGroup = await AppStorage.getItem(groupKey);
        if (savedGroup) {
            const groupData = JSON.parse(savedGroup);
            contact.avatar = groupData.avatar || contact.avatar;
            contact.name = groupData.name || contact.name;
        }
    }
    
    currentChatContact = contact;
    const chatApp = document.getElementById('chatApp');
    const chatContactName = document.getElementById('chatContactName');
    const chatContactAvatar = document.getElementById('chatContactAvatar');
    
    // 设置联系人信息
    chatContactName.textContent = contact.name;
    chatContactAvatar.src = contact.avatar || 'https://placehold.co/40x40/E8E8E8/999?text=头像';
    
    // 显示私聊界面
    chatApp.classList.add('show');
    
    // 🚀 新增：清除未读消息数量
    const messageInList = currentMessages.find(m => m.id === contact.id);
    if (messageInList && messageInList.unread > 0) {
        messageInList.unread = 0;
        console.log(`📱 进入聊天界面，清除未读消息数量`);
        // 重新渲染消息列表以更新显示
        await renderMessagesList();
    }
    
    // 根据聊天类型显示不同的设置按钮
    const settingsBtn = document.querySelector('.chat-settings-btn');
    if (contact.isGroup) {
        settingsBtn.style.display = 'flex';
        settingsBtn.onclick = () => openGroupSettings();
    } else {
        settingsBtn.style.display = 'flex';
        settingsBtn.onclick = () => openContactSettings();
    }
    
    // 渲染聊天消息
    renderChatMessages();
    
    // 检查是否有待处理的AI回复
    setTimeout(async () => {
        const pendingResponse = await checkPendingAIResponse(contact.id);
        if (pendingResponse) {
            console.log('发现待处理的AI回复，正在显示...');
            await renderAndSaveAIReplies(pendingResponse);
        }
    }, 500);
}

// 🚀 优化：退出聊天时保存所有数据
async function closeChatApp() {
    playClickSound();
    
    // 保存当前聊天的消息（如果有当前聊天联系人）
    if (currentChatContact && chatMessages && chatMessages.length > 0) {
        console.log(`💾 正在保存与 ${currentChatContact.name} 的聊天记录...`);
        try {
            // 保存聊天消息
            await saveChatMessages(currentChatContact.id, chatMessages);
            console.log(`✅ 聊天记录保存成功！共 ${chatMessages.length} 条消息`);
            
            // 保存消息列表
            await saveMessagesData();
            console.log('✅ 消息列表保存成功！');
        } catch (error) {
            console.error('❌ 保存失败:', error);
        }
    }
    
    const chatApp = document.getElementById('chatApp');
    chatApp.classList.remove('show');
    
    // 🚀 修复：不立即清空currentChatContact，让AI在后台继续生成
    // 延迟清空，给AI足够时间完成生成
    setTimeout(() => {
        currentChatContact = null;
    }, 10000); // 10秒后清空，足够AI完成生成
}

async function renderChatMessages() {
    const chatMessagesContainer = document.getElementById('chatMessages');
    
    // 获取自己的头像
    const selfAvatar = await getSelfAvatar();
    
    // 从IndexedDB加载保存的聊天消息
    let messages = await loadChatMessages(currentChatContact.id);
    
    // 不再注入任何示例消息；保持空对话由用户开始
    if (messages.length > 0) {
        // 更新消息中的头像（确保使用最新的头像）
        messages = messages.map(msg => ({
            ...msg,
            avatar: (msg.sender === 'sent' || msg.isFromUser) ? selfAvatar : currentChatContact.avatar
        }));
    }
    
    // 保留所有消息，但使用虚拟滚动优化性能
    
    // 保存更新后的消息
    chatMessages = messages;
    
    chatMessagesContainer.innerHTML = '';
    
    // 分页加载逻辑：只渲染最新的消息（性能优化）
    const totalMessages = messages.length;
    currentRenderedCount = 0;
    
    // 分页加载优化：只渲染最新的消息，大幅提升性能
    const MESSAGES_PER_PAGE = 20; // 每页20条消息，参考其他老师的优化
    const maxRenderMessages = MESSAGES_PER_PAGE;
    const initialMessages = messages.length > maxRenderMessages 
        ? messages.slice(-maxRenderMessages) 
        : messages;
    
    // 使用DocumentFragment优化性能，参考其他老师的实现
    const fragment = document.createDocumentFragment();
    initialMessages.forEach(message => {
        const messageElement = document.createElement('div');
        // 系统提示（例如撤回/拍一拍）
        if (message.recalled === true) {
            const tip = document.createElement('div');
            tip.className = 'message-system';
            tip.textContent = '你撤回了一条消息';
            chatMessagesContainer.appendChild(tip);
            return;
        }
        if (message.type === 'system') {
            const tip = document.createElement('div');
            tip.className = 'message-system';
            tip.textContent = message.content || '';
            chatMessagesContainer.appendChild(tip);
            return;
        }
        messageElement.className = `message ${message.sender}`;
        
        let contentHTML = '';
        
        // 根据消息类型渲染不同内容
        if (message.image) {
            // 图片消息
            contentHTML = `
                <div class="message-image">
                    <img src="${message.image}" alt="图片" class="message-image-content" onclick="openImageLightbox('${message.image}')">
                </div>
                ${message.content ? `<div class="message-text">${message.content}</div>` : ''}
            `;
        } else if (message.type === 'transfer') {
            // 转账消息
            const amount = message.content.match(/¥(\d+\.?\d*)/)?.[1] || '0.00';
            const note = message.content.match(/备注：(.+)/)?.[1] || '';
            contentHTML = `
                <div class="message-transfer">
                    <div class="transfer-row">
                        <div class="transfer-icon">+</div>
                        <div class="transfer-amount">¥ ${amount}</div>
                    </div>
                    <div class="transfer-status">已转账给${currentChatContact ? currentChatContact.name : '对方'}</div>
                    ${note ? `<div class="transfer-note">备注：${note}</div>` : ''}
                </div>
            `;
        } else if (message.type === 'location') {
            // 定位消息
            const address = message.content.replace('📍 ', '');
            const title = address;
            contentHTML = `
                <div class="message-location">
                    <div class="location-card">
                        <div class="location-card-header">
                            <div class="location-card-title">${title}</div>
                            <div class="location-card-subtitle">已发送位置</div>
                        </div>
                        <div class="location-card-body">
                            ${message.image ? `<img src="${message.image}" alt="位置图片" class="location-card-image" onclick=\"openImageLightbox('${message.image}')\">` : `<div class="location-card-placeholder">？ ？</div>`}
                        </div>
                    </div>
                </div>
            `;
        } else if (message.type === 'food_order') {
            // 点外卖消息
            const name = message.content.match(/🍔 (.+)/)?.[1] || '外卖订单';
            const amount = message.content.match(/¥(\d+\.?\d*)/)?.[1] || '0.00';
            contentHTML = `
                <div class="message-food-order">
                    <div class="food-order-header">
                        <div class="food-order-icon">🍔</div>
                        <div class="food-order-info">
                            <div class="food-order-name">${name}</div>
                            <div class="food-order-price">¥ ${amount}</div>
                        </div>
                    </div>
                    <div class="food-order-status">已发送外卖订单</div>
                    ${message.image ? `<div class="food-order-image"><img src="${message.image}" alt="食物图片" class="food-order-image-content" onclick=\"openImageLightbox('${message.image}')\"></div>` : ''}
                </div>
            `;
        } else if (message.type === 'emotion') {
            // 表情包消息
            contentHTML = `
                <div class="message-emotion">
                    <div class="emotion-image-container">
                        <img src="${message.emotionUrl}" alt="${message.emotionName}" class="emotion-image" onerror="this.style.display='none'">
                    </div>
                </div>
            `;
        } else if (message.type === 'voice') {
            // 语音消息
            const approxSec = message.duration || Math.max(3, Math.min(59, Math.round((message.content || '').length / 6)));
            const voiceId = `voice_${message.id}`;
            contentHTML = `
                <div class="message-voice-container">
                    <div class="message-voice">
                        <div class="voice-play-btn" onclick="toggleVoiceText('${voiceId}')">
                            <div class="voice-play-icon"></div>
                        </div>
                        <div class="voice-waveform">
                            <div class="voice-bar"></div>
                            <div class="voice-bar"></div>
                            <div class="voice-bar"></div>
                            <div class="voice-bar"></div>
                            <div class="voice-bar"></div>
                            <div class="voice-bar"></div>
                            <div class="voice-bar"></div>
                        </div>
                        <div class="voice-duration">${approxSec}"</div>
                    </div>
                    <div class="voice-text-content" id="${voiceId}" style="display: none;">
                        <div class="voice-text">${message.content}</div>
                    </div>
                </div>
            `;
        } else if (message.type === 'image') {
            // 图片消息
            const imageId = `image_${message.id}`;
            contentHTML = `
                <div class="message-image-container" id="${imageId}">
                    <div class="random-image-container" style="display: inline-block; position: relative; min-width: 100px; max-width: 100%; min-height: 100px; max-height: 130px; border: 2px solid transparent; border-radius: 15px; margin: 0 0 -6px 0; overflow-y: auto; box-shadow: 0 4px 8px rgba(255, 182, 193, 0.4); background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(5px);" data-random-image>
                        <details style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer;">
                            <summary style="list-style: none; width: 100%; height: 100%;"></summary>
                            <div style="position: absolute; top: 2px; left: 2px; right: 2px; background: linear-gradient(135deg, rgba(255, 192, 203, 0.4), rgba(255, 182, 193, 0.4)); color: #333333; padding: 8px; border-radius: 12px; text-align: center; z-index: 0; box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.5);">
                                <div style="border: 1px solid rgba(255, 192, 203, 0.3); padding: 12px 8px; width: calc(100% - 3px); text-align: center; word-wrap: break-word; border-radius: 10px; background: rgba(255, 255, 255, 0.98); box-shadow: inset 0 0 8px rgba(255, 192, 203, 0.2);">
                                    <p style="margin: 0; font-family: 'Comic Sans MS', cursive; font-size: 11px; text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);">${message.content}</p>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
            `;
        } else if (message.type === 'video') {
            // 视频消息
            const videoId = `video_${message.id}`;
            const duration = Math.max(10, Math.min(300, Math.round(message.content.length / 3))); // 根据描述长度估算时长
            contentHTML = `
                <div class="message-video-container" id="${videoId}">
                    <div class="video-thumbnail" style="position: relative; width: 200px; height: 120px; border-radius: 12px; overflow: hidden; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);">
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.3); display: flex; align-items: center; justify-content: center;">
                            <div class="video-play-btn" style="width: 50px; height: 50px; background: rgba(255, 255, 255, 0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease;">
                                <div style="width: 0; height: 0; border-left: 15px solid #333; border-top: 10px solid transparent; border-bottom: 10px solid transparent; margin-left: 3px;"></div>
                            </div>
                        </div>
                        <div style="position: absolute; bottom: 8px; right: 8px; background: rgba(0, 0, 0, 0.7); color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">
                            ${Math.floor(duration / 60)}:${String(duration % 60).padStart(2, '0')}
                        </div>
                        <div style="position: absolute; top: 8px; left: 8px; right: 8px; background: rgba(0, 0, 0, 0.6); color: white; padding: 4px 8px; border-radius: 6px; font-size: 11px; text-align: center;">
                            ${message.content}
                        </div>
                    </div>
                </div>
            `;
        } else if (message.type === 'file') {
            // 文件消息
            const fileId = `file_${message.id}`;
            const title = message.fileTitle || message.content.split('|')[0] || '文件';
            const size = message.fileSize || message.content.split('|')[1] || '0KB';
            const content = message.fileContent || message.content.split('|')[2] || '';
            const fileExtension = title.split('.').pop()?.toLowerCase() || 'file';
            
            // 根据文件类型选择图标
            let fileIcon = '📄';
            if (['pdf'].includes(fileExtension)) fileIcon = '📕';
            else if (['doc', 'docx'].includes(fileExtension)) fileIcon = '📘';
            else if (['xls', 'xlsx'].includes(fileExtension)) fileIcon = '📗';
            else if (['ppt', 'pptx'].includes(fileExtension)) fileIcon = '📙';
            else if (['txt'].includes(fileExtension)) fileIcon = '📄';
            else if (['zip', 'rar', '7z'].includes(fileExtension)) fileIcon = '🗜️';
            else if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExtension)) fileIcon = '🖼️';
            else if (['mp4', 'avi', 'mov'].includes(fileExtension)) fileIcon = '🎬';
            else if (['mp3', 'wav', 'flac'].includes(fileExtension)) fileIcon = '🎵';
            
            contentHTML = `
                <div class="message-file-container" id="${fileId}">
                    <div class="file-card" style="background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 12px; max-width: 280px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); cursor: pointer;" onclick="toggleFileContent('${fileId}')">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 32px;">${fileIcon}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; font-size: 14px; color: #333; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${title}</div>
                                <div style="font-size: 12px; color: #666;">${size}</div>
                            </div>
                            <div style="color: #999; font-size: 12px;">点击查看</div>
                        </div>
                        <div class="file-content" id="file_content_${fileId}" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid #f0f0f0;">
                            <div style="background: #f8f9fa; padding: 8px; border-radius: 6px; font-size: 13px; line-height: 1.4; color: #333;">${content}</div>
                        </div>
                    </div>
                </div>
            `;
        } else if (message.type === 'weather') {
            // 天气消息
            const weatherId = `weather_${message.id}`;
            const city = message.weatherCity || message.content.split('|')[0] || '未知城市';
            const temperature = message.weatherTemperature || message.content.split('|')[1] || '0°C';
            const condition = message.weatherCondition || message.content.split('|')[2] || '未知';
            
            // 根据天气状况选择图标
            let weatherIcon = '☀️';
            if (condition.includes('雨') || condition.includes('雷')) weatherIcon = '🌧️';
            else if (condition.includes('雪')) weatherIcon = '❄️';
            else if (condition.includes('云') || condition.includes('阴')) weatherIcon = '☁️';
            else if (condition.includes('雾') || condition.includes('霾')) weatherIcon = '🌫️';
            else if (condition.includes('晴')) weatherIcon = '☀️';
            else if (condition.includes('风')) weatherIcon = '💨';
            
            contentHTML = `
                <div class="message-weather-container" id="${weatherId}">
                    <div class="weather-card" style="background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); color: white; border-radius: 16px; padding: 16px; max-width: 280px; box-shadow: 0 4px 12px rgba(116, 185, 255, 0.3);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                            <div>
                                <div style="font-size: 18px; font-weight: 600; margin-bottom: 4px;">${city}</div>
                                <div style="font-size: 12px; opacity: 0.9;">${new Date().toLocaleDateString('zh-CN', { month: 'long', day: 'numeric' })}</div>
                            </div>
                            <div style="font-size: 36px;">${weatherIcon}</div>
                        </div>
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="font-size: 32px; font-weight: 300;">${temperature}</div>
                            <div style="font-size: 14px; opacity: 0.9; text-align: right;">
                                <div>${condition}</div>
                                <div style="font-size: 11px; margin-top: 2px;">天气信息</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else if (message.type === 'forum_forward') {
            // 转发论坛帖子消息
            const post = message.originalPost;
            contentHTML = `
                <div class="message-forum-card">
                    <div class="message-forum-title">${post.title || '无标题'}</div>
                    <div class="message-forum-content">${post.content}</div>
                    <div class="message-forum-footer">
                        <span class="message-forum-author">@${post.author}</span>
                        <span class="message-forum-time">${post.time}</span>
                        <div class="message-forum-stats">
                            <span class="message-forum-likes">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>
                                </svg>
                                ${post.likes || 0}
                            </span>
                            <span class="message-forum-comments">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                </svg>
                                ${post.comments || 0}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        } else if (message.type === 'chat_history') {
            // 聊天记录消息
            contentHTML = renderChatHistoryMessage(message.content);
        } else {
            // 普通文本消息
            const replyBlock = message.replyTo ? `
                <div class="reply-block">
                    <div class="reply-block-title">${message.replyTo.senderName || '对方'}</div>
                    <div class="reply-block-text">${message.replyTo.text || '[卡片消息]'}</div>
                </div>
            ` : '';
            
            // 检查是否是定位相关的文本消息，如果是则渲染为定位卡片
            if (message.content.includes('📍') || message.content.includes('位置') || message.content.includes('地址') || message.content.includes('定位')) {
                const address = message.content.replace(/📍\s*/, '');
                contentHTML = `
                    <div class="message-location">
                        <div class="location-card">
                            <div class="location-card-header">
                                <div class="location-card-title">${address}</div>
                                <div class="location-card-subtitle">已发送位置</div>
                            </div>
                            <div class="location-card-body">
                                <div class="location-card-placeholder">？ ？</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
            contentHTML = `${replyBlock}<div class="message-content">${message.content}</div>`;
            }
        }
        
        messageElement.innerHTML = `
            <img src="${message.avatar}" alt="" class="message-avatar">
            <div class="message-wrapper">
                ${contentHTML}
                <div class="message-time">${message.time}</div>
            </div>
        `;
        // 多选圆圈
        const circle = document.createElement('div');
        circle.className = 'select-circle';
        messageElement.appendChild(circle);
        
        // 添加到fragment中，而不是直接添加到容器
        fragment.appendChild(messageElement);
        // 绑定长按事件
        bindLongPress(messageElement, message);
        // 双击头像：系统提示"你拍了拍对方的头像"
        const avatarEl = messageElement.querySelector('.message-avatar');
        if (avatarEl) {
            avatarEl.addEventListener('dblclick', () => {
                const tipText = (message.sender === 'sent') ? '你拍了拍自己的头像' : '你拍了拍对方的头像';
                addSystemTip(tipText);
            });
        }
    });
    
    // 一次性添加所有消息到容器，大幅提升性能
    chatMessagesContainer.appendChild(fragment);
    
    // 更新已渲染的消息数量
    currentRenderedCount = initialMessages.length;
    
    // 如果还有更多消息，添加"加载更多"按钮
    if (totalMessages > currentRenderedCount) {
        prependLoadMoreButton(chatMessagesContainer);
    }
    
    // 滚动到底部
    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
    
    // 为图片消息设置随机背景
    setTimeout(() => {
        const imageContainers = document.querySelectorAll('.message-image-container .random-image-container[data-random-image]');
        imageContainers.forEach(container => {
            if (!container.style.background) {
                const images = [
                    'https://files.catbox.moe/0g3kqu.jpg',
                    'https://files.catbox.moe/d5b7k6.jpg',
                    'https://files.catbox.moe/0yrhh6.jpg',
                    'https://files.catbox.moe/8mjvdg.jpg',
                    'https://files.catbox.moe/fvidas.jpg',
                    'https://files.catbox.moe/q6so2i.jpg',
                    'https://files.catbox.moe/5a96cp.jpg',
                    'https://files.catbox.moe/0mp6h0.jpg',
                    'https://files.catbox.moe/epcn03.jpg',
                    'https://files.catbox.moe/7jzdp7.jpg',
                    'https://files.catbox.moe/jrmu6w.jpg',
                    'https://files.catbox.moe/c0bwhn.jpg',
                    'https://files.catbox.moe/0blxme.jpg',
                    'https://files.catbox.moe/qicobr.jpg',
                    'https://files.catbox.moe/n94ztu.jpg'
                ];
                const randomImage = images[Math.floor(Math.random() * images.length)];
                container.style.background = `url('${randomImage}') center/cover`;
            }
        });
    }, 100);
}

// 添加"加载更多"按钮
function prependLoadMoreButton(container) {
    const button = document.createElement('button');
    button.id = 'load-more-btn';
    button.textContent = '加载更早的记录';
    button.addEventListener('click', loadMoreMessages);
    container.prepend(button);
}

// 加载更多消息
async function loadMoreMessages() {
    const chatMessagesContainer = document.getElementById('chatMessages');
    if (!currentChatContact) return;
    
    // 移除旧的"加载更多"按钮
    const loadMoreBtn = document.getElementById('load-more-btn');
    if (loadMoreBtn) loadMoreBtn.remove();
    
    const totalMessages = chatMessages.length;
    const nextSliceStart = totalMessages - currentRenderedCount - MESSAGE_RENDER_WINDOW;
    const nextSliceEnd = totalMessages - currentRenderedCount;
    const messagesToPrepend = chatMessages.slice(Math.max(0, nextSliceStart), nextSliceEnd);
    
    // 记录滚动高度，用于保持滚动位置
    const oldScrollHeight = chatMessagesContainer.scrollHeight;
    
    // 将消息添加到容器前面
    for (const message of messagesToPrepend.reverse()) {
        await prependMessage(message);
    }
    
    // 更新已渲染计数
    currentRenderedCount += messagesToPrepend.length;
    
    // 保持滚动位置不变
    const newScrollHeight = chatMessagesContainer.scrollHeight;
    chatMessagesContainer.scrollTop += (newScrollHeight - oldScrollHeight);
    
    // 如果还有更多消息，继续显示按钮
    if (totalMessages > currentRenderedCount) {
        prependLoadMoreButton(chatMessagesContainer);
    }
}

// 在消息容器前面添加单条消息
async function prependMessage(message) {
    const chatMessagesContainer = document.getElementById('chatMessages');
    const messageElement = document.createElement('div');
    
    // 系统提示（例如撤回/拍一拍）
    if (message.recalled === true) {
        const tip = document.createElement('div');
        tip.className = 'message-system';
        tip.textContent = '你撤回了一条消息';
        chatMessagesContainer.prepend(tip);
        return;
    }
    if (message.type === 'system') {
        const tip = document.createElement('div');
        tip.className = 'message-system';
        tip.textContent = message.content || '';
        chatMessagesContainer.prepend(tip);
        return;
    }
    
    messageElement.className = `message ${message.sender}`;
    
    let contentHTML = '';
    
    // 根据消息类型渲染不同内容
    if (message.image) {
        // 图片消息
        contentHTML = `
            <div class="message-image">
                <img src="${message.image}" alt="图片" class="message-image-content" onclick="openImageLightbox('${message.image}')">
            </div>
            ${message.content ? `<div class="message-text">${message.content}</div>` : ''}
        `;
    } else if (message.type === 'transfer') {
        // 转账消息
        const amount = message.content.match(/¥(\d+\.?\d*)/)?.[1] || '0.00';
        const note = message.content.match(/备注：(.+)/)?.[1] || '';
        contentHTML = `
            <div class="message-transfer">
                <div class="transfer-row">
                    <div class="transfer-icon">+</div>
                    <div class="transfer-amount">¥ ${amount}</div>
                </div>
                <div class="transfer-status">已转账给${currentChatContact ? currentChatContact.name : '对方'}</div>
                ${note ? `<div class="transfer-note">备注：${note}</div>` : ''}
            </div>
        `;
    } else if (message.type === 'location') {
        // 定位消息
        const address = message.content.replace('📍 ', '');
        const title = address;
        contentHTML = `
            <div class="message-location">
                <div class="location-card">
                    <div class="location-card-header">
                        <div class="location-card-title">${title}</div>
                        <div class="location-card-subtitle">已发送位置</div>
                    </div>
                    <div class="location-card-body">
                        ${message.image ? `<img src="${message.image}" alt="位置图片" class="location-card-image" onclick=\"openImageLightbox('${message.image}')\">` : `<div class="location-card-placeholder">？ ？</div>`}
                    </div>
                </div>
            </div>
        `;
    } else if (message.type === 'food_order') {
        // 点外卖消息
        const name = message.content.match(/🍔 (.+)/)?.[1] || '外卖订单';
        const amount = message.content.match(/¥(\d+\.?\d*)/)?.[1] || '0.00';
        contentHTML = `
            <div class="message-food-order">
                <div class="food-order-header">
                    <div class="food-order-icon">🍔</div>
                    <div class="food-order-info">
                        <div class="food-order-name">${name}</div>
                        <div class="food-order-price">¥ ${amount}</div>
                    </div>
                </div>
                <div class="food-order-status">已发送外卖订单</div>
                ${message.image ? `<div class="food-order-image"><img src="${message.image}" alt="食物图片" class="food-order-image-content" onclick=\"openImageLightbox('${message.image}')\"></div>` : ''}
            </div>
        `;
    } else if (message.type === 'voice') {
        // 语音消息
        contentHTML = `
            <div class="message-voice">
                <div class="voice-icon">🎵</div>
                <div class="voice-content">${message.content}</div>
            </div>
        `;
    } else {
        // 普通文本消息
        let replyBlock = '';
        if (message.replyTo) {
            const replyMsg = chatMessages.find(m => m.id === message.replyTo);
            if (replyMsg) {
                const replyContent = replyMsg.content.length > 20 ? replyMsg.content.substring(0, 20) + '...' : replyMsg.content;
                replyBlock = `<div class="message-reply">回复 ${replyMsg.sender === 'sent' ? '你' : currentChatContact.name}: ${replyContent}</div>`;
            }
        }
        
        if (message.image) {
            contentHTML = `
                <div class="message-image-container">
                    <div class="random-image-container" data-random-image="true">
                        <img src="${message.image}" alt="图片" class="message-image-content" onclick="openImageLightbox('${message.image}')">
                    </div>
                </div>
                ${replyBlock}
                ${message.content ? `<div class="message-text">${message.content}</div>` : ''}
            `;
        } else {
            contentHTML = `${replyBlock}<div class="message-content">${message.content}</div>`;
        }
    }
    
    messageElement.innerHTML = `
        <img src="${message.avatar}" alt="" class="message-avatar">
        <div class="message-wrapper">
            ${contentHTML}
            <div class="message-time">${message.time}</div>
        </div>
    `;
    
    // 添加消息ID属性，用于多选功能
    messageElement.setAttribute('data-message-id', message.id);
    
    // 多选圆圈
    const circle = document.createElement('div');
    circle.className = 'select-circle';
    messageElement.appendChild(circle);
    
    chatMessagesContainer.prepend(messageElement);
    
    // 绑定长按事件
    bindLongPress(messageElement, message);
    
    // 绑定多选点击事件
    messageElement.addEventListener('click', (e) => {
        if (isMultiSelectMode) {
            e.preventDefault();
            e.stopPropagation();
            toggleMessageSelection(message.id);
        }
    });
    
    // 双击头像：系统提示"你拍了拍对方的头像"
    const avatarEl = messageElement.querySelector('.message-avatar');
    if (avatarEl) {
        avatarEl.addEventListener('dblclick', () => {
            const tipText = (message.sender === 'sent') ? '你拍了拍自己的头像' : '你拍了拍对方的头像';
            addSystemTip(tipText);
            // 播放点击头像音效
            playAvatarSound();
        });
    }
}

// 发送单条消息（不触发AI回复）
async function sendSingleMessage() {
    const inputField = document.getElementById('chatInputField');
    const message = inputField.value.trim();
    
    if (!message) return;
    
    playSendSound();
    
    const chatMessagesContainer = document.getElementById('chatMessages');
    const currentTime = `${new Date().getHours()}:${String(new Date().getMinutes()).padStart(2, '0')}`;
    
    // 获取自己的头像
    const selfAvatar = await getSelfAvatar();
    
    // 创建新消息元素
    const messageElement = document.createElement('div');
    messageElement.className = 'message sent';
    
    const replyPreview = window.__replyTarget ? `
        <div class=\"reply-block\">
            <div class=\"reply-block-title\">${window.__replyTarget.senderName || '对方'}</div>
            <div class=\"reply-block-text\">${window.__replyTarget.text || '[卡片消息]'}<\/div>
        <\/div>
    ` : '';

    messageElement.innerHTML = `
        <img src="${selfAvatar}" alt="" class="message-avatar">
        <div class="message-wrapper">
            ${replyPreview}
            <div class="message-content">${message}</div>
            <div class="message-time">${currentTime}</div>
        </div>
    `;
    
    chatMessagesContainer.appendChild(messageElement);
    
    // 保存发送的消息到chatMessages数组
    const newMessage = {
        id: Date.now(),
        sender: 'sent',
        content: message,
        time: currentTime,
        avatar: selfAvatar,
        replyTo: window.__replyTarget || null
    };
    chatMessages.push(newMessage);
    
    // 保存到IndexedDB
    await saveChatMessages(currentChatContact.id, chatMessages);
    
    // 清空输入框与引用目标
    inputField.value = '';
    clearReplyTarget();
    
    // 只有在用户明确想要AI回复时才检查API状态
    // 这里不显示提醒，因为用户可能只是想发送普通消息
    
    // 滚动到底部
    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
}

// 🚀 优化：发送完成按钮 - 触发AI回复
async function sendComplete() {
    const inputField = document.getElementById('chatInputField');
    if (!inputField) return;
    
    const content = inputField.value.trim();
    
    // 如果有输入内容，先发送消息
    if (content) {
        // 调用优化后的发送函数（在initChatInputOptimized中定义）
        const sendMessage = window.__optimizedSendMessage;
        if (sendMessage) {
            sendMessage();
            return; // AI回复会在sendMessage中自动触发
        }
    }
    
    // 检查是否有新消息需要AI回复
    const recentMessages = chatMessages.filter(msg => 
        msg.sender === 'sent' && 
        (Date.now() - msg.id) < 10000 // 最近10秒内的消息
    );
    
    if (recentMessages.length === 0) {
        // 没有新消息，直接返回
        return;
    }
    
    playSendSound();
    
    // 显示正在输入
    setChatTyping(true);
    
    // 检查是否需要自动生成日记
    setTimeout(() => {
        autoGenerateDiary();
    }, 2000); // 延迟2秒检查，避免影响AI回复
    
    // 获取最近发送的消息内容
    const messagesToSend = recentMessages.map(msg => msg.content).join('\n');
    
    // 检查是否有图片消息
    const hasImageMessage = recentMessages.some(msg => msg.image);
    const imageData = hasImageMessage ? recentMessages.find(msg => msg.image)?.image : null;
    
    try {
        let replyText;
        if (aiConfig.provider && aiConfig.apiKey && aiConfig.model && aiConfig.status === 'connected') {
            // 如果有图片，使用AI识图功能
            if (hasImageMessage && imageData) {
                console.log('检测到图片消息，使用AI识图功能...');
                const aiReply = await recognizeImageWithAI(imageData, messagesToSend);
                replyText = aiReply;
            } else {
                // 普通文字消息，使用常规AI回复
                const aiReply = await sendAIMessage(messagesToSend);
                replyText = aiReply;
            }
            
            // 如果AI回复为null，说明任务已加入队列，显示提示
            if (!replyText) {
                showAPIReminder('AI正在思考中', 'AI正在后台处理您的消息，您可以切换到其他页面，完成后会自动显示回复');
                return; // 不继续处理，等待后台处理
            }
        } else {
            // 没有连接AI时，显示提醒
            showAPIReminder('未连接AI服务', '请先配置AI服务才能获得智能回复');
            replyText = null;
        }
        
        // 只有当有AI回复时才处理
        if (replyText && currentChatContact) {
        // 解析动作块并执行；剩余文本用于逐条发送
        const { cleanText, actions } = parseAndExtractAIActions(replyText);
        const fallbackActs = actions && actions.length ? [] : detectFallbackActionsFromText(cleanText);
        await executeAIActions(actions && actions.length ? actions : fallbackActs);
        await renderAndSaveAIReplies(cleanText);
        
        // 检查是否应该发送表情包
        if (shouldSendEmotion(cleanText)) {
            console.log('AI回复触发表情包发送检查');
            console.log('AI回复内容:', cleanText);
            
            // 智能选择表情包：根据AI回复内容和表情包名称匹配
            const emotion = selectEmotionByContent(cleanText);
            
            if (emotion) {
                console.log('智能选择表情包:', emotion);
                // 延迟发送表情包，让文字消息先显示
                setTimeout(async () => {
                    await sendAIEmotion(emotion);
                }, 1000);
            } else {
                console.log('没有找到合适的表情包');
            }
        } else {
            console.log('AI回复未触发表情包发送');
        }
        }
        
        // AI发动态功能 - 聊天触发
        if (currentChatContact && !currentChatContact.isGroup) {
            await aiPublishMomentFromChat(currentChatContact.name, messagesToSend);
        }
    } catch (e) {
        console.error('AI回复失败:', e);
        // AI回复失败时，显示错误提醒
        showAPIReminder('AI服务错误', 'AI服务暂时不可用，请检查网络连接或API配置');
    } finally {
        // 完成：恢复为在线
        setChatTyping(false);
    }
}

function getRandomReply() {
    // 预设消息已清空，当没有连接AI时不会发送任何回复
    return null;
}

// 解析AI消息，识别新的格式规则
function parseAndExtractAIActions(content) {
    const actions = [];
    let cleanText = content;
    
    // 解析语音消息 [语音：文本内容]
    const voiceMatch = content.match(/\[语音：(.+?)\]/g);
    if (voiceMatch) {
        voiceMatch.forEach(match => {
            const text = match.match(/\[语音：(.+?)\]/)[1];
            actions.push({
                type: 'voice',
                text: text,
                duration: Math.max(3, Math.min(59, Math.round(text.length / 6)))
            });
            cleanText = cleanText.replace(match, '');
        });
    }
    
    // 解析外卖消息 [外卖：食物|金额|备注]
    const foodMatch = content.match(/\[外卖：(.+?)\]/g);
    if (foodMatch) {
        foodMatch.forEach(match => {
            const parts = match.match(/\[外卖：(.+?)\]/)[1].split('|');
            actions.push({
                type: 'food_order',
                food: parts[0] || '',
                amount: parts[1] || '0',
                note: parts[2] || ''
            });
            cleanText = cleanText.replace(match, '');
        });
    }
    
    // 解析定位消息 [定位：地址]
    const locationMatch = content.match(/\[定位：(.+?)\]/g);
    if (locationMatch) {
        locationMatch.forEach(match => {
            const address = match.match(/\[定位：(.+?)\]/)[1];
            actions.push({
                type: 'location',
                address: address
            });
            cleanText = cleanText.replace(match, '');
        });
    }
    
    // 解析转账消息 [转账：金额|备注]
    const transferMatch = content.match(/\[转账：(.+?)\]/g);
    if (transferMatch) {
        transferMatch.forEach(match => {
            const parts = match.match(/\[转账：(.+?)\]/)[1].split('|');
            actions.push({
                type: 'transfer',
                amount: parts[0] || '0',
                note: parts[1] || ''
            });
            cleanText = cleanText.replace(match, '');
        });
    }
    
    // 解析图片消息 [图片：描述]
    const imageMatch = content.match(/\[图片：(.+?)\]/g);
    if (imageMatch) {
        imageMatch.forEach(match => {
            const description = match.match(/\[图片：(.+?)\]/)[1];
            actions.push({
                type: 'image',
                description: description
            });
            cleanText = cleanText.replace(match, '');
        });
    }
    
    // 解析视频消息 [视频：描述]
    const videoMatch = content.match(/\[视频：(.+?)\]/g);
    if (videoMatch) {
        videoMatch.forEach(match => {
            const description = match.match(/\[视频：(.+?)\]/)[1];
            actions.push({
                type: 'video',
                description: description
            });
            cleanText = cleanText.replace(match, '');
        });
    }
    
    // 解析文件消息 [文件：标题|大小|内容]
    const fileMatch = content.match(/\[文件：(.+?)\]/g);
    if (fileMatch) {
        fileMatch.forEach(match => {
            const parts = match.match(/\[文件：(.+?)\]/)[1].split('|');
            actions.push({
                type: 'file',
                title: parts[0] || '文件',
                size: parts[1] || '0KB',
                content: parts[2] || ''
            });
            cleanText = cleanText.replace(match, '');
        });
    }
    
    // 解析天气消息 [天气：城市|温度|天气状况]
    const weatherMatch = content.match(/\[天气：(.+?)\]/g);
    if (weatherMatch) {
        weatherMatch.forEach(match => {
            const parts = match.match(/\[天气：(.+?)\]/)[1].split('|');
            actions.push({
                type: 'weather',
                city: parts[0] || '未知城市',
                temperature: parts[1] || '0°C',
                condition: parts[2] || '未知'
            });
            cleanText = cleanText.replace(match, '');
        });
    }
    
    // 清理多余的空行和空格
    cleanText = cleanText.replace(/\n\s*\n/g, '\n').trim();
    
    return { cleanText, actions };
}

// 检测文本中的备用动作
function detectFallbackActionsFromText(text) {
    const actions = [];
    
    // 检测语音相关关键词
    if (text.includes('语音') || text.includes('说话') || text.includes('录音')) {
        actions.push({
            type: 'voice',
            text: text,
            duration: Math.max(3, Math.min(59, Math.round(text.length / 6)))
        });
    }
    
    // 检测外卖相关关键词
    if (text.includes('外卖') || text.includes('点餐') || text.includes('订餐')) {
        actions.push({
            type: 'food_order',
            food: '美食',
            amount: '0',
            note: text
        });
    }
    
    // 检测定位相关关键词
    if (text.includes('位置') || text.includes('地址') || text.includes('定位')) {
        actions.push({
            type: 'location',
            address: text
        });
    }
    
    // 检测转账相关关键词
    if (text.includes('转账') || text.includes('发红包') || text.includes('给钱')) {
        actions.push({
            type: 'transfer',
            amount: '0',
            note: text
        });
    }
    
    // 检测图片相关关键词
    if (text.includes('图片') || text.includes('照片') || text.includes('发图')) {
        actions.push({
            type: 'image',
            description: text
        });
    }
    
    // 检测视频相关关键词
    if (text.includes('视频') || text.includes('录像') || text.includes('发视频')) {
        actions.push({
            type: 'video',
            description: text
        });
    }
    
    // 检测文件相关关键词
    if (text.includes('文件') || text.includes('文档') || text.includes('发文件')) {
        actions.push({
            type: 'file',
            title: '文件',
            size: '0KB',
            content: text
        });
    }
    
    // 检测天气相关关键词
    if (text.includes('天气') || text.includes('温度') || text.includes('气温')) {
        actions.push({
            type: 'weather',
            city: '当前城市',
            temperature: '20°C',
            condition: text
        });
    }
    
    return actions;
}

// 执行AI动作
async function executeAIActions(actions) {
    for (const action of actions) {
        switch (action.type) {
            case 'voice':
                await createVoiceMessage(action.text, action.duration);
                break;
            case 'food_order':
                await createFoodOrderMessage(action.food, action.amount, action.note);
                break;
            case 'location':
                await createLocationMessage(action.address);
                break;
            case 'transfer':
                await createTransferMessage(action.amount, action.note);
                break;
            case 'image':
                await createImageMessage(action.description);
                break;
            case 'video':
                await createVideoMessage(action.description);
                break;
            case 'file':
                await createFileMessage(action.title, action.size, action.content);
                break;
            case 'weather':
                await createWeatherMessage(action.city, action.temperature, action.condition);
                break;
        }
    }
}

// 创建语音消息
async function createVoiceMessage(text, duration) {
    const newMessage = {
        id: Date.now(),
        sender: 'received',
        content: text,
        time: `${new Date().getHours()}:${String(new Date().getMinutes()).padStart(2, '0')}`,
        avatar: currentChatContact ? currentChatContact.avatar : 'https://placehold.co/40x40/E8E8E8/999?text=对方',
        type: 'voice',
        duration: duration
    };
    
    chatMessages.push(newMessage);
    await saveChatMessages(currentChatContact.id, chatMessages);
    await renderChatMessages();
}

// 创建外卖消息
async function createFoodOrderMessage(food, amount, note) {
    const newMessage = {
        id: Date.now(),
        sender: 'received',
        content: `🍔 ${food}\n💰 ¥${amount}${note ? '\n备注：' + note : ''}\n已发送外卖订单`,
        time: `${new Date().getHours()}:${String(new Date().getMinutes()).padStart(2, '0')}`,
        avatar: currentChatContact ? currentChatContact.avatar : 'https://placehold.co/40x40/E8E8E8/999?text=对方',
        type: 'food_order'
    };
    
    chatMessages.push(newMessage);
    await saveChatMessages(currentChatContact.id, chatMessages);
    await renderChatMessages();
}

// 创建定位消息
async function createLocationMessage(address) {
    const newMessage = {
        id: Date.now(),
        sender: 'received',
        content: address,
        time: `${new Date().getHours()}:${String(new Date().getMinutes()).padStart(2, '0')}`,
        avatar: currentChatContact ? currentChatContact.avatar : 'https://placehold.co/40x40/E8E8E8/999?text=对方',
        type: 'location'
    };
    
    chatMessages.push(newMessage);
    await saveChatMessages(currentChatContact.id, chatMessages);
    await renderChatMessages();
}

// 创建转账消息
async function createTransferMessage(amount, note) {
    const newMessage = {
        id: Date.now(),
        sender: 'received',
        content: `💰 ¥${amount}${note ? '\n备注：' + note : ''}`,
        time: `${new Date().getHours()}:${String(new Date().getMinutes()).padStart(2, '0')}`,
        avatar: currentChatContact ? currentChatContact.avatar : 'https://placehold.co/40x40/E8E8E8/999?text=对方',
        type: 'transfer'
    };
    
    chatMessages.push(newMessage);
    await saveChatMessages(currentChatContact.id, chatMessages);
    await renderChatMessages();
}

// 创建图片消息
async function createImageMessage(description) {
    const newMessage = {
        id: Date.now(),
        sender: 'received',
        content: description,
        time: `${new Date().getHours()}:${String(new Date().getMinutes()).padStart(2, '0')}`,
        avatar: currentChatContact ? currentChatContact.avatar : 'https://placehold.co/40x40/E8E8E8/999?text=对方',
        type: 'image'
    };
    
    chatMessages.push(newMessage);
    await saveChatMessages(currentChatContact.id, chatMessages);
    await renderChatMessages();
}

// 创建视频消息
async function createVideoMessage(description) {
    const newMessage = {
        id: Date.now(),
        sender: 'received',
        content: description,
        time: `${new Date().getHours()}:${String(new Date().getMinutes()).padStart(2, '0')}`,
        avatar: currentChatContact ? currentChatContact.avatar : 'https://placehold.co/40x40/E8E8E8/999?text=对方',
        type: 'video'
    };
    
    chatMessages.push(newMessage);
    await saveChatMessages(currentChatContact.id, chatMessages);
    await renderChatMessages();
}

// 创建文件消息
async function createFileMessage(title, size, content) {
    const newMessage = {
        id: Date.now(),
        sender: 'received',
        content: `${title}|${size}|${content}`,
        time: `${new Date().getHours()}:${String(new Date().getMinutes()).padStart(2, '0')}`,
        avatar: currentChatContact ? currentChatContact.avatar : 'https://placehold.co/40x40/E8E8E8/999?text=对方',
        type: 'file',
        fileTitle: title,
        fileSize: size,
        fileContent: content
    };
    
    chatMessages.push(newMessage);
    await saveChatMessages(currentChatContact.id, chatMessages);
    await renderChatMessages();
}

// 创建天气消息
async function createWeatherMessage(city, temperature, condition) {
    const newMessage = {
        id: Date.now(),
        sender: 'received',
        content: `${city}|${temperature}|${condition}`,
        time: `${new Date().getHours()}:${String(new Date().getMinutes()).padStart(2, '0')}`,
        avatar: currentChatContact ? currentChatContact.avatar : 'https://placehold.co/40x40/E8E8E8/999?text=对方',
        type: 'weather',
        weatherCity: city,
        weatherTemperature: temperature,
        weatherCondition: condition
    };
    
    chatMessages.push(newMessage);
    await saveChatMessages(currentChatContact.id, chatMessages);
    await renderChatMessages();
}

// 渲染并保存AI回复（已删除重复函数，使用上面的正确实现）

// 切换语音文本显示
function toggleVoiceText(voiceId) {
    const voiceTextContent = document.getElementById(voiceId);
    if (voiceTextContent) {
        if (voiceTextContent.style.display === 'none') {
            voiceTextContent.style.display = 'block';
            voiceTextContent.style.animation = 'slideDown 0.3s ease-out';
        } else {
            voiceTextContent.style.animation = 'slideUp 0.3s ease-out';
            setTimeout(() => {
                voiceTextContent.style.display = 'none';
            }, 300);
        }
    }
}

// 切换文件内容显示
function toggleFileContent(fileId) {
    const fileContent = document.getElementById(`file_content_${fileId}`);
    if (fileContent) {
        if (fileContent.style.display === 'none') {
            fileContent.style.display = 'block';
            fileContent.style.animation = 'slideDown 0.3s ease-out';
        } else {
            fileContent.style.animation = 'slideUp 0.3s ease-out';
            setTimeout(() => {
                fileContent.style.display = 'none';
            }, 300);
        }
    }
}

// 支持回车发送消息（避免重复发送）
let __lastEnterSendAt = 0;
function initChatInput() {
    const chatInputField = document.getElementById('chatInputField');
    if (chatInputField) {
        chatInputField.addEventListener('keydown', (e) => {
            // 中文输入法合成中或按住 Shift 时不发送
            if (e.isComposing || e.shiftKey) return;
            if (e.key === 'Enter') {
                e.preventDefault();
                const now = Date.now();
                if (now - __lastEnterSendAt < 250) return; // 防抖，避免重复触发
                __lastEnterSendAt = now;
                sendSingleMessage();
            }
        });
    }
}

// ========== 长按/菜单/引用/撤回 ==========
let __longPressTimer = null;
let __selectedMessage = null;
let __menuOpenAt = 0;
let __isMultiselect = false;
let __selectedIds = new Set();

function bindLongPress(messageEl, messageData) {
    const start = (ev) => {
        clearTimeout(__longPressTimer);
        __longPressTimer = setTimeout(() => {
            __selectedMessage = messageData;
            openMessageMenuAt(ev.touches ? ev.touches[0].clientX : ev.clientX,
                              ev.touches ? ev.touches[0].clientY : ev.clientY,
                              messageData);
        }, 500);
    };
    const cancel = () => clearTimeout(__longPressTimer);
    messageEl.addEventListener('mousedown', start);
    messageEl.addEventListener('touchstart', start, { passive: true });
    ['mouseup','mouseleave','touchend','touchcancel'].forEach(evt => messageEl.addEventListener(evt, cancel));
}

function openMessageMenuAt(x, y, data) {
    const menu = document.getElementById('messageMenu');
    if (!menu) return;
    // 仅自己消息显示撤回
    const recall = document.getElementById('menuRecall');
    if (recall) recall.style.display = (data.sender === 'sent') ? 'block' : 'none';
    menu.style.left = Math.max(10, x - 60) + 'px';
    menu.style.top = (y + 8) + 'px';
    menu.classList.add('show');
    __menuOpenAt = Date.now();
}

function closeMessageMenu() {
    const menu = document.getElementById('messageMenu');
    if (menu) menu.classList.remove('show');
}

document.addEventListener('click', (e) => {
    const menu = document.getElementById('messageMenu');
    if (!menu) return;
    // 避免长按后释放产生的“点击”立刻把菜单关掉
    if (Date.now() - __menuOpenAt < 300) return;
    if (menu.classList.contains('show') && !menu.contains(e.target)) {
        closeMessageMenu();
    }
});

function quoteSelectedMessage() {
    if (!__selectedMessage) return;
    const textSnippet = getMessageSnippet(__selectedMessage);
    window.__replyTarget = {
        id: __selectedMessage.id,
        senderName: (__selectedMessage.sender === 'sent') ? '我' : (currentChatContact ? currentChatContact.name : '对方'),
        text: textSnippet
    };
    const preview = document.getElementById('replyPreview');
    const txt = document.getElementById('replyPreviewText');
    if (preview && txt) {
        txt.textContent = `${window.__replyTarget.senderName}: ${textSnippet}`;
        preview.style.display = 'block';
    }
    closeMessageMenu();
}

function clearReplyTarget() {
    window.__replyTarget = null;
    const preview = document.getElementById('replyPreview');
    if (preview) preview.style.display = 'none';
}

function recallSelectedMessage() {
    if (!__selectedMessage || __selectedMessage.sender !== 'sent') return;
    // 标记为撤回并保存
    const idx = chatMessages.findIndex(m => m.id === __selectedMessage.id);
    if (idx >= 0) {
        chatMessages[idx] = { id: chatMessages[idx].id, recalled: true, time: chatMessages[idx].time };
        saveChatMessages(currentChatContact.id, chatMessages).then(() => {
            renderChatMessages();
        });
    }
    closeMessageMenu();
}

function getMessageSnippet(msg) {
    if (msg.type === 'transfer') return '[转账]';
    if (msg.type === 'location') return msg.content || '[位置]';
    if (msg.type === 'food_order') return '[外卖订单]';
    if (msg.type === 'voice') return `[语音]`;
    if (msg.image) return '[图片]';
    return (msg.content || '').slice(0, 80);
}

// —— 多选模式 ——
function enterMultiselectMode() {
    __isMultiselect = true;
    __selectedIds = new Set();
    const app = document.getElementById('chatApp');
    if (app) app.classList.add('multiselect');
    document.getElementById('multiselectToolbar')?.classList.add('show');
    closeMessageMenu();
    // 点击消息可切换选择
    attachSelectHandlers();
}

function exitMultiselectMode() {
    __isMultiselect = false;
    __selectedIds = new Set();
    const app = document.getElementById('chatApp');
    if (app) app.classList.remove('multiselect');
    document.getElementById('multiselectToolbar')?.classList.remove('show');
    // 清空圆圈选中样式
    document.querySelectorAll('.select-circle').forEach(c => c.classList.remove('selected'));
}

function attachSelectHandlers() {
    const container = document.getElementById('chatMessages');
    container.querySelectorAll('.message').forEach((el, idx) => {
        el.onclick = (e) => {
            if (!__isMultiselect) return;
            const i = idx;
            const msg = chatMessages[i];
            if (!msg) return;
            const circle = el.querySelector('.select-circle');
            if (__selectedIds.has(msg.id)) {
                __selectedIds.delete(msg.id);
                circle?.classList.remove('selected');
            } else {
                __selectedIds.add(msg.id);
                circle?.classList.add('selected');
            }
        };
    });
}

async function deleteSelectedMessages() {
    if (!__isMultiselect || __selectedIds.size === 0) { alert('请选择消息'); return; }
    if (!confirm('确定删除选中的消息吗？')) return;
    chatMessages = chatMessages.filter(m => !__selectedIds.has(m.id));
    await saveChatMessages(currentChatContact.id, chatMessages);
    await renderChatMessages();
    exitMultiselectMode();
}

// 转发相关功能
let __selectedForwardFriends = new Set();

// 打开转发消息弹窗
function forwardSelectedMessages() {
    if (!__isMultiselect || __selectedIds.size === 0) {
        alert('请选择要转发的消息');
        return;
    }
    
    playClickSound();
    openForwardModal();
}

// 打开转发弹窗并渲染好友列表
async function openForwardModal() {
    const modal = document.getElementById('forwardModal');
    const friendsList = document.getElementById('forwardFriendsList');
    
    if (!modal || !friendsList) return;
    
    // 清空之前的选择
    __selectedForwardFriends.clear();
    
    // 获取所有好友（排除群聊和当前聊天对象）
    const allContacts = currentMessages.filter(m => 
        !m.isGroup && 
        m.id !== (currentChatContact ? currentChatContact.id : null)
    );
    
    // 渲染好友列表
    friendsList.innerHTML = '';
    
    if (allContacts.length === 0) {
        friendsList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">暂无可转发的好友</div>';
    } else {
        for (const contact of allContacts) {
            const friendItem = document.createElement('div');
            friendItem.className = 'forward-friend-item';
            friendItem.dataset.contactId = contact.id;
            
            // 获取好友头像
            let avatar = contact.avatar || 'https://placehold.co/48x48/E8E8E8/999?text=头像';
            const contactKey = `contact_${contact.id}`;
            const savedContact = await AppStorage.getItem(contactKey);
            if (savedContact) {
                const contactData = JSON.parse(savedContact);
                avatar = contactData.avatar || avatar;
            }
            
            friendItem.innerHTML = `
                <img src="${avatar}" alt="${contact.name}" class="forward-friend-avatar">
                <div class="forward-friend-info">
                    <div class="forward-friend-name">${contact.name}</div>
                    <div class="forward-friend-status">在线</div>
                </div>
                <div class="forward-friend-checkbox"></div>
            `;
            
            friendItem.onclick = () => toggleForwardFriend(contact.id, friendItem);
            friendsList.appendChild(friendItem);
        }
    }
    
    modal.classList.add('show');
}

// 切换转发好友选择
function toggleForwardFriend(contactId, element) {
    playClickSound();
    
    if (__selectedForwardFriends.has(contactId)) {
        __selectedForwardFriends.delete(contactId);
        element.classList.remove('selected');
    } else {
        __selectedForwardFriends.add(contactId);
        element.classList.add('selected');
    }
}

// 关闭转发弹窗
function closeForwardModal() {
    playClickSound();
    const modal = document.getElementById('forwardModal');
    if (modal) {
        modal.classList.remove('show');
        __selectedForwardFriends.clear();
    }
}

// 确认转发消息
async function confirmForwardMessages() {
    if (__selectedForwardFriends.size === 0) {
        alert('请选择要转发的好友');
        return;
    }
    
    playClickSound();
    
    // 获取选中的消息
    const selectedMessages = chatMessages.filter(m => __selectedIds.has(m.id));
    
    if (selectedMessages.length === 0) {
        alert('没有选中的消息');
        return;
    }
    
    // 获取自己的信息
    const selfSettings = await AppStorage.getItem('selfSettings');
    let selfName = '我';
    let selfAvatar = 'https://placehold.co/36x36/E8E8E8/999?text=我';
    if (selfSettings) {
        const selfData = JSON.parse(selfSettings);
        selfName = selfData.name || '我';
        selfAvatar = selfData.avatar || selfAvatar;
    }
    
    // 为每个选中的好友转发消息
    for (const contactId of __selectedForwardFriends) {
        // 获取目标联系人的聊天记录
        const targetChatKey = `chat_${contactId}`;
        const existingChat = await AppStorage.getItem(targetChatKey);
        let targetChatMessages = existingChat ? JSON.parse(existingChat) : [];
        
        // 当前时间
        const now = new Date();
        const timeStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        
        // 创建聊天记录卡片
        if (selectedMessages.length === 1) {
            // 单条消息，直接转发内容
            const msg = selectedMessages[0];
            const forwardedMessage = {
                id: Date.now() + Math.random(),
                sender: 'sent',
                time: timeStr,
                content: msg.content || '',
                type: msg.type || 'text',
                image: msg.image || null,
                voiceDuration: msg.voiceDuration || null,
                amount: msg.amount || null,
                transferNote: msg.transferNote || null,
                location: msg.location || null,
                foodOrderData: msg.foodOrderData || null
            };
            targetChatMessages.push(forwardedMessage);
        } else {
            // 多条消息，打包成聊天记录
            const chatHistoryData = {
                title: `与${currentChatContact ? currentChatContact.name : '对方'}的聊天记录`,
                messages: []
            };
            
            // 获取对方的头像
            let otherAvatar = currentChatContact ? currentChatContact.avatar : 'https://placehold.co/36x36/E8E8E8/999?text=对方';
            
            for (const msg of selectedMessages) {
                const isSent = msg.sender === 'sent';
                const senderName = isSent ? selfName : (currentChatContact ? currentChatContact.name : '对方');
                const senderAvatar = isSent ? selfAvatar : otherAvatar;
                const msgContent = getMessageSnippet(msg);
                
                chatHistoryData.messages.push({
                    name: senderName,
                    avatar: senderAvatar,
                    content: msgContent
                });
            }
            
            const forwardedMessage = {
                id: Date.now() + Math.random(),
                sender: 'sent',
                content: JSON.stringify(chatHistoryData),
                time: timeStr,
                type: 'chat_history'
            };
            targetChatMessages.push(forwardedMessage);
        }
        
        // 保存更新后的聊天记录
        await AppStorage.setItem(targetChatKey, JSON.stringify(targetChatMessages));
        
        // 更新消息列表中的最后消息
        const contactInMessages = currentMessages.find(m => m.id === contactId);
        if (contactInMessages) {
            contactInMessages.lastMessage = selectedMessages.length === 1 ? 
                getMessageSnippet(selectedMessages[0]) : 
                `[聊天记录] ${selectedMessages.length}条消息`;
            contactInMessages.time = timeStr;
        }
    }
    
    // 保存消息列表
    await saveMessagesData();
    await renderMessagesList();
    
    // 关闭转发弹窗
    closeForwardModal();
    
    // 退出多选模式
    exitMultiselectMode();
    
    alert(`已转发给 ${__selectedForwardFriends.size} 位好友`);
}

// 收藏选中的消息
function favoriteSelectedMessages() {
    if (!__isMultiselect || __selectedIds.size === 0) {
        alert('请选择要收藏的消息');
        return;
    }
    
    playClickSound();
    openFavoriteModal();
}

// 打开收藏弹窗
function openFavoriteModal() {
    const modal = document.getElementById('favoriteModal');
    const titleInput = document.getElementById('favoriteTitle');
    const previewContainer = document.getElementById('selectedMessagesPreview');
    
    if (!modal || !titleInput || !previewContainer) return;
    
    // 清空输入框
    titleInput.value = '';
    
    // 生成消息预览
    const selectedMessages = chatMessages.filter(m => __selectedIds.has(m.id));
    previewContainer.innerHTML = '';
    
    selectedMessages.forEach(msg => {
        const previewItem = document.createElement('div');
        previewItem.className = 'message-preview-item';
        
        const avatar = document.createElement('img');
        avatar.className = 'message-preview-avatar';
        avatar.src = msg.sender === 'sent' ? 'https://placehold.co/32x32/6C8CD5/fff?text=我' : currentChatContact.avatar;
        
        const content = document.createElement('div');
        content.className = 'message-preview-content';
        content.textContent = getMessagePreviewText(msg);
        
        previewItem.appendChild(avatar);
        previewItem.appendChild(content);
        previewContainer.appendChild(previewItem);
    });
    
    // 显示弹窗
    modal.classList.add('show');
}

// 关闭收藏弹窗
function closeFavoriteModal() {
    playClickSound();
    const modal = document.getElementById('favoriteModal');
    if (modal) {
        modal.classList.remove('show');
    }
}

// 确认收藏
async function confirmFavorite() {
    const titleInput = document.getElementById('favoriteTitle');
    const title = titleInput.value.trim();
    
    if (!title) {
        alert('请输入收藏标题！');
        return;
    }
    
    playClickSound();
    
    // 获取选中的消息
    const selectedMessages = chatMessages.filter(m => __selectedIds.has(m.id));
    
    if (selectedMessages.length === 0) {
        alert('没有选中的消息！');
        return;
    }
    
    // 创建收藏项
    const favoriteItem = {
        id: Date.now().toString(),
        title: title,
        messages: selectedMessages,
        createdAt: new Date().toISOString(),
        contactId: currentChatContact.id,
        contactName: currentChatContact.name
    };
    
    // 保存到本地存储
    await saveFavoriteItem(favoriteItem);
    
    // 关闭弹窗并退出多选模式
    closeFavoriteModal();
    exitMultiselectMode();
    
    alert(`已收藏 ${selectedMessages.length} 条消息！`);
}

// 保存收藏项到本地存储
async function saveFavoriteItem(favoriteItem) {
    try {
        const favoritesKey = 'chat_favorites';
        const existingFavorites = await AppStorage.getItem(favoritesKey);
        let favorites = existingFavorites ? JSON.parse(existingFavorites) : [];
        
        // 添加新收藏
        favorites.unshift(favoriteItem); // 新收藏放在最前面
        
        // 限制收藏数量（最多200条）
        if (favorites.length > 200) {
            favorites = favorites.slice(0, 200);
        }
        
        await AppStorage.setItem(favoritesKey, JSON.stringify(favorites));
        console.log('收藏保存成功');
    } catch (error) {
        console.error('保存收藏失败:', error);
        alert('保存收藏失败！');
    }
}

// 获取消息预览文本
function getMessagePreviewText(msg) {
    if (msg.type === 'image') return '[图片]';
    if (msg.type === 'emoji') return '[表情]';
    if (msg.type === 'file') return '[文件]';
    if (msg.type === 'voice') return '[语音]';
    return (msg.content || '').slice(0, 30);
}

// 打开收藏列表弹窗
async function openFavoritesListModal() {
    const modal = document.getElementById('favoritesListModal');
    const favoritesList = document.getElementById('favoritesList');
    
    if (!modal || !favoritesList) return;
    
    // 显示弹窗
    modal.classList.add('show');
    
    // 加载收藏列表
    await loadFavoritesList();
}

// 关闭收藏列表弹窗
function closeFavoritesListModal() {
    playClickSound();
    const modal = document.getElementById('favoritesListModal');
    if (modal) {
        modal.classList.remove('show');
    }
}

// 加载收藏列表
async function loadFavoritesList() {
    const favoritesList = document.getElementById('favoritesList');
    if (!favoritesList) return;
    
    try {
        const favoritesKey = 'chat_favorites';
        const favoritesData = await AppStorage.getItem(favoritesKey);
        const favorites = favoritesData ? JSON.parse(favoritesData) : [];
        
        if (favorites.length === 0) {
            favoritesList.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #999;">
                    <div style="font-size: 48px; margin-bottom: 16px;">📝</div>
                    <div>暂无收藏消息</div>
                    <div style="font-size: 12px; margin-top: 8px;">长按消息选择多条，然后点击收藏按钮</div>
                </div>
            `;
            return;
        }
        
        // 渲染收藏列表
        favoritesList.innerHTML = '';
        favorites.forEach(favorite => {
            const favoriteItem = createFavoriteItem(favorite);
            favoritesList.appendChild(favoriteItem);
        });
        
    } catch (error) {
        console.error('加载收藏列表失败:', error);
        favoritesList.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #ff4757;">
                <div>加载收藏列表失败</div>
            </div>
        `;
    }
}

// 创建收藏项元素
function createFavoriteItem(favorite) {
    const item = document.createElement('div');
    item.className = 'favorite-item';
    item.onclick = () => viewFavoriteDetail(favorite);
    
    const timeStr = new Date(favorite.createdAt).toLocaleString('zh-CN', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    // 生成消息预览 - 显示更多消息
    const maxPreviewMessages = Math.min(favorite.messages.length, 4); // 最多显示4条预览
    const messagePreviews = favorite.messages.slice(0, maxPreviewMessages).map(msg => {
        const avatar = msg.sender === 'sent' ? 
            'https://placehold.co/20x20/6C8CD5/fff?text=我' : 
            favorite.contactId ? getContactAvatar(favorite.contactId) : 
            'https://placehold.co/20x20/999/fff?text=?';
        
        return `
            <div class="favorite-message-preview">
                <img src="${avatar}" class="favorite-message-avatar">
                <span class="favorite-message-content">${getMessagePreviewText(msg)}</span>
            </div>
        `;
    }).join('');
    
    const moreCount = favorite.messages.length > maxPreviewMessages ? `等${favorite.messages.length}条消息` : '';
    
    // 生成所有消息预览（用于展开时显示）
    const allMessagePreviews = favorite.messages.map(msg => {
        const avatar = msg.sender === 'sent' ? 
            'https://placehold.co/20x20/6C8CD5/fff?text=我' : 
            favorite.contactId ? getContactAvatar(favorite.contactId) : 
            'https://placehold.co/20x20/999/fff?text=?';
        
        return `
            <div class="favorite-message-preview">
                <img src="${avatar}" class="favorite-message-avatar">
                <span class="favorite-message-content">${getMessagePreviewText(msg)}</span>
            </div>
        `;
    }).join('');

    item.innerHTML = `
        <div class="favorite-item-content">
            <div class="favorite-item-header">
                <span class="favorite-item-title">${favorite.title}</span>
                <span class="favorite-item-time">${timeStr}</span>
            </div>
            <div class="favorite-item-messages" id="messages-${favorite.id}">
                ${messagePreviews}
                ${moreCount ? `<div style="font-size: 12px; color: #999; margin-top: 4px;">${moreCount}</div>` : ''}
            </div>
            ${favorite.messages.length > 4 ? `
                <button class="favorite-expand-btn" onclick="event.stopPropagation(); toggleFavoriteMessages('${favorite.id}', ${favorite.messages.length})">
                    展开查看全部 ${favorite.messages.length} 条消息
                </button>
            ` : ''}
        </div>
        <div class="favorite-item-actions">
            <button class="favorite-action-btn delete" onclick="event.stopPropagation(); deleteFavorite('${favorite.id}')">删除</button>
        </div>
    `;
    
    return item;
}

// 查看收藏详情
function viewFavoriteDetail(favorite) {
    playClickSound();
    
    // 创建详情弹窗
    const detailModal = document.createElement('div');
    detailModal.className = 'modal-overlay';
    detailModal.style.zIndex = '10000';
    detailModal.innerHTML = `
        <div class="modal-content" style="max-width: 500px; max-height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3>${favorite.title}</h3>
                <span class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</span>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 16px;">
                <div style="margin-bottom: 16px; padding: 12px; background: #f5f5f5; border-radius: 8px; font-size: 12px; color: #666;">
                    来自：${favorite.contactName} | 收藏时间：${new Date(favorite.createdAt).toLocaleString('zh-CN')}
                </div>
                <div class="favorite-detail-messages" style="overflow-y: auto; max-height: 400px;">
                    ${favorite.messages.map(msg => createFavoriteMessageElement(msg, favorite.contactId)).join('')}
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(detailModal);
    
    // 点击背景关闭
    detailModal.onclick = (e) => {
        if (e.target === detailModal) {
            detailModal.remove();
        }
    };
}

// 创建收藏消息元素
function createFavoriteMessageElement(msg, contactId) {
    const isUser = msg.sender === 'sent';
    const avatar = isUser ? 
        'https://placehold.co/32x32/6C8CD5/fff?text=我' : 
        getContactAvatar(contactId);
    
    const time = new Date(msg.timestamp).toLocaleTimeString('zh-CN', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    let content = '';
    if (msg.type === 'image') {
        content = `<img src="${msg.image}" style="max-width: 200px; border-radius: 8px;">`;
    } else if (msg.type === 'emoji') {
        content = `<div style="font-size: 24px;">${msg.content}</div>`;
    } else {
        content = `<div>${msg.content}</div>`;
    }
    
    return `
        <div style="display: flex; align-items: flex-start; margin-bottom: 12px; ${isUser ? 'flex-direction: row-reverse;' : ''}">
            <img src="${avatar}" style="width: 32px; height: 32px; border-radius: 50%; margin: 0 8px; object-fit: cover;">
            <div style="flex: 1; ${isUser ? 'text-align: right;' : ''}">
                <div style="font-size: 12px; color: #999; margin-bottom: 4px;">${time}</div>
                <div style="background: ${isUser ? '#6C8CD5' : '#f0f0f0'}; color: ${isUser ? 'white' : '#333'}; padding: 8px 12px; border-radius: 12px; display: inline-block; max-width: 80%; word-wrap: break-word;">
                    ${content}
                </div>
            </div>
        </div>
    `;
}

// 删除收藏
async function deleteFavorite(favoriteId) {
    if (!confirm('确定要删除这个收藏吗？')) return;
    
    playClickSound();
    
    try {
        const favoritesKey = 'chat_favorites';
        const favoritesData = await AppStorage.getItem(favoritesKey);
        const favorites = favoritesData ? JSON.parse(favoritesData) : [];
        
        const updatedFavorites = favorites.filter(f => f.id !== favoriteId);
        await AppStorage.setItem(favoritesKey, JSON.stringify(updatedFavorites));
        
        // 重新加载收藏列表
        await loadFavoritesList();
        
    } catch (error) {
        console.error('删除收藏失败:', error);
        alert('删除收藏失败！');
    }
}

// 获取联系人头像
function getContactAvatar(contactId) {
    const contact = currentMessages.find(c => c.id === contactId);
    return contact ? contact.avatar : 'https://placehold.co/20x20/999/fff?text=?';
}

// 切换收藏消息的展开/收起状态
function toggleFavoriteMessages(favoriteId, totalMessages) {
    const messagesContainer = document.getElementById(`messages-${favoriteId}`);
    const expandBtn = messagesContainer.nextElementSibling;
    
    if (!messagesContainer || !expandBtn) return;
    
    if (messagesContainer.classList.contains('expanded')) {
        // 收起 - 恢复到预览状态
        messagesContainer.classList.remove('expanded');
        expandBtn.textContent = `展开查看全部 ${totalMessages} 条消息`;
        
        // 重新加载预览消息
        loadPreviewMessages(favoriteId, totalMessages);
    } else {
        // 展开 - 显示所有消息
        messagesContainer.classList.add('expanded');
        expandBtn.textContent = '收起';
        
        // 加载所有消息
        loadAllFavoriteMessages(favoriteId);
    }
}

// 加载收藏的所有消息
async function loadAllFavoriteMessages(favoriteId) {
    try {
        const favoritesKey = 'chat_favorites';
        const favoritesData = await AppStorage.getItem(favoritesKey);
        const favorites = favoritesData ? JSON.parse(favoritesData) : [];
        const favorite = favorites.find(f => f.id === favoriteId);
        
        if (!favorite) return;
        
        const messagesContainer = document.getElementById(`messages-${favoriteId}`);
        if (!messagesContainer) return;
        
        // 生成所有消息预览
        const allMessagePreviews = favorite.messages.map(msg => {
            const avatar = msg.sender === 'sent' ? 
                'https://placehold.co/20x20/6C8CD5/fff?text=我' : 
                favorite.contactId ? getContactAvatar(favorite.contactId) : 
                'https://placehold.co/20x20/999/fff?text=?';
            
            return `
                <div class="favorite-message-preview">
                    <img src="${avatar}" class="favorite-message-avatar">
                    <span class="favorite-message-content">${getMessagePreviewText(msg)}</span>
                </div>
            `;
        }).join('');
        
        // 更新消息容器内容
        messagesContainer.innerHTML = allMessagePreviews;
        
    } catch (error) {
        console.error('加载全部消息失败:', error);
    }
}

// 加载预览消息（收起状态）
async function loadPreviewMessages(favoriteId, totalMessages) {
    try {
        const favoritesKey = 'chat_favorites';
        const favoritesData = await AppStorage.getItem(favoritesKey);
        const favorites = favoritesData ? JSON.parse(favoritesData) : [];
        const favorite = favorites.find(f => f.id === favoriteId);
        
        if (!favorite) return;
        
        const messagesContainer = document.getElementById(`messages-${favoriteId}`);
        if (!messagesContainer) return;
        
        // 只显示前4条消息
        const maxPreviewMessages = Math.min(favorite.messages.length, 4);
        const messagePreviews = favorite.messages.slice(0, maxPreviewMessages).map(msg => {
            const avatar = msg.sender === 'sent' ? 
                'https://placehold.co/20x20/6C8CD5/fff?text=我' : 
                favorite.contactId ? getContactAvatar(favorite.contactId) : 
                'https://placehold.co/20x20/999/fff?text=?';
            
            return `
                <div class="favorite-message-preview">
                    <img src="${avatar}" class="favorite-message-avatar">
                    <span class="favorite-message-content">${getMessagePreviewText(msg)}</span>
                </div>
            `;
        }).join('');
        
        const moreCount = favorite.messages.length > 4 ? `等${favorite.messages.length}条消息` : '';
        
        // 更新消息容器内容
        messagesContainer.innerHTML = messagePreviews + (moreCount ? `<div style="font-size: 12px; color: #999; margin-top: 4px;">${moreCount}</div>` : '');
        
    } catch (error) {
        console.error('加载预览消息失败:', error);
    }
}

// 获取消息的简短描述（用于转发）
function getMessageSnippet(msg) {
    if (msg.type === 'image' || msg.type === 'emoji') {
        return '[图片]';
    } else if (msg.type === 'voice') {
        return '[语音]';
    } else if (msg.type === 'transfer') {
        return '[转账]';
    } else if (msg.type === 'location') {
        return '[位置]';
    } else if (msg.type === 'food_order') {
        return '[外卖订单]';
    } else if (msg.type === 'chat_history') {
        return '[聊天记录]';
    } else {
        return msg.content || '[消息]';
    }
}

// ========== 角色表情功能 ==========

// 添加表情模板
function addEmotionTemplate() {
    const textarea = document.getElementById('characterEmotions');
    const template = `开心：https://example.com/happy.gif
难过：https://example.com/sad.gif
生气：https://example.com/angry.gif
惊讶：https://example.com/surprised.gif
害羞：https://example.com/shy.gif
思考：https://example.com/thinking.gif`;
    
    if (textarea.value.trim()) {
        textarea.value += '\n' + template;
    } else {
        textarea.value = template;
    }
    
    // 保存到本地存储
    saveCharacterEmotions();
}

// 清空表情
function clearEmotions() {
    if (confirm('确定要清空所有表情设置吗？')) {
        document.getElementById('characterEmotions').value = '';
        saveCharacterEmotions();
    }
}

// 测试表情包发送
async function testEmotion() {
    const emotions = parseCharacterEmotions();
    const emotionNames = Object.keys(emotions);
    
    if (emotionNames.length === 0) {
        alert('请先设置表情包链接！');
        return;
    }
    
    // 获取随机表情
    const emotion = getRandomEmotion();
    if (emotion) {
        // 模拟AI发送表情包
        const now = new Date();
        const timeStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        
        const emotionMessage = {
            id: Date.now(),
            sender: 'received',
            content: `[${emotion.name}]`,
            time: timeStr,
            avatar: currentChatContact ? currentChatContact.avatar : 'https://placehold.co/36x36/E8E8E8/999?text=AI',
            type: 'emotion',
            emotionUrl: emotion.url,
            emotionName: emotion.name
        };
        
        if (currentChatContact) {
            chatMessages.push(emotionMessage);
            await saveChatMessages(currentChatContact.id, chatMessages);
            await renderChatMessages();
            alert(`测试发送表情包：${emotion.name}`);
        } else {
            alert(`测试表情包：${emotion.name}\n链接：${emotion.url}`);
        }
    } else {
        alert('没有可用的表情包！');
    }
}

// 保存角色表情到本地存储
async function saveCharacterEmotions() {
    const textarea = document.getElementById('characterEmotions');
    const emotionsText = textarea.value.trim();
    
    try {
        await AppStorage.setItem('characterEmotions', emotionsText);
        console.log('角色表情保存成功');
    } catch (error) {
        console.error('保存角色表情失败:', error);
    }
}

// 加载角色表情
async function loadCharacterEmotions() {
    try {
        const emotionsText = await AppStorage.getItem('characterEmotions');
        if (emotionsText) {
            document.getElementById('characterEmotions').value = emotionsText;
        }
    } catch (error) {
        console.error('加载角色表情失败:', error);
    }
}

// ========== 角色通话立绘功能 ==========

// 处理通话立绘上传
function handleCallImageUpload(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewImg = document.getElementById('callImagePreviewImg');
            const placeholder = document.getElementById('callImagePlaceholder');
            const clearBtn = document.getElementById('callImageClearBtn');
            
            previewImg.src = e.target.result;
            previewImg.style.display = 'block';
            placeholder.style.display = 'none';
            clearBtn.style.display = 'inline-block';
            
            // 保存到本地存储
            saveCallImage(e.target.result);
        };
        reader.readAsDataURL(file);
    }
}

// 保存通话立绘
async function saveCallImage(imageData) {
    try {
        await AppStorage.setItem('characterCallImage', imageData);
        console.log('角色通话立绘保存成功');
    } catch (error) {
        console.error('保存角色通话立绘失败:', error);
    }
}

// 加载通话立绘
async function loadCallImage() {
    try {
        const imageData = await AppStorage.getItem('characterCallImage');
        if (imageData) {
            const previewImg = document.getElementById('callImagePreviewImg');
            const placeholder = document.getElementById('callImagePlaceholder');
            const clearBtn = document.getElementById('callImageClearBtn');
            
            previewImg.src = imageData;
            previewImg.style.display = 'block';
            placeholder.style.display = 'none';
            clearBtn.style.display = 'inline-block';
        }
    } catch (error) {
        console.error('加载角色通话立绘失败:', error);
    }
}

// 清除通话立绘
async function clearCallImage() {
    try {
        await AppStorage.removeItem('characterCallImage');
        
        const previewImg = document.getElementById('callImagePreviewImg');
        const placeholder = document.getElementById('callImagePlaceholder');
        const clearBtn = document.getElementById('callImageClearBtn');
        
        previewImg.src = '';
        previewImg.style.display = 'none';
        placeholder.style.display = 'flex';
        clearBtn.style.display = 'none';
        
        console.log('角色通话立绘已清除');
    } catch (error) {
        console.error('清除角色通话立绘失败:', error);
    }
}

// 解析角色表情
function parseCharacterEmotions() {
    const textarea = document.getElementById('characterEmotions');
    const emotionsText = textarea.value.trim();
    
    if (!emotionsText) return {};
    
    const emotions = {};
    const lines = emotionsText.split('\n');
    
    lines.forEach(line => {
        const trimmedLine = line.trim();
        if (trimmedLine && trimmedLine.includes('：')) {
            const [name, url] = trimmedLine.split('：', 2);
            if (name && url) {
                emotions[name.trim()] = url.trim();
            }
        }
    });
    
    return emotions;
}

// 获取随机表情
function getRandomEmotion() {
    const emotions = parseCharacterEmotions();
    const emotionNames = Object.keys(emotions);
    
    if (emotionNames.length === 0) return null;
    
    const randomIndex = Math.floor(Math.random() * emotionNames.length);
    const emotionName = emotionNames[randomIndex];
    const emotionUrl = emotions[emotionName];
    
    return {
        name: emotionName,
        url: emotionUrl
    };
}

// 根据情绪获取表情
function getEmotionByMood(mood) {
    const emotions = parseCharacterEmotions();
    
    // 尝试匹配情绪关键词
    const moodKeywords = {
        '开心': ['开心', '高兴', '快乐', '兴奋', '愉快'],
        '难过': ['难过', '伤心', '悲伤', '沮丧', '失落'],
        '生气': ['生气', '愤怒', '恼火', '烦躁', '不满'],
        '惊讶': ['惊讶', '吃惊', '震惊', '意外', '惊奇'],
        '害羞': ['害羞', '腼腆', '羞涩', '不好意思'],
        '思考': ['思考', '考虑', '想', '琢磨', '沉思']
    };
    
    for (const [emotionName, keywords] of Object.entries(moodKeywords)) {
        if (emotions[emotionName]) {
            for (const keyword of keywords) {
                if (mood.includes(keyword)) {
                    return {
                        name: emotionName,
                        url: emotions[emotionName]
                    };
                }
            }
        }
    }
    
    // 如果没有匹配到，返回随机表情
    return getRandomEmotion();
}

// 根据AI回复内容智能选择表情包
function selectEmotionByContent(aiResponse) {
    const emotions = parseCharacterEmotions();
    const emotionNames = Object.keys(emotions);
    
    if (emotionNames.length === 0) return null;
    
    // 根据AI回复内容和表情包名称进行智能匹配
    const response = aiResponse.toLowerCase();
    
    // 定义情绪匹配规则
    const emotionRules = {
        '开心': ['开心', '高兴', '快乐', '兴奋', '愉快', '哈哈', '笑', '😊', '😄', '喜欢', '爱', '满足', '幸福'],
        '难过': ['难过', '伤心', '悲伤', '沮丧', '失落', '😢', '😭', '哭', '痛苦', '孤独', '失望'],
        '生气': ['生气', '愤怒', '恼火', '烦躁', '不满', '😠', '😡', '气', '讨厌', '讨厌'],
        '惊讶': ['惊讶', '吃惊', '震惊', '意外', '惊奇', '😲', '😮', '哇', '意外'],
        '害羞': ['害羞', '腼腆', '羞涩', '不好意思', '😳', '紧张'],
        '思考': ['思考', '考虑', '想', '琢磨', '沉思', '🤔', '担心', '期待', '希望'],
        '放松': ['放松', '温暖', '舒服', '安心', '平静']
    };
    
    // 尝试匹配情绪
    for (const [emotionName, keywords] of Object.entries(emotionRules)) {
        if (emotions[emotionName]) {
            for (const keyword of keywords) {
                if (response.includes(keyword)) {
                    return {
                        name: emotionName,
                        url: emotions[emotionName]
                    };
                }
            }
        }
    }
    
    // 如果没有匹配到，尝试根据表情包名称的相似性选择
    const bestMatch = findBestEmotionMatch(response, emotions);
    if (bestMatch) {
        return bestMatch;
    }
    
    // 最后选择随机表情
    return getRandomEmotion();
}

// 根据表情包名称找到最佳匹配
function findBestEmotionMatch(response, emotions) {
    let bestMatch = null;
    let bestScore = 0;
    
    for (const [emotionName, url] of Object.entries(emotions)) {
        const score = calculateEmotionScore(response, emotionName);
        if (score > bestScore) {
            bestScore = score;
            bestMatch = { name: emotionName, url: url };
        }
    }
    
    // 只有得分足够高才返回匹配结果
    return bestScore > 0.3 ? bestMatch : null;
}

// 计算情绪匹配得分
function calculateEmotionScore(response, emotionName) {
    const responseWords = response.split(/[\s，。！？,.\s]+/);
    const emotionWords = emotionName.split(/[\s，。！？,.\s]+/);
    
    let score = 0;
    
    // 直接匹配
    if (response.includes(emotionName)) {
        score += 1.0;
    }
    
    // 部分匹配
    for (const word of emotionWords) {
        if (response.includes(word)) {
            score += 0.5;
        }
    }
    
    // 语义相似性（简单实现）
    const semanticMatches = {
        '开心': ['笑', '乐', '喜', '欢'],
        '难过': ['哭', '泪', '悲', '哀'],
        '生气': ['怒', '火', '气', '愤'],
        '惊讶': ['惊', '奇', '异', '怪'],
        '害羞': ['羞', '腼', '涩', '怯'],
        '思考': ['想', '思', '虑', '考']
    };
    
    if (semanticMatches[emotionName]) {
        for (const semantic of semanticMatches[emotionName]) {
            if (response.includes(semantic)) {
                score += 0.3;
            }
        }
    }
    
    return score;
}

// AI发送表情包
async function sendAIEmotion(emotion) {
    if (!emotion || !emotion.url) return;
    
    const now = new Date();
    const timeStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    
    const emotionMessage = {
        id: Date.now(),
        sender: 'received',
        content: `[${emotion.name}]`,
        time: timeStr,
        avatar: currentChatContact.avatar,
        type: 'emotion',
        emotionUrl: emotion.url,
        emotionName: emotion.name
    };
    
    chatMessages.push(emotionMessage);
    await saveChatMessages(currentChatContact.id, chatMessages);
    await renderChatMessages();
}

// 检查AI回复中是否应该发送表情包
function shouldSendEmotion(aiResponse) {
    // 检查是否有设置表情包
    const emotions = parseCharacterEmotions();
    if (Object.keys(emotions).length === 0) {
        return false; // 没有设置表情包就不发送
    }
    
    // 检查AI回复中是否包含情绪表达或情感词汇
    const emotionalKeywords = [
        '开心', '高兴', '快乐', '兴奋', '愉快', '哈哈', '笑', '😊', '😄',
        '难过', '伤心', '悲伤', '沮丧', '失落', '😢', '😭', '哭',
        '生气', '愤怒', '恼火', '烦躁', '不满', '😠', '😡', '气',
        '惊讶', '吃惊', '震惊', '意外', '惊奇', '😲', '😮', '哇',
        '害羞', '腼腆', '羞涩', '不好意思', '😳',
        '思考', '考虑', '想', '琢磨', '沉思', '🤔',
        '喜欢', '爱', '讨厌', '讨厌', '害怕', '担心', '紧张', '放松',
        '期待', '希望', '失望', '满足', '幸福', '痛苦', '孤独', '温暖'
    ];
    
    // 检查是否包含情绪词汇
    const hasEmotionalContent = emotionalKeywords.some(keyword => 
        aiResponse.includes(keyword)
    );
    
    // 如果包含情绪内容，80%概率发送表情包
    if (hasEmotionalContent) {
        return Math.random() < 0.8;
    }
    
    // 如果没有明显情绪，30%概率随机发送
    return Math.random() < 0.3;
}

// 从AI回复中提取情绪关键词
function extractMoodFromResponse(response) {
    const moodKeywords = [
        '开心', '高兴', '快乐', '兴奋', '愉快', '哈哈', '开心', '😊', '😄', '笑', '开心', '高兴',
        '难过', '伤心', '悲伤', '沮丧', '失落', '😢', '😭', '哭', '难过', '伤心',
        '生气', '愤怒', '恼火', '烦躁', '不满', '😠', '😡', '气', '生气', '愤怒',
        '惊讶', '吃惊', '震惊', '意外', '惊奇', '😲', '😮', '哇', '惊讶', '吃惊',
        '害羞', '腼腆', '羞涩', '不好意思', '😊', '😳', '害羞', '腼腆',
        '思考', '考虑', '想', '琢磨', '沉思', '🤔', '想', '思考', '考虑'
    ];
    
    for (const keyword of moodKeywords) {
        if (response.includes(keyword)) {
            return keyword;
        }
    }
    
    return null;
}

// 添加系统提示消息
async function addSystemTip(text) {
    const now = new Date();
    const timeStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    chatMessages.push({ id: Date.now(), type: 'system', content: text, time: timeStr });
    await saveChatMessages(currentChatContact.id, chatMessages);
    await renderChatMessages();
}

// 渲染聊天记录消息的HTML
function renderChatHistoryMessage(chatHistoryData) {
    const data = JSON.parse(chatHistoryData);
    
    let historyHTML = `
        <div class="message-chat-history">
            <div class="chat-history-header">
                <div class="chat-history-icon">💬</div>
                <div class="chat-history-title">${data.title}</div>
            </div>
            <div class="chat-history-body">
    `;
    
    data.messages.forEach((msg, index) => {
        historyHTML += `
            <div class="chat-history-item">
                <img src="${msg.avatar}" class="chat-history-avatar" alt="${msg.name}">
                <div class="chat-history-content">
                    <div class="chat-history-name">${msg.name}</div>
                    <div class="chat-history-text">${msg.content}</div>
                </div>
            </div>
        `;
    });
    
    historyHTML += `
            </div>
            <div class="chat-history-footer">
                聊天记录
            </div>
        </div>
    `;
    
    return historyHTML;
}

// 当页面加载后，为所有聊天记录消息添加渲染支持
// 注意：这需要在renderChatMessages函数中调用
// 如果消息类型是chat_history，使用renderChatHistoryMessage函数渲染
</script>
<script>
// IndexedDB 封装：AppStorage（兼容 localStorage 风格）
(function(){
  const DB_NAME = 'AppLargeStorage';
  const STORE_NAME = 'kv';
  const DB_VERSION = 1;
  let dbPromise = null;

  function openDB() {
    if (dbPromise) return dbPromise;
    dbPromise = new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onupgradeneeded = function(e){
        const db = req.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          db.createObjectStore(STORE_NAME);
        }
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
    return dbPromise;
  }

  async function idbGet(key){
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_NAME, 'readonly');
      const store = tx.objectStore(STORE_NAME);
      const r = store.get(key);
      r.onsuccess = () => resolve(r.result ?? null);
      r.onerror = () => reject(r.error);
    });
  }
  async function idbSet(key, value){
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_NAME, 'readwrite');
      const store = tx.objectStore(STORE_NAME);
      const r = store.put(value, key);
      r.onsuccess = () => resolve();
      r.onerror = () => reject(r.error);
    });
  }
  async function idbDelete(key){
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_NAME, 'readwrite');
      const store = tx.objectStore(STORE_NAME);
      const r = store.delete(key);
      r.onsuccess = () => resolve();
      r.onerror = () => reject(r.error);
    });
  }
  async function idbClear(){
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_NAME, 'readwrite');
      const store = tx.objectStore(STORE_NAME);
      const r = store.clear();
      r.onsuccess = () => resolve();
      r.onerror = () => reject(r.error);
    });
  }
  async function idbKeys(){
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_NAME, 'readonly');
      const store = tx.objectStore(STORE_NAME);
      const keys = [];
      const cursorReq = store.openCursor();
      cursorReq.onsuccess = (e) => {
        const cursor = e.target.result;
        if (cursor) { keys.push(cursor.key); cursor.continue(); } else { resolve(keys); }
      };
      cursorReq.onerror = () => reject(cursorReq.error);
    });
  }

  // 迁移：仅首次运行，将 localStorage 内容复制到 IndexedDB
  async function migrateFromLocalStorageOnce(){
    try {
      const migratedFlag = await idbGet('__migrated_from_localstorage__');
      if (migratedFlag) return;
      for (let i = 0; i < window.localStorage.length; i++) {
        const key = window.localStorage.key(i);
        const val = window.localStorage.getItem(key);
        await idbSet(key, val);
      }
      await idbSet('__migrated_from_localstorage__', '1');
    } catch(err) { console.warn('迁移到IndexedDB失败:', err); }
  }

  // 暴露与localStorage一致的异步封装
  window.AppStorage = {
    async getItem(key){
      return await idbGet(key);
    },
    async setItem(key, value){
      await idbSet(key, value);
    },
    async removeItem(key){
      await idbDelete(key);
    },
    async clear(){
      await idbClear();
    },
    async keys(){
      return await idbKeys();
    }
  };

  // 提供同步风格辅助（返回Promise的便捷包装场景）
  window.getData = (key) => AppStorage.getItem(key);
  window.setData = (key, val) => AppStorage.setItem(key, val);
  window.removeData = (key) => AppStorage.removeItem(key);

  // 页面启动即做一次迁移
  migrateFromLocalStorageOnce();
})();

// 桌面滑动功能
let currentDesktopPage = 1;
let isDesktopTransitioning = false;

// 初始化桌面滑动功能
function initDesktopSwipe() {
    const desktopContainer = document.getElementById('desktopContainer');
    const pageIndicators = document.querySelectorAll('.page-indicator');
    
    // 鼠标事件（电脑端）
    let startX = 0;
    let startY = 0;
    let isDragging = false;
    
    desktopContainer.addEventListener('mousedown', (e) => {
        startX = e.clientX;
        startY = e.clientY;
        isDragging = true;
        desktopContainer.style.cursor = 'grabbing';
    });
    
    desktopContainer.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        e.preventDefault();
    });
    
    desktopContainer.addEventListener('mouseup', (e) => {
        if (!isDragging) return;
        isDragging = false;
        desktopContainer.style.cursor = 'grab';
        
        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;
        
        // 只有水平滑动距离大于垂直滑动距离时才切换页面
        if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
            if (deltaX > 0 && currentDesktopPage > 1) {
                // 向右滑动，切换到上一页
                switchDesktopPage(currentDesktopPage - 1);
            } else if (deltaX < 0 && currentDesktopPage < 2) {
                // 向左滑动，切换到下一页
                switchDesktopPage(currentDesktopPage + 1);
            }
        }
    });
    
    // 触摸事件（手机端）
    let touchStartX = 0;
    let touchStartY = 0;
    
    desktopContainer.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
    });
    
    desktopContainer.addEventListener('touchend', (e) => {
        const touchEndX = e.changedTouches[0].clientX;
        const touchEndY = e.changedTouches[0].clientY;
        const deltaX = touchEndX - touchStartX;
        const deltaY = touchEndY - touchStartY;
        
        // 只有水平滑动距离大于垂直滑动距离时才切换页面
        if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
            if (deltaX > 0 && currentDesktopPage > 1) {
                // 向右滑动，切换到上一页
                switchDesktopPage(currentDesktopPage - 1);
            } else if (deltaX < 0 && currentDesktopPage < 2) {
                // 向左滑动，切换到下一页
                switchDesktopPage(currentDesktopPage + 1);
            }
        }
    });
    
    // 页面指示器点击事件
    pageIndicators.forEach((indicator, index) => {
        indicator.addEventListener('click', () => {
            switchDesktopPage(index + 1);
        });
    });
    
    // 键盘事件（电脑端）
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft' && currentDesktopPage > 1) {
            switchDesktopPage(currentDesktopPage - 1);
        } else if (e.key === 'ArrowRight' && currentDesktopPage < 2) {
            switchDesktopPage(currentDesktopPage + 1);
        }
    });
}

// 切换桌面页面
function switchDesktopPage(pageNumber) {
    if (isDesktopTransitioning || pageNumber === currentDesktopPage) return;
    
    isDesktopTransitioning = true;
    const desktopContainer = document.getElementById('desktopContainer');
    const pageIndicators = document.querySelectorAll('.page-indicator');
    const pages = document.querySelectorAll('.desktop-page');
    
    // 更新当前页面
    currentDesktopPage = pageNumber;
    
    // 更新页面显示
    pages.forEach((page, index) => {
        page.classList.toggle('active', index + 1 === pageNumber);
    });
    
    // 更新指示器
    pageIndicators.forEach((indicator, index) => {
        indicator.classList.toggle('active', index + 1 === pageNumber);
    });
    
    // 播放切换音效
    playClickSound();
    
    // 重置过渡状态
    setTimeout(() => {
        isDesktopTransitioning = false;
    }, 300);
}

// 页面初始化
async function initializeApp() {
    // 加载桌面壁纸
    const savedDesktopWallpaper = await AppStorage.getItem('desktopWallpaper');
    if (savedDesktopWallpaper) {
        applyDesktopWallpaper(savedDesktopWallpaper);
        updateDesktopWallpaperDisplay(savedDesktopWallpaper);
    }
    
    // 初始化桌面滑动功能
    initDesktopSwipe();
    
    // 加载聊天壁纸
    const savedChatWallpaper = await AppStorage.getItem('chatWallpaper');
    if (savedChatWallpaper) {
        applyChatWallpaper(savedChatWallpaper);
    }
    
    // 加载消息数据
    await loadMessagesData();
    
    // 只在第一次访问时清除预设数据
    const hasClearedPresetData = await AppStorage.getItem('hasClearedPresetData');
    if (!hasClearedPresetData) {
        await clearPresetData();
        await AppStorage.setItem('hasClearedPresetData', 'true');
    }
    
    // 加载动态数据
    await loadMomentData();
    
    // 加载个人信息
    loadProfileData();
}

// 优化后的聊天输入框初始化函数（修复移动端卡顿问题）
function initChatInputOptimized() {
    const inputField = document.getElementById('chatInputField');
    const sendBtn = document.getElementById('chatSendBtn');
    
    if (!inputField || !sendBtn) {
        console.warn('Chat input elements not found');
        return;
    }
    
    // 防止在移动端输入时频繁触发事件导致卡顿
    // 使用 compositionstart/compositionend 来检测输入法状态
    let isComposing = false;
    
    inputField.addEventListener('compositionstart', () => {
        isComposing = true;
    });
    
    inputField.addEventListener('compositionend', () => {
        isComposing = false;
    });
    
    // 发送消息函数 - 移动端超高性能版本
    async function sendMessage() {
        // 如果正在使用输入法，不发送
        if (isComposing) return;
        
        const content = inputField.value.trim();
        if (!content) return;
        
        // 🚀 移动端优化：立即清空输入框，提升响应速度
        inputField.value = '';
        
        // 🚀 移动端优化：禁用输入框，防止重复发送
        inputField.disabled = true;
        sendBtn.disabled = true;
        
        // 创建消息对象（同步操作，不等待）
        const now = new Date();
        const message = {
            id: Date.now(),
            sender: 'sent',
            content: content,
            time: `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`,
            avatar: '', // 先设为空，后面异步更新
            isFromUser: true
        };
        
        // 立即添加到消息列表
        chatMessages.push(message);
        
        // 🚀 移动端优化：使用最简化的DOM操作
        const chatMessagesContainer = document.getElementById('chatMessages');
        
        // 创建消息元素（使用innerHTML，在移动端比createElement更快）
        const messageHTML = `
            <div class="message sent" data-message-id="${message.id}">
                <div class="message-content">${content}</div>
                <div class="message-time">${message.time}</div>
            </div>
        `;
        
        // 🚀 移动端优化：直接插入HTML，避免多次DOM操作
        chatMessagesContainer.insertAdjacentHTML('beforeend', messageHTML);
        
        // 🚀 移动端优化：使用setTimeout而不是requestAnimationFrame，在移动端更稳定
        setTimeout(() => {
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }, 0);
        
        // 🚀 移动端优化：立即恢复输入框状态
        setTimeout(() => {
            inputField.disabled = false;
            sendBtn.disabled = false;
            inputField.focus();
        }, 100);
        
        // 🚀 优化：智能消息管理 - 直接移除旧消息而不是替换
        // 这样可以显著减少DOM操作，提升性能
        requestAnimationFrame(() => {
            const allMessages = chatMessagesContainer.querySelectorAll('.message:not(.message-placeholder)');
            const MAX_VISIBLE_MESSAGES = 50; // 增加到50条，平衡性能和体验
            
            if (allMessages.length > MAX_VISIBLE_MESSAGES) {
                // 计算需要移除的消息数量
                const removeCount = allMessages.length - MAX_VISIBLE_MESSAGES;
                
                // 创建一个占位符（只创建一次）
                const existingPlaceholder = chatMessagesContainer.querySelector('.message-placeholder');
                if (!existingPlaceholder) {
                    const placeholder = document.createElement('div');
                    placeholder.className = 'message-placeholder';
                    placeholder.innerHTML = `
                        <div class="placeholder-content">
                            <div class="placeholder-dot"></div>
                            <div class="placeholder-dot"></div>
                            <div class="placeholder-dot"></div>
                            <span class="placeholder-text">📜 ${removeCount} 条历史消息</span>
                        </div>
                    `;
                    placeholder.style.cssText = 'height:50px;display:flex;align-items:center;justify-content:center;color:#999;font-size:12px;border:1px dashed #ddd;margin:5px 0;border-radius:8px;background:#f9f9f9;cursor:pointer;';
                    placeholder.onclick = () => renderChatMessages(); // 点击加载全部
                    chatMessagesContainer.insertBefore(placeholder, chatMessagesContainer.firstChild);
                } else {
                    // 更新占位符文本
                    const placeholderText = existingPlaceholder.querySelector('.placeholder-text');
                    if (placeholderText) {
                        placeholderText.textContent = `📜 ${removeCount} 条历史消息`;
                    }
                }
                
                // 批量移除旧消息（使用DocumentFragment优化性能）
                for (let i = 0; i < removeCount; i++) {
                    if (allMessages[i]) {
                        allMessages[i].remove();
                    }
                }
            }
        });
        
        // 🚀 移动端优化：使用更长的延迟，避免阻塞UI
        setTimeout(async () => {
            try {
                // 🚀 移动端优化：延迟获取头像，避免阻塞发送
                const selfAvatar = await getSelfAvatar();
                message.avatar = selfAvatar;
                
                // 🚀 移动端优化：延迟更新头像，避免重排
                const messageElement = chatMessagesContainer.querySelector(`[data-message-id="${message.id}"]`);
                if (messageElement) {
                    // 创建头像元素
                    const avatarEl = document.createElement('img');
                    avatarEl.className = 'message-avatar';
                    avatarEl.src = selfAvatar;
                    avatarEl.alt = '';
                    
                    // 插入到消息开头
                    messageElement.insertBefore(avatarEl, messageElement.firstChild);
                }
                
                // 🚀 移动端优化：延迟更新消息列表，避免阻塞
                const messageInList = currentMessages.find(m => m.id === currentChatContact.id);
                if (messageInList) {
                    messageInList.lastMessage = content.substring(0, 30) + (content.length > 30 ? '...' : '');
                    messageInList.time = message.time;
                    
                    // 重新渲染消息列表以显示更新
                    await renderMessagesList();
                }
                
                // 🚀 移动端优化：AI回复延迟更长时间，确保UI完全响应
                if (aiConfig.provider && aiConfig.apiKey && aiConfig.model && aiConfig.status === 'connected') {
                    // 🚀 修复：保存当前联系人信息，避免切换界面时丢失
                    const currentContact = currentChatContact;
                    
                    setTimeout(async () => {
                        try {
                            setChatTyping(true);
                            const aiResponse = await sendAIMessage(content);
                            setChatTyping(false);
                            
                            if (aiResponse) {
                                const { cleanText, actions } = parseAndExtractAIActions(aiResponse);
                                
                                if (AI_TEXT_RULES.denyActions || !actions || actions.length === 0) {
                                    await renderAndSaveAIReplies(cleanText, currentContact);
                                } else {
                                    await renderAndSaveAIReplies(cleanText, currentContact);
                                    await executeAIActions(actions);
                                }
                            }
                        } catch (error) {
                            console.error('AI回复失败:', error);
                            setChatTyping(false);
                        }
                    }, 500); // 移动端延迟更长时间
                }
            } catch (error) {
                console.error('发送消息失败:', error);
            }
        }, 200); // 移动端延迟200ms
    }
    
    // 暴露到全局，供sendComplete调用
    window.__optimizedSendMessage = sendMessage;
    
    // 回车发送消息（PC端）- 超高性能版本
    inputField.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey && !isComposing) {
            e.preventDefault();
            // 立即发送，不等待任何异步操作
            sendMessage();
        }
    });
    
    // 🚀 移动端优化：简化输入框事件处理，避免卡顿
    let inputDebounceTimer = null;
    let isInputProcessing = false;
    
    inputField.addEventListener('input', () => {
        // 🚀 移动端优化：避免频繁的样式更新
        if (isInputProcessing) return;
        isInputProcessing = true;
        
        // 清除之前的定时器
        if (inputDebounceTimer) {
            clearTimeout(inputDebounceTimer);
        }
        
        // 🚀 移动端优化：使用更长的防抖时间
        inputDebounceTimer = setTimeout(() => {
            isInputProcessing = false;
            // 不执行任何耗时操作，保持输入流畅
        }, 1000);
        
        // 🚀 移动端优化：减少样式更新频率
        if (!inputField.style.borderColor) {
            inputField.style.borderColor = '#4CAF50';
            setTimeout(() => {
                inputField.style.borderColor = '';
            }, 200);
        }
    });
    
    // 点击发送按钮
    sendBtn.addEventListener('click', sendMessage);
    
    // 🚀 移动端优化：减少消息管理频率，避免卡顿
    let messageManagementTimer = null;
    
    function manageMessages() {
        const chatMessagesContainer = document.getElementById('chatMessages');
        if (!chatMessagesContainer) return;
        
        const allMessages = chatMessagesContainer.querySelectorAll('.message');
        if (allMessages.length > 30) { // 移动端保留更多消息
            // 🚀 移动端优化：批量处理，减少DOM操作
            const messagesToReplace = allMessages.length - 30;
            const fragment = document.createDocumentFragment();
            
            for (let i = 0; i < messagesToReplace; i++) {
                const message = allMessages[i];
                const placeholder = document.createElement('div');
                placeholder.className = 'message-placeholder';
                placeholder.innerHTML = `
                    <div class="placeholder-content">
                        <span class="placeholder-text">${messagesToReplace - i} 条历史消息</span>
                    </div>
                `;
                placeholder.style.cssText = 'height:40px;display:flex;align-items:center;justify-content:center;color:#999;font-size:12px;border:1px dashed #ddd;margin:5px 0;border-radius:8px;background:#f9f9f9;';
                
                // 替换消息为占位符
                message.parentNode.replaceChild(placeholder, message);
            }
        }
    }
    
    // 🚀 移动端优化：使用更长的间隔，减少性能影响
    setInterval(() => {
        if (messageManagementTimer) return;
        messageManagementTimer = setTimeout(() => {
            manageMessages();
            messageManagementTimer = null;
        }, 100);
    }, 15000); // 每15秒检查一次
    
    // 添加滚动监听器，实现虚拟滚动
    const chatMessagesContainer = document.getElementById('chatMessages');
    if (chatMessagesContainer) {
        chatMessagesContainer.addEventListener('scroll', () => {
            // 当用户滚动到顶部时，可以显示更多历史消息
            if (chatMessagesContainer.scrollTop < 100) {
                showMoreHistoryMessages();
            }
        });
    }
}

// 高性能渲染新消息函数（只渲染单条消息，不重新渲染整个聊天界面）
async function renderNewMessage(message) {
    const chatMessagesContainer = document.getElementById('chatMessages');
    if (!chatMessagesContainer) return;
    
    // 创建消息元素
    const messageElement = document.createElement('div');
    messageElement.className = `message ${message.sender}`;
    
    // 获取自己的头像
    const selfAvatar = await getSelfAvatar();
    
    // 构建消息内容HTML（简化版，只处理普通文本消息）
    let contentHTML = '';
    if (message.type === 'transfer') {
        // 转账消息
        const amount = message.content.match(/¥(\d+\.?\d*)/)?.[1] || '0.00';
        const note = message.content.match(/备注：(.+)/)?.[1] || '';
        contentHTML = `
            <div class="message-transfer">
                <div class="transfer-row">
                    <div class="transfer-icon">+</div>
                    <div class="transfer-amount">¥ ${amount}</div>
                </div>
                <div class="transfer-status">已转账给${currentChatContact ? currentChatContact.name : '对方'}</div>
                ${note ? `<div class="transfer-note">备注：${note}</div>` : ''}
            </div>
        `;
    } else {
        // 普通文本消息
        contentHTML = `<div class="message-content">${message.content}</div>`;
    }
    
    // 设置消息HTML
    messageElement.innerHTML = `
        <img src="${message.avatar}" alt="" class="message-avatar">
        <div class="message-wrapper">
            ${contentHTML}
            <div class="message-time">${message.time}</div>
        </div>
    `;
    
    // 添加多选圆圈
    const circle = document.createElement('div');
    circle.className = 'select-circle';
    messageElement.appendChild(circle);
    
    // 直接添加到容器末尾（不重新渲染所有消息）
    chatMessagesContainer.appendChild(messageElement);
    
    // 绑定长按事件
    bindLongPress(messageElement, message);
    
    // 双击头像事件
    const avatarEl = messageElement.querySelector('.message-avatar');
    if (avatarEl) {
        avatarEl.addEventListener('dblclick', () => {
            const tipText = (message.sender === 'sent') ? '你拍了拍自己的头像' : '你拍了拍对方的头像';
            addSystemTip(tipText);
        });
    }
    
    // 滚动到底部（使用requestAnimationFrame确保流畅）
    requestAnimationFrame(() => {
        chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
    });
    
    // 🚀 优化：智能消息管理 - 直接移除旧消息而不是替换
    requestAnimationFrame(() => {
        const allMessages = chatMessagesContainer.querySelectorAll('.message:not(.message-placeholder)');
        const MAX_VISIBLE_MESSAGES = 50;
        
        if (allMessages.length > MAX_VISIBLE_MESSAGES) {
            const removeCount = allMessages.length - MAX_VISIBLE_MESSAGES;
            
            // 创建或更新占位符
            const existingPlaceholder = chatMessagesContainer.querySelector('.message-placeholder');
            if (!existingPlaceholder) {
                const placeholder = document.createElement('div');
                placeholder.className = 'message-placeholder';
                placeholder.innerHTML = `
                    <div class="placeholder-content">
                        <div class="placeholder-dot"></div>
                        <div class="placeholder-dot"></div>
                        <div class="placeholder-dot"></div>
                        <span class="placeholder-text">📜 ${removeCount} 条历史消息</span>
                    </div>
                `;
                placeholder.style.cssText = 'height:50px;display:flex;align-items:center;justify-content:center;color:#999;font-size:12px;border:1px dashed #ddd;margin:5px 0;border-radius:8px;background:#f9f9f9;cursor:pointer;';
                placeholder.onclick = () => renderChatMessages();
                chatMessagesContainer.insertBefore(placeholder, chatMessagesContainer.firstChild);
            } else {
                const placeholderText = existingPlaceholder.querySelector('.placeholder-text');
                if (placeholderText) {
                    placeholderText.textContent = `📜 ${removeCount} 条历史消息`;
                }
            }
            
            // 批量移除旧消息
            for (let i = 0; i < removeCount; i++) {
                if (allMessages[i]) {
                    allMessages[i].remove();
                }
            }
        }
    });
}

// 高性能渲染AI回复消息
async function renderNewAIMessage(message) {
    const chatMessagesContainer = document.getElementById('chatMessages');
    if (!chatMessagesContainer) {
        // 🚀 修复：如果聊天界面已关闭，只保存消息，不渲染
        console.log('聊天界面已关闭，AI消息已保存但未渲染');
        return;
    }
    
    // 创建消息元素
    const messageElement = document.createElement('div');
    messageElement.className = `message ${message.sender}`;
    
    // 构建消息内容HTML（简化版）
    const contentHTML = `<div class="message-content">${message.content}</div>`;
    
    // 设置消息HTML
    messageElement.innerHTML = `
        <img src="${message.avatar}" alt="" class="message-avatar">
        <div class="message-wrapper">
            ${contentHTML}
            <div class="message-time">${message.time}</div>
        </div>
    `;
    
    // 添加多选圆圈
    const circle = document.createElement('div');
    circle.className = 'select-circle';
    messageElement.appendChild(circle);
    
    // 直接添加到容器末尾
    chatMessagesContainer.appendChild(messageElement);
    
    // 绑定长按事件
    bindLongPress(messageElement, message);
    
    // 滚动到底部
    requestAnimationFrame(() => {
        chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
    });
}

// 显示更多历史消息（从占位符恢复消息）
async function showMoreHistoryMessages() {
    const chatMessagesContainer = document.getElementById('chatMessages');
    if (!chatMessagesContainer) return;
    
    // 查找占位符
    const placeholders = chatMessagesContainer.querySelectorAll('.message-placeholder');
    if (placeholders.length > 0) {
        // 恢复第一个占位符为真实消息
        const placeholder = placeholders[0];
        const placeholderText = placeholder.querySelector('.placeholder-text').textContent;
        const messageCount = parseInt(placeholderText.match(/(\d+)/)?.[1] || '0');
        
        if (messageCount > 0) {
            // 从内存中找到对应的消息
            const messageIndex = chatMessages.length - 20 - messageCount;
            if (messageIndex >= 0 && messageIndex < chatMessages.length) {
                const message = chatMessages[messageIndex];
                
                // 创建真实的消息元素
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.sender}`;
                
                // 构建消息内容HTML
                let contentHTML = '';
                if (message.type === 'transfer') {
                    const amount = message.content.match(/¥(\d+\.?\d*)/)?.[1] || '0.00';
                    const note = message.content.match(/备注：(.+)/)?.[1] || '';
                    contentHTML = `
                        <div class="message-transfer">
                            <div class="transfer-row">
                                <div class="transfer-icon">+</div>
                                <div class="transfer-amount">¥ ${amount}</div>
                            </div>
                            <div class="transfer-status">已转账给${currentChatContact ? currentChatContact.name : '对方'}</div>
                            ${note ? `<div class="transfer-note">备注：${note}</div>` : ''}
                        </div>
                    `;
                } else {
                    contentHTML = `<div class="message-content">${message.content}</div>`;
                }
                
                messageElement.innerHTML = `
                    <img src="${message.avatar}" alt="" class="message-avatar">
                    <div class="message-wrapper">
                        ${contentHTML}
                        <div class="message-time">${message.time}</div>
                    </div>
                `;
                
                // 替换占位符为真实消息
                placeholder.parentNode.replaceChild(messageElement, placeholder);
                
                // 如果现在消息太多，将最旧的消息替换为占位符
                const allMessages = chatMessagesContainer.querySelectorAll('.message');
                if (allMessages.length > 20) {
                    const oldestMessage = allMessages[0];
                    const placeholder = document.createElement('div');
                    placeholder.className = 'message-placeholder';
                    placeholder.innerHTML = `
                        <div class="placeholder-content">
                            <div class="placeholder-dot"></div>
                            <div class="placeholder-dot"></div>
                            <div class="placeholder-dot"></div>
                            <span class="placeholder-text">1 条历史消息</span>
                        </div>
                    `;
                    placeholder.style.height = '60px';
                    placeholder.style.display = 'flex';
                    placeholder.style.alignItems = 'center';
                    placeholder.style.justifyContent = 'center';
                    placeholder.style.color = '#999';
                    placeholder.style.fontSize = '12px';
                    placeholder.style.border = '1px dashed #ddd';
                    placeholder.style.margin = '5px 0';
                    placeholder.style.borderRadius = '8px';
                    placeholder.style.background = '#f9f9f9';
                    
                    oldestMessage.parentNode.replaceChild(placeholder, oldestMessage);
                }
            }
        }
    }
}

// 🚀 优化：防抖存储 - 减少存储次数，提升性能
let saveTimer = null;
let pendingSaves = new Map(); // 使用Map缓存待保存的数据

const debouncedSave = (contactId, messages) => {
    // 先缓存数据
    pendingSaves.set(contactId, messages);
    
    if (saveTimer) {
        clearTimeout(saveTimer);
    }
    
    saveTimer = setTimeout(async () => {
        try {
            // 批量保存所有待保存的数据
            const saves = Array.from(pendingSaves.entries());
            pendingSaves.clear();
            
            // 使用Promise.all并行保存，提升效率
            await Promise.all(saves.map(([id, msgs]) => 
                saveChatMessages(id, msgs).catch(err => {
                    console.error(`保存联系人${id}的消息失败:`, err);
                })
            ));
            
            console.log(`✅ 批量保存成功，共${saves.length}个会话`);
        } catch (error) {
            console.error('批量保存失败:', error);
        }
    }, 1000); // 降低到1秒，提升响应速度
};

// 🚀 性能优化完成标记
console.log('%c🚀 消息界面性能优化已启用', 'color: #4CAF50; font-weight: bold; font-size: 14px;');
console.log('%c✅ 优化项目:', 'color: #2196F3; font-weight: bold;');
console.log('  1. DOM元素限制：最多保留50条可见消息');
console.log('  2. 防抖存储：减少IndexedDB写入频率');
console.log('  3. 输入框优化：防止输入时卡顿');
console.log('  4. DocumentFragment：减少DOM重排');
console.log('  5. requestAnimationFrame：优化滚动性能');
console.log('  6. 批量操作：提升数据保存效率');

// PWA性能优化：使用Web Workers处理复杂操作
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then(registration => {
                console.log('SW registered: ', registration);
            })
            .catch(registrationError => {
                console.log('SW registration failed: ', registrationError);
            });
    });
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', () => {
    initializeApp();
    initChatInputOptimized();
    
    // 启动AI后台处理服务
    startAIBackgroundService();
    
    // 初始化图片上传
    handlePostImageUpload();
    
    // 初始化角色卡文件上传
    const characterFileUpload = document.getElementById('character-file-upload');
    if (characterFileUpload) {
        characterFileUpload.addEventListener('change', handleCharacterFileUpload);
    }
    
    // 聊天功能条事件监听器
    const chatToolbar = document.getElementById('chatToolbar');
    if (chatToolbar) {
        chatToolbar.addEventListener('click', (e) => {
            if (e.target === chatToolbar) {
                closeChatMenu();
            }
        });
        
        // 添加鼠标滚轮支持
        const toolbarContent = chatToolbar.querySelector('.chat-toolbar-content');
        if (toolbarContent) {
            toolbarContent.addEventListener('wheel', (e) => {
                e.preventDefault();
                toolbarContent.scrollLeft += e.deltaY;
            });
        }
    }
    
    // 删除确认弹窗点击外部关闭
    const deleteConfirmOverlay = document.getElementById('deleteConfirmOverlay');
    if (deleteConfirmOverlay) {
        deleteConfirmOverlay.addEventListener('click', (e) => {
            if (e.target === deleteConfirmOverlay) {
                closeDeleteConfirm();
            }
        });
    }
    
    // 点击页面空白处关闭聊天功能条
    document.addEventListener('click', (e) => {
        const toolbar = document.getElementById('chatToolbar');
        const plusBtn = document.querySelector('.chat-plus-btn');
        if (!toolbar) return;
        const isOpen = toolbar.style.display === 'block' || toolbar.classList.contains('show');
        const clickedInsideToolbar = toolbar.contains(e.target);
        const clickedPlusBtn = plusBtn && (plusBtn === e.target || plusBtn.contains(e.target));
        if (isOpen && !clickedInsideToolbar && !clickedPlusBtn) {
            closeChatMenu();
        }
    });

    // Esc 键关闭聊天功能条
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeChatMenu();
        }
    });
    
    // 弹窗点击外部关闭事件监听器
    const modals = ['imageUploadModal', 'transferModal', 'locationModal', 'foodOrderModal', 'voiceTextModal', 'videoCallModal'];
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    if (modalId === 'imageUploadModal') closeImageUploadModal();
                    else if (modalId === 'transferModal') closeTransferModal();
                    else if (modalId === 'locationModal') closeLocationModal();
                    else if (modalId === 'foodOrderModal') closeFoodOrderModal();
                    else if (modalId === 'voiceTextModal') closeVoiceTextModal();
                    else if (modalId === 'videoCallModal') closeVideoCallModal();
                }
            });
        }
    });
});

// 大图预览逻辑
function openImageLightbox(src) {
    const lightbox = document.getElementById('imageLightbox');
    const img = document.getElementById('lightboxImage');
    if (!lightbox || !img) return;
    img.src = src;
    lightbox.classList.add('show');
}

function closeImageLightbox() {
    const lightbox = document.getElementById('imageLightbox');
    const img = document.getElementById('lightboxImage');
    if (!lightbox || !img) return;
    lightbox.classList.remove('show');
    img.src = '';
}

// 通知系统
function showNotification(message) {
    // 创建通知元素
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.textContent = message;
    
    // 添加样式
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        font-size: 14px;
        max-width: 300px;
        word-wrap: break-word;
        animation: slideInRight 0.3s ease-out;
    `;
    
    // 添加动画样式
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
    
    // 添加到页面
    document.body.appendChild(notification);
    
    // 3秒后自动移除
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
    
    // 如果浏览器支持通知API，也发送系统通知
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('多云熊小手机', {
            body: message,
            icon: 'https://files.catbox.moe/r5s188.jpg'
        });
    }
}

// 桌面翻页功能 - 让时间和天气组件跟随翻页（仅支持点击指示器）
(function() {
    let currentPage = 1;
    
    const desktopContainer = document.getElementById('desktopContainer');
    const widgetContainer = document.querySelector('.widget-container');
    const pageIndicators = document.querySelectorAll('.page-indicator');
    const page1 = document.getElementById('desktopPage1');
    const page2 = document.getElementById('desktopPage2');
    
    if (!desktopContainer || !widgetContainer) return;
    
    function switchPage(pageNum) {
        currentPage = pageNum;
        
        // 更新页面状态
        if (pageNum === 1) {
            page1.classList.add('active');
            page2.classList.remove('active');
            widgetContainer.style.transform = 'translateX(0)';
            desktopContainer.style.transform = 'translateX(0)';
        } else if (pageNum === 2) {
            page1.classList.remove('active');
            page2.classList.add('active');
            widgetContainer.style.transform = 'translateX(-100%)';
            desktopContainer.style.transform = 'translateX(-100%)';
        }
        
        // 更新指示器
        pageIndicators.forEach((indicator, index) => {
            if (index + 1 === pageNum) {
                indicator.classList.add('active');
            } else {
                indicator.classList.remove('active');
            }
        });
    }
    
    // 点击指示器切换页面
    pageIndicators.forEach((indicator, index) => {
        indicator.addEventListener('click', () => {
            switchPage(index + 1);
        });
    });
    
    // 键盘支持（左右箭头键）
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft' && currentPage === 2) {
            switchPage(1);
        } else if (e.key === 'ArrowRight' && currentPage === 1) {
            switchPage(2);
        }
    });
})();
</script>
</body>
</html>
